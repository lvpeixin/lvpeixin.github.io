<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="吕培新的博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="吕培新的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="吕培新的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/">





  <title>吕培新的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">吕培新的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活中没有弱者，只有不愿努力的人。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-computer">
          <a href="/categories/计算机基础" rel="section">
            
            计算机基础
          </a>
        </li>
      
        
        <li class="menu-item menu-item-network">
          <a href="/categories/网络技术" rel="section">
            
            网络技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux">
          <a href="/categories/linux" rel="section">
            
            Linux运维
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/python" rel="section">
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-shell">
          <a href="/categories/shell脚本" rel="section">
            
            Shell脚本
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sql">
          <a href="/categories/数据库" rel="section">
            
            数据库
          </a>
        </li>
      
        
        <li class="menu-item menu-item-webserver">
          <a href="/categories/Web服务器" rel="section">
            
            Web服务器
          </a>
        </li>
      
        
        <li class="menu-item menu-item-automated">
          <a href="/categories/自动化运维" rel="section">
            
            自动化运维工具
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cluster">
          <a href="/categories/集群" rel="section">
            
            集群
          </a>
        </li>
      
        
        <li class="menu-item menu-item-editor">
          <a href="/categories/文本三剑客" rel="section">
            
            文本三剑客
          </a>
        </li>
      
        
        <li class="menu-item menu-item-algorithm">
          <a href="/categories/算法" rel="section">
            
            算法
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/03/LVS介绍及工作原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/03/LVS介绍及工作原理/" itemprop="url">LVS介绍及工作原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-03T16:21:00+08:00">
                2018-07-03
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群/" itemprop="url" rel="index">
                    <span itemprop="name">集群</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、Cluster集群概念"><a href="#一、Cluster集群概念" class="headerlink" title="一、Cluster集群概念"></a><strong>一、Cluster集群概念</strong></h2><p><strong>集群(cluster)</strong>技术是一种较新的技术，通过集群技术，可以在付出较低成本的情况</p>
<p>下获得在性能、可靠性、灵活性方面的相对较高的收益，其任务调度则是集群系统中</p>
<p>的核心技术。</p>
<h3 id="系统扩展方式："><a href="#系统扩展方式：" class="headerlink" title="系统扩展方式："></a><strong>系统扩展方式：</strong></h3><p>Scale UP：向上扩展,增强</p>
<p>Scale Out：向外扩展,增加设备，调度分配问题，Cluster</p>
<p>Cluster：集群,为解决某个特定问题将多台计算机组合起来形成的单个系统</p>
<p>Linux Cluster类型：</p>
<p>LB：Load Balancing，负载均衡</p>
<p>HA：High Availiablity，高可用，SPOF（single Point Of failure）</p>
<p>MTBF：Mean Time Between Failure 平均无故障时间</p>
<p>MTTR：Mean Time To Restoration（ repair）平均恢复前时间</p>
<p>A=MTBF/（MTBF+MTTR） (0,1)：99%, 99.5%, 99.9%, 99.99%, 99.999%</p>
<p>HPC：High-performance computing，高性能 <a href="http://www.top500.org" target="_blank" rel="noopener">www.top500.org</a></p>
<h3 id="分布式系统："><a href="#分布式系统：" class="headerlink" title="分布式系统："></a><strong>分布式系统：</strong></h3><p>分布式存储：云盘</p>
<p>分布式计算：hadoop，Spark</p>
<p>分布式文件系统：fastfs</p>
<h3 id="集群与分布式："><a href="#集群与分布式：" class="headerlink" title="集群与分布式："></a><strong>集群与分布式：</strong></h3><p>简单来说集群是解决高可用的，而分布式是解决高性能、高并发的</p>
<p><strong>集群：</strong>同一个业务，部署在多个服务器上</p>
<p><strong>分布式：</strong>一个业务分拆多个子业务，部署在不同的服务器上</p>
<h3 id="Cluster分类"><a href="#Cluster分类" class="headerlink" title="Cluster分类"></a><strong>Cluster分类</strong></h3><p>LB Cluster的实现</p>
<p>硬件</p>
<p>F5 Big-IP</p>
<p>Citrix Netscaler</p>
<p>A10 A10</p>
<p>软件</p>
<p>lvs：Linux Virtual Server</p>
<p>nginx：支持七层调度</p>
<p>haproxy：支持七层调度</p>
<p>ats：apache traffic server，yahoo捐助</p>
<p>perlbal：Perl 编写</p>
<p>pound</p>
<p><strong>基于工作的协议层次划分：</strong></p>
<p>传输层（通用）：DPORT</p>
<p>LVS：</p>
<p>nginx：stream</p>
<p>haproxy：mode tcp</p>
<p>应用层（专用）：针对特定协议，自定义的请求模型分类</p>
<p>proxy server：</p>
<p>http：nginx, httpd, haproxy(mode http), …</p>
<p>fastcgi：nginx, httpd, …</p>
<p>mysql：mysql-proxy, …</p>
<p>会话保持：负载均衡</p>
<p>(1)session sticky：同一用户调度固定服务器</p>
<p>Source IP：LVS sh算法（对某一特定服务而言）</p>
<p>Cookie</p>
<p>(2)session replication：每台服务器拥有全部session</p>
<p>session multicast cluster</p>
<p>(3)session server：专门的session服务器</p>
<p>Memcached，Redis</p>
<p>HA集群实现方案</p>
<p>keepalived:vrrp协议</p>
<p>ais:应用接口规范</p>
<p>heartbeat</p>
<p>cman+rgmanager(RHCS)</p>
<p>coresync_pacemaker</p>
<h2 id="二、LVS介绍"><a href="#二、LVS介绍" class="headerlink" title="二、LVS介绍"></a><strong>二、LVS介绍</strong></h2><p><strong>LVS：Linux Virtual Server</strong>，负载调度器，集成内核 章文嵩 阿里</p>
<p><strong>官网</strong>：<a href="http://www.linuxvirtualserver.org/" target="_blank" rel="noopener">http://www.linuxvirtualserver.org/</a></p>
<p><strong>VS</strong>：Virtual Server，负责调度</p>
<p><strong>RS</strong>：Real Server，负责真正提供服务</p>
<p><strong>L4</strong>：四层路由器或交换机</p>
<p><strong>工作原理：</strong>VS根据请求报文的目标IP和目标协议及端口将其调度转发至某RS，根据调度</p>
<p>算法来挑选RS</p>
<p>iptables/netfilter：</p>
<p>iptables：用户空间的管理工具</p>
<p>netfilter：内核空间上的框架</p>
<p>流入：<strong>PREROUTING –&gt; INPUT</strong></p>
<p>流出：<strong>OUTPUT –&gt; POSTROUTING</strong></p>
<p>转发：<strong>PREROUTING –&gt; FORWARD –&gt; POSTROUTING</strong></p>
<p>DNAT：目标地址转换； <strong>PREROUTING</strong></p>
<p>LVS集群的通用结构：</p>
<p><img src="1.png" alt="1"></p>
<h3 id="LVS工作原理"><a href="#LVS工作原理" class="headerlink" title="LVS工作原理"></a>LVS工作原理</h3><p>LVS集群类型中的术语：</p>
<p><strong>VS：</strong>Virtual Server，Director Server(DS)，Dispatcher(调度器)，Load Balancer</p>
<p><strong>RS：</strong>Real Server(lvs), upstream server(nginx)，backend server(haproxy)</p>
<p><strong>CIP：</strong>Client IP</p>
<p><strong>VIP:</strong> Virtual serve IP VS外网的IP</p>
<p><strong>DIP:</strong> Director IP VS内网的IP</p>
<p><strong>RIP:</strong> Real server IP</p>
<p>访问流程：<strong>CIP &lt;–&gt; VIP == DIP &lt;–&gt; RIP</strong></p>
<p>lvs：ipvsadm/ipvs</p>
<p>ipvsadm：用户空间的命令行工具，规则管理器</p>
<p>用于管理集群服务及RealServer</p>
<p>ipvs：工作于内核空间netfilter的INPUT钩子上的框架</p>
<h3 id="lvs集群的类型："><a href="#lvs集群的类型：" class="headerlink" title="lvs集群的类型："></a><strong>lvs集群的类型：</strong></h3><p><strong>lvs-nat：</strong>修改请求报文的目标IP,多目标IP的DNAT(重点)</p>
<p><strong>lvs-dr：</strong>操纵封装新的MAC地址(重点)</p>
<p><strong>lvs-tun：</strong>在原请求IP报文之外新加一个IP首部</p>
<p><strong>lvs-fullnat：</strong>修改请求报文的源和目标IP</p>
<h2 id="三、LVS模式与调度算法"><a href="#三、LVS模式与调度算法" class="headerlink" title="三、LVS模式与调度算法"></a><strong>三、LVS模式与调度算法</strong></h2><h3 id="lvs-nat模式"><a href="#lvs-nat模式" class="headerlink" title="lvs-nat模式"></a><strong>lvs-nat模式</strong></h3><p>本质是多目标IP的DNAT，通过将请求报文中的目标地址和目标端口修改为某挑</p>
<p>出的RS的RIP和PORT实现转发</p>
<p>LVS-NAT的体系结构如下图所示：</p>
<p><img src="2.png" alt="2"></p>
<p>（1）RIP和DIP应在同一个IP网络，且应使用私网地址；RS的网关要指向DIP</p>
<p>（2）请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈</p>
<p>（3）支持端口映射，可修改请求报文的目标PORT</p>
<p>（4）VS必须是Linux系统，RS可以是任意OS系统</p>
<p>LVS-NAT数据流程时序图：</p>
<p><img src="2-2.png" alt="2-2"></p>
<h3 id="LVS-DR模式"><a href="#LVS-DR模式" class="headerlink" title="LVS-DR模式"></a><strong>LVS-DR模式</strong></h3><p><strong>LVS-DR：Direct Routing</strong>，直接路由，LVS默认模式,应用最广泛,通过为请求报文重新</p>
<p>封装一个MAC首部进行转发，源MAC是DIP所在的接口的MAC，目标MAC是某挑选出</p>
<p>的RS的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变</p>
<p>LVS-DR的体系结构如下图所示：</p>
<p><img src="3.png" alt="3"></p>
<p>（1） Director和各RS都配置有VIP</p>
<p>（2） 确保前端路由器将目标IP为VIP的请求报文发往Director</p>
<p>在前端网关做静态绑定VIP和Director的MAC地址</p>
<p>在RS上使用arptables工具</p>
<p>arptables -A IN -d $VIP -j DROP</p>
<p>arptables -A OUT -s $VIP -j mangle –mangle-ip-s $RIP</p>
<p>在RS上修改内核参数以限制arp通告及应答级别</p>
<p><strong>/proc/sys/net/ipv4/conf/all/arp_ignore</strong></p>
<p><strong>/proc/sys/net/ipv4/conf/all/arp_announce</strong></p>
<p>（3）RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；</p>
<p>RIP的网关不能指向DIP，以确保响应报文不会经由Director</p>
<p>（4）RS和Director要在同一个物理网络</p>
<p>（5）请求报文要经由Director，但响应报文不经由Director，而由RS直接发往</p>
<p>Client</p>
<p>（6）不支持端口映射（端口不能修败）</p>
<p>（7）RS可使用大多数OS系统</p>
<p>LVS-DR数据流程时序图：</p>
<p><img src="3-2.png" alt="3-2"></p>
<h3 id="lvs-tun模式"><a href="#lvs-tun模式" class="headerlink" title="lvs-tun模式"></a><strong>lvs-tun模式</strong></h3><p>转发方式：不修改请求报文的IP首部（源IP为CIP，目标IP为VIP），而在原IP报文</p>
<p>之外再封装一个IP首部（源IP是DIP，目标IP是RIP），将报文发往挑选出的目标</p>
<p>RS；RS直接响应给客户端（源IP是VIP，目标IP是CIP）</p>
<p>LVS-TUN的体系结构如图所示：</p>
<p><img src="4.png" alt="4"></p>
<p>(1) DIP, VIP, RIP都应该是公网地址</p>
<p>(2) RS的网关一般不能指向DIP</p>
<p>(3) 请求报文要经由Director，但响应不能经由Director</p>
<p>(4) 不支持端口映射</p>
<p>(5) RS的OS须支持隧道功能</p>
<p>LVS-TUN数据流程时序图：</p>
<p><img src="4-2.png" alt="4-2"></p>
<h3 id="LVS-FULLNAT模式"><a href="#LVS-FULLNAT模式" class="headerlink" title="LVS-FULLNAT模式"></a><strong>LVS-FULLNAT模式</strong></h3><p><strong>lvs-fullnat：</strong>通过同时修改请求报文的源IP地址和目标IP地址进行转发</p>
<p>CIP –&gt; DIP</p>
<p>VIP –&gt; RIP</p>
<p>(1) VIP是公网地址，RIP和DIP是私网地址，且通常不在同一IP网络；因此，</p>
<p>RIP的网关一般不会指向DIP</p>
<p>(2) RS收到的请求报文源地址是DIP，因此，只需响应给DIP；但Director还</p>
<p>要将其发往Client</p>
<p>(3) 请求和响应报文都经由Director</p>
<p>(4) 支持端口映射</p>
<p>注意：此类型kernel默认不支持</p>
<h3 id="三种-主要IP-负载均衡技术比较："><a href="#三种-主要IP-负载均衡技术比较：" class="headerlink" title="三种 主要IP 负载均衡技术比较："></a>三种 主要IP 负载均衡技术比较：</h3><p><img src="优缺点.png" alt="优缺点"></p>
<p>lvs-nat与lvs-fullnat：请求和响应报文都经由Director</p>
<p>lvs-nat：RIP的网关要指向DIP</p>
<p>lvs-fullnat：RIP和DIP未必在同一IP网络，但要能通信</p>
<p>lvs-dr与lvs-tun：请求报文要经由Director，但响应报文由RS直接发往Client</p>
<p>lvs-dr：通过封装新的MAC首部实现，通过MAC网络转发</p>
<p>lvs-tun：通过在原IP报文外封装新IP头实现转发，支持远距离通信</p>
<p>lvs-nat 的优点是服务器可以运行任何支持 TCP/IP 的操作系统，它只需要</p>
<p>一个 IP 地址配置在调度器上，服务器组可以用私有的 IP 地址。缺点是它的伸缩</p>
<p>能力有限，当服务器结点数目升到 20 时，调度器本身有可能成为系统的新瓶颈，</p>
<p>因为在 lvs-nat 中请求和响应报文都需要通过负载调度器。</p>
<p>lvs-dr优点是负载调度器可以处理大量的请求，因为调度器只处理客户到服</p>
<p>务器端的连接，响应数据可以直接从独立的网络路由返回给客户，这可以极大地</p>
<p>提高 LVS 集群系统的伸缩性。缺点是要求负载调度器与实际服务器都有一块网</p>
<p>卡连在同一物理网段上，服务器网络设备（或者设备别名）不作 ARP 响应，或</p>
<p>者能将报文重定向（Redirect）到本地的 Socket 端口上。</p>
<p>lvs-tun 的优点是负载调度器可以处理大量的请求，它甚至可以调度百台以</p>
<p>上的服务器（同等规模的服务器），而它不会成为系统的瓶颈，因为负载调度器</p>
<p>只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。</p>
<h3 id="LVS的调度算法"><a href="#LVS的调度算法" class="headerlink" title="LVS的调度算法"></a><strong>LVS的调度算法</strong></h3><p>轮训算法 加权轮训算法 最小连接算法 加权最下连接算法 …..</p>
<p>LVS Scheduling Method LVS的调度方法：</p>
<p><strong>1.Fixed Scheduling Method</strong>  静态调度方法</p>
<p>(1).<strong>RR</strong>         轮询</p>
<p>(2).<strong>WRR</strong>    加权轮询</p>
<p>(3).<strong>SH</strong>         源地址hash；实现session sticky，源IP地址hash；将来自于同一</p>
<p>个IP地址的请求始终发往第一次挑中的RS，从而实现会话绑定</p>
<p>(4).<strong>DH</strong>        目标地址hash；目标地址哈希，将发往同一个目标地址的请求始终转</p>
<p>发至第一次挑中的RS，典型使用场景是正向代理缓存场景中的负载均</p>
<p>衡，如：宽带运营商</p>
<p><strong>2.Dynamic Scheduling Method</strong> 动态调度方法</p>
<p>(1).<strong>LC</strong>         最少连接；适用于长连接应用</p>
<p>​          Overhead=activeconns*256+inactiveconns</p>
<p>(2).<strong>WLC</strong>    加权最少连接(默认调度方法)</p>
<p>  Overhead=(activeconns*256+inactiveconns)/weight </p>
<p>(3).<strong>SED</strong>      最少期望延迟</p>
<p>Overhead=(activeconns+1)*256/weight</p>
<p>(4).<strong>NQ</strong>       第一轮均匀分配，后续SED</p>
<p>(5).<strong>LBLC</strong>   基于本地的最少连接；动态的DH算法，使用场景：根据负载状态实现正向代理</p>
<p>(6).<strong>LBLCR</strong>  带复制的基于本地的最少连接；带复制功能的LBLC解决LBLC负载不均衡</p>
<p>问题，从负载重的复制到负载轻的RS</p>
<h2 id="四、ipvsadm命令"><a href="#四、ipvsadm命令" class="headerlink" title="四、ipvsadm命令"></a><strong>四、ipvsadm命令</strong></h2><p><strong>核心功能：</strong></p>
<p>集群服务管理：增、删、改</p>
<p>集群服务的RS管理：增、删、改</p>
<p><strong>查看</strong></p>
<p><strong>ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]] [-M netmask] [–pe</strong></p>
<p><strong>persistence_engine] [-b sched-flags]</strong></p>
<p>ipvsadm -D -t|u|f service-address 删除</p>
<p>ipvsadm –C 清空</p>
<p>ipvsadm –R 重载</p>
<p>ipvsadm -S [-n] 保存</p>
<p>ipvsadm -a|e -t|u|f service-address -r server-address [options]</p>
<p>ipvsadm -d -t|u|f service-address -r server-address</p>
<p>ipvsadm -L|l [options]</p>
<p>ipvsadm -Z [-t|u|f service-address]</p>
<p>管理集群服务：增、改、删</p>
<p>增、改：</p>
<p>ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]]</p>
<p>删除：</p>
<p>ipvsadm -D -t|u|f service-address</p>
<p>service-address：</p>
<p>-t|u|f：</p>
<p>-t: TCP协议的端口，VIP:TCP_PORT</p>
<p>-u: UDP协议的端口，VIP:UDP_PORT</p>
<p>-f：firewall MARK，标记，一个数字</p>
<p>[-s scheduler]：指定集群的调度算法，默认为wlc</p>
<p>管理集群上的RS：增、改、删</p>
<p>增、改：ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]</p>
<p>删：ipvsadm -d -t|u|f service-address -r server-address</p>
<p>server-address：</p>
<p>rip[:port] 如省略port，不作端口映射</p>
<p><strong>选项：</strong></p>
<p>lvs类型：</p>
<p>-g: gateway, dr类型，默认</p>
<p>-i: ipip, tun类型</p>
<p>-m: masquerade, nat类型</p>
<p>-w weight：权重</p>
<p>清空定义的所有内容：ipvsadm –C</p>
<p>清空计数器：ipvsadm -Z [-t|u|f service-address]</p>
<p>查看：<strong>ipvsadm -L|l [options]</strong></p>
<p>–numeric, -n：以数字形式输出地址和端口号</p>
<p>–exact：扩展信息，精确值</p>
<p>–connection，-c：当前IPVS连接输出</p>
<p>–stats：统计信息</p>
<p>–rate ：输出速率信息</p>
<p>ipvs规则： /proc/net/ip_vs</p>
<p>ipvs连接：/proc/net/ip_vs_conn</p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/30/防火墙技术(一)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/30/防火墙技术(一)/" itemprop="url">防火墙技术(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-30T16:18:20+08:00">
                2018-06-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>防火墙（Firewall），也称防护墙，是由Check Point创立者Gil Shwed于1993年发明并引入国际互联网。</p>
<p>它是一种工作在网络或主机边缘，对进出网络或主机的数据包基于一定的规则检查，并在匹配某规则时</p>
<p>由规则定义的行为进行处理的一组功能的组件，基本上的实现都是默认情况下关闭所有的通过型访问，</p>
<p>只开放允许访问的策略 </p>
<h2 id="一、防火墙介绍"><a href="#一、防火墙介绍" class="headerlink" title="一、防火墙介绍"></a><strong>一、防火墙介绍</strong></h2><h3 id="防火墙的分类"><a href="#防火墙的分类" class="headerlink" title="防火墙的分类"></a>防火墙的分类</h3><p>按防火墙<strong>服务范围</strong>可分为：</p>
<p><strong>主机防火墙：</strong>服务范围为当前主机</p>
<p><strong>网络防火墙：</strong>服务范围为防火墙一侧的局域网</p>
<p>按<strong>软硬件</strong>可分为：</p>
<p><strong>硬件防火墙：</strong>在专用硬件级别实现部分功能的防火墙；另一个部分功能基于软件</p>
<p>实现，Checkpoint, NetScreen</p>
<p><strong>软件防火墙：</strong>运行于通用硬件平台之上的防火墙的应用软件</p>
<p>按<strong>OSI模型</strong>可分为：</p>
<p><strong>网络层防火墙：</strong>OSI下面第三层</p>
<p><strong>应用层防火墙/代理服务器</strong>：代理网关，OSI七层</p>
<h3 id="Netfilter组件"><a href="#Netfilter组件" class="headerlink" title="Netfilter组件"></a><strong>Netfilter组件</strong></h3><p><strong>Netfilter是Linux 2.4内核防火墙框架，该框架既简洁又灵活，可实现安全策略应用中的许多功能，</strong></p>
<p><strong>如数据包过滤、数据包处理、地址伪装、透明代理、动态网络地址转换（NAT），</strong></p>
<p><strong>以及基于用户及媒体访问控制（MAC）地址的过滤和基于状态的过滤、包速率限制等。</strong></p>
<p><strong>特性：</strong></p>
<p>内核空间，集成在Linux内核中</p>
<p>扩展各种网络服务的结构化底层框架</p>
<p>内核中选取五个位置放了五个hook(勾子) function<strong>(INPUT、OUTPUT、FORWARD、</strong></p>
<p><strong>PREROUTING、POSTROUTING)</strong>，而这五个hook function向用户开放，用户可以通过一</p>
<p>个命令工具（iptables）向其写入规则</p>
<p>由信息过滤表（table）组成，包含控制IP包处理的规则集（rules），规则被分组放在链（chain）上</p>
<p><strong>三种报文流向：</strong></p>
<p>流入本机：PREROUTING –&gt; INPUT–&gt;用户空间进程</p>
<p>流出本机：用户空间进程 –&gt;OUTPUT–&gt; POSTROUTING</p>
<p>转发：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p>
<p><img src="timg_imagequality80sizeb9999_10000sec1530335045851di3ca9d674c9be44456c2a.jpg" alt="timg_image&amp;quality=80&amp;size=b9999_10000&amp;sec=1530335045851&amp;di=3ca9d674c9be44456c2a"></p>
<p><strong>iptables</strong>由四个表和五个链以及一些规则组成</p>
<p>四个表table：<strong>filter、nat、mangle、raw</strong></p>
<p><strong>filter表</strong>：过滤规则表，根据预定义的规则过滤符合条件的数据包</p>
<p><strong>nat表</strong>：network address translation 地址转换规则表</p>
<p><strong>mangle</strong>：修改数据标记位规则表</p>
<p><strong>raw</strong>：关闭NAT表上启用的连接跟踪机制，加快封包穿越防火墙速度</p>
<p>优先级由高到低的顺序为:<strong>raw–&gt;mangle–&gt;nat–&gt;filter</strong></p>
<p>五个内置链chain</p>
<p><strong>INPUT</strong></p>
<p><strong>OUTPUT</strong></p>
<p><strong>FORWARD</strong></p>
<p><strong>PREROUTING</strong></p>
<p><strong>POSTROUTING</strong></p>
<p><img src="表链结构.png" alt="表链结构"></p>
<h2 id="二、iptables工具"><a href="#二、iptables工具" class="headerlink" title="二、iptables工具"></a><strong>二、iptables工具</strong></h2><p><strong>格式：iptables [-t table] SUBCOMMAND chain [-m matchname [per-matchoptions]] -j</strong></p>
<p><strong>targetname</strong>  <strong>[per-target-options]</strong></p>
<p><strong>(1)table：</strong></p>
<p>​    raw, mangle, nat, [filter]默认</p>
<p><strong>(2)SUBCOMMAND：</strong></p>
<ol>
<li><p>链管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-N  new, 自定义一条新的规则链</span><br><span class="line">-X  delete，删除自定义的空的规则链</span><br><span class="line">-P  Policy，设置默认策略；对filter表中的链而言，</span><br><span class="line">其默认策略有: ACCEPT：接受</span><br><span class="line">             DROP：丢弃</span><br><span class="line">             REJECT：拒绝</span><br><span class="line">-E     重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-L        list, 列出指定鏈上的所有规则，本选项须置后</span><br><span class="line">-n        numberic，以数字格式显示地址和端口号</span><br><span class="line">-v        verbose，详细信息</span><br><span class="line">-vv      更详细</span><br><span class="line">-x        exactly，显示计数器结果的精确值,而非单位转换后的易读值</span><br><span class="line">–line-numbers        显示规则的序号</span><br></pre></td></tr></table></figure>
<p>常用组合：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-vnL</span><br><span class="line">–vvnxL –line-numbers</span><br><span class="line">-S selected,以iptables-save          命令格式显示链上规则</span><br></pre></td></tr></table></figure>
</li>
<li><p>规则管理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-A：append，追加</span><br><span class="line">-I：insert, 插入，要指明插入至的规则编号，默认为第一条</span><br><span class="line">-D：delete，删除</span><br><span class="line">    (1) 指明规则序号</span><br><span class="line">    (2) 指明规则本身</span><br><span class="line">-R：replace，替换指定链上的指定规则编号</span><br><span class="line">-F：flush，清空指定的规则链</span><br><span class="line">-Z：zero，置零</span><br><span class="line">iptables的每条规则都有两个计数器</span><br><span class="line">    (1) 匹配到的报文的个数</span><br><span class="line">    (2) 匹配到的所有报文的大小之和</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>(3)扩展匹配条件</strong></p>
<p>​    扩展匹配条件：需要加载扩展模块（/usr/lib64/xtables/*.so），方可生效</p>
<p>​    查看帮助 man iptables-extensions</p>
<p>​    扩展匹配分为隐性扩展和显性扩展两种</p>
<p><strong>隐性扩展：</strong>不需要写模块名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>显性扩展：</strong>必须指定模块名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如：iptables -A INPUT -p tcp -m multiport –dports 21,80,445 -j REJECT</span><br></pre></td></tr></table></figure>
<p><strong>(4)处理动作：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-j targetname [per-target-options]</span><br></pre></td></tr></table></figure>
<p>简单：    <strong>ACCEPT，DROP</strong></p>
<p>扩展：    <strong>REJECT：–reject-with:icmp-port-unreachable</strong>默认</p>
<p>RETURN：返回调用链</p>
<p>REDIRECT：端口重定向</p>
<p>LOG：记录日志，dmesg</p>
<p>MARK：做防火墙标记</p>
<p>DNAT：目标地址转换</p>
<p>SNAT：源地址转换</p>
<p>MASQUERADE：地址伪装</p>
<p>…</p>
<p>自定义链：</p>
<h2 id="三、iptables基本命令使用举例"><a href="#三、iptables基本命令使用举例" class="headerlink" title="三、iptables基本命令使用举例"></a><strong>三、iptables基本命令使用举例</strong></h2><h3 id="一-链及NAT的基本操作"><a href="#一-链及NAT的基本操作" class="headerlink" title="(一)链及NAT的基本操作"></a><strong>(一)链及NAT的基本操作</strong></h3><ol>
<li><p>清除所有的规则。</p>
<p>1）清除预设表filter中所有规则链中的规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure>
<p>2）清除预设表filter中使用者自定链中的规则。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br></pre></td></tr></table></figure>
<p>3)清楚NAT表规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F -t nat</span><br></pre></td></tr></table></figure>
<p>4)NAT表的显示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -nL</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置链的默认策略。一般有两种方法。</p>
<p>1）首先允许所有的包，然后再禁止有危险的包通过放火墙。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT ACCEPT</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure>
<p>2）首先禁止所有的包，然后根据需要的服务允许特定的包通过防火墙。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure>
</li>
<li><p>列出表/链中的所有规则。默认只列出filter表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L</span><br></pre></td></tr></table></figure>
</li>
<li><p>向链中添加规则。下面的语句用于开放网络接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -o lo -j ACCEPT</span><br><span class="line">iptables -A INPUT -i eth0 -j ACEPT</span><br><span class="line">iptables -A OUTPUT -o eth1 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -i eth1 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -0 eth1 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>注意:由于本地进程不会经过FORWARD链，因此回环接口lo只在INPUT和OUTPUT两个链上作用。</p>
</li>
<li><p>使用者自定义链。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -N custom</span><br><span class="line">iptables -A custom -s 0/0 -d 0/0 -p icmp -j DROP</span><br><span class="line">iptables -A INPUT -s 0/0 -d 0/0 -j DROP</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="二-设置基本的规则匹配"><a href="#二-设置基本的规则匹配" class="headerlink" title="(二)设置基本的规则匹配"></a><strong>(二)设置基本的规则匹配</strong></h3><ol>
<li><p>指定协议匹配。</p>
<p>1）匹配指定协议。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp</span><br></pre></td></tr></table></figure>
<pre><code>2）匹配指定协议之外的所有协议。

       <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p !tcp</span><br></pre></td></tr></table></figure>
</code></pre></li>
<li><p>指定地址匹配。</p>
<p>1）指定匹配的主机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 192.168.0.18</span><br></pre></td></tr></table></figure>
<p>2）指定匹配的网络。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -s 192.168.2.0/24</span><br></pre></td></tr></table></figure>
<p>3）匹配指定主机之外的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s !192.168.0.19</span><br></pre></td></tr></table></figure>
<pre><code>4）匹配指定网络之外的网络。
</code></pre></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -s ! 192.168.3.0/24</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><p>指定网络接口匹配。</p>
<p>1）指定单一的网络接口匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i eth0</span><br><span class="line">iptables -A FORWARD -o eth0</span><br></pre></td></tr></table></figure>
<p>2）指定同类型的网络接口匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -o ppp+</span><br></pre></td></tr></table></figure>
</li>
<li><p>指定端口匹配。</p>
<p>1）指定单一端口匹配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp –sport www</span><br><span class="line">iptables -A INPUT -p udp –dport 53</span><br></pre></td></tr></table></figure>
<pre><code>2）匹配指定端口之外的端口。

             <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp –dport !22</span><br></pre></td></tr></table></figure>

3）匹配端口范围。
</code></pre></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp –sport 22:80</span><br></pre></td></tr></table></figure>
<p>​    4）匹配ICMP端口和ICMP类型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INOUT -p icmp –icimp-type 8</span><br></pre></td></tr></table></figure>
<p>​    5）指定ip碎片。</p>
<p>​    每个网络接口都有一个MTU（最大传输单元），这个参数定义了可以通过的数据包的最大尺寸。</p>
<p>​    如果一个    数据包大于这个参数值时，系统会将其划分成更小的数据包称为ip碎片）来传输，</p>
<p>​    而接受方则对这些ip碎片再进行重组以还原整个包。</p>
<p>​    这样会导致一个问题：当系统将大数据包划分成ip碎片传输时，第一个碎片含有完整的包头信息</p>
<p>（IP+TCP、UDP和ICMP），但是后续的碎片只有包头的部分信息（如源地址、目的地址）。 </p>
<p>​    因此，检查后面的ip碎片的头部（象有TCP、UDP和ICMP一样）是不可能的。假如有这样的一条</p>
<p><strong>规则：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -p tcp -s 192.168.1.0/24 -d 192.168.2.100 –dport 80 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>并且这时的FORWARD的policy为DROP时，系统只会让第一个ip碎片通过，而余下的碎片因为包头信息不</p>
<p>完整而无法通过。可以通过—fragment/-f 选项来指定第二个及以后的ip碎片解决上述问题。</p>
<p>#iptables -A FORWARD -f -s 192.168.1.0/24 -d 192.168.2.100 -j ACCEPT</p>
<p>注意现在有许多进行ip碎片<em>的实例，如DoS</em>，因此允许ip碎片通过是有安全隐患的，对于这一点可以</p>
<p>采用iptables的匹配扩展来进行限制。</p>
<h3 id="三-设置扩展的规则匹配（举例已忽略目标动作）"><a href="#三-设置扩展的规则匹配（举例已忽略目标动作）" class="headerlink" title="(三)设置扩展的规则匹配（举例已忽略目标动作）"></a><strong>(三)设置扩展的规则匹配（举例已忽略目标动作）</strong></h3><p>1、多端口匹配。</p>
<p>1）匹配多个源端口。</p>
<p>#iptables -A INPUT -p tcp -m multiport –sport 22,53,80,110</p>
<p>2）匹配多个目的端口。</p>
<p>#iptables -A INPUT -p tcp -m multiport –dpoort 22,53,80</p>
<p>3）匹配多端口(无论是源端口还是目的端口）</p>
<p>#iptables -A INPUT -p tcp -m multiport –port 22,53,80,110</p>
<p>2、指定TCP匹配扩展</p>
<p>使用 –tcp-flags 选项可以根据tcp包的标志位进行过滤。</p>
<p>#iptables -A INPUT -p tcp –tcp-flags SYN,FIN,ACK SYN</p>
<p>#iptables -A FROWARD -p tcp –tcp-flags ALL SYN,ACK</p>
<p>上实例中第一个表示SYN、ACK、FIN的标志都检查，但是只有SYN匹配。第二个表示ALL（SYN，</p>
<p>ACK，FIN，RST，URG，PSH）的标志都检查，但是只有设置了SYN和ACK的匹配。</p>
<p>#iptables -A FORWARD -p tcp –syn</p>
<p>选项—syn相当于”–tcp-flags SYN,RST,ACK SYN”的简写。</p>
<p>3、limit速率匹配扩展。</p>
<p>1）指定单位时间内允许通过的数据包个数，单位时间可以是/second、/minute、/hour、/day或使用第一个子母。</p>
<p>#iptables -A INPUT -m limit –limit 300/hour</p>
<p>2 )指定触发事件的阀值。</p>
<p>#iptables -A INPUT -m limit –limit-burst 10</p>
<p>用来比对一次同时涌入的封包是否超过10个，超过此上限的包将直接丢弃。</p>
<p>3）同时指定速率限制和触发阀值。</p>
<p>#iptables -A INPUT -p icmp -m limit –-limit 3/m –limit-burst 3</p>
<p>表示每分钟允许的最大包数量为限制速率（本例为3）加上当前的触发阀值burst数。任何情况下，都可保</p>
<p>证3个数据包通过，触发阀值burst相当于允许额外的包数量。</p>
<p>4、基于状态的匹配扩展（连接跟踪）</p>
<p>每个网络连接包括以下信息：源地址、目标地址、源端口、目的端口，称为套接字对（socket pairs）；协</p>
<p>议类型、连接状态（TCP协议）</p>
<p>和超时时间等。防火墙把这些信息称为状态（stateful）。状态包过滤防火墙能在内存中维护一个跟踪状态</p>
<p>的表，比简单包过滤防火墙具有更大的安全性，命令格式如下：</p>
<p>iptables -m state –-state [!]state [,state,state,state]</p>
<p>其中，state表是一个逗号分割的列表，用来指定连接状态，4种：</p>
<p><strong>&gt;NEW：</strong>该包想要开始一个新的连接（重新连接或连接重定向）</p>
<p><strong>&gt;RELATED：</strong>该包是属于某个已经建立的连接所建立的新连接。举例：</p>
<p>FTP的数据传输连接和控制连接之间就是RELATED关系。</p>
<p><strong>&gt;ESTABLISHED：</strong>该包属于某个已经建立的连接。</p>
<p><strong>&gt;INVALID：</strong>该包不匹配于任何连接，通常这些包被DROP。</p>
<p><strong>&gt;UNTRACKED：</strong>未进行追踪的连接，如raw表中关闭追踪</p>
<p><strong>示例：</strong></p>
<p>iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport –dports 22,80 -m state —</p>
<p>state NEW,ESTABLISHED -j ACCEPT</p>
<p>iptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport –sports 22,80 -m state —</p>
<p>state ESTABLISHED -j ACCEPT</p>
<p>已经追踪到的并记录下来的连接信息库</p>
<p><strong>/proc/net/nf_conntrack</strong></p>
<p>调整连接追踪功能所能够容纳的最大连接数量</p>
<p><strong>/proc/sys/net/nf_conntrack_max</strong></p>
<p>不同的协议的连接追踪时长</p>
<p><strong>/proc/sys/net/netfilter/</strong></p>
<p>注意：CentOS7 需要加载模块： <strong>modprobe nf_conntrack</strong></p>
<h3 id="开放被动模式的ftp服务"><a href="#开放被动模式的ftp服务" class="headerlink" title="开放被动模式的ftp服务"></a><strong>开放被动模式的ftp服务</strong></h3><ol>
<li>装载ftp连接追踪的专用模块：</li>
</ol>
<p>跟踪模块路径：/lib/modules/kernelversion/kernel/net/netfilter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/iptables-config </span><br><span class="line">    IPTABLES_MODULES=“nf_conntrack_ftp”</span><br><span class="line">    modproble nf_conntrack_ftp</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>放行请求报文：</li>
</ol>
<p>命令连接：NEW, ESTABLISHED</p>
<p>数据连接：RELATED, ESTABLISHED</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables –I INPUT -d LocalIP -p tcp -m state –state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -A INPUT -d LocalIP -p tcp –dport 21 -m state –state NEW -j ACCEPT</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>放行响应报文：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I OUTPUT -s LocalIP -p tcp -m state –state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure>
<p><strong>开放被动模式的ftp服务示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install vsftpd</span><br><span class="line">systemctl start vsftpd</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -F</span><br><span class="line">iptables -A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp –dport 21 -m state –state NEW -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -m state –state ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables –vnL</span><br></pre></td></tr></table></figure>
<h3 id="iptable防火墙优化原则"><a href="#iptable防火墙优化原则" class="headerlink" title="iptable防火墙优化原则"></a><strong>iptable防火墙优化原则</strong></h3><p>任何不允许的访问，应该在请求到达时给予拒绝</p>
<p>规则在链接上的次序即为其检查时的生效次序</p>
<p>基于上述，规则优化</p>
<p>1 安全放行所有入站和出站的状态为ESTABLISHED状态连接</p>
<p>2 谨慎放行入站的新请求</p>
<p>3 有特殊目的限制访问功能，要在放行规则之前加以拒绝</p>
<p>4 同类规则（访问同一应用），匹配范围小的放在前面，用于特殊处理</p>
<p>5 不同类的规则（访问不同应用），匹配范围大的放在前面</p>
<p>6 应该将那些可由一条规则能够描述的多个规则合并为一条</p>
<p>7 设置默认策略，建议白名单（只放行特定连接）</p>
<p>1） iptables -P，不建议</p>
<p>2） 建议在规则的最后定义规则做为默认策略</p>
<p>## </p>
<h2 id="四、NAT地址转换"><a href="#四、NAT地址转换" class="headerlink" title="四、NAT地址转换"></a><strong>四、NAT地址转换</strong></h2><p><strong>NAT：network address translation</strong></p>
<p>PREROUTING，INPUT，OUTPUT，POSTROUTING</p>
<p><strong>请求报文：</strong>修改源/目标IP，由定义如何修改</p>
<p><strong>响应报文</strong>：修改源/目标IP，根据跟踪机制自动实现</p>
<p><strong>SNAT：source NAT POSTROUTING, INPUT</strong></p>
<p>让本地网络中的主机通过某一特定地址访问外部网络，实现地址伪装</p>
<p><strong>请求报文：</strong>修改源IP</p>
<p><strong>典型应用场景：</strong>多个PC机使用ADSL路由器共享上网，每个PC机都配置了内网IP，PC机访问</p>
<p>外部网络的时候，路由器将数据包的报头中的源地址替换成路由器的ip，当外部网络的服</p>
<p>务器比如网站web服务器接到访问请求的时候，他的日志记录下来的是路由器的ip地址，而</p>
<p>不是pc机的内网ip；这是因为，这个服务器收到的数据包的报头里边的“源地址”，已经</p>
<p>被替换了所以叫做SNAT，基于源地址的地址转换。</p>
<p><strong>DNAT：destination NAT PREROUTING , OUTPUT</strong></p>
<p>把本地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，</p>
<p>但隐藏真实IP</p>
<p><strong>请求报文：</strong>修改目标IP</p>
<p><strong>典型应用场景：</strong>比如有web服务器放在内网配置内网ip，前端有个防火墙配置公网ip，互联</p>
<p>网上的访问者使用公网ip来访问这个网站当访问的时候，客户端发出一个数据包，这个数据</p>
<p>包的报头里边，目标地址写的是防火墙的公网ip，防火墙会把这个数据包的报头改写一次，</p>
<p>将目标地址改写成web服务器的内网ip，然后再把这个数据包发送到内网的web服务器上，这</p>
<p>样，数据包就穿透了防火墙，并从公网ip变成了一个对内网地址的访问了，即DNAT，基于目</p>
<p>标的网络地址转换。</p>
<p><strong>PNAT：port nat，</strong>端口和IP都进行修改</p>
<p><strong>SNAT：固定IP</strong></p>
<p>–to-source [ipaddr[-ipaddr]][:port[-port]]</p>
<p>–random</p>
<p>iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT –tosource ExtIP</p>
<p>示例：</p>
<p>iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! –d 10.0.1.0/24 -j SNAT —</p>
<p>to-source 172.18.1.6-172.18.1.9</p>
<p><strong>SNAT：动态IP</strong></p>
<p>MASQUERADE：地址伪装</p>
<p>如此配置的话，不用指定SNAT的目标ip了，不管现在网卡的出口获得了怎样的动态ip，</p>
<p>MASQUERADE会自动读取网卡现在的ip地址然后做SNAT出去，这样就实现了很好的动态</p>
<p>SNAT地址转换。</p>
<p>–to-ports port[-port]</p>
<p>–random</p>
<p>iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j  MASQUERADE</p>
<p><strong>示例：</strong></p>
<p>iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! –d 10.0.1.0/24 -j</p>
<p>MASQUERADE</p>
<h3 id="如何区分SNAT和DNAT"><a href="#如何区分SNAT和DNAT" class="headerlink" title="如何区分SNAT和DNAT"></a><strong>如何区分SNAT和DNAT</strong></h3><p>从定义来讲它们一个是源地址转换，一个是目标地址转换。都是地址转换的功能，将私有地</p>
<p>址转换为公网地址。</p>
<p>要区分这两个功能可以简单的由连接发起者是谁来区分：</p>
<p>内部地址要访问公网上的服务时（如web访问），内部地址会主动发起连接，由路由器或者</p>
<p>防火墙上的网关对内部地址做个地址转换，将内部地址的私有IP转换为公网的公有IP，网</p>
<p>关的这个地址转换称为SNAT，主要用于内部共享IP访问外部。</p>
<p>当内部需要提供对外服务时（如对外发布web网站），外部地址发起主动连接，由路由器或</p>
<p>者防火墙上的网关接收这个连接，然后将连接转换到内部，此过程是由带有公网IP的网关替</p>
<p>代内部服务来接收外部的连接，然后在内部做地址转换，此转换称为DNAT，主要用于内部服</p>
<p>务对外发布。</p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/29/SAMBA服务介绍及相关实验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/29/SAMBA服务介绍及相关实验/" itemprop="url">SAMBA服务介绍及相关实验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-29T16:15:07+08:00">
                2018-06-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、SAMBA介绍"><a href="#一、SAMBA介绍" class="headerlink" title="一、SAMBA介绍"></a><strong>一、SAMBA介绍</strong></h2><p><strong>Samba</strong>是在Linux和UNIX系统上实现SMB协议的一个免费软件，由服务器及客户端程序构成。</p>
<p><strong>SMB：Server Messages Block，信息服务块，</strong>是一种在局域网上共享文件和打印机的一种通信协议，</p>
<p>它为局域网内的不同计算机之间提供文件及打印机等资源的共享服务。</p>
<p><strong>CIFS：common internet file system，</strong>微软基于SMB发布，CIFS是公共的或开放的SMB协议版本，</p>
<p>并由Microsoft使用。像SMB协议一样，CIFS在高层运行，而不像TCP/IP协议那样运行在底层。</p>
<p>CIFS可以看做是应用程序协议如文件传输协议和超文本传输协议的一个实现。</p>
<h3 id="SAMBA的功能："><a href="#SAMBA的功能：" class="headerlink" title="SAMBA的功能："></a><strong>SAMBA的功能：</strong></h3><p>共享文件和打印，实现在线编辑</p>
<p>实现登录SAMBA用户的身份认证</p>
<p>可以进行NetBIOS名称解析</p>
<p>外围设备共享</p>
<h3 id="计算机网络管理模式："><a href="#计算机网络管理模式：" class="headerlink" title="计算机网络管理模式："></a><strong>计算机网络管理模式：</strong></h3><p>工作组 <strong>WORKGROUP</strong>：计算机对等关系，帐号信息各自管理</p>
<p>域 <strong>DOMAIN</strong>： C/S结构，帐号信息集中管理，DC,AD</p>
<h3 id="相关包："><a href="#相关包：" class="headerlink" title="相关包："></a><strong>相关包：</strong></h3><p>​    Samba                         提供smb服务</p>
<p>​    Samba-client              客户端软件</p>
<p>​    samba-common         通用软件</p>
<p>​    cifs-utils smb              客户端工具</p>
<p>​    samba-winbind          和AD相关</p>
<h3 id="相关服务进程："><a href="#相关服务进程：" class="headerlink" title="相关服务进程："></a><strong>相关服务进程：</strong></h3><p>​    smbd 提供smb（cifs）服务 <strong>TCP:139,445</strong></p>
<p>​    nmbd NetBIOS名称解析      <strong>UDP:137,138</strong></p>
<h3 id="主配置文件："><a href="#主配置文件：" class="headerlink" title="主配置文件："></a><strong>主配置文件：</strong></h3><p><strong>/etc/samba/smb.conf</strong></p>
<p>帮助参看：man smb.conf</p>
<p>语法检查：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testparm [-v][/etc/samba/smb.conf]</span><br></pre></td></tr></table></figure>
<p>客户端工具：smbclient,mount.cifs</p>
<h2 id="二、SAMBA服务配置"><a href="#二、SAMBA服务配置" class="headerlink" title="二、SAMBA服务配置"></a><strong>二、SAMBA服务配置</strong></h2><p>smb.conf继承了.ini文件的格式，用[ ]分成不同的部分</p>
<p><strong>全局设置：</strong></p>
<p>​    [global]             服务器通用或全局设置的部分</p>
<p><strong>特定共享设置：</strong></p>
<p>​    [homes]           用户的家目录共享</p>
<p>​    [printers]        定义打印机资源和服务</p>
<p>​    [sharename]  自定义的共享目录配置</p>
<p>其中：#和;开头的语句为注释，大小写不敏感</p>
<p><strong>宏定义：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%m 客户端主机的NetBIOS名</span><br><span class="line"></span><br><span class="line">%M 客户端主机的FQDN</span><br><span class="line"></span><br><span class="line">%H 当前用户家目录路径</span><br><span class="line"></span><br><span class="line">%U 当前用户用户名</span><br><span class="line"></span><br><span class="line">%g 当前用户所属组</span><br><span class="line"></span><br><span class="line">%h samba服务器的主机名</span><br><span class="line"></span><br><span class="line">%L samba服务器的NetBIOS名</span><br><span class="line"></span><br><span class="line">%I 客户端主机的IP</span><br><span class="line"></span><br><span class="line">%T 当前日期和时间</span><br><span class="line"></span><br><span class="line">%S 可登录的用户名</span><br></pre></td></tr></table></figure>
<p><strong>workgroup</strong>              指定工作组名称</p>
<p><strong>server string</strong>          主机注释信息</p>
<p><strong>netbios name</strong>         指定NetBIOS名</p>
<p><strong>interfaces</strong>               指定服务侦听接口和IP</p>
<p><strong>hosts allow</strong>             可用“,” ，空格，或tab分隔，默认允许所有主机访问，也可在每个共享独立配置，</p>
<p>如在[global]设置，将应用并覆盖所有共享设置</p>
<p>​    IPv4 network/prefix：172.25.0.0/24 IPv4前缀: 172.25.0.</p>
<p>​    IPv4 network/netmask：172.25.0.0/255.255.255.0</p>
<p>​    主机名：desktop.example.com</p>
<p>​    以example.com后缀的主机名：.example.com</p>
<p><strong>示例：</strong></p>
<p>​    hosts allow = 172.25.</p>
<p>​    hosts allow = 172.25. .example.com</p>
<p><strong>hosts deny</strong>      拒绝指定主机访问</p>
<p>config file=/etc/samba/conf.d/%U      用户独立的配置文件</p>
<p>Log file=/var/log/samba/log.%m 不同客户机采用不同日志</p>
<p>max log size=50 日志文件达到50K，将轮循rotate,单位KB</p>
<p><strong>Security三种认证方式：</strong></p>
<p>​    <strong>share：</strong>匿名(CentOS7不再支持)</p>
<p>​    <strong>user：</strong>samba用户（采有linux用户，samba的独立口令）</p>
<p>​    <strong>domain：</strong>使用DC（DOMAIN CONTROLLER)认证</p>
<p><strong>passdb backend = tdbsam</strong>              密码数据库格式</p>
<p> <strong>实现samba用户：</strong><br>    包：samba-common-tools<br>    工具：smbpasswd pdbedit<br>    samba用户须是Linux用户，建议使用/sbin/nologin</p>
<h3 id="配置samba日志"><a href="#配置samba日志" class="headerlink" title="配置samba日志"></a><strong>配置samba日志</strong></h3><p>默认不记录</p>
<p>以IP方式记录日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log file = /var/log/samba/log.%I</span><br><span class="line">log level = 2</span><br></pre></td></tr></table></figure>
<p><img src="日志.png" alt="日志"></p>
<p>日志文件达到50K，将轮循rotate,单位KB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max log size=50</span><br></pre></td></tr></table></figure>
<h3 id="配置目录共享"><a href="#配置目录共享" class="headerlink" title="配置目录共享"></a><strong>配置目录共享</strong></h3><p><strong>[共享名称]</strong>             远程网络看到的共享名称</p>
<p>comment                 注释信息</p>
<p>path                          所共享的目录路径</p>
<p>public                       能否被guest访问的共享，默认no，和guest ok 类似</p>
<p>browsable                是否允许所有用户浏览此共享,默认为yes,no为隐藏</p>
<p>writable=yes           可以被所有用户读写，默认为no</p>
<p>read only=no           和writable=yes等价，如与以上设置冲突，放在后面的设置生效，默认只读</p>
<p>write list                  三种形式：用户，@组名，+组名,用，分隔如writable=no，列表中用户或组可读写，不在列表中用户只读</p>
<p>valid users              特定用户才能访问该共享，如为空，将允许所有用户，用户名之间用空格分隔</p>
<p><strong>备注：</strong>每个共享目录应该有独立的[ ]部分</p>
<h2 id="三、SMABA用户管理与挂载"><a href="#三、SMABA用户管理与挂载" class="headerlink" title="三、SMABA用户管理与挂载"></a><strong>三、SMABA用户管理与挂载</strong></h2><h3 id="管理samba用户"><a href="#管理samba用户" class="headerlink" title="管理samba用户"></a><strong>管理samba用户</strong></h3><p>实现samba用户</p>
<p>包：samba-common-tools</p>
<p>工具：smbpasswd pdbedit</p>
<p>samba用户须是Linux用户，建议使用/sbin/nologin</p>
<p>### </p>
<p>添加samba用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd -a &lt;user&gt;</span><br><span class="line">pdbedit -a -u &lt;user&gt;</span><br></pre></td></tr></table></figure>
<p>修改用户密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd &lt;user&gt;</span><br></pre></td></tr></table></figure>
<p>删除用户和密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd –x &lt;user&gt;</span><br><span class="line">pdbedit –x –u &lt;user&gt;</span><br></pre></td></tr></table></figure>
<p>查看samba用户列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/samba/private/passdb.tdb</span><br><span class="line">pdbedit –L –v</span><br></pre></td></tr></table></figure>
<p> 查看samba服务器状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbstatus</span><br></pre></td></tr></table></figure>
<h3 id="挂载CIFS文件系统"><a href="#挂载CIFS文件系统" class="headerlink" title="挂载CIFS文件系统"></a><strong>挂载CIFS文件系统</strong></h3><p>手动挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t cifs -o user=wang,password=wxlinux //server//shared</span><br><span class="line">/mnt/smb</span><br></pre></td></tr></table></figure>
<p>开机自动挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/fstab 可以用文件代替用户名和密码的输入</span><br><span class="line">//server/homes /mnt cifs credentials=/etc/smb.txt 0 0</span><br><span class="line">cat /etc/smb.txt</span><br><span class="line">username=wang</span><br><span class="line">password=password</span><br><span class="line">chmod 600 /etc/smb.txt</span><br></pre></td></tr></table></figure>
<h2 id="四、实验：将Linux作为SAMBA客户端访问Windows共享文件"><a href="#四、实验：将Linux作为SAMBA客户端访问Windows共享文件" class="headerlink" title="四、实验：将Linux作为SAMBA客户端访问Windows共享文件"></a><strong>四、实验：将Linux作为SAMBA客户端访问Windows共享文件</strong></h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a>前期准备：</h3><p>Window系统版本为 win10</p>
<p>Linux系统版本为 CentOS 7.4</p>
<p>Windows系统中共享目录如下：</p>
<p><img src="1-49.png" alt="1"></p>
<p>在Windows系统中创建一个test用户(必须以管理员身份创建)</p>
<p><img src="lazy.png" alt="2"></p>
<h3 id="Linux系统："><a href="#Linux系统：" class="headerlink" title="Linux系统："></a><strong>Linux系统：</strong></h3><p>安装samba-client包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install samba-client</span><br></pre></td></tr></table></figure>
<p>查看Windows系统上的共资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient -L 192.168.30.1 -U test%123</span><br></pre></td></tr></table></figure>
<p><img src="http://www.178linux.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" alt="3"></p>
<p>连接Windows系统上的共享资源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //192.168.30.1/lamp -U test%123</span><br></pre></td></tr></table></figure>
<p><img src="4-35.png" alt="4"></p>
<p>挂载windows共享目录到/mnt/win目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /mnt/win</span><br><span class="line"></span><br><span class="line">mount -o username=test,password=123,vers=3.0  //192.168.30.1/lamp /mnt/win</span><br></pre></td></tr></table></figure>
<p>也可写入<strong>/etc/fstab</strong>文件中永久挂载，为了防止明文用户名密码，可用下面写法，将用户和账号保存在一个文件中</p>
<p><img src="5-30.png" alt="5"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/user.txt</span><br><span class="line">    username=test</span><br><span class="line">    password=123</span><br></pre></td></tr></table></figure>
<h2 id="五、实验：Linux系统作为SAMBA服务器端"><a href="#五、实验：Linux系统作为SAMBA服务器端" class="headerlink" title="五、实验：Linux系统作为SAMBA服务器端"></a><strong>五、实验：Linux系统作为SAMBA服务器端</strong></h2><p>在LINUX系统中创建SAMBA账号需要先创建LINUX账号在使用smbpasswd命令转换为samba账号</p>
<p>创建linux账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin smb1</span><br><span class="line">useradd -s /sbin/nologin smb2</span><br><span class="line">useradd -s /sbin/nologin smb3</span><br></pre></td></tr></table></figure>
<p>将linux账号变为samba账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd -a smb1</span><br><span class="line">smbpasswd -a smb2</span><br><span class="line">smbpasswd -a smb3</span><br></pre></td></tr></table></figure>
<p>删除samba账号可使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd –x</span><br></pre></td></tr></table></figure>
<p>修改samba账号密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbpasswd user</span><br></pre></td></tr></table></figure>
<p>查看已有的samba账号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pdbedit -L</span><br></pre></td></tr></table></figure>
<p><img src="1-50.png" alt="1"></p>
<p>开启smb服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start smb</span><br></pre></td></tr></table></figure>
<p>切换客户端进行测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="2-47.png" alt="2"></p>
<p>默认以samba用户的家目录作为共享目录</p>
<p>也可在Window作为访问端连接SAMBA服务器</p>
<p><img src="3-46.png" alt="3"></p>
<h2 id="六、实验：SAMBA共享指定目录"><a href="#六、实验：SAMBA共享指定目录" class="headerlink" title="六、实验：SAMBA共享指定目录"></a><strong>六、实验：SAMBA共享指定目录</strong></h2><p>添加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim etc/samba/sam.conf</span><br><span class="line">    [share]</span><br><span class="line">    comment=smba share dir</span><br><span class="line">    path=/data/tools</span><br><span class="line">    read only=no            # 等价于writeabe=yes</span><br><span class="line">    public=no               # 是否允许匿名访问，默认为NO</span><br><span class="line">    valid users=smb1 smb2   # 指定有效用户，其他用户不可访问</span><br><span class="line">    \#valid users=+staff    # 也可指定有效组，用户多时建议用组管理</span><br><span class="line">    \#wirte list            # 指定列表中用户可写，需配合read only=yes</span><br></pre></td></tr></table></figure>
<p><img src="1-51.png" alt="1"></p>
<p>smbclient //192.168.30.10/share -U smb1%centos</p>
<p><img src="2-49.png" alt="2"></p>
<p>smb3用户由于没有授权，所有拒绝登录</p>
<p><img src="3-47.png" alt="3"></p>
<h2 id="七、实验：针对不同的用户设置不同的共享目录和权限"><a href="#七、实验：针对不同的用户设置不同的共享目录和权限" class="headerlink" title="七、实验：针对不同的用户设置不同的共享目录和权限"></a><strong>七、实验：针对不同的用户设置不同的共享目录和权限</strong></h2><h3 id="SAMBA服务器端"><a href="#SAMBA服务器端" class="headerlink" title="SAMBA服务器端:"></a>SAMBA服务器端:</h3><p>目前已存在的SAMBA用户</p>
<p><img src="1-52.png" alt="1"></p>
<p>配置文件中加上此行，指定配置目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim etc/samba/sam.conf</span><br><span class="line">    [global]</span><br><span class="line">    config file = /etc/samba/conf.d/%U</span><br></pre></td></tr></table></figure>
<p><img src="http://www.178linux.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" alt="2"></p>
<p>创建SAMBA共享目录和测试文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/smb2</span><br><span class="line">mkdir /data/smb3</span><br><span class="line">touch /data/smb2/test2</span><br><span class="line">touch /data/smb3/test3</span><br></pre></td></tr></table></figure>
<p>创建SAMBA配置目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/samba/conf.d/</span><br><span class="line">cd /etc/samba/conf.d/</span><br><span class="line">vim smb2</span><br><span class="line">    [share]</span><br><span class="line">    path=/data/smb2</span><br><span class="line">    writeable=yes</span><br><span class="line">vim smb3</span><br><span class="line">    [share]</span><br><span class="line">    path=/data/smb3</span><br></pre></td></tr></table></figure>
<p>给data目录添加777权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 777 /data/</span><br></pre></td></tr></table></figure>
<p>重启smb服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemct restart smb</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<p>使用samb2用户登录，共享目录为/data/smb2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //192.168.30.7/share -U smb2%centos</span><br></pre></td></tr></table></figure>
<p><img src="3-48.png" alt="3"></p>
<p>使用samb2用户登录，共享目录为/data/smb3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //192.168.30.7/share -U smb3%centos</span><br></pre></td></tr></table></figure>
<p><img src="http://www.178linux.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" alt="4"></p>
<h2 id="八、实验：实现多用户SAMBA挂载-仅CentOS-7支持，RHCE"><a href="#八、实验：实现多用户SAMBA挂载-仅CentOS-7支持，RHCE" class="headerlink" title="八、实验：实现多用户SAMBA挂载(仅CentOS 7支持，RHCE)"></a><strong>八、实验：实现多用户SAMBA挂载(仅CentOS 7支持，RHCE)</strong></h2><h3 id="SAMBA服务器端："><a href="#SAMBA服务器端：" class="headerlink" title="SAMBA服务器端："></a><strong>SAMBA服务器端：</strong></h3><p>目前已有四个samba账号，smb1，smb2，smb3，smb4</p>
<p><img src="1-53.png" alt="1"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/samba/</span><br><span class="line">[share]</span><br><span class="line">    comment = samba share dir</span><br><span class="line">    path = /data/tools</span><br><span class="line">    read only = yes</span><br><span class="line">    valid users = smb1 smb2 smb3 smbshare</span><br><span class="line">    write list = smb1 smb3</span><br></pre></td></tr></table></figure>
<p><img src="2-51.png" alt="2"></p>
<p>添加/data/tools目录读写权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 /data/tools</span><br></pre></td></tr></table></figure>
<p>重启smb服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart smb</span><br></pre></td></tr></table></figure>
<h3 id="客户端："><a href="#客户端：" class="headerlink" title="客户端："></a><strong>客户端：</strong></h3><p>必须建立同名用户，UID可以不一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">useradd smb1</span><br><span class="line">useradd smb2</span><br><span class="line">useradd smb3</span><br></pre></td></tr></table></figure>
<p>用smbshare用户挂载share目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o username=smbshare,password=centos,multiuser //192.168.30.10/share /mnt</span><br></pre></td></tr></table></figure>
<p>若要永久挂载，可修改<strong>/etc/fstab</strong>目录</p>
<p><img src="3-49.png" alt="3"></p>
<p>备注：SELinux环境下还需：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chcon -R -t samba_share_t /data/to</span><br></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su – smb1</span><br></pre></td></tr></table></figure>
<p>验证SAMBA服务器是否有同名用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>创建f1文件所有者为f1</p>
<p><img src="smb1.png" alt="smb1"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su – smb2</span><br></pre></td></tr></table></figure>
<p>由于smb2不在wirte_list表中，不具有读权限，登录失败</p>
<p><img src="smb2.png" alt="smb2"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su – smb3</span><br><span class="line">cifscreds add 192.168.30.7</span><br></pre></td></tr></table></figure>
<p>创建f3文件所有者为smb3</p>
<p><img src="smb3.png" alt="smb3"></p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/28/NFS文件系统介绍及相关实验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/28/NFS文件系统介绍及相关实验/" itemprop="url">NFS文件系统介绍及相关实验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-28T16:13:51+08:00">
                2018-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、NFS网络文件系统介绍"><a href="#一、NFS网络文件系统介绍" class="headerlink" title="一、NFS网络文件系统介绍"></a><strong>一、NFS网络文件系统介绍</strong></h2><p><strong>NFS：Network File System</strong> 网络文件系统，基于内核的文件系统。Sun公司开发，通过使用NFS，</p>
<p>用户和程序可以像访问本地文件一样访问远端系统上的文件，基于<strong>RPC</strong>（远程过程调用）实现</p>
<p><strong>RPC</strong>采用C/S模式。客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。</p>
<p>在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，</p>
<p>计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，</p>
<p>然后调用执行继续进行。</p>
<h3 id="NFS优势："><a href="#NFS优势：" class="headerlink" title="NFS优势："></a><strong>NFS优势：</strong></h3><ol>
<li><p>节省本地存储空间，将常用的数据如：home目录,存放在一台NFS服务器上且可以通过网络访问，那么本</p>
<p>地终端将可以减少自身存储空间的使用，适合在局域网使用</p>
</li>
<li><p>用户不需要在网络中的每个机器上都建有Home目录，Home目录可以放在NFS服务器上且可以在网络上</p>
<p>被访问使用。</p>
</li>
<li><p>一些存储设备如软驱、CDROM和Zip（一种高储存密度的磁盘驱动器与磁盘）等都可以在网络上被别的</p>
<p>机器使用。这可以减少整个网络上可移动介质设备的数量。</p>
</li>
</ol>
<h3 id="NFS常见应用场景："><a href="#NFS常见应用场景：" class="headerlink" title="NFS常见应用场景："></a><strong>NFS常见应用场景：</strong></h3><ol>
<li><p>多个机器共享一台CDROM或者其他设备。这对于在多台机器中安装软件来说更加便宜跟方便。</p>
</li>
<li><p>在大型网络中，配置一台中心NFS服务器用来放置所有用户的home目录可能会带来便利。这些目录能被输出到网络以便用户不管在哪台工作站上登录，总能得到相同的home目录。</p>
</li>
<li><p>不同客户端可在NFS上观看影视文件，节省本地空间。</p>
</li>
<li>在客户端完成的工作数据，可以备份保存到NFS服务器上用户自己的路径下。</li>
</ol>
<h2 id="二、NFS服务介绍"><a href="#二、NFS服务介绍" class="headerlink" title="二、NFS服务介绍"></a><strong>二、NFS服务介绍</strong></h2><p>软件包：<strong>nfs-utils</strong>(系统自带)</p>
<p>Kernel支持:<strong>nfs.ko</strong></p>
<p>端口：<strong>2049(nfsd),</strong> 其它端口由<strong>rpcbind(111)</strong>分配</p>
<p>配置文件：/etc/exports,/etc/exports.d/*.exports</p>
<p><strong>CentOS 7</strong>不支持同一目录同时用nfs和samba共享，因为使用锁机制不同</p>
<p>相关软件包：rpcbind（必须），tcp_wrappers</p>
<p><strong>CentOS 6</strong>开始portmap进程由rpcbind代替</p>
<p><strong>NFS服务主要进程：</strong></p>
<p>​    rpc.nfsd 最主要的NFS进程，管理客户端是否可登录</p>
<p>​    rpc.mountd 挂载和卸载NFS文件系统，包括权限管理</p>
<p>​    rpc.lockd 非必要，管理文件锁，避免同时写出错</p>
<p>​    rpc.statd 非必要，检查文件一致性，可修复文件</p>
<p><strong>日志：</strong>/var/lib/nfs/</p>
<p>配置防火墙，开放NFS服务</p>
<p>配置NFS使用固定端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/nfs</span><br><span class="line">    RQUOTAD_PORT=875</span><br><span class="line">    LOCKD_TCPPORT=32803</span><br><span class="line">    LOCKD_UDPPORT=32769</span><br><span class="line">    MOUNTD_PORT=892</span><br><span class="line">    STATD_PORT=662</span><br><span class="line">    STATD_OUTGOING_PORT=2020</span><br></pre></td></tr></table></figure>
<p>防火墙除开放上述端口，还需开放TCP和UDP的111和2049共4个端口</p>
<h3 id="导出的文件系统的格式："><a href="#导出的文件系统的格式：" class="headerlink" title="导出的文件系统的格式："></a><strong>导出的文件系统的格式：</strong></h3><p><strong>/dir   主机1(opt1,opt2) 主机2(opt1,opt2)…</strong></p>
<p>#开始为注释</p>
<p><strong>主机格式：</strong></p>
<p>单个主机：ipv4，ipv6，FQDN</p>
<p>IP networks：两种掩码格式均支持</p>
<p>172.18.0.0/255.255.0.0</p>
<p>172.18.0.0/16</p>
<p>wildcards：主机名通配，例如*.magedu.com，IP不可以</p>
<p>netgroups：NIS域的主机组，@group_name</p>
<p>anonymous：表示使用*通配所有客户端</p>
<p>每个条目指定目录导出到的哪些主机，及相关的权限和选项</p>
<p><strong>默认选项：**</strong>(ro,sync,root_squash,no_all_squash)**</p>
<p><img src="选项.png" alt="选项"></p>
<p><strong>示例：</strong>在<strong>/etc/exports</strong>文件中定义导出目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/myshare server.example.com</span><br><span class="line">/myshare *.example.com</span><br><span class="line">/myshare server?.example.com</span><br><span class="line">/myshare server[0-20].example.com</span><br><span class="line">/myshare 172.25.11.10</span><br><span class="line">/myshare 172.25.0.0/16</span><br><span class="line">/myshare 2000:472:18:b51:c32:a21</span><br><span class="line">/myshare 2000:472:18:b51::/64</span><br><span class="line">/myshare *.example.com 172.25.0.0/16</span><br><span class="line">/myshare desktop.example.com(ro)</span><br><span class="line">/myshare desktop.example.com(ro) server[0-20].example.com(rw)</span><br><span class="line">/myshare diskless.example.com(rw,no_root_squash)</span><br></pre></td></tr></table></figure>
<h3 id="NFS工具："><a href="#NFS工具：" class="headerlink" title="NFS工具："></a><strong>NFS工具：</strong></h3><p><strong>rpcinfo</strong></p>
<p>rpcinfo -p hostname</p>
<p>rpcinfo -s hostname  查看RPC注册程序</p>
<p><strong>exportfs</strong></p>
<p>​    -v 查看本机所有NFS共享</p>
<p>​    -r 重读配置文件，并共享目录</p>
<p>​    -a 输出本机所有共享</p>
<p>​    -au 停止本机所有共享</p>
<p>查看指定NFS服务器提供的共享目录文件</p>
<p><strong>showmount -e NfsServerIP</strong></p>
<p><strong>mount.nfs</strong> 挂载工具</p>
<p>NFSv4支持通过挂载NFS服务器的共享“根”，从而浏览NFS服务器上的共享目录列表</p>
<p><strong>mount nfsserver:/ /mnt/nfs</strong></p>
<h2 id="三、NFS挂载及autofs自动挂载"><a href="#三、NFS挂载及autofs自动挂载" class="headerlink" title="三、NFS挂载及autofs自动挂载"></a><strong>三、NFS挂载及autofs自动挂载</strong></h2><h3 id="客户端NFS挂载："><a href="#客户端NFS挂载：" class="headerlink" title="客户端NFS挂载："></a><strong>客户端NFS挂载：</strong></h3><p>基于安全考虑，建议使用<strong>nosuid,nodev,noexec</strong>挂载选项</p>
<p><strong>NFS相关的挂载选项：</strong></p>
<p>​    fg（默认）前台挂载，bg后台挂载</p>
<p>​    hard（默认）持续请求，soft 非持续请求</p>
<p>​    intr 和hard配合，请求可中断</p>
<p>​    rsize和wsize 一次读和写数据最大字节数，rsize=32768</p>
<p>​    _netdev 无网络不挂载</p>
<p><strong>示例：</strong></p>
<p>默认NFS v4版本挂载</p>
<p>​    mount -o rw,nosuid,fg,hard,intr 192.168.0.1:/testdir /mnt/nfs/</p>
<p>也可指定以其他NFS版本挂载</p>
<p>​    mount -o vers=3 192.168.2.7:/data/nfsdir2 /mnt/nfs2</p>
<p>开机挂载:<strong>/etc/fstab</strong></p>
<p>​    192.168.0.1:/public /mnt/nfs nfs defaults 0 0</p>
<h3 id="autofs自动挂载："><a href="#autofs自动挂载：" class="headerlink" title="autofs自动挂载："></a><strong>autofs自动挂载：</strong></h3><p>可使用autofs按需要挂载NFS共享，在空闲时自动卸载</p>
<p>由autofs包提供</p>
<p>系统管理器指定由<strong>/etc/auto.master</strong>自动挂载器守护进程控制的挂载点</p>
<p>自动挂载监视器访问这些目录并按要求挂载文件系统</p>
<p>文件系统在失活的指定间隔5分钟后会自动卸载</p>
<p>为所有导出到网络中的NFS启用特殊匹配 -host 至“browse”</p>
<p>参看帮助：man 5 autofs</p>
<p>支持含通配符的目录名</p>
<p><strong>server:/export/&amp;</strong></p>
<h2 id="四、实验：实现NFS服务"><a href="#四、实验：实现NFS服务" class="headerlink" title="四、实验：实现NFS服务"></a><strong>四、实验：实现NFS服务</strong></h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>虚拟机两台</p>
<p>NFS服务器：CentOS 7.4      IP：192.168.2.7</p>
<p>客户端：CentOS 7.4     IP：192.168.2.11</p>
<h3 id="NFS服务器端："><a href="#NFS服务器端：" class="headerlink" title="NFS服务器端："></a><strong>NFS服务器端：</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nfs-server</span><br><span class="line">mkdir /data/nfsdir&#123;1,2,3&#125;</span><br><span class="line">vim /etc/exports</span><br><span class="line">    /data/nfsdir1 *</span><br><span class="line">    /data/nfsdir2 *(rw)</span><br><span class="line">    /data/nfsdir3 *(rw,no_root_squash)</span><br></pre></td></tr></table></figure>
<p>也可基于IP控制NFS访问(安全性不高，可被冒充)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>重启NFS服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs –r</span><br></pre></td></tr></table></figure>
<p>查看本机已生效的NFS共享文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs -v</span><br></pre></td></tr></table></figure>
<p><img src="1-45.png" alt="1"></p>
<h3 id="客户端："><a href="#客户端：" class="headerlink" title="客户端："></a><strong>客户端：</strong></h3><p>查看NFS服务器提供的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 192.168.2.7</span><br></pre></td></tr></table></figure>
<p><img src="2-43.png" alt="2"></p>
<p>创建挂载NFS的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>挂载nfsdir1，默认NFS v4版本挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount 192.168.2.7:/data/nfsdir1 /mnt/nfs1</span><br></pre></td></tr></table></figure>
<p>也可指定以其他NFS版本挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o vers=3 192.168.2.7:/data/nfsdir2 /mnt/nfs2</span><br></pre></td></tr></table></figure>
<p>NFS也是一种文件系统，可用mount命令查看已挂载的NFS文件系统</p>
<p><img src="3-43.png" alt="3"></p>
<p>写入<strong>/etc/fstab</strong>文件中实现永久挂载</p>
<p><img src="4-33.png" alt="4"></p>
<p>nfs1目录只读挂载，无法创建文件</p>
<p>nfs2目录可创建文件，文件所有者，所属组映射为nfsnobody</p>
<p>nfs3目录因为加了no_root_squash，root创建文件不影响到nfsnobody</p>
<p><img src="5-28.png" alt="5"></p>
<h2 id="五、实验：实现NFS伪根-RHCE"><a href="#五、实验：实现NFS伪根-RHCE" class="headerlink" title="五、实验：实现NFS伪根(RHCE)"></a><strong>五、实验：实现NFS伪根(RHCE)</strong></h2><h3 id="前期准备：-1"><a href="#前期准备：-1" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>虚拟机两台</p>
<p>NFS服务器：CentOS 7.4      IP：192.168.2.7</p>
<p>客户端：CentOS 7.4       IP：192.168.2.11</p>
<h3 id="NFS服务器端：-1"><a href="#NFS服务器端：-1" class="headerlink" title="NFS服务器端："></a><strong>NFS服务器端：</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir /app/nfsdir1</span><br><span class="line">mkdir /data/nfsdir2</span><br><span class="line">mkdir /nfsroot/dir&#123;1,2&#125; -pv</span><br><span class="line"></span><br><span class="line"># 挂载目录</span><br><span class="line">vim /etc/fstab</span><br><span class="line">    /app/nfsdir1  /nfsroot/dir1  none  bind   0   0</span><br><span class="line">    /data/nfsdir2  /nfsroot/dir2  none  bind   0   0</span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure>
<p><img src="1-46.png" alt="1"></p>
<p>NFS配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports.d/nfsroot.exports</span><br><span class="line">    /nfsroot       *(fsid=0,rw,crossmnt)</span><br><span class="line">    /nfsroot/dir1  *(rw)</span><br><span class="line">    /nfsroot/dir2  *(ro)</span><br></pre></td></tr></table></figure>
<p>重启NFS服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs –r</span><br></pre></td></tr></table></figure>
<p>查看本机生效的NFS文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exportfs –v</span><br></pre></td></tr></table></figure>
<h3 id="客户端：-1"><a href="#客户端：-1" class="headerlink" title="客户端："></a><strong>客户端：</strong></h3><p>查看NFS服务器提供的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmount -e 192.168.2.7</span><br></pre></td></tr></table></figure>
<p>挂载伪根目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount 192.168.2.7:/nfsroot /mnt</span><br></pre></td></tr></table></figure>
<p><img src="2-44.png" alt="2"></p>
<h2 id="六、实验：实现家目录NFS自动绝对路径、相对路径挂载"><a href="#六、实验：实现家目录NFS自动绝对路径、相对路径挂载" class="headerlink" title="六、实验：实现家目录NFS自动绝对路径、相对路径挂载"></a><strong>六、实验：实现家目录NFS自动绝对路径、相对路径挂载</strong></h2><h3 id="前期准备：-2"><a href="#前期准备：-2" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>虚拟机三台</p>
<p>NFS服务器：CentOS 6.9   IP：192.168.30.13</p>
<p>客户端1：CentOS 7.4  IP：192.168.2.7</p>
<p>客户端2：CentOS 7.4  IP：192.168.2.11</p>
<h3 id="实验预期："><a href="#实验预期：" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>客户端1实现相对路径挂载，客户端2实现绝对路基挂载</p>
<h3 id="NFS服务器："><a href="#NFS服务器：" class="headerlink" title="NFS服务器："></a><strong>NFS服务器：</strong></h3><p>开启nfs服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service rpcbind start</span><br><span class="line">service nfs start</span><br></pre></td></tr></table></figure>
<p>建立用户nfs1，nfs2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -d /data/nfs/nfs1 -u 2001 nfs1</span><br><span class="line">useradd -d /data/nfs/nfs2 -u 2002 nfs2</span><br></pre></td></tr></table></figure>
<p>编写测试文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch /data/nfs/nfs1/test1</span><br><span class="line">touch /data/nfs/nfs2/test2</span><br></pre></td></tr></table></figure>
<p>编写nfs共享配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/exports</span><br><span class="line">/data/  *(rw)</span><br></pre></td></tr></table></figure>
<h3 id="相对路径挂载："><a href="#相对路径挂载：" class="headerlink" title="相对路径挂载："></a><strong>相对路径挂载：</strong></h3><p>切换到客户端1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="1-47.png" alt="1"></p>
<p>建立两个用户nfsuser1，nfsuser2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -u 2001 nfsuser1</span><br><span class="line">useradd -u 2002 nfsuser2</span><br></pre></td></tr></table></figure>
<p>配置相对路径自动挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/auto.master</span><br><span class="line">/home  /etc/home.autofs</span><br></pre></td></tr></table></figure>
<p><img src="2-45.png" alt="2"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/home.autofs</span><br><span class="line">    nfsuser1  -fstype=nfs,vers=3 192.168.30.11:/data/nfs/nfs1</span><br><span class="line">    nfsuser2  -fstype=nfs,vers=3 192.168.30.11:/data/nfs/nfs2</span><br></pre></td></tr></table></figure>
<p><img src="3-44.png" alt="3"></p>
<p>重启autofs服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart autofs</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su -nfsuser1</span><br></pre></td></tr></table></figure>
<p><img src="4-34.png" alt="4"></p>
<h3 id="绝对路径挂载："><a href="#绝对路径挂载：" class="headerlink" title="绝对路径挂载："></a><strong>绝对路径挂载：</strong></h3><p>切换到客户端2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -u 2001 nfsuser1</span><br><span class="line">useradd -u 2002 nfsuser2</span><br></pre></td></tr></table></figure>
<p>配置绝对路径自动挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/auto.master</span><br><span class="line">	/- /etc/home.autofs</span><br></pre></td></tr></table></figure>
<p><img src="5-29.png" alt="5"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/home.autofs</span><br><span class="line">    /home/nfsuser1  -fstype=nfs,vers=3 192.168.30.11:/data/nfs/nfs1</span><br><span class="line">    /home/nfsuser2  -fstype=nfs,vers=3 192.168.30.11:/data/nfs/nfs2</span><br></pre></td></tr></table></figure>
<p><img src="6-22.png" alt="6"></p>
<p>测试：</p>
<p><img src="7-15.png" alt="7"></p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/26/FTP服务介绍及相关实验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/26/FTP服务介绍及相关实验/" itemprop="url">FTP服务介绍及相关实验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-26T16:12:34+08:00">
                2018-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、FTP服务"><a href="#一、FTP服务" class="headerlink" title="一、FTP服务"></a>一、FTP服务</h2><p><strong>FTP</strong>是File Transfer Protocol<strong>（文件传输协议）</strong>的英文简称，而中文简称为“文传协议”。</p>
<p>用于Internet上的控制文件的双向传输。FTP协议是早期的三个应用级协议之一。</p>
<p><strong>基于C/S结构</strong></p>
<p>双通道协议：数据和命令连接</p>
<p>数据传输格式：二进制（默认）和文本</p>
<h3 id="两种模式："><a href="#两种模式：" class="headerlink" title="两种模式："></a><strong>两种模式：</strong></h3><p>服务器角度</p>
<p><strong>主动(PORT style)</strong>：服务器主动连接</p>
<p>​    命令（控制）：客户端：随机port — 服务器：<strong>tcp21</strong></p>
<p>​    数据：                客户端：随机port — 服务器：<strong>tcp20</strong></p>
<p><strong>被动(PASV style)</strong>：客户端主动连接</p>
<p>​    命令（控制）：客户端：随机port — 服务器：<strong>tcp21</strong></p>
<p>​    数据：                客户端：随机port — 服务器：<strong>随机port</strong></p>
<p>服务器被动模式数据端口示例：</p>
<p>​    227 Entering Passive Mode (192,168,175,138,224,59)</p>
<p>​    服务器数据端口为：<strong>224*256+59</strong></p>
<p><strong>注：</strong>Linux客户端默认使用被动模式</p>
<p>​    Windows客户端默认使用主动模式</p>
<p>​    Linux系统客户端若要切换主动模式，可使用：ftp -A ServerIP Port</p>
<p><strong>主动连接与被动连接的优缺点：</strong></p>
<ol>
<li>主动连接对FTP服务器的管理有利，但对客户端的管理不利。因为FTP服务器企图与客户端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。</li>
<li>被动连接对FTP客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻塞掉。</li>
</ol>
<p><strong>注：</strong>可通过为FTP服务器指定一个有限的端口范围来减小服务器端口暴露的风险。</p>
<h3 id="FTP服务器："><a href="#FTP服务器：" class="headerlink" title="FTP服务器："></a><strong>FTP服务器：</strong></h3><p><strong>Wu-ftpd，Proftpd，Pureftpd，ServU，IIS</strong></p>
<p><strong>vsftpd</strong>：Very Secure FTP Daemon，CentOS默认FTP服务器</p>
<p>高速，稳定，下载速度是WU-FTP的两倍</p>
<p>ftp.redhat.com数据：单机最多可支持15000个并发</p>
<h3 id="客户端软件："><a href="#客户端软件：" class="headerlink" title="客户端软件："></a><strong>客户端软件：</strong></h3><p><strong>ftp，lftp，lftpget，wget，curl</strong></p>
<p>​    ftp -A ftpserver port -A 主动模式 -p 被动模式</p>
<p>​    lftp -u username ftpserver</p>
<p>​    lftp username@ftpserver</p>
<p>​    lftpget <a href="ftp://ftpserver/pub/file" target="_blank" rel="noopener">ftp://ftpserver/pub/file</a></p>
<p>gftp: GUI centos5 最新版2.0.19 (11/30/2008)</p>
<p>filezilla，CuteFtp，FlashFXP，LeapFtp</p>
<p>IE <a href="ftp://username:password@ftpserver" target="_blank" rel="noopener">ftp://username:password@ftpserver</a></p>
<h3 id="状态码："><a href="#状态码：" class="headerlink" title="状态码："></a><strong>状态码：</strong></h3><p><strong>1XX：</strong>信息类     125：数据连接打开</p>
<p><strong>2XX：</strong>成功类状态 200：命令OK 230：登录成功</p>
<p><strong>3XX：</strong>补充类     331：用户名OK</p>
<p><strong>4XX：</strong>客户端错误 425：不能打开数据连接</p>
<p><strong>5XX：</strong>服务器错误 530：不能登录</p>
<h3 id="用户认证："><a href="#用户认证：" class="headerlink" title="用户认证："></a><strong>用户认证：</strong></h3><p><strong>匿名用户：</strong>ftp,anonymous,对应Linux用户ftp</p>
<p><strong>系统用户：</strong>Linux用户,用户/etc/passwd,密码/etc/shadow</p>
<p><strong>虚拟用户：</strong>特定服务的专用用户，独立的用户/密码文件</p>
<p><strong>nsswitch：</strong>network service switch  名称解析框架</p>
<p><strong>pam：</strong>pluggable authentication module 可插拔认证模块 </p>
<p>​<strong> pam的相关文件：</strong>   <strong>/lib64/security /etc/pam.d/ /etc/pam.conf</strong></p>
<h2 id="二、vsftpd服务"><a href="#二、vsftpd服务" class="headerlink" title="二、vsftpd服务"></a><strong>二、vsftpd服务</strong></h2><p><strong>vsftpd</strong>全称为”Very Secure FTP Daemon“,意为非常安全的FTP守护进程，</p>
<p>vsftpd最初发展理念就是建构一个以安全为重心的FTP服务器。</p>
<p>由vsftpd包提供，CentOS 7之后不再由xinetd管理</p>
<p>用户认证配置文件：</p>
<p><strong>/etc/pam.d/vsftpd</strong></p>
<p>服务脚本：</p>
<p><strong>/usr/lib/systemd/system/vsftpd.service</strong></p>
<p><strong>/etc/rc.d/init.d/vsftpd</strong></p>
<p>配置文件：</p>
<p><strong>/etc/vsftpd/vsftpd.conf</strong></p>
<p><strong>格式：option=value</strong></p>
<p><strong>注意：</strong>= 前后不要有空格</p>
<p>匿名用户（映射为系统用户ftp ）登录的根目录位置：<strong>/var/ftp</strong></p>
<p>系统用户共享文件位置：用户家目录</p>
<p>虚拟用户共享文件位置：为其映射的系统用户的家目录</p>
<h3 id="vsftpd虚拟用户"><a href="#vsftpd虚拟用户" class="headerlink" title="vsftpd虚拟用户"></a><strong>vsftpd虚拟用户</strong></h3><p><strong>虚拟用户：</strong></p>
<p>所有虚拟用户会统一映射为一个指定的系统帐号：访问共享位置，即为此系统帐号的家目录</p>
<p>各虚拟用户可被赋予不同的访问权限，通过匿名用户的权限控制参数进行指定</p>
<p>虚拟用户帐号的存储方式：</p>
<p>文件：编辑文本文件，此文件需要被编码为hash格式</p>
<p>奇数行为用户名，偶数行为密码</p>
<p>db_load -T -t hash -f vusers.txt vusers.db</p>
<p>关系型数据库中的表中：</p>
<p>实时查询数据库完成用户认证</p>
<p>mysql库：pam要依赖于<strong>pam-mysql</strong></p>
<p>/lib64/security/pam_mysql.so</p>
<p>/usr/share/doc/pam_mysql-0.7/README</p>
<h3 id="vsftpd-conf常用配置"><a href="#vsftpd-conf常用配置" class="headerlink" title="vsftpd.conf常用配置"></a><strong>vsftpd.conf常用配置</strong></h3><p><strong>帮助查询：</strong>man 5 vsftpd.conf</p>
<p><strong>重设命令端口：</strong>listen_port=21</p>
<p><strong>主动模式端口</strong></p>
<p>​    connect_from_port_20=YES     主动模式端口为20</p>
<p>​    ftp_data_port=20             指定主动模式的端口</p>
<p><strong>被动模式端口范围</strong></p>
<p>​    Linux客户端默认使用被动模式</p>
<p>​    Windows客户端默认使用主动模式</p>
<p>​    pasv_min_port=6000           0为随机分配</p>
<p>​    pasv_max_port=6010</p>
<p>   <strong>注：</strong>可以通过为FTP服务器指定一个有限的端口范围来减小服务器端口暴露的风险</p>
<p><strong>使用当地时间</strong></p>
<p>use_localtime=YES 使用当地时间（默认为NO，使用GMT）</p>
<p><strong>匿名用户</strong></p>
<p>​    anonymous_enable=YES          支持匿名用户</p>
<p>​    no_anon_password=YES(默认NO)  匿名用户略过口令检查</p>
<p>​    anon_world_readable_only (默认YES)只能下载全部读的文件</p>
<p>​    anon_upload_enable=YES        匿名上传，注意:文件系统权限</p>
<p>​    anon_mkdir_write_enable=YES   匿名创建，写权限</p>
<p>​    anon_umask=077                指定匿名上传文件的umask</p>
<p>​    anon_other_write_enable=YES   可删除和修改上传的文件</p>
<p><strong>可指定上传文件的默认的所有者和权限</strong></p>
<p>​    chown_uploads=YES(默认NO)</p>
<p>​    chown_username=wang</p>
<p>​    chown_upload_mode=0644</p>
<p><strong>Linux系统用户</strong></p>
<p>​    guest_enable=YES              所有系统用户都映射成guest用户</p>
<p>​    guest_username=ftp            配合上面选项才生效，指定guest用户</p>
<p>​    local_enable=YES              是否允许Linux用户登录</p>
<p>​    write_enable-YES              是否允许Linux用户上传文件</p>
<p>​    local_umask=022               指定系统用户上传文件的默认权限</p>
<p>​    local_root=/ftproot           非匿名用户登录所在目录</p>
<p><strong>禁锢所有系统用户在家目录中</strong></p>
<p>​    chroot_local_user=YES（默认NO，不禁锢）禁锢系统用户</p>
<p><strong>禁锢或不禁锢特定的系统用户在家目录中，与上面设置功能相反</strong></p>
<p>​    chroot_list_enable=YES chroot_list_file=/etc/vsftpd/chroot_list</p>
<p>​    当chroot_local_user=YES时，则chroot_list中用户不禁锢，白名单</p>
<p>​    当chroot_local_user=NO时，则chroot_list中用户禁锢，黑名单</p>
<h3 id="ftp日志"><a href="#ftp日志" class="headerlink" title="ftp日志"></a><strong>ftp日志</strong></h3><p><strong>wu-ftp日志</strong>：默认启用</p>
<p>​    xferlog_enable=YES （默认）   启用记录上传下载日志</p>
<p>​    xferlog_std_format=YES （默认）使用wu-ftp日志格式</p>
<p>​    xferlog_file=/var/log/xferlog （默认）可自动生成</p>
<p><strong>vsftpd日志：</strong>默认不启用</p>
<p>​    dual_log_enable=YES           使用vsftpd日志格式，默认不启用</p>
<p>​    vsftpd_log_file=/var/log/vsftpd.log（默认）可自动生成</p>
<p><strong>登录提示信息</strong></p>
<p>​    ftpd_banner=”welcome to mage ftp server”</p>
<p>​    banner_file=/etc/vsftpd/ftpbanner.txt 优先上面项生效</p>
<p><strong>目录访问提示信息</strong></p>
<p>​    dirmessage_enable=YES (默认)</p>
<p>​    message_file=.message(默认)    信息存放在指定目录下.message</p>
<p><strong>使用PAM完成用户认证</strong></p>
<p>​    pam_service_name=vsftpd</p>
<p>​    pam配置文件:<strong>/etc/pam.d/vsftpd</strong></p>
<p><strong>/etc/vsftpd/ftpusers</strong>           默认文件中用户拒绝登录</p>
<p><strong>/etc/vsftpd/users_list</strong>         默认文件中用户拒绝登录，不提示口令输入</p>
<p><strong>是否启用控制用户登录的列表文件</strong></p>
<p>​    userlist_enable=YES            默认有此设置</p>
<p>​    userlist_deny=YES(默认值)      黑名单,不提示口令，NO为白名单</p>
<p>​    userlist_file=/etc/vsftpd/users_list 此为默认值</p>
<p><strong>连接限制</strong></p>
<p>​    max_clients=0                  最大并发连接数</p>
<p>​    max_per_ip=0                   每个IP同时发起的最大连接数</p>
<p><strong>注：</strong>生成环境一般会将最大并发连接数按需设置；单个IP最大连接数尽量调小</p>
<p><strong>vsftpd服务指定用户身份运行</strong></p>
<p>​    nopriv_user=nobody</p>
<p><strong>传输速率：</strong>字节/秒</p>
<p>​    anon_max_rate=0                匿名用户的最大传输速率</p>
<p>​    local_max_rate=0               本地用户的最大传输速率</p>
<p><strong>连接时间：</strong>秒为单位</p>
<p>​    connect_timeout=60             主动模式数据连接超时时长</p>
<p>​    accept_timeout=60              被动模式数据连接超时时长</p>
<p>​    data_connection_timeout=300    数据连接无数据输超时时长</p>
<p>​    idle_session_timeout=60        无命令操作超时时长</p>
<p><strong>优先以文本方式传输</strong></p>
<p>​    ascii_upload_enable=YES</p>
<p>​    ascii_download_enable=YES</p>
<p>配置FTP服务以非独立服务方运行:listen=NO，默认为独立方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/xinetd.d/rsync</span><br><span class="line">service ftp</span><br><span class="line">&#123;</span><br><span class="line">    flags = REUSE</span><br><span class="line">    socket_type = stream</span><br><span class="line">    wait = no</span><br><span class="line">    user = root</span><br><span class="line">    server = /usr/sbin/vsftpd</span><br><span class="line">    log_on_failure += USERID</span><br><span class="line">    disable = no</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="三、实验：实现基于SSL的FTPS"><a href="#三、实验：实现基于SSL的FTPS" class="headerlink" title="三、实验：实现基于SSL的FTPS"></a><strong>三、实验：实现基于SSL的FTPS</strong></h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>FTP服务器：CentOS7.4</p>
<p>IP地址：192.168.2.11</p>
<h3 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p><strong>查看是否支持SSL</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd `which vsftpd`|grep libssl  # 查看到libssl.so</span><br></pre></td></tr></table></figure>
<p><img src="1-42.png" alt="1"></p>
<p><strong>创建自签名证书</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/pki/tls/certs/</span><br><span class="line">make vsftpd.pem</span><br><span class="line">openssl x509 -in vsftpd.pem -noout -text</span><br></pre></td></tr></table></figure>
<p><strong>配置vsftpd服务支持SSL：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">    ssl_enable=YES 		# 启用SSL</span><br><span class="line">    allow_anon_ssl=NO	# 匿名不支持SSL</span><br><span class="line">    force_local_logins_ssl=YES 	# 本地用户登录加密</span><br><span class="line">    force_local_data_ssl=YES 	# 本地用户数据传输加密</span><br><span class="line">    rsa_cert_file=/etc/pki/tls/certs/vsftpd.pem 	# 指定证书位置</span><br></pre></td></tr></table></figure>
<p><img src="2-40.png" alt="2"></p>
<p><strong>用filezilla工具测试:</strong></p>
<ol>
<li>点击文件–&gt;站点管理器–&gt;新站点，协议选择SFTP，登录类型选择一般</li>
</ol>
<p><img src="3-40.png" alt="3"></p>
<ol start="2">
<li>是否信任主机并继续，点确定</li>
</ol>
<p><img src="4-30.png" alt="4"></p>
<ol start="3">
<li>连接成功</li>
</ol>
<p><img src="5-26.png" alt="5"></p>
<h2 id="四、实验：基于文件验证的vsftpd虚拟用户"><a href="#四、实验：基于文件验证的vsftpd虚拟用户" class="headerlink" title="四、实验：基于文件验证的vsftpd虚拟用户"></a><strong>四、实验：基于文件验证的vsftpd虚拟用户</strong></h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备:"></a><strong>前期准备:</strong></h3><p>Ftp服务器: CentOS 7.4      192.168.2.7</p>
<p>访问端：CentOS7.5         192.168.2.11</p>
<h3 id="具体步骤：-1"><a href="#具体步骤：-1" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><ol>
<li>创建用户数据库文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vusers.txt</span><br><span class="line">    vuse1</span><br><span class="line">    centos</span><br><span class="line">    vuse2</span><br><span class="line">	lpx</span><br><span class="line">cd /etc/vsftpd/  </span><br><span class="line">db_load -T -t hash -f vusers.txt vusers.db   # 转换为db型文件</span><br><span class="line">chmod 600 vusers.db</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建用户和访问FTP目录</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -pv /data/ftp</span><br><span class="line">useradd -d /data/ftp -s /sbin/nologin vuser</span><br><span class="line">chmod +rx /data/ftp/</span><br><span class="line"># centos7 还需要执行以下操作：</span><br><span class="line">chmod -w /data/ftp/</span><br><span class="line">mkdir /data/ftp/upload</span><br><span class="line">setfacl -m u:vuser:rwx /data/ftp/upload</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>创建pam配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pam.d/vsftpd.db</span><br><span class="line">    auth required pam_userdb.so db=/etc/vsftpd/vusers</span><br><span class="line">    account required pam_userdb.so db=/etc/vsftpd/vusers</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>指定pam</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br><span class="line">    guest_enable=YES</span><br><span class="line">    guest_username=vuser</span><br><span class="line">    user_config_dir=/etc/vsftpd/vusers.d/</span><br></pre></td></tr></table></figure>
<p><img src="1-43.png" alt="1"></p>
<p>找到此行，将vsftpd模块替换为vsftpd.db</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pam_service_name=vsftpd==&gt;pam_service_name=vsftpd.db</span><br></pre></td></tr></table></figure>
<p><img src="2-41.png" alt="2"></p>
<ol start="5">
<li>虚拟用户建立独立的配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/vsftpd/vusers.d/</span><br><span class="line">cd /etc/vsftpd/vusers.d/</span><br><span class="line"></span><br><span class="line"># 创建个用户自己的配置文件</span><br><span class="line"># 允许vuser1用户可读写，其他用户只读</span><br><span class="line">vim vuser1</span><br><span class="line">    anon_upload_enable=YES</span><br><span class="line">    anon_mkdir_write_enable=YES</span><br><span class="line">    anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line">指定vuse2用户登录的根目录</span><br><span class="line">vim vuser2</span><br><span class="line">	local_root=/data/ftp</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>测试</li>
</ol>
<p>切换到另外一台主机ftp连接，虚拟用户vuser1，vuser2登录成功</p>
<p><img src="3-41.png" alt="3"></p>
<h2 id="五、实验：实现基于MySQL验证的vsftpd虚拟用户"><a href="#五、实验：实现基于MySQL验证的vsftpd虚拟用户" class="headerlink" title="五、实验：实现基于MySQL验证的vsftpd虚拟用户"></a><strong>五、实验：实现基于MySQL验证的vsftpd虚拟用户</strong></h2><h3 id="前期准备：-1"><a href="#前期准备：-1" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>虚拟机2台</p>
<p>FTP服务器：  CentOS 7.4     IP：192.168.2.11</p>
<p>MySQL服务器：CentOS 7.4     IP：192.168.2.12</p>
<h3 id="具体步骤：-2"><a href="#具体步骤：-2" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p><strong>一、安装所需要包和包组：</strong></p>
<p>在数据库服务器上安装包：</p>
<p><strong>Centos7：</strong>在数据库服务器上安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum –y install mariadb-server</span><br><span class="line">systemctl start mariadb.service</span><br><span class="line">systemctl enable mariadb</span><br></pre></td></tr></table></figure>
<p><strong>Centos6：</strong>在数据库服务器上安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum –y install mysql-server</span><br></pre></td></tr></table></figure>
<p>在FTP服务器上安装vsftpd和pam_mysql包</p>
<p><strong>CentOS6：</strong>pam_mysql由epel6的源中提供</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install vsftpd pam_mysql</span><br></pre></td></tr></table></figure>
<p><strong>CentOS7：</strong>无对应rpm包，需手动编译安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y groupinstall &quot;Development Tools&quot;</span><br><span class="line">yum -y install mariadb-devel pam-devel vsftpd</span><br></pre></td></tr></table></figure>
<p>编译安装pam_mysql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">下载pam_mysql-0.7RC1.tar.gz报</span><br><span class="line">tar xvf pam_mysql-0.7RC1.tar.gz</span><br><span class="line">cd pam_mysql-0.7RC1/</span><br><span class="line">./configure --with-mysql=/usr --with-pam=/usr --with-pam-mods-dir=/lib64/security</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p><strong>二、在数据库服务器上创建虚拟用户账号</strong></p>
<ol>
<li>建立存储虚拟用户数据库和连接的数据库用户</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE vsftpd;</span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br><span class="line"># ftp服务和mysql不在同一主机：</span><br><span class="line">mysql&gt; GRANT SELECT ON vsftpd.* TO vsftpd@&apos;192.168.%.%&apos; IDENTIFIED BY &apos;magedu&apos;;</span><br></pre></td></tr></table></figure>
<p>ftp服务和mysql在同一主机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT SELECT ON vsftpd.* TO vsftpd@localhost IDENTIFIED BY &apos;magedu&apos;;</span><br><span class="line">mysql&gt; GRANT SELECT ON vsftpd.* TO vsftpd@&apos;127.0.0.1′ IDENTIFIED BY &apos;magedu&apos;;</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>准备相关表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; USE vsftpd;</span><br><span class="line">mysql&gt; SHOW TABLES;</span><br><span class="line">mysql&gt; CREATE TABLE users (</span><br><span class="line">    id INT AUTO_INCREMENT NOT NULL PRIMARY KEY,</span><br><span class="line">    name CHAR(50) BINARY NOT NULL,</span><br><span class="line">    password CHAR(48) BINARY NOT NULL</span><br><span class="line">);</span><br><span class="line">mysql&gt;DESC users;</span><br></pre></td></tr></table></figure>
<p><img src="1-44.png" alt="1"></p>
<p>测试连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uvsftpd –h192.168.2.11 -pmagedu</span><br><span class="line">mysql&gt; SHOW DATABASES;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>添加虚拟用户</li>
</ol>
<p>根据需要添加所需要的用户，为了安全应该使用PASSWORD函数加密其密码后存储</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; DESC users;</span><br><span class="line">mysql&gt; INSERT INTO users(name,password)	values(&apos;wang&apos;,password(&apos;magedu&apos;));</span><br><span class="line">mysql&gt; INSERT INTO users(name,password) values(&apos;mage&apos;,password(&apos;magedu&apos;));</span><br><span class="line">mysql&gt; SELECT * FROM users;</span><br></pre></td></tr></table></figure>
<p><img src="2-42.png" alt="2"></p>
<p><strong>三、在FTP服务器上配置vsftpd服务</strong></p>
<ol>
<li>在FTP服务器上建立pam认证所需文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/pam.d/vsftpd.mysql 添加如下两行</span><br><span class="line">    auth required pam_mysql.so user=vsftpd passwd=magedu</span><br><span class="line">    host=192.168.2.11 db=vsftpd table=users usercolumn=name</span><br><span class="line">    passwdcolumn=password crypt=2</span><br><span class="line">    account required pam_mysql.so user=vsftpd passwd=magedu</span><br><span class="line">    host=192.168.2.11 db=vsftpd table=users usercolumn=name</span><br><span class="line">    passwdcolumn=password crypt=2</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong>参考README文档，选择正确的加密方式</p>
<p>crypt是加密方式，0表示不加密，1表示crypt(3)加密，2表示使用mysql</p>
<p>password()函数加密，3表示md5加密，4表示sha1加密</p>
<p><strong>配置字段说明：</strong></p>
<p>​    auth                       表示认证</p>
<p>​    account                 验证账号密码正常使用</p>
<p>​    required               表示认证要通过</p>
<p>​    pam_mysql.so     模块是默认的相对路径，是相对/lib64/security/路径而言，也可以写绝对路径；</p>
<p>​                    后面为给此模块传递的参数</p>
<p>​    user=vsftpd          登录mysql的用户</p>
<p>​    passwd=magedu  登录mysql的的密码</p>
<p>​    host=mysqlserver mysql  服务器的主机名或ip地址</p>
<p>​    db=vsftpd             指定连接msyql的数据库名称</p>
<p>​    table=users          指定连接数据库中的表名</p>
<p>​    usercolumn=name 当做用户名的字段</p>
<p>​    passwdcolumn=password 当做用户名字段的密码</p>
<p>​    crypt=2                 密码的加密方式为mysql password()函数加密</p>
<ol start="2">
<li><p>建立相应用户和修改vsftpd配置文件，使其适应mysql认证</p>
<p>建立虚拟用户映射的系统用户及对应的目录</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">useradd -s /sbin/nologin -d /var/ftproot vuser</span><br><span class="line">chmod 555 /var/ftproot centos7 需除去ftp根目录的写权限</span><br><span class="line">mkdir /var/ftproot/&#123;upload,pub&#125;</span><br><span class="line">setfacl –m u:vuser:rwx /var/ftproot/upload</span><br><span class="line"># 确保**/etc/vsftpd.conf**中已经启用了以下选项</span><br><span class="line">vim /etc/vsftpd.conf</span><br><span class="line">	anonymous_enable=YES</span><br><span class="line"># 添加下面两项</span><br><span class="line">	guest_enable=YES</span><br><span class="line">	guest_username=vuser</span><br></pre></td></tr></table></figure>
<p><img src="3-42.png" alt="3"></p>
<p>修改下面一项，原系统用户无法登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pam_service_name=vsftpd.mysql</span><br></pre></td></tr></table></figure>
<p><img src="4-32.png" alt="4"></p>
<p><strong>四、启动vsftpd服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service vsftpd start;systemctl start vsftpd</span><br><span class="line">chkconfig vsftpd on;systemctl enable vsftpd</span><br><span class="line"></span><br><span class="line">#查看端口开启情况</span><br><span class="line">netstat -tnlp |grep :21</span><br></pre></td></tr></table></figure>
<p><strong>五、测试：利用FTP客户端工具,以虚拟用户登录验证结果</strong></p>
<p><img src="5-27.png" alt="5"></p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/23/LAMP架构实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/23/LAMP架构实现/" itemprop="url">LAMP架构实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-23T16:08:26+08:00">
                2018-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web服务器/" itemprop="url" rel="index">
                    <span itemprop="name">Web服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、LAMP介绍"><a href="#一、LAMP介绍" class="headerlink" title="一、LAMP介绍"></a><strong>一、LAMP介绍</strong></h2><p><strong>LAM(M)P</strong>是一组Web应用软件的组合，Linux+Apache+Mysql/MariaDB+Perl/PHP/Python一组</p>
<p>常用来搭建动态网站或者服务器的开源软件，所有组成产品均是开源软件，本身都是各自</p>
<p>独立的程序，但是因为常被放在一起使用，拥有了越来越高的兼容度，共同组成了一个强</p>
<p>大的Web应用程序平台。</p>
<p><strong>L：</strong>Linux</p>
<p><strong>A：</strong>Apache (httpd)</p>
<p><strong>M：</strong>Mysql, Mariadb</p>
<p><strong>M：</strong>Memcached</p>
<p><strong>P：</strong>PHP, Perl, Python</p>
<h3 id="WEB资源类型："><a href="#WEB资源类型：" class="headerlink" title="WEB资源类型："></a><strong>WEB资源类型：</strong></h3><p>​    <strong>静态资源</strong>：原始形式与响应内容一致，在客户端浏览器执行</p>
<p>   <strong>动态资源</strong>：原始形式通常为程序文件，需要在服务器端执行之后，将执行结果返回给客户端</p>
<p><strong>Web相关语言</strong></p>
<p>客户端技术： html，javascript</p>
<p>服务器端技术：php, jsp，python，asp</p>
<h3 id="LAMP工作原理："><a href="#LAMP工作原理：" class="headerlink" title="LAMP工作原理："></a><strong>LAMP工作原理：</strong></h3><p><img src="1-34.png" alt="1"></p>
<h2 id="二、实例：LAMP搭建PhpMyAdmin"><a href="#二、实例：LAMP搭建PhpMyAdmin" class="headerlink" title="二、实例：LAMP搭建PhpMyAdmin"></a><strong>二、实例：LAMP搭建PhpMyAdmin</strong></h2><h3 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a><strong>实验环境：</strong></h3><p><strong>Linux：</strong>      CentOS 7.4</p>
<p><strong>Apache：</strong>   httpd-2.4.6</p>
<p><strong>MariaDB：</strong>mariadb-server-5.5.56</p>
<p><strong>Php，php-mysql：</strong>php-5.4.16</p>
<h3 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p>1 下载phpMyAdmin 4.0.10.20</p>
<p>注：此版本支持PHP 5.2 和 MySQL 5之前，不支持 PHP 5.5 更新的版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://files.phpmyadmin.net/phpMyAdmin/4.0.10.20/phpMyAdmin-4.0.10.20-all-languages.tar.xz</span><br></pre></td></tr></table></figure>
<p>2 解压到httpd目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf phpMyAdmin-4.0.10.20-all-languages.tar.xz -C /var/www/html/</span><br></pre></td></tr></table></figure>
<p>  统一该目录名称，方便操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html/</span><br><span class="line">mv phpMyAdmin-4.0.10.20-all-languages/ phpMyAdmin</span><br></pre></td></tr></table></figure>
<p>3 复制配置文件，不需要更改内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd phpMyAdmin/</span><br><span class="line">cp config.sample.inc.php config.inc.php</span><br></pre></td></tr></table></figure>
<p>安装php-mbstring</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install php-mbstring –y</span><br></pre></td></tr></table></figure>
<p>4 重启httpd服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure>
<p>5 打开浏览器访问<a href="http://192.168.30.10/phpMyAdmin/，出现下图即表示PhpMyAdmin搭建成功" target="_blank" rel="noopener">http://192.168.30.10/phpMyAdmin/，出现下图即表示PhpMyAdmin搭建成功</a></p>
<p><img src="1-35.png" alt="1"></p>
<p>6使用mysql账号进行登录，就可进行数据库的图形化操作了</p>
<p><img src="2-36.png" alt="2"></p>
<h2 id="三、实例：CentOS7编译Php-xcache"><a href="#三、实例：CentOS7编译Php-xcache" class="headerlink" title="三、实例：CentOS7编译Php-xcache"></a><strong>三、实例：CentOS7编译Php-xcache</strong></h2><h3 id="实验环境：-1"><a href="#实验环境：-1" class="headerlink" title="实验环境："></a><strong>实验环境：</strong></h3><p>亚马逊云主机一台，以WordPress搭建了<a href="http://www.wxlinux.com/" target="_blank" rel="noopener">www.wxlinux.com</a></p>
<p>操作系统版本：CentOS7.5</p>
<p>PHP版本为：5.4.16</p>
<p>Httpd版本为：Apache2.4.6</p>
<p>数据库版本：mariadb-server-5.5.56</p>
<p>安全前我们测试下<a href="http://www.wxlinux.com的每秒请求数，为1.90次/秒" target="_blank" rel="noopener">www.wxlinux.com的每秒请求数，为1.90次/秒</a></p>
<p>ab -c 10 -n 100 <a href="http://www.wxlinux.com/" target="_blank" rel="noopener">http://www.wxlinux.com/</a></p>
<p><img src="1-36.png" alt="1"></p>
<p>下载最新版本Php-xcache</p>
<p>wget <a href="https://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz" target="_blank" rel="noopener">https://xcache.lighttpd.net/pub/Releases/3.2.0/xcache-3.2.0.tar.gz</a></p>
<p>解压包到/data目录下</p>
<p>tar  xvf  xcache-3.2.0.tar.gz  -C /data</p>
<p><strong>cd xcache-3.2.0</strong></p>
<p>此时xcache目录下是没有configure文件的，我们需要使用phpize命令生成它</p>
<p>安装php-devlop包</p>
<p>yum install php-devlop</p>
<p>yum install gcc</p>
<p>生成编译环境</p>
<p>phpize</p>
<p>查看下php-config文件位置</p>
<p>[root@wxlinux ~]#which php-config</p>
<p><strong>/bin/php-config</strong></p>
<p>编译安装</p>
<p>./configure –enable-xcache –with-php-config=/bin/php-config</p>
<p>make &amp;&amp; make install</p>
<p>cp xcache-3.2.0/xcache.ini /etc/php.d/</p>
<p>重启http服务使其生效</p>
<p>systemctl restart httpd.service</p>
<p>再次进行测试，每秒请求数提升到3.95</p>
<p><img src="3-35.png" alt="3"></p>
<h2 id="四、实例：LAMP搭建wordpress"><a href="#四、实例：LAMP搭建wordpress" class="headerlink" title="四、实例：LAMP搭建wordpress"></a><strong>四、实例：LAMP搭建wordpress</strong></h2><p>前期准备：</p>
<p>操作系统版本：CentOS7.5</p>
<p>PHP版本为：5.4.16</p>
<p>Httpd版本为：Apache2.4.6</p>
<p>数据库版本：mariadb-server-5.5.56</p>
<p>配置环境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd php mariadb-server php-mysql</span><br></pre></td></tr></table></figure>
<p>启动相应服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start httpd mariadb</span><br></pre></td></tr></table></figure>
<p>为数据库设置root账号密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root password “XXXXXXXX”</span><br></pre></td></tr></table></figure>
<p>创建一个名为wordpress的数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database wordpress;</span><br></pre></td></tr></table></figure>
<p>下载wordpress</p>
<p>wget <a href="http://wordpress.org/latest.tar.gz" target="_blank" rel="noopener">http://wordpress.org/latest.tar.gz</a></p>
<p>解压安装包</p>
<p>tar –zxf latest.tar.gz -C /var/www/html</p>
<p>注意wordpress目录权限</p>
<p>setfacl -R -m u:apache:rwx /var/www/html/wordpress</p>
<p>重启httpd服务</p>
<p>systemctl restart httpd</p>
<p>浏览器打开：<a href="http://192.168.30.10/wordpress" target="_blank" rel="noopener">http://192.168.30.10/wordpress</a></p>
<p>简单的进行一些配置，即可完成wordpress的搭建</p>
<p>![DLH}ZHW]<a href="http://www.178linux.com/wp-content/uploads/2018/06/DLHZHWGR6Q_QTE3DQSU2.png" target="_blank" rel="noopener">GR6Q_QTE3DQSU2</a></p>
<h2 id="五、实验：centos7上源码编译安装LAMP的多虚拟主机wordpress，discuz"><a href="#五、实验：centos7上源码编译安装LAMP的多虚拟主机wordpress，discuz" class="headerlink" title="五、实验：centos7上源码编译安装LAMP的多虚拟主机wordpress，discuz"></a><strong>五、实验：centos7上源码编译安装LAMP的多虚拟主机wordpress，discuz</strong></h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>虚拟机两台</p>
<p><strong>LAMP server：</strong> CentOS 7.5，完全干净的系统环境  IP：192.168.30.17</p>
<p><strong>Client：</strong>              CentOS7.4                                           IP：192.168.30.10</p>
<p>准备以下安装包</p>
<p><strong>apr-1.6.3.tar.gz</strong>                    </p>
<p><strong>apr-util-1.6.1.tar.gz</strong></p>
<p><strong>httpd-2.4.33.tar.bz2</strong> </p>
<p><strong>mariadb-10.2.15-linux-x86_64.tar.gz</strong> </p>
<p><strong>php-7.1.18.tar.bz2</strong></p>
<p><strong>wordpress-4.9.4-zh_CN.tar.gz</strong></p>
<p><strong>Discuz_X3.3_SC_UTF8.zip</strong></p>
<h3 id="1-编译安装httpd"><a href="#1-编译安装httpd" class="headerlink" title="1.编译安装httpd"></a><strong>1.编译安装httpd</strong></h3><p>tar xvf httpd-2.4.33.tar.bz2</p>
<p>tar xvf apr-1.6.3.tar.gz</p>
<p>tar xvf apr-util-1.6.1.tar.gz</p>
<p>cp -av apr-util-1.6.1 httpd-2.4.33/srclib/apr-util</p>
<p>cp -av apr-1.6.3 httpd-2.4.33/srclib/apr</p>
<p>./configure –prefix=/app/httpd24 \</p>
<p>–enable-so \</p>
<p>–enable-ssl \</p>
<p>–enable-cgi \</p>
<p>–enable-rewrite \</p>
<p>–with-zlib \</p>
<p>–with-pcre \</p>
<p>–with-included-apr \</p>
<p>–enable-modules=most \</p>
<p>–enable-mpms-shared=all \</p>
<p>–with-mpm=prefork</p>
<p>make &amp;&amp; make install</p>
<p>echo PATH=/app/httpd24/bin:$PATH &gt; /etc/profile.d/lamp.sh</p>
<p>. /etc/profile.d/lamp.sh</p>
<p>开启httpd服务</p>
<p>apachectl</p>
<h3 id="2-二进制安装mariadb"><a href="#2-二进制安装mariadb" class="headerlink" title="2.二进制安装mariadb"></a><strong>2.二进制安装mariadb</strong></h3><p>tar xvf mariadb-10.2.15-linux-x86_64.tar.gz  -C /usr/local/</p>
<p><strong>cd /usr/local/</strong></p>
<p>ln -s mariadb-10.2.15-linux-x86_64/ mysql</p>
<p>useradd -r -s /sbin/nologin mysql</p>
<p>chown -R mysql.mysql  mysql/</p>
<p>mkdir /data/mysql -pv</p>
<p>chown mysql.mysql /data/mysql/</p>
<p><strong>vim /etc/profile.d/lamp.sh</strong></p>
<p>PATH=/appl/httpd24/bin:/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</p>
<p>. /etc/profile.d/lamp.sh</p>
<p><strong>cd mysql/</strong></p>
<p>./scripts/mysql_install_db –datadir=/data/mysql –user=mysql</p>
<p><strong>vim /etc/my.cnf</strong></p>
<p>datadir=/data/mysql</p>
<p>chkconfig –add mysqld</p>
<p>chkconfig –list</p>
<p>service mysqld start</p>
<p>ss -ntl</p>
<p><img src="1-37.png" alt="1"></p>
<p>创建wordpress数据库，和管理用户</p>
<p>MariaDB [(none)]&gt; create database wordpress;</p>
<p>MariaDB [(none)]&gt; grant all on wordpress.* to wpuser@’192.168.30.%’ identified by ‘centos’;</p>
<h3 id="3-编译安装fastcgi模式的php"><a href="#3-编译安装fastcgi模式的php" class="headerlink" title="3.编译安装fastcgi模式的php"></a><strong>3.编译安装fastcgi模式的php</strong></h3><p>tar xvf php-7.1.18.tar.bz2</p>
<p><strong>cd php-7.1.18/</strong></p>
<p>./configure –prefix=/app/php \</p>
<p>–enable-mysqlnd \</p>
<p>–with-mysqli=mysqlnd \</p>
<p>–with-openssl \</p>
<p>–with-pdo-mysql=mysqlnd \</p>
<p>–enable-mbstring \</p>
<p>–with-freetype-dir \</p>
<p>–with-jpeg-dir \</p>
<p>–with-png-dir \</p>
<p>–with-zlib \</p>
<p>–with-libxml-dir=/usr \</p>
<p>–enable-xml \</p>
<p>–enable-sockets \</p>
<p>–enable-fpm \</p>
<p>–with-config-file-path=/etc \</p>
<p>–with-config-file-scan-dir=/etc/php.d \</p>
<p>–enable-maintainer-zts \</p>
<p>–disable-fileinfo</p>
<p>make &amp;&amp; make install</p>
<p><strong>cd /root/srcs/php-7.1.18/</strong></p>
<p>cp php.ini-production /etc/php.ini</p>
<p>cp sapi/fpm/init.d.php-fpm /etc/init.d/php-fpm</p>
<p>chmod +x /etc/init.d/php-fpm</p>
<p>chkconfig –add php-fpm</p>
<p>chkconfig php-fpm on</p>
<p><strong>cd /app/php/etc</strong></p>
<p>cp php-fpm.conf.default php-fpm.conf</p>
<p>cp php-fpm.d/<a href="http://www.conf.default" target="_blank" rel="noopener">www.conf.default</a> php-fpm.d/<a href="http://www.conf" target="_blank" rel="noopener">www.conf</a></p>
<p>service php-fpm start</p>
<p>ss -ntl</p>
<p><img src="2-37.png" alt="2"></p>
<p><strong>vim /etc/profile.d/lamp.sh</strong></p>
<p>PATH=/app/php/bin:/app/php/sbin:/app/httpd24/bin:/usr/local/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</p>
<p>. /etc/profile.d/lamp.sh</p>
<p><strong>vim /app/httpd24/conf/httpd.conf</strong></p>
<p>取消下面两行的注释，启用代理功能</p>
<p>LoadModule proxy_module modules/mod_proxy.so</p>
<p>LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so</p>
<p><img src="3-36.png" alt="3"></p>
<p>修改下面行</p>
<ifmodule dir_module><br><br>DirectoryIndex index.php index.html<br><br></ifmodule>

<p>addType application/x-httpd-php .php</p>
<p>AddType application/x-httpd-php-source .phps</p>
<p>ProxyRequests Off</p>
<p>ProxyPassMatch ^/(.*.php)$ fcgi://127.0.0.1:9000/app/httpd24/htdocs/$1</p>
<p><img src="4-27.png" alt="4"></p>
<p>重启httpd服务</p>
<p>apache restart</p>
<h3 id="4-安装wordpress"><a href="#4-安装wordpress" class="headerlink" title="4.安装wordpress"></a><strong>4.安装wordpress</strong></h3><p>解压安装包</p>
<p>tar –zxf  – wordpress-4.9.4-zh_CN.tar.gz -C /app/httpd24/htdocs/blog</p>
<p>注意wordpress目录权限</p>
<p>setfacl -R -m u:apache:rwx /var/www/html/wordpress</p>
<p>重启httpd服务</p>
<p>systemctl restart httpd</p>
<h3 id="5-安装Discuz"><a href="#5-安装Discuz" class="headerlink" title="5.安装Discuz"></a><strong>5.安装Discuz</strong></h3><p>mv Discuz_X3.3_SC_UTF8.zip /app/httpd24/htdocs/bbs/</p>
<p><strong>cd /app/httpd24/htdocs/bbs/</strong></p>
<p>unzip mv Discuz_X3.3_SC_UTF8.zip</p>
<p>配置虚拟主机</p>
<p>修改配置文件，开启虚拟主机配置目录</p>
<p><strong>vim httpd-vhosts.conf</strong></p>
<p># Virtual hosts</p>
<p>Include conf/extra/httpd-vhosts.conf       找到此行，去掉注释</p>
<p>6.配置虚拟主机</p>
<p><strong>vim /app/httpd24/conf/extra/httpd-vhosts.conf</strong></p>
<virtualhost *:80><br><br>​    servername <a href="http://www.blog.com" target="_blank" rel="noopener">www.blog.com</a><br><br>​    documentroot /app/httpd24/htdocs/blog/wordpress<br><br>​    DirectoryIndex index.php<br><br>​    ProxyRequests Off<br><br>​    ProxyPassMatch ^/(.*.php)$ fcgi://127.0.0.1:9000/app/httpd24/htdocs/blog/wordpress/$1<br><br></virtualhost>



<virtualhost *:80><br><br>​    servername <a href="http://www.bbs.com" target="_blank" rel="noopener">www.bbs.com</a><br><br>​    documentroot /app/httpd24/htdocs/bbs<br><br>​    DirectoryIndex index.php<br><br>​    ProxyRequests Off<br><br>​    ProxyPassMatch ^/(.*.php)$ fcgi://127.0.0.1:9000/app/httpd24/htdocs/bbs/$1<br><br></virtualhost>



<h3 id="7-测试："><a href="#7-测试：" class="headerlink" title="7.测试："></a><strong>7.测试：</strong></h3><p>此时切换到另外一台主机访问<a href="http://www.blog.com及www.bbs.com" target="_blank" rel="noopener">www.blog.com及www.bbs.com</a></p>
<p>为了方便实现，这里修改hosts文件模拟DNS</p>
<p>加入此行：</p>
<p><strong>vim /etc/hosts</strong></p>
<p>192.168.30.17 <a href="http://www.blog.com" target="_blank" rel="noopener">www.blog.com</a> <a href="http://www.bbs.com" target="_blank" rel="noopener">www.bbs.com</a></p>
<p>切换到图形界面，打开firefox浏览器直接输入<a href="http://www.blog.com，直接转向了wordpress的安装页面" target="_blank" rel="noopener">www.blog.com，直接转向了wordpress的安装页面</a></p>
<p><img src="6-20.png" alt="6"></p>
<p>输入<a href="http://www.bbs.com，则直接转向了wordpress的安装页面" target="_blank" rel="noopener">www.bbs.com，则直接转向了wordpress的安装页面</a></p>
<p><img src="7-13.png" alt="7"></p>
<p>至此，我们完成了编译LAPM，基于主机头的wordpress和Discuz的安装！</p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/23/PHP简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/23/PHP简介/" itemprop="url">PHP简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-23T16:06:59+08:00">
                2018-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web服务器/" itemprop="url" rel="index">
                    <span itemprop="name">Web服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="PHP简介"><a href="#PHP简介" class="headerlink" title="PHP简介"></a><strong>PHP简介</strong></h2><p><strong>PHP</strong>是通用服务器端脚本编程语言，主要用于web开发实现动态web页面，也是最早实现将脚本嵌入</p>
<p>HTML源码文档中的服务器端脚本语言之一。同时，PHP还提供了一个命令行接口，因此，其也可以</p>
<p>在大多数系统上作为一个独立的shell来使用</p>
<p>官方网站：<a href="http://www.php.net/" target="_blank" rel="noopener">http://www.php.net/</a></p>
<p><img src="封面.jpg" alt="封面"></p>
<h3 id="PHP-文件是什么"><a href="#PHP-文件是什么" class="headerlink" title="PHP 文件是什么?"></a><strong>PHP 文件是什么?</strong></h3><p>PHP 文件可包含文本、HTML、JavaScript代码和 PHP 代码</p>
<p>PHP 代码在服务器上执行，结果以纯 HTML 形式返回给浏览器</p>
<p>PHP 文件的默认文件扩展名是 “.php”</p>
<h3 id="PHP-能做什么"><a href="#PHP-能做什么" class="headerlink" title="PHP 能做什么?"></a><strong>PHP 能做什么?</strong></h3><p>PHP 可以生成动态页面内容</p>
<p>PHP 可以创建、打开、读取、写入、关闭服务器上的文件</p>
<p>PHP 可以收集表单数据</p>
<p>PHP 可以发送和接收 cookies</p>
<p>PHP 可以添加、删除、修改您的数据库中的数据</p>
<p>PHP 可以限制用户访问您的网站上的一些页面</p>
<p>PHP 可以加密数据</p>
<p>通过 PHP，您不再限于输出 HTML。您可以输出图像、PDF 文件，甚至 Flash 电影。您还可以输出任意的文本，</p>
<p>比如 XHTML 和 XML。</p>
<h3 id="为什么使用-PHP"><a href="#为什么使用-PHP" class="headerlink" title="为什么使用 PHP?"></a><strong>为什么使用 PHP?</strong></h3><p>PHP 可在不同的平台上运行（Windows、Linux、Unix、Mac OS X 等）</p>
<p>PHP 与目前几乎所有的正在被使用的服务器相兼容（Apache、IIS 等）</p>
<p>PHP 提供了广泛的数据库支持</p>
<p>PHP 是免费开源的</p>
<p>PHP 易于学习，并可高效地运行在服务器端</p>
<h3 id="php语言格式"><a href="#php语言格式" class="headerlink" title="php语言格式"></a><strong>php语言格式</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">…php code…</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h2 id="基于LINUX系统的PHP布署"><a href="#基于LINUX系统的PHP布署" class="headerlink" title="基于LINUX系统的PHP布署"></a><strong>基于LINUX系统的PHP布署</strong></h2><p>php：脚本语言解释器</p>
<p>配置文件：<strong>/etc/php.ini, /etc/php.d/*.ini</strong></p>
<p>配置文件在php解释器启动时被读取</p>
<p>对配置文件的修改生效方法</p>
<p>Modules：重启httpd服务</p>
<p>FastCGI：重启php-fpm服务</p>
<p>### </p>
<h3 id="Modules配置格式："><a href="#Modules配置格式：" class="headerlink" title="Modules配置格式："></a><strong>Modules配置格式：</strong></h3><p><strong>/etc/php.ini</strong>配置文件格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[foo]：Section Header</span><br><span class="line">directive = value</span><br><span class="line"></span><br><span class="line">注释符：较新的版本中，已经完全使用;进行注释</span><br><span class="line"></span><br><span class="line">\#：		纯粹的注释信息</span><br><span class="line">;：		用于注释可启用的directive</span><br><span class="line"></span><br><span class="line">max_execution_time= 30           最长执行时间30s</span><br><span class="line"></span><br><span class="line">memory_limit 128M                生产不够，可调大</span><br><span class="line"></span><br><span class="line">display_errors off               调试使用，不要打开，否则可能暴露重要信息</span><br><span class="line"></span><br><span class="line">display_startup_errors off       建议关闭</span><br><span class="line"></span><br><span class="line">post_max_size 8M                 最大上传数据大小，生产可能临时要调大，比下面项要大</span><br><span class="line"></span><br><span class="line">upload_max_filesize 2M           最大上传文件，生产可能要调大</span><br><span class="line"></span><br><span class="line">max_file_uploads = 20             同时上传最多文件数</span><br><span class="line"></span><br><span class="line">date.timezone =Asia/Shanghai 		指定时区</span><br><span class="line"></span><br><span class="line">short_open_tag=on                   开启短标签,如&lt;? phpinfo();?&gt;</span><br></pre></td></tr></table></figure>
<p>php.ini的核心配置选项文档：</p>
<p><a href="http://php.net/manual/zh/ini.core.php" target="_blank" rel="noopener">http://php.net/manual/zh/ini.core.php</a></p>
<p>php.ini配置选项列表：</p>
<p><a href="http://php.net/manual/zh/ini.list.php" target="_blank" rel="noopener">http://php.net/manual/zh/ini.list.php</a></p>
<h3 id="FastCGI配置格式："><a href="#FastCGI配置格式：" class="headerlink" title="FastCGI配置格式："></a><strong>FastCGI配置格式：</strong></h3><p>配置文件：<strong>/etc/php.ini，/etc/php.d/*.ini</strong></p>
<p>Module下，重启Httpd服务</p>
<p>FastCGI模式下，重启php-fpm服务</p>
<p>配置文件格式</p>
<p>配置文件格式：[foo]:Section Header</p>
<p>Directive=value</p>
<p>注释符：# 纯粹的注释信息</p>
<p>; 用于注释可启动的指令</p>
<p>说明：在较新的版本中，已经完全使用”;”进行注释</p>
<p>fcgi服务配置文件：<strong>/etc/php-fpm.conf, /etc/php-fpm.d/*.conf</strong></p>
<p>连接池：</p>
<p>​    pm = static|dynamic</p>
<p>static：固定数量的子进程；pm.max_children</p>
<p>  dynamic：子进程数量以动态模式管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pm.max_children</span><br><span class="line">pm.start_servers</span><br><span class="line">pm.min_spare_servers</span><br><span class="line">pm.max_spare_servers</span><br><span class="line">pm.max_requests = 500</span><br></pre></td></tr></table></figure>
<p>确保运行php-fpm进程的用户对session目录有读写权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/php/session</span><br><span class="line">chown apache.apache /var/lib/php/session</span><br></pre></td></tr></table></figure>
<p><strong>配置fastcgi</strong></p>
<p>(1)配置httpd，添加/etc/httpd/conf.d/fcgi.conf配置文件，内容类似</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意：在HTTPD服务器上必须启用proxy_fcgi_module模块，充当PHP客户端</p>
<p>httpd –M |grep fcgi</p>
<p><strong>cat /etc/httpd/conf.modules.d/00-proxy.conf</strong></p>
<p>(2)虚拟主机配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/vhosts.conf</span><br><span class="line">    DirectoryIndex index.php</span><br><span class="line">    &lt;VirtualHost *:80&gt;</span><br><span class="line">        ServerName www.b.net</span><br><span class="line">        DocumentRoot /apps/vhosts/b.net</span><br><span class="line">        ProxyRequests Off</span><br><span class="line">        ProxyPassMatch ^/(.*\.php)$ fcgi://127.0.0.1:9000/apps/vhosts/b.net/$1</span><br><span class="line"></span><br><span class="line">        &lt;Directory “/apps/vhosts/b.net”&gt;</span><br><span class="line">             Options None</span><br><span class="line">             AllowOverride None</span><br><span class="line">            Require all granted</span><br><span class="line">         &lt;/Directory&gt;</span><br><span class="line">    &lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<h3 id="php-mysql"><a href="#php-mysql" class="headerlink" title="php-mysql"></a><strong>php-mysql</strong></h3><p>Php连接数据库三种方式：</p>
<p>1)使用mysql扩展连接数据库(渐已淘汰)</p>
<p>2)使用mysqli扩展连接数据库</p>
<p>3)使用pdo扩展连接数据库(主流)；支持mysql外的其他一些数据库</p>
<h3 id="测试代码："><a href="#测试代码：" class="headerlink" title="测试代码："></a><strong>测试代码：</strong></h3><ol>
<li>PHP使用mysql扩展连接数据库的测试代码：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/html/test.php</span><br><span class="line">    &lt;?php</span><br><span class="line">        $conn = mysql_connect(‘mysql_host’,’mysql_username’,’mysql_password’);</span><br><span class="line">        if ($conn)</span><br><span class="line">        echo “OK”;</span><br><span class="line">        else</span><br><span class="line">        echo “Failure”;</span><br><span class="line">        \#echo mysql_error();</span><br><span class="line">        mysql_close();</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<p>​    连接成功返回OK，失败则返回Failure</p>
<ol start="2">
<li>PHP用mysqli扩展连接数据库的测试代码：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/html/test.php</span><br><span class="line">    &lt;?php</span><br><span class="line">        $mysqli=new mysqli(‘mysql_host’,’mysql_username’,’mysql_password’);</span><br><span class="line">        if(mysqli_connect_errno())&#123;</span><br><span class="line">        echo “Failure”;</span><br><span class="line">        $mysqli=null;</span><br><span class="line">        exit;</span><br><span class="line">        &#125;</span><br><span class="line">        echo “OK”;</span><br><span class="line">        $mysqli-&gt;close();</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<p>​    连接成功返回OK，失败则返回Failure</p>
<ol start="3">
<li>PHP使用pdo扩展连接数据库的测试代码1：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/html/test.php</span><br><span class="line">    &lt;?php</span><br><span class="line">        $dsn=’mysql:host=localhost;dbname=mysql’;</span><br><span class="line">        $username=’root’;</span><br><span class="line">        $passwd=’centos’;</span><br><span class="line">        $dbh=new PDO($dsn,$username,$passwd);</span><br><span class="line">        var_dump($dbh);</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<p>​    连接成功返回object(PDO)#1 (0) { } ，失败则返回500状态码</p>
<p>PHP使用pdo扩展连接数据库的测试代码2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/html/test.php</span><br><span class="line">    &lt;?php</span><br><span class="line">        try &#123;</span><br><span class="line">            $user=’root’;</span><br><span class="line">            $pass=’centos’;</span><br><span class="line">            $dbh = new PDO(‘mysql:host=localhost;dbname=mysql’, $user, $pass);</span><br><span class="line">            foreach($dbh-&gt;query(‘SELECT user,host from user’) as $row) &#123;</span><br><span class="line">            print_r($row);</span><br><span class="line">                 &#125;</span><br><span class="line">            $dbh = null;</span><br><span class="line">            &#125; catch (PDOException $e) &#123;</span><br><span class="line">                print “Error!: ” . $e-&gt;getMessage() . “&lt;br/&gt;”;</span><br><span class="line">                die();</span><br><span class="line">          &#125;</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure>
<p>成功返回：Array([user]=&gt;root[0]=&gt;root[host]=&gt;127.0.0.1[1]=&gt;127.0.0.1)…</p>
<p>失败返回：Error!</p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/22/https网络安全协议/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/22/https网络安全协议/" itemprop="url">https网络安全协议</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-22T16:05:44+08:00">
                2018-06-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络技术/" itemprop="url" rel="index">
                    <span itemprop="name">网络技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、https协议介绍"><a href="#一、https协议介绍" class="headerlink" title="一、https协议介绍"></a><strong>一、https协议介绍</strong></h2><p><strong>HTTPS（全称：Hyper Text Transfer Protocol over Secure Socket Layer）</strong>，</p>
<p>是以安全为目标的HTTP通道，简单讲是HTTP的安全版。即HTTP下加入SSL层，HTTPS的安全基础是SSL，</p>
<p>因此加密的详细内容就需要SSL。 https:URL表明它使用了HTTP，但HTTPS存在不同于HTTP的默认端口及一个加</p>
<p>密身份验证层（在HTTP与TCP之间）。</p>
<h3 id="发展历史："><a href="#发展历史：" class="headerlink" title="发展历史："></a><strong>发展历史：</strong></h3><p>这个系统的最初研发由<strong>网景公司</strong>(Netscape)进行，并内置于其浏览器Netscape Navigator中，提供了身份</p>
<p>验证与加密通讯方法。现在它被广泛用于网络安全敏感的通讯，例如交易支付方面。</p>
<h3 id="主要作用："><a href="#主要作用：" class="headerlink" title="主要作用："></a><strong>主要作用：</strong></h3><ol>
<li><p>建立一个信息安全通道，来保证数据传输的安全；</p>
</li>
<li><p>确认网站的真实性，凡是使用了 https 的网站，都可以通过点击浏览器地址栏的锁头标志来查看网站</p>
<p>认证之后的真实信息，也可以通过 CA 机构颁发的安全签章来查询   。</p>
</li>
</ol>
<h3 id="HTTPS与HTTP的区别："><a href="#HTTPS与HTTP的区别：" class="headerlink" title="HTTPS与HTTP的区别："></a><strong>HTTPS与HTTP的区别：</strong></h3><p>1、https协议需要到ca申请证书，一般免费证书很少，需要交费。</p>
<p>2、http是超文本传输协议，信息是明文传输，https 则是具有安全性的ssl加密传输协议。</p>
<p>3、http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。</p>
<p>4、http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证</p>
<p>的网络协议，比http协议安全。</p>
<h3 id="SSL会话的简化过程："><a href="#SSL会话的简化过程：" class="headerlink" title="SSL会话的简化过程："></a><strong>SSL会话的简化过程：</strong></h3><ol>
<li><p>客户端发送可供选择的加密方式，并向服务器请求证书</p>
</li>
<li><p>服务器端发送证书以及选定的加密方式给客户端</p>
</li>
<li><p>客户端取得证书并进行证书验证</p>
<p>如果信任给其发证书的CA</p>
<pre><code>a. 验证证书来源的合法性；用CA的公钥解密证书上数字签名

b. 验证证书的内容的合法性：完整性验证

c. 检查证书的有效期限

d. 检查证书是否被吊销

e. 证书中拥有者的名字，与访问的目标主机要一致
</code></pre></li>
<li><p>客户端生成临时会话密钥（对称密钥），并使用服务器端的公钥加密此数据发送给服务器，完成密钥交换</p>
</li>
<li><p>服务用此密钥加密用户请求的资源，响应给客户端</p>
</li>
</ol>
<p>注意：SSL是基于IP地址实现,单IP的主机仅可以使用一个https虚拟主机</p>
<h2 id="二、实验：实现https"><a href="#二、实验：实现https" class="headerlink" title="二、实验：实现https"></a><strong>二、实验：实现https</strong></h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>两台虚拟机</p>
<p><strong>CA：</strong>       CentOS 7.4      IP：192.168.30.10   </p>
<p><strong>客端户：</strong>CentOS 6.9      IP：192.168.30.11</p>
<h3 id="实验预期："><a href="#实验预期：" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>CA服务器为客户端颁发证书，使其能够实现https访问</p>
<h3 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p><strong>CA端：</strong></p>
<p>生成私钥</p>
<p>(umask 077;openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)</p>
<p>自签名证书</p>
<p>openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650</p>
<p>交互式填写</p>
<p>国家：CN</p>
<p>省份：beijing</p>
<p>城市：beijing</p>
<p>公司名称：lvpx</p>
<p>部门：opt</p>
<p>Common name：lvpx.com</p>
<p><strong>Client端：</strong></p>
<p>生成客户端私钥</p>
<p>(umask 066;openssl genrsa -out httpd.key 1024)</p>
<p>生成证书申请</p>
<p>openssl req -new -key httpd.key -out httpd.csr</p>
<p>交互式填写</p>
<p>国家：CN</p>
<p>省份：beijing</p>
<p>城市：beijing</p>
<p>公司名称：lvpx</p>
<p>部门：opt</p>
<p>Common name：http.lvpx.com</p>
<p>注：国家，省份，公司必须一致才能申请成功</p>
<p>将证书申请发送到CA</p>
<p>scp httpd.csr 192.168.30.10:/root/</p>
<p><strong>CA端：</strong></p>
<p>建立已颁发证书信息列表文件；V：生效；R：吊销；</p>
<p>touch /etc/pki/CA/index.txt</p>
<p>建立证书序列号</p>
<p>echo 0F &gt; /etc/pki/CA/serial     </p>
<p>颁发证书</p>
<p>openssl ca -in httpd.csr -out /etc/pki/CA/certs/httpd.crt -days 730</p>
<p>将证书及CA自授权证书发送到客户端：</p>
<p>scp /etc/pki/CA/certs/httpd.crt 192.168.30.11:/root/</p>
<p>scp /etc/pki/CA/cacert.pem 192.168.30.11:/root/</p>
<p><strong>Client端：</strong></p>
<p>安装加密模块</p>
<p>yum install mod_ssl –y</p>
<p>rpm -ql mod_ssl</p>
<p>修改配置文件其中此三行</p>
<p><strong>vim /etc/httpd/conf.d/ssl.conf</strong></p>
<p>SSLCertificateFile /etc/httpd/conf.d/ssl/httpd.crt</p>
<p>SSLCertificateKeyFile /etc/httpd/conf.d/ssl/httpd.key</p>
<p>SSLCACertificateFile /etc/httpd/conf.d/ssl/cacert.pem</p>
<p>重启httpd服务</p>
<p>service httpd restart</p>
<p>此时打开浏览器已能够正常访问<strong><a href="https://192.168.30.11/" target="_blank" rel="noopener">https://192.168.30.11/</a></strong></p>
<p>显示不安全的页面，这是由于证书未添加到浏览器信任造成的</p>
<p><img src="2-2.jpg" alt="2"></p>
<p>将CA自签名证书导入到浏览器即可安全访问</p>
<h2 id="三、http重定向https"><a href="#三、http重定向https" class="headerlink" title="三、http重定向https"></a><strong>三、http重定向https</strong></h2><p>当我们区域https协议后，就出现了一个问题，此时http与https是可以同时被访问的，那么当用户用http访</p>
<p>问网站时，还是有安全隐患的，如何解决呢？我们只需要将<strong>http重定向到https即可</strong></p>
<p>实现http请求转发至https的URL方法如下：</p>
<h3 id="方法一：重定向"><a href="#方法一：重定向" class="headerlink" title="方法一：重定向"></a><strong>方法一：重定向</strong></h3><p><strong>备注：</strong>有安全隐患，每次请求还会先走http协议</p>
<p><strong>Redirect [status] URL-path URL</strong></p>
<p>status状态：</p>
<p>permanent:  永久301</p>
<p>Temp：        临时302</p>
<p>示例：</p>
<p>Redirect temp / <a href="https://www.magedu.com/" target="_blank" rel="noopener">https://www.magedu.com/</a></p>
<h3 id="方法二：HSTS"><a href="#方法二：HSTS" class="headerlink" title="方法二：HSTS"></a><strong>方法二：HSTS</strong></h3><p><strong>备注：</strong>仅第一次访问会走http协议，建议使用此种方法</p>
<p><strong>HSTS:HTTP Strict Transport Security</strong></p>
<p>服务器端配置支持HSTS后，会在给浏览器返回的HTTP首部中携带HSTS字段。浏览</p>
<p>器获取到该信息后，会将所有HTTP访问请求在内部做307跳转到HTTPS。而无需任何</p>
<p>网络过程</p>
<p><strong>HSTS preload list</strong></p>
<p><strong>作用：</strong>使第一次访问也走https协议</p>
<p>是Chrome浏览器中的HSTS预载入列表，在该列表中的网站，使用Chrome浏览器访</p>
<p>问时，会自动转换成HTTPS。Firefox、Safari、Edge浏览器也会采用这个列表</p>
<h3 id="实现HSTS示例："><a href="#实现HSTS示例：" class="headerlink" title="实现HSTS示例："></a><strong>实现HSTS示例：</strong></h3><p><strong>vim /etc/httpd/conf/httpd.conf</strong></p>
<p>Header always set Strict-Transport-Security “max-age=31536000”</p>
<p>RewriteEngine on</p>
<p>RewriteRule ^(/.*)$ https://%{HTTP_HOST}$1 [redirect=302]</p>
<p>curl -I  <a href="http://www.taobao.com" target="_blank" rel="noopener">www.taobao.com</a></p>
<p>Strict-Transport-Security: max-age=31536000</p>
<h2 id="四、云主机实现免费的https"><a href="#四、云主机实现免费的https" class="headerlink" title="四、云主机实现免费的https"></a><strong>四、云主机实现免费的https</strong></h2><p>现在许多云服务厂商都提供了免费的域名型加密SSL证书，仅对域名所有权进行验证，快速颁发，较好保</p>
<p>护网站数据安全，适合个人，小微企业应用。</p>
<p>本次就以在腾讯云申请免费SSL证书为例：</p>
<p>腾讯云官方网站：<a href="https://cloud.tencent.com/" target="_blank" rel="noopener">https://cloud.tencent.com</a></p>
<p>1登录进入页面后点击上方+号，添加SSL证书管理</p>
<p><img src="3-34.png" alt="3"></p>
<p>2点击申请证书，显示证书颁发机构为<strong>亚洲诚信(TRUSTASIA)</strong>，证书有效期为一年</p>
<p><img src="4-26.png" alt="4"></p>
<p>3.点击确定后，会要求输入域名，申请邮箱等信息，按需填写即可</p>
<p><img src="5-24.png" alt="5"></p>
<p>4.接下来会进行域名身份验证，这里我们选择选择手动DNS验证<img src="6-21.png" alt="6"></p>
<p>5.点击确认申请，生成解析记录</p>
<p><img src="7-14.png" alt="7"></p>
<p>接下来我们需要等待10分钟左右证书审核通过</p>
<p>6.回到我们的域名DNS管理页，添加一条TXT/SPF的解析</p>
<p><strong>HOSTNAME</strong>填写腾讯云解析记录中的主机记录</p>
<p><strong>TEXT</strong>填写记录值</p>
<p><img src="8-6.png" alt="8"></p>
<p>7.证书申请完成后，就可以点击下载了</p>
<p><img src="9-4.png" alt="9"></p>
<p>8.根据自己web服务类型，进行后续配置</p>
<p>腾讯云官方证书安装方法指引文档：<a href="https://cloud.tencent.com/document/product/400/4143" target="_blank" rel="noopener">https://cloud.tencent.com/document/product/400/4143</a></p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/21/Apache介绍及常用配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/21/Apache介绍及常用配置/" itemprop="url">Apache介绍及常用配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-21T17:09:23+08:00">
                2018-06-21
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web服务器/" itemprop="url" rel="index">
                    <span itemprop="name">Web服务器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、Apache介绍"><a href="#一、Apache介绍" class="headerlink" title="一、Apache介绍"></a><strong>一、Apache介绍</strong></h2><p><strong>Apache</strong>是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，</p>
<p>由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。</p>
<p>它快速、可靠并且可通过简单的API扩充，将Perl/Python等解释器编译到服务器中。</p>
<p>官方网站：<a href="http://httpd.apache.org/" target="_blank" rel="noopener">http://httpd.apache.org/</a></p>
<h3 id="发展历史："><a href="#发展历史：" class="headerlink" title="发展历史："></a><strong>发展历史：</strong></h3><p>20世纪90年代初，国家超级计算机应用中心NCSA开发</p>
<p>1995年开源社区发布apache（a patchy server）</p>
<p><strong>ASF:</strong> apache software foundation</p>
<p><strong>FSF：</strong>Free Software Foundation</p>
<h3 id="特性："><a href="#特性：" class="headerlink" title="特性："></a><strong>特性：</strong></h3><ol>
<li>高度模块化：core+modules</li>
<li>动态加/卸载：DSO(Dynamic Shared Object)</li>
<li>多路处理模块：MPM(multi-processing module)</li>
</ol>
<h3 id="功能特性："><a href="#功能特性：" class="headerlink" title="功能特性："></a><strong>功能特性：</strong></h3><ul>
<li><p><strong>虚拟主机:</strong> 基于<strong>IP、Port、FQDN</strong>的建立的</p>
</li>
<li><p><strong>CGI(通用网关接口):</strong></p>
<p>​        CGI是WWW技术中最重要的技术之一，有着不可替代的重要地位。CGI是外部应用程序与WEB服务器之间的接口标准，是在CGI程序和Web服务器之间传递信息的过程。CGI规范允许Web服务器执行外部程序，并将它们的输出发送给Web浏览器，CGI将Web的一组简单的静态超媒体文档变成一个完整的新的交互式媒体。</p>
</li>
<li><p><strong>反向代理</strong></p>
<p>​        是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器 </p>
</li>
<li><p><strong>负载均衡</strong></p>
<p>​        负载均衡建立在现有网络结构之上，它提供了一种廉价有效透明的方法扩展网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性 </p>
</li>
<li><p><strong>路径别名</strong></p>
</li>
<li><p><strong>丰富的用户认证机制</strong></p>
<p>​    basic：明文传输密码信息认证机制</p>
<p>​    digestL：加密传输密码认证机制</p>
</li>
<li><p><strong>支持第三方模块</strong></p>
</li>
</ul>
<h3 id="Httpd安装及主要文件"><a href="#Httpd安装及主要文件" class="headerlink" title="Httpd安装及主要文件"></a><strong>Httpd安装及主要文件</strong></h3><p><strong>版本：</strong></p>
<p>​    CentOS 6：2.2</p>
<p>​    CentOS 7：2.4</p>
<p><strong>安装方式：</strong></p>
<ol>
<li>rpm，yum：centos发行版，稳定，建议使用</li>
<li>编译安装：定制或特殊需求</li>
</ol>
<h3 id="CentOS-6程序环境：httpd-2-2"><a href="#CentOS-6程序环境：httpd-2-2" class="headerlink" title="CentOS 6程序环境：httpd-2.2"></a>CentOS 6程序环境：httpd-2.2</h3><p><strong>配置文件：</strong></p>
<p>​       /etc/httpd/conf/httpd.conf</p>
<p>​       /etc/httpd/conf.d/*.conf</p>
<p><strong>检查配置语法：</strong></p>
<p>​    httpd –t</p>
<p>​    service httpd configtest</p>
<p><strong>服务脚本：</strong>/etc/rc.d/init.d/httpd</p>
<p><strong>脚本配置文件：</strong>/etc/sysconfig/httpd</p>
<p><strong>服务控制和启动：</strong></p>
<p>​    chkconfig httpd on|off</p>
<p>​    service {start|stop|restart|status|configtest|reload} httpd</p>
<p><strong>站点网页文档根目录：</strong></p>
<p>​    /var/www/html</p>
<p><strong>模块文件路径：</strong></p>
<p>​    /etc/httpd/modules</p>
<p>​    /usr/lib64/httpd/modules</p>
<p><strong>主程序文件：</strong></p>
<p>​    /usr/sbin/httpd</p>
<p>​    /usr/sbin/httpd.worker</p>
<p>​    /usr/sbin/httpd.event</p>
<p><strong>主进程文件：</strong></p>
<p>​    /etc/httpd/run/httpd.pid</p>
<p><strong>日志文件目录：</strong></p>
<p>​    /var/log/httpd</p>
<p>​        access_log: 访问日志</p>
<p>​        error_log：错误日志</p>
<p><strong>帮助文档包：</strong></p>
<p>​    httpd-manual</p>
<p><strong>Apache</strong>是一个模块化的程序，管理员可以选择一些模块来增加服务器的某些功能。</p>
<p>这些模块，可以在创建服务器程序时静态地编译到httpd服务器的二进制代码中，</p>
<p>也可以编译成一些独立于服务器程序的DynamicShared Objects (DSOs)文件</p>
<p>模块索引官方文档：<a href="http://httpd.apache.org/docs/2.4/mod/" target="_blank" rel="noopener">http://httpd.apache.org/docs/2.4/mod/</a></p>
<p><strong>查看静态编译的模块:</strong> httpd -l</p>
<p><strong>查看静态编译及动态装载的模块:</strong>    httpd –M</p>
<p><strong>动态模块加载:</strong>不需重启即生效</p>
<p><strong>动态模块路径:</strong>/usr/lib64/httpd/modules/</p>
<h3 id="httpd-2-4"><a href="#httpd-2-4" class="headerlink" title="httpd-2.4"></a>httpd-2.4</h3><p> <strong>新特性</strong></p>
<ul>
<li><p>MPM支持运行为DSO机制；以模块形式按需加载</p>
</li>
<li><p>event MPM生产环境可用</p>
</li>
<li><p>异步读写机制</p>
</li>
<li><p>支持每模块及每目录的单独日志级别定义</p>
</li>
<li><p>每请求相关的专用配置</p>
</li>
<li><p>增强版的表达式分析式</p>
</li>
<li><p>毫秒级持久连接时长定义</p>
</li>
<li><p>基于FQDN的虚拟主机不需要NameVirutalHost指令</p>
</li>
<li><p>新指令，AllowOverrideList</p>
</li>
<li><p>支持用户自定义变量</p>
</li>
<li><p>更低的内存消耗</p>
</li>
<li><p>修改了一些配置机制</p>
<p>不再支持使用Order, Deny, Allow来做基于IP的访问控制</p>
</li>
<li><p>新模块</p>
<ol>
<li><p>mod_proxy_fcgi: 用于MODY代理的FASCGI协议后端</p>
</li>
<li><p>mod_remoteip: </p>
<p>替换表观客户端远程IP地址用IP地址列表请求的主机名由代理或负载平衡器通过请求报头。</p>
</li>
<li><p>mod_ratelimit: 为客户端提供带宽速率限制</p>
</li>
</ol>
</li>
</ul>
<h3 id="CentOS-7程序环境："><a href="#CentOS-7程序环境：" class="headerlink" title="CentOS 7程序环境："></a>CentOS 7程序环境：</h3><p><strong>安装方法：</strong>rpm，编译安装</p>
<p><strong>配置文件：</strong></p>
<p>​    /etc/httpd/conf/httpd.conf<br>    /etc/httpd/conf.d/*.conf</p>
<p><strong>模块相关的配置文件：</strong></p>
<p>​    /etc/httpd/conf.modules.d/*.conf</p>
<p>​    systemd unit file：</p>
<p>​    /usr/lib/systemd/system/httpd.service</p>
<p><strong>主程序文件：</strong></p>
<p>​    /usr/sbin/httpd<br>    httpd-2.4支持MPM的动态切换</p>
<p><strong>日志文件：</strong></p>
<p>​    /var/log/httpd<br>        access_log：访问日志<br>        error_log：错误日志</p>
<p><strong>站点文档：</strong></p>
<p>​    /var/www/html</p>
<p><strong>模块文件路径：</strong></p>
<p>​    /usr/lib64/httpd/modules </p>
<p><strong>服务控制：</strong></p>
<p>​    systemctl enable|disable httpd.service<br>    systemctl {start|stop|restart|status} httpd.service</p>
<h2 id="二、httpd-2-2常用设置"><a href="#二、httpd-2-2常用设置" class="headerlink" title="二、httpd-2.2常用设置"></a><strong>二、httpd-2.2常用设置</strong></h2><p><strong>httpd配置文件的组成：</strong></p>
<p>grep “Section”  /etc/httpd/conf/httpd.conf ：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">### Section 1: Global Environment： 全局设置</span><br><span class="line">### Section 2: &apos;Main&apos; server configuration： 主服务器</span><br><span class="line">### Section 3: Virtual Hosts：虚拟主机</span><br></pre></td></tr></table></figure>
<p> <strong>配置格式：</strong> directive value<br>    directive: 不区分字符大小写<br>    value: 为路径时，是否区分大小写，取决于文件系统</p>
<h3 id="1-服务器版本信息显示格式"><a href="#1-服务器版本信息显示格式" class="headerlink" title="1. 服务器版本信息显示格式"></a><strong>1. 服务器版本信息显示格式</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ServerTokens Major|Minor|Min[imal]|Prod[uctOnly]|OS|Full</span><br><span class="line">ServerTokens Prod[uctOnly] ：Server: Apache</span><br><span class="line">ServerTokens Major: Server: Apache/2</span><br><span class="line">ServerTokens Minor: Server: Apache/2.0</span><br><span class="line">ServerTokens Min[imal]: Server: Apache/2.0.41</span><br><span class="line">ServerTokens OS: Server: Apache/2.0.41 (Unix)</span><br><span class="line">ServerTokens Full (or not specified): Server: Apache/2.0.41 (Unix) PHP/4.2.2MyMod/1.2</span><br></pre></td></tr></table></figure>
<p>建议使用：<strong>ServerTokens Prod</strong></p>
<p>示例：</p>
<p>​    当使用curl –I命令访问一台主机时，系统默认： ServerTokens OS</p>
<p><img src="3-29.png" alt="2"></p>
<p>​    修改为：ServerToken Prod</p>
<p><img src="3-30.png" alt="3"></p>
<h3 id="2-修改监听的IP和Port"><a href="#2-修改监听的IP和Port" class="headerlink" title="2. 修改监听的IP和Port"></a><strong>2. 修改监听的IP和Port</strong></h3><p><strong>Listen [IP:]PORT</strong></p>
<p>(1) 省略IP表示为本机所有IP</p>
<p>(2) Listen指令至少一个，可重复出现多次</p>
<p>​    Listen 80</p>
<p>​    Listen 8080</p>
<p>示例：vim /etc/httpd/conf/httpd.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Listen 192.168.1.7:8080</span><br><span class="line">Lsten 80</span><br></pre></td></tr></table></figure>
<p>注：当主配置文件/etc/httpd/conf/httpd.conf以及 /etc/httpd/conf.d目录下同时有Listen指令时，将同时生效</p>
<h3 id="3-持久连接"><a href="#3-持久连接" class="headerlink" title="3.持久连接"></a><strong>3.持久连接</strong></h3><p><strong>Persistent Connection：</strong>连接建立，每个资源获取完成后不会断开连接，而是继续等待其它的请求完成，</p>
<p>默认关闭持久连接</p>
<p>断开条件：数量限制：100</p>
<p>时间限制：以秒为单位， httpd-2.4 支持毫秒级</p>
<p>副作用：对并发访问量较大的服务器，持久连接功能会使用有些请求得不到响应</p>
<p>折衷：使用较短的持久连接时间</p>
<p>设置： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KeepAlive On|Off     # 开启或关闭持久连接</span><br><span class="line">KeepAliveTimeout 15  # 设置持久连接的时间限制</span><br><span class="line">MaxKeepAliveRequests 100     # 设置断开持久连接的数量限制</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">telnet WEB_SERVER_IP PORT</span><br><span class="line">GET /URL HTTP/1.1</span><br><span class="line">Host: WEB_SERVER_IP</span><br></pre></td></tr></table></figure>
<h3 id="4-MPM-多路处理模块"><a href="#4-MPM-多路处理模块" class="headerlink" title="4. MPM 多路处理模块"></a><strong>4. MPM 多路处理模块</strong></h3><p>​    经过适当的配置，可以提高服务器的负载能力。</p>
<p>​    原理是通过增加服务进程数量使服务器可以同时处理更多用户请求。</p>
<p>​    三种模式：prefork, worker, event（2.2为试验阶段）</p>
<p>​    httpd-2.2不支持同时编译多个模块，所以只能编译时选定一个；rpm安装</p>
<p>​    的包提供三个二进制程序文件，分别用于实现对不同MPM机制的支持</p>
<p>​    确认方法：</p>
<p>​    httpd –V</p>
<p><img src="1-29.png" alt="1"></p>
<p>​    ps aux | grep httpd</p>
<p>​     <strong>默认</strong>为/usr/sbin/httpd, 即<strong>prefork</strong>模式</p>
<p>​    <strong>更换使用的httpd程序：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysconfig/httpd</span><br><span class="line">  HTTPD=/usr/sbin/httpd.worker   #切换worker模式,也可切换成其他模式</span><br></pre></td></tr></table></figure>
<p>​     <strong>重启服务生效</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service httpd restart  </span><br><span class="line">pstree -p|grep httpd   # 查看进程和线程发现httpd</span><br></pre></td></tr></table></figure>
<p>  <strong>Httpd 2.4 与之不同</strong></p>
<p>​    <strong>以动态模块方式提供</strong></p>
<p>   <strong>配置文件：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.modules.d/00-mpm.conf</span><br><span class="line"></span><br><span class="line">httpd –M |grep mpm</span><br></pre></td></tr></table></figure>
<p>   <strong>重启服务生效</strong></p>
<p>​    pstree -p|grep httpd 查看进程和线程</p>
<h4 id="prefork："><a href="#prefork：" class="headerlink" title="prefork："></a><strong>prefork：</strong></h4><p>多进程I/O模型，每个进程响应一个请求，默认模型</p>
<p>一个主进程：生成和回收n个子进程，创建套接字，不响应请求</p>
<p>多个子进程：工作work进程，每个子进程处理一个请求；系统初始时，预先生成多个空闲进程，等待请求，最大不超过1024个</p>
<p><strong>优点：</strong>成熟稳定，兼容所有新老模块。同时，不需要担心线程安全的问题。（我们常用的mod_php，PHP的拓展不需要支持线程安全）</p>
<p><strong>缺点：</strong>一个进程相对占用更多的系统资源，消耗更多的内存。而且，它并不擅长处理高并发请求，在这种场景下，它会将请求放进队列中，一直等到有可用进程，请求才会被处理。</p>
<p><strong>prefork的默认配置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule prefork.c&gt;</span><br><span class="line"></span><br><span class="line">StartServers 8 服务启动时，预先同时开启几个进程</span><br><span class="line"></span><br><span class="line">MinSpareServers 5</span><br><span class="line"></span><br><span class="line">MaxSpareServers 20</span><br><span class="line"></span><br><span class="line">ServerLimit 256 最多进程数,最大20000</span><br><span class="line"></span><br><span class="line">MaxClients 256 最大并发</span><br><span class="line"></span><br><span class="line">MaxRequestsPerChild 4000 子进程最多能处理的请求数量。在处理MaxRequestsPerChild 个请求之后,子进程将会被父进程终止，这时候子进程占用的内存就会释放(为0时永远不释放）</span><br><span class="line"></span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>
<h4 id="worker："><a href="#worker：" class="headerlink" title="worker："></a><strong>worker：</strong></h4><p>复用的多进程I/O模型,多进程多线程，IIS使用此模型</p>
<p>一个主进程：生成m个子进程，每个子进程负责生个n个线程，每个线程响应一个请求，并发响应请求：m*n</p>
<p><strong>优点：</strong>占据更少的内存，高并发下表现更优秀。</p>
<p><strong>缺点：</strong>必须考虑线程安全的问题，因为多个子线程是共享父进程的内存地址的。</p>
<p>如果使用keep-alive的长连接方式，某个线程会一直被占据，也许中间几乎没有请求，需要一直等待到超时才会被</p>
<p>释放。如果过多的线程，被这样占据，也会导致在高并发场景下的无服务线程可用。（该问题在prefork模式下，</p>
<p>同样会发生）</p>
<p><strong>worker的默认配置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule worker.c&gt;</span><br><span class="line"></span><br><span class="line">StartServers 4</span><br><span class="line"></span><br><span class="line">MaxClients 300</span><br><span class="line"></span><br><span class="line">MinSpareThreads 25</span><br><span class="line"></span><br><span class="line">MaxSpareThreads 75</span><br><span class="line"></span><br><span class="line">ThreadsPerChild 25</span><br><span class="line"></span><br><span class="line">MaxRequestsPerChild 0 无限制</span><br><span class="line"></span><br><span class="line">&lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>
<h4 id="event："><a href="#event：" class="headerlink" title="event："></a><strong>event：</strong></h4><p>事件驱动模型（worker模型的变种）</p>
<p>一个主进程：生成m个子进程，每个进程直接响应n个请求，并发响应请求：m*n，</p>
<p>有专门的线程来管理这些keep-alive类型的线程，当有真实请求时，将请求传递给服务线程，</p>
<p>执行完毕后，又允许释放。这样增强了高并发场景下的请求处理能力</p>
<p>​    httpd-2.2: event 测试版，centos6默认</p>
<p>​    httpd-2.4：event 稳定版，centos7默认</p>
<h3 id="5-DSO-动态共享对象"><a href="#5-DSO-动态共享对象" class="headerlink" title="5. DSO 动态共享对象"></a>5. DSO 动态共享对象</h3><p><strong>加载动态模块配置文件</strong></p>
<p>​    /etc/httpd/conf/httpd.conf</p>
<p><strong>配置指定实现模块加载格式</strong>：</p>
<p>​    LoadModule &lt;mod_name&gt; &lt;mod_path&gt;</p>
<p><strong>模块文件路径可使用相对路径</strong>：</p>
<p>相对于ServerRoot（默认/etc/httpd）</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LoadModule auth_basic_module</span><br><span class="line"></span><br><span class="line">modules/mod_auth_basic.so</span><br></pre></td></tr></table></figure>
<h3 id="6-更改httpd服务默认目录"><a href="#6-更改httpd服务默认目录" class="headerlink" title="6. 更改httpd服务默认目录"></a><strong>6. 更改httpd服务默认目录</strong></h3><p><strong>DocumentRoot  “/path”</strong></p>
<p>文档路径映射：DocumentRoot指向的路径为URL路径的起始位置</p>
<p>示例：</p>
<p>​    DocumentRoot “/app/data”</p>
<p>CentOS7必须给目录授权才能使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory “/app/data”&gt;</span><br><span class="line">    Require all granted</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">http://HOST:PORT/test/index.html</span><br><span class="line">**–&gt;** /app/data/test/index.html</span><br></pre></td></tr></table></figure>
<p>注意：SELinux和iptables的状态</p>
<h3 id="7-定义站点未指定时的默认页面"><a href="#7-定义站点未指定时的默认页面" class="headerlink" title="7. 定义站点未指定时的默认页面"></a><strong>7. 定义站点未指定时的默认页面</strong></h3><p>默认为testing页面：</p>
<p><strong>DirectoryIndex index.html index.html.var</strong></p>
<h3 id="8-基于IP的访问控制"><a href="#8-基于IP的访问控制" class="headerlink" title="8. 基于IP的访问控制:"></a><strong>8. 基于IP的访问控制:</strong></h3><p><strong>CentOS 6：</strong></p>
<p>order和allow、deny</p>
<p>放在directory, .htaccess中</p>
<p>order：定义生效次序；写在后面的表示默认法则</p>
<p>​    Order allow,deny</p>
<p>​    Order deny,allow</p>
<p>Allow from和Deny from：定义客户端地址</p>
<p>客户端地址：</p>
<p>IP</p>
<p>网络: 172.16</p>
<p>172.16.0.0</p>
<p>172.16.0.0/16</p>
<p>172.16.0.0/255.255.0.0</p>
<p><strong>CentOS 7：</strong></p>
<p><strong>无明确授权的目录</strong>，默认拒绝</p>
<p><strong>允许所有主机访问</strong>：Require all granted</p>
<p><strong>拒绝所有主机访问</strong>：Require all denied</p>
<p><strong>控制特定的IP访问</strong>：</p>
<p>​    Require ip IPADDR：授权指定来源的IP访问</p>
<p>​    Require not ip IPADDR：拒绝特定的IP访问</p>
<p><strong>控制特定的主机访问：</strong></p>
<p>​    Require host HOSTNAME：授权特定主机访问</p>
<p>​    Require not host HOSTNAME：拒绝</p>
<p><strong>HOSTNAME：</strong></p>
<p>​    FQDN：特定主机</p>
<p>​    domin.tld：指定域名下的所有主机</p>
<h3 id="9-针对资源进行访问控制"><a href="#9-针对资源进行访问控制" class="headerlink" title="9. 针对资源进行访问控制"></a><strong>9. 针对资源进行访问控制</strong></h3><p>可基于两种机制指明对哪些资源进行何种访问控制</p>
<p>访问控制机制有两种：客户端来源地址，用户账号</p>
<h4 id="文件系统路径："><a href="#文件系统路径：" class="headerlink" title="文件系统路径："></a><strong>文件系统路径：</strong></h4><p><strong>针对目录：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory  “/path”&gt;</span><br><span class="line">…</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p><strong>针对文件，支持通配符：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;File “/path/file”&gt;</span><br><span class="line">…</span><br><span class="line">&lt;/File&gt;</span><br></pre></td></tr></table></figure>
<p><strong>支持正则表达式：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FileMatch “PATTERN”&gt;</span><br><span class="line">…</span><br><span class="line">&lt;/FileMatch&gt;</span><br></pre></td></tr></table></figure>
<h4 id="URL路径："><a href="#URL路径：" class="headerlink" title="URL路径："></a><strong>URL路径：</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Location “”&gt;</span><br><span class="line">…</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">&lt;LocationMatch “”&gt;</span><br><span class="line">…</span><br><span class="line">&lt;/LocationMatch&gt;</span><br></pre></td></tr></table></figure>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch “\.(gif|jpe?g|png)$”&gt;</span><br><span class="line"></span><br><span class="line">&lt;Files “?at.*”&gt; 通配符</span><br><span class="line"></span><br><span class="line">&lt;Location /status&gt;</span><br><span class="line"></span><br><span class="line">&lt;LocationMatch “/(extra|special)/data”&gt;</span><br></pre></td></tr></table></figure>
<h3 id="10-中“基于源地址”实现访问控制"><a href="#10-中“基于源地址”实现访问控制" class="headerlink" title="10 . 中“基于源地址”实现访问控制"></a><strong>10 . <directory>中“基于源地址”实现访问控制</directory></strong></h3><p><strong>(1) Options：</strong>后跟1个或多个以空白字符分隔的选项列表</p>
<p>在选项前的+，- 表示增加或删除指定选项</p>
<p>常见选项：</p>
<p>Indexes：指明的URL路径下不存在与定义的主页面资源相符的资源</p>
<p>文件时，返回索引列表给用户</p>
<p>FollowSymLinks：允许访问符号链接文件所指向的源文件</p>
<p>None：全部禁用</p>
<p>All： 全部允许</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory /web/docs&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory /web/docs/spec&gt;</span><br><span class="line">	Options FollowSymLinks</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory /web/docs&gt;</span><br><span class="line">	Options Indexes FollowSymLinks</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;Directory /web/docs/spec&gt;</span><br><span class="line">	Options +Includes -Indexes</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p><strong>(2) AllowOverride</strong></p>
<p>与访问控制相关的哪些指令可以放在指定目录下的.htaccess（由AccessFileName指定）文件中，</p>
<p>覆盖之前的配置指令</p>
<p>只对<directory>语句有效</directory></p>
<p>​    AllowOverride All: 所有指令都有效</p>
<p>​    AllowOverride None：.htaccess 文件无效</p>
<p>​    AllowOverride AuthConfig Indexes 除了AuthConfig 和Indexes的其它指令都无法覆盖</p>
<h3 id="11-日志设定"><a href="#11-日志设定" class="headerlink" title="11.日志设定"></a><strong>11.日志设定</strong></h3><p><strong>日志类型：</strong> /var/log/httpd</p>
<p>​    访问日志</p>
<p>​    错误日志</p>
<p><strong>错误日志：</strong></p>
<p>​    ErrorLog logs/error_log</p>
<p>​    LogLevel warn     </p>
<p>​    LogLevel 可选值:</p>
<p><strong>debug, info, notice, warn,error,crit, alert, emerg</strong>                越靠后等级越高</p>
<p><strong>访问日志：</strong></p>
<p>定义日志格式：<strong>LogFormat format strings</strong></p>
<p><strong>LogFormat “%h %l %u %t \”%r\” %&gt;s %b \”%{Referer}i\” \”%{User-Agent}i\”” combined</strong></p>
<p>使用日志格式：</p>
<p><strong>CustomLog logs/access_log combined</strong></p>
<p>参考帮助：<a href="http://httpd.apache.org/docs/2.2/mod/mod_log_config.html#formats" target="_blank" rel="noopener">http://httpd.apache.org/docs/2.2/mod/mod_log_config.html#formats</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">%h 客户端IP地址</span><br><span class="line">%l 远程用户,启用mod_ident才有效，通常为减号“-”</span><br><span class="line">%u 验证（basic，digest）远程用户,非登录访问时，为一个减号“-”</span><br><span class="line">%t 服务器收到请求时的时间</span><br><span class="line">%r  First line of request，即表示请求报文的首行；记录了此次请求的“方法”，“URL”以及协议版本</span><br><span class="line">%&gt;s 响应状态码</span><br><span class="line">%b 响应报文的大小，单位是字节；不包括响应报文http首部</span><br><span class="line">%&#123;Referer&#125;i 请求报文中首部“referer”的值；即从哪个页面中的超链接跳转至当前页面的，超链接来源</span><br><span class="line"></span><br><span class="line">%&#123;User-Agent&#125;i  显示浏览器类型；请求报文中首部“User-Agent”的值；即发出请求的应用程序更多的格式选项请参考官方**mod_log_config** 文档</span><br></pre></td></tr></table></figure>
<p><strong>示例：</strong></p>
<p>默认日志中日期显示为：<strong>[21/Jun/2018:17:00:54 +0800]</strong></p>
<p><strong>vim /etc/httpd/conf/httpd.conf</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LogFormat “%h %l %u %t \”%r\” %&gt;s %b \”%&#123;Referer&#125;i\” \”%&#123;User-Agent&#125;i\”” combined找到此行</span><br><span class="line">修改 %t **==&gt;**  %&#123;%F %T&#125;t</span><br><span class="line">再次打开access_log日志日期格式：**2018-06-21 19:02:27**</span><br></pre></td></tr></table></figure>
<h3 id="12-设定默认字符集"><a href="#12-设定默认字符集" class="headerlink" title="12. 设定默认字符集"></a><strong>12. 设定默认字符集</strong></h3><p><strong>/etc/httpd/conf/httpd.conf： AddDefaultCharset UTF-8</strong>  </p>
<p>中文字符集：GBK, GB2312, GB18030</p>
<h3 id="13定义路径别名"><a href="#13定义路径别名" class="headerlink" title="13定义路径别名"></a><strong>13定义路径别名</strong></h3><p><strong>格式： Alias /URL/ “/PATH/”</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DocumentRoot “/www/htdocs”</span><br><span class="line"></span><br><span class="line">http://www.magedu.com/download/bash.rpm</span><br><span class="line"></span><br><span class="line">==&gt;/www/htdocs/download/bash.rpm</span><br><span class="line"></span><br><span class="line">Alias /download/ “/rpms/pub/”</span><br><span class="line"></span><br><span class="line">http://www.magedu.com/download/bash.rpm</span><br><span class="line"></span><br><span class="line">==&gt;/rpms/pub/bash.rpm</span><br><span class="line"></span><br><span class="line">http://www.magedu.com/images/logo.png</span><br><span class="line"></span><br><span class="line">==&gt;/www/htdocs/images/logo.png</span><br><span class="line"></span><br><span class="line">注意：CentOS 7要给重新指定的路径进行grant授权才可访问</span><br><span class="line"></span><br><span class="line">&lt;directory “/rpm/pub”&gt;</span><br><span class="line"></span><br><span class="line">require all granted</span><br><span class="line"></span><br><span class="line">&lt;/directory&gt;</span><br></pre></td></tr></table></figure>
<h3 id="14-基于用户的访问控制"><a href="#14-基于用户的访问控制" class="headerlink" title="14. 基于用户的访问控制"></a><strong>14. 基于用户的访问控制</strong></h3><p>认证质询：<strong>WWW-Authenticate</strong>：响应码为401，拒绝客户端请求，并说明要求客户端提供账号和密码</p>
<p>认证：Authorization：客户端用户填入账号和密码后再次发送请求报文；认证通过时，则服务器发送响应的资源</p>
<p>认证方式两种：</p>
<p>​        <strong>basic：</strong>明文</p>
<p>​        <strong>digest：</strong>消息摘要认证,兼容性差</p>
<p>安全域：需要用户认证后方能访问的路径；应该通过名称对其进行标识，以便于告知用户认证的原因</p>
<p>用户的账号和密码</p>
<p>​    虚拟账号：仅用于访问某服务时用到的认证标识</p>
<p>​    存储：文本文件，SQL数据库，ldap目录存储，nis等</p>
<p>basic认证配置示例：</p>
<ol>
<li>定义安全域</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory “/path”&gt;</span><br><span class="line">Options None</span><br><span class="line">AllowOverride None</span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName “String“</span><br><span class="line">AuthUserFile “/PATH/HTTPD_USER_PASSWD_FILE”</span><br><span class="line">Require user username1 username2 …</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<p>​    允许账号文件中的所有用户登录访问：</p>
<p>​    Require valid-user</p>
<ol start="2">
<li><p>提供账号和密码存储（文本文件）</p>
<p>使用专用命令完成此类文件的创建及用户管理</p>
<p>htpasswd [options] /PATH/HTTPD_PASSWD_FILE username</p>
<p>​    -c：自动创建文件，仅应该在文件不存在时使用</p>
<p>​    -p：明文密码</p>
<p>​    -d：CRYPT格式加密，默认</p>
<p>​    -m：md5格式加密</p>
<p>​    -s:  sha格式加密</p>
<p>​    -D：删除指定用户</p>
</li>
</ol>
<p>基于组账号进行认证</p>
<ol>
<li>定义安全域</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory “/path”&gt;</span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName “String“</span><br><span class="line">AuthUserFile “/PATH/HTTPD_USER_PASSWD_FILE”</span><br><span class="line">AuthGroupFile “/PATH/HTTPD_GROUP_FILE”</span><br><span class="line">Require group grpname1 grpname2 …</span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>创建用户账号和组账号文件</p>
<p>组文件：每一行定义一个组</p>
<p>GRP_NAME: username1 username2 …</p>
</li>
</ol>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory “/www/htdocs/admin”&gt;</span><br><span class="line">    Options None</span><br><span class="line">    AllowOverride None</span><br><span class="line">    AuthType Basic</span><br><span class="line">    AuthName “Administator private”</span><br><span class="line">    AuthUserFile “/etc/httpd/conf.d/.htpasswd”</span><br><span class="line">    AuthGroupFile “/etc/httpd/conf.d/.htgroup”</span><br><span class="line">    Require group webadmins</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">vim /etc/httpd/conf.d/.htgroup</span><br><span class="line"></span><br><span class="line">webadmins:wang mage</span><br></pre></td></tr></table></figure>
<p>远程客户端和用户验证的控制</p>
<p>Satisfy ALL|Any</p>
<p>ALL 客户机IP和用户验证都需要通过才可以</p>
<p>Any客户机IP和用户验证,有一个满足即可</p>
<p>示例：</p>
<p>​    Require valid-user</p>
<p>​    Order allow,deny</p>
<p>​    Allow from 192.168.1</p>
<p>​    Satisfy Any</p>
<h3 id="15-实现用户家目录的http共享"><a href="#15-实现用户家目录的http共享" class="headerlink" title="15. 实现用户家目录的http共享"></a><strong>15. 实现用户家目录的http共享</strong></h3><p>基于模块<strong>mod_userdir.so</strong>实现</p>
<p>​    httpd -M |grep userdir</p>
<p>​    SELinux: http_enable_homedirs</p>
<p><strong>相关设置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line">    &lt;IfModule mod_userdir.c&gt;</span><br><span class="line">        #UserDir disabled</span><br><span class="line">        UserDir public_html #指定共享目录的名称</span><br><span class="line">    &lt;/IfModule&gt;</span><br></pre></td></tr></table></figure>
<p><strong>准备目录</strong></p>
<p>​    su – lpx;mkdir ~/public_html</p>
<p>​    setfacl –m u:apache:x ~lpx</p>
<p><strong>访问</strong></p>
<p><a href="http://localhost/~lpx/index.html" target="_blank" rel="noopener">http://localhost/~lpx/index.html</a></p>
<h3 id="16-status页面"><a href="#16-status页面" class="headerlink" title="16. status页面"></a><strong>16. status页面</strong></h3><p><strong>功能：</strong>显示系统中的状态信息，了解服务器状态，监控用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LoadModule status_module modules/mod_status.so</span><br><span class="line">&lt;Location /server-status&gt;</span><br><span class="line">SetHandler server-status</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">ExtendedStatus On 显示扩展信息</span><br></pre></td></tr></table></figure>
<p><strong>访问：</strong></p>
<p><strong><a href="http://IP:PORT/server-status" target="_blank" rel="noopener">http://IP:PORT/server-status</a></strong>     就可以监控apache服务了下面就是该网页所显示的监控情况：</p>
<p><img src="4-24.png" alt="4"></p>
<p><strong>参数说明：</strong></p>
<p>字段                         说明</p>
<p>Server Version        Apache 服务器的版本。</p>
<p>Server MPM           MPM工作模式</p>
<p>Server Built             Apache 服务器编译安装的时间。</p>
<p>Current Time          目前的系统时间。</p>
<p>Restart Time           Apache 重新启动的时间。</p>
<p>Parent Server Generation        Apache 父程序 (parent process) 的世代编号，就是 httpd 接收到 SIGHUP</p>
<p>而重新启动的次数。</p>
<p>Server uptime         Apache 启动后到现在经过的时间。</p>
<p>Total accesses          到目前为此 Apache 接收的联机数量及传输的数据量。</p>
<p>CPU Usage               目前 CPU 的使用情形。</p>
<p>_SWSS….              所有 Apache process 目前的状态。每一个字符表示一个程序，最多可以显示 256 个程序</p>
<p>的状态。</p>
<p>Scoreboard Key         上述状态的说明。以下为每一个字符符号所表示的意义：</p>
<p>* _：等待连结中。</p>
<p>* S：启动中。</p>
<p>* R：正在读取要求。</p>
<p>* W：正在送出回应。</p>
<p>* K：处于保持联机的状态。</p>
<p>* D：正在查找DNS。</p>
<p>* C：正在关闭连结。</p>
<p>* L：正在写入记录文件。</p>
<p>* G：进入正常结束程序中。</p>
<p>* I：处理闲置。</p>
<p>* .：尚无此程序。</p>
<p>Srv         本程序与其父程序的世代编号。</p>
<p>PID        本程序的process id。</p>
<p>Acc         分别表示本次联机、本程序所处理的存取次数。</p>
<p>M           该程序目前的状态。</p>
<p>CPU       该程序所耗用的CPU资源。</p>
<p>SS           距离上次处理要求的时间。</p>
<p>Req        最后一次处理要求所耗费的时间，以千分之一秒为单位。</p>
<p>Conn      本次联机所传送的数据量。</p>
<p>Child       由该子程序所传送的数据量。</p>
<p>Slot        由该 Slot 所传送的数据量。</p>
<p>Client       客户端的地址。</p>
<p>VHost       属于哪一个虚拟主机或本主机的IP。</p>
<p>Request     联机所提出的要求信息。</p>
<h2 id="三、httpd-2-4常用配置"><a href="#三、httpd-2-4常用配置" class="headerlink" title="三、httpd-2.4常用配置"></a><strong>三、httpd-2.4常用配置</strong></h2><h3 id="1-切换使用的MPM"><a href="#1-切换使用的MPM" class="headerlink" title="1.切换使用的MPM"></a>1.切换使用的MPM</h3><ul>
<li><p>Centos 7:   /etc/httpd/conf.modules.d/00-mpm.conf</p>
<pre><code>启用要启用的MPM相关的LoadModule指令即可
</code></pre></li>
<li><p>centos6编译安装:</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd24/httpd.conf</span><br><span class="line">    Include /etc/httpd24/extra/httpd-mpm.conf</span><br><span class="line">    LoadModule mpm_event_module</span><br><span class="line">    modules/mod_mpm_event.so</span><br></pre></td></tr></table></figure>
<h3 id="2-主目录："><a href="#2-主目录：" class="headerlink" title="2.主目录："></a>2.主目录：</h3><p>​    DocumentRoot /path</p>
<h3 id="3-基于IP的访问控制"><a href="#3-基于IP的访问控制" class="headerlink" title="3.基于IP的访问控制:"></a>3.基于IP的访问控制:</h3><p>无明确授权的目录，默认拒绝<br>允许所有主机访问：Require all granted<br>拒绝所有主机访问：Require all denied<br>控制特定的IP访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Require ip IPADDR：授权指定来源的IP访问</span><br><span class="line">Require not ip IPADDR：拒绝特定的IP访问</span><br></pre></td></tr></table></figure>
<p>控制特定的主机访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Require host HOSTNAME：授权特定主机访问</span><br><span class="line">Require not host HOSTNAME：拒绝</span><br><span class="line">HOSTNAME：</span><br><span class="line">	FQDN：特定主机	</span><br><span class="line">	domin.tld：指定域名下的所有主机</span><br></pre></td></tr></table></figure>
<p> 不能有失败，至少有一个成功匹配才成功，即失败优先</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;RequireAll&gt;</span><br><span class="line">	Require all granted</span><br><span class="line">	Require not ip 172.16.1.1 拒绝特定IP</span><br><span class="line">&lt;/RequireAll&gt;</span><br></pre></td></tr></table></figure>
<p> 多个语句有一个成功，则成功，即成功优先</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;RequireAny&gt;</span><br><span class="line">	Require all denied</span><br><span class="line">	require ip 172.16.1.1 允许特定IP</span><br><span class="line">&lt;/RequireAny&gt;</span><br></pre></td></tr></table></figure>
<h3 id="4-虚拟主机"><a href="#4-虚拟主机" class="headerlink" title="4. 虚拟主机"></a>4. 虚拟主机</h3><p>基于FQDN的虚拟主机不再需要NameVirutalHost指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName www.b.net</span><br><span class="line">    DocumentRoot &quot;/apps/b.net/htdocs&quot;</span><br><span class="line">    &lt;Directory &quot;/apps/b.net/htdocs&quot;&gt;</span><br><span class="line">        Options None</span><br><span class="line">        AllowOverride None</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p>注意：任意目录下的页面只有显式授权才能被访问</p>
<h3 id="5-ssl-安装mod-ssl，和httpd-2-2相同配置"><a href="#5-ssl-安装mod-ssl，和httpd-2-2相同配置" class="headerlink" title="5. ssl:安装mod_ssl，和httpd-2.2相同配置"></a>5. ssl:安装mod_ssl，和httpd-2.2相同配置</h3><h3 id="6-KeepAlive-on"><a href="#6-KeepAlive-on" class="headerlink" title="6. KeepAlive on"></a>6. KeepAlive on</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KeepAliveTimeout #ms</span><br><span class="line">MaxKeepAliveRequests 100	毫秒级持久连接时长定义</span><br></pre></td></tr></table></figure>
<h2 id="四、mod-deflate模块——压缩页面优化传输"><a href="#四、mod-deflate模块——压缩页面优化传输" class="headerlink" title="四、mod_deflate模块——压缩页面优化传输"></a>四、mod_deflate模块——压缩页面优化传输</h2><p><strong>mod_deflate</strong></p>
<p><strong>功能：</strong>压缩页面优化传输速度</p>
<p><strong>官方文档：</strong><a href="http://httpd.apache.org/docs/2.4/mod/mod_deflate.html" target="_blank" rel="noopener">http://httpd.apache.org/docs/2.4/mod/mod_deflate.html</a></p>
<p><strong>适用场景：</strong></p>
<p>(1) 节约带宽，额外消耗CPU；同时，可能有些较老浏览器不支持</p>
<p>(2) 压缩适于压缩的资源，例如文本文件</p>
<p><strong>LoadModule deflate_module modules/mod_deflate.so SetOutputFilter DEFLATE</strong></p>
<p># Restrict compression to these MIME types</p>
<p>AddOutputFilterByType DEFLATE text/plain</p>
<p>AddOutputFilterByType DEFLATE text/html</p>
<p>AddOutputFilterByType DEFLATE application/xhtml+xml</p>
<p>AddOutputFilterByType DEFLATE text/xml</p>
<p>AddOutputFilterByType DEFLATE application/xml</p>
<p>AddOutputFilterByType DEFLATE application/x-javascript</p>
<p>AddOutputFilterByType DEFLATE text/javascript</p>
<p>AddOutputFilterByType DEFLATE text/css</p>
<p>Level of compression (Highest 9 – Lowest 1)                   压缩比(1-9)</p>
<p><strong>DeflateCompressionLevel 9</strong></p>
<p>排除特定旧版本的浏览器，不支持压缩</p>
<p>Netscape 4.x 只压缩text/html</p>
<p>BrowserMatch ^Mozilla/4 gzip-only-text/html</p>
<p>Netscape 4.06-08三个版本 不压缩</p>
<p>BrowserMatch ^Mozilla/4.0[678] no-gzip</p>
<p>Internet Explorer标识本身为“Mozilla / 4”，但实际上是能够处理请求的压缩。</p>
<p>如果用户代理首部匹配字符串“MSIE”（“B”为单词边界”），就关闭之前定</p>
<p>义的限制</p>
<p>BrowserMatch \bMSI[E] !no-gzip !gzip-only-text/html</p>
<p><strong>查看网站是否压缩</strong></p>
<p>方法一：利用curl命令</p>
<p>Curl -I -v –compressed  <a href="http://www.178linux.com/" target="_blank" rel="noopener">http://www.178linux.com</a></p>
<p>方法二：站长工具查询</p>
<p><a href="http://tool.chinaz.com/Gzips/" target="_blank" rel="noopener">http://tool.chinaz.com/Gzips/</a></p>
<p><img src="%E5%8E%8B%E7%BC%A9%E6%9F%A5%E8%AF%A2.png" alt="压缩查询"></p>
<p><strong>示例：</strong></p>
<p>查看mod_deflate.so模块是否已加载</p>
<p><img src="1-30.png" alt="1"></p>
<p>修改配置文件</p>
<p><img src="2-32.png" alt="2"></p>
<p>重启httpd服务即可</p>
<p>systemctl restart httpd</p>
<h2 id="五、centos6-9编译安装httpd2-4-29"><a href="#五、centos6-9编译安装httpd2-4-29" class="headerlink" title="五、centos6.9编译安装httpd2.4.29"></a>五、centos6.9编译安装httpd2.4.29</h2><ol>
<li>解压包</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall &quot;development tools&quot;</span><br><span class="line">yum install openssl-devel pcre-devel expat-devel </span><br><span class="line"></span><br><span class="line">tar xvf apr-1.6.3.tar.bz2 </span><br><span class="line">tar xvf apr-util-1.6.1.tar.bz2 </span><br><span class="line">tar xvf httpd-2.4.29.tar.bz2</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>安装apr和apr-util</li>
</ol>
<p>安装apr-1.4+</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd apr-1.6.2</span><br><span class="line">./configure --prefix=/app/apr</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>安装apr-util-1.4+</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ../apr-util-1.6.0</span><br><span class="line">./configure --prefix=/app/apr-util --with-apr=/app/apr/</span><br><span class="line">make -j 2 &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>编译安装httpd2.4</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/app/httpd24 \</span><br><span class="line">--enable-so \</span><br><span class="line">--enable-ssl \</span><br><span class="line">--enable-cgi \</span><br><span class="line">--enable-rewrite \</span><br><span class="line">--with-zlib \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-apr=/app/apr/ \</span><br><span class="line">--with-apr-util=/app/apr-util/ \</span><br><span class="line">--enable-modules=most \</span><br><span class="line">--enable-mpms-shared=all \</span><br><span class="line">--with-mpm=prefork</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>环境变量</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;PATH=/app/httpd24/bin/:$PATH&apos; &gt; /etc/profile.d/httpd24.sh</span><br><span class="line">. /etc/profile.d/httpd24.sh</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>用户和组</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin apache</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>配置文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /app/httpd24/conf/httpd.conf </span><br><span class="line">    user apache</span><br><span class="line">    group apache</span><br></pre></td></tr></table></figure>
<ol start="7">
<li>开机脚本</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/init.d/httpd /etc/init.d/httpd24</span><br><span class="line">vim /etc/init.d/httpd24</span><br><span class="line">    apachectl=/app/httpd24/bin/apachectl</span><br><span class="line">    httpd=$&#123;HTTPD-/app/httpd24/bin/httpd&#125;</span><br><span class="line">    pidfile=$&#123;PIDFILE-/app/httpd24/logs/httpd.pid&#125;</span><br><span class="line">    lockfile=$&#123;LOCKFILE-/var/lock/subsys/httpd24&#125;</span><br><span class="line"></span><br><span class="line">chkconfig --add httpd24</span><br><span class="line">chkconfig httpd24 on</span><br><span class="line">service httpd24 start</span><br></pre></td></tr></table></figure>
<h2 id="六、实现虚拟主机——单台主机搭建多个网站"><a href="#六、实现虚拟主机——单台主机搭建多个网站" class="headerlink" title="六、实现虚拟主机——单台主机搭建多个网站"></a><strong>六、实现虚拟主机——单台主机搭建多个网站</strong></h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>虚拟机一台，操作系统版本为CentOS 7.4，IP地址：192.168.30.10</p>
<h3 id="1实验：基于端口号的虚拟主机"><a href="#1实验：基于端口号的虚拟主机" class="headerlink" title="1实验：基于端口号的虚拟主机"></a><strong>1实验：基于端口号的虚拟主机</strong></h3><p><strong>实验预期：</strong></p>
<p>搭建三个网站，网站与监听端口对应关系如下：</p>
<p><a href="http://www.a.com" target="_blank" rel="noopener">www.a.com</a>          Listen 81</p>
<p><a href="http://www.b.com" target="_blank" rel="noopener">www.b.com</a>          Listen 82</p>
<p><a href="http://www.c.com" target="_blank" rel="noopener">www.c.com</a>          Listen 83</p>
<p><strong>具体步骤：</strong></p>
<p>创建网站目录</p>
<p>mkdir /data/website{1,2,3} -pv</p>
<p>echo <a href="http://www.a.com" target="_blank" rel="noopener">www.a.com</a> &gt; /data/website1/index.html</p>
<p>echo <a href="http://www.b.com" target="_blank" rel="noopener">www.b.com</a> &gt; /data/website2/index.html</p>
<p>echo <a href="http://www.c.com" target="_blank" rel="noopener">www.c.com</a> &gt; /data/website3/index.html</p>
<p><img src="http://www.178linux.com/wp-content/uploads/2018/06/1-31.png" alt="1"></p>
<p>编写配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/test2.conf</span><br><span class="line"></span><br><span class="line">Listen 81</span><br><span class="line"></span><br><span class="line">listen 82</span><br><span class="line"></span><br><span class="line">listen 83</span><br><span class="line"></span><br><span class="line">&lt;directory “/data/”&gt;</span><br><span class="line"></span><br><span class="line">require all granted</span><br><span class="line"></span><br><span class="line">&lt;/directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:81&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website1”</span><br><span class="line"></span><br><span class="line">ServerName www.a.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/a.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/a.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:82&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website2”</span><br><span class="line"></span><br><span class="line">ServerName www.b.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/b.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/b.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:83&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website3”</span><br><span class="line"></span><br><span class="line">ServerName www.c.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/c.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/c.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p><img src="2-33.png" alt="2"></p>
<p><strong>重启httpd服务</strong></p>
<p>​    systemctl restart httpd</p>
<p><strong>检查端口是否监听状态</strong></p>
<p>​    ss -ntl</p>
<p><img src="3-31.png" alt="3"></p>
<p>浏<strong>览器分别打开IP:port测试网页能否正常显示</strong></p>
<p><img src="4-25.png" alt="4"></p>
<h3 id="2-实验：基于IP地址的虚拟主机"><a href="#2-实验：基于IP地址的虚拟主机" class="headerlink" title="2. 实验：基于IP地址的虚拟主机"></a><strong>2. 实验：基于IP地址的虚拟主机</strong></h3><p><strong>实验预期</strong>：</p>
<p>搭建三个网站，网站与IP地址对应关系如下：</p>
<p><a href="http://www.a.com" target="_blank" rel="noopener">www.a.com</a>          192.168.30.11</p>
<p><a href="http://www.b.com" target="_blank" rel="noopener">www.b.com</a>          192.168.30.22</p>
<p><a href="http://www.c.com" target="_blank" rel="noopener">www.c.com</a>          192.168.30.33</p>
<p><strong>添加IP地址</strong></p>
<p>ip addr add 192.168.30.11/24 dev ens33</p>
<p>ip addr add 192.168.30.22/24 dev ens33</p>
<p>ip addr add 192.168.30.33/24 dev ens33</p>
<p><img src="1-32.png" alt="1"></p>
<p><strong>修改配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/test.conf</span><br><span class="line"></span><br><span class="line">&lt;directory “/data/”&gt;</span><br><span class="line"></span><br><span class="line">require all granted</span><br><span class="line"></span><br><span class="line">&lt;/directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.30.11:80&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website1”</span><br><span class="line"></span><br><span class="line">ServerName www.a.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/a.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/a.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.30.22:80&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website2”</span><br><span class="line"></span><br><span class="line">ServerName www.b.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/b.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/b.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost 192.168.30.33:80&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website3”</span><br><span class="line"></span><br><span class="line">ServerName www.c.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/c.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/c.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p><img src="2-34.png" alt="2"></p>
<p>重启httpd服务</p>
<p>systemctl restart httpd</p>
<p>打开浏览器分别测试</p>
<p><img src="3-32.png" alt="3"></p>
<h3 id="3实验：基于主机头的虚拟主机"><a href="#3实验：基于主机头的虚拟主机" class="headerlink" title="3实验：基于主机头的虚拟主机"></a><strong>3实验：基于主机头的虚拟主机</strong></h3><p><strong>实验预期：</strong></p>
<p>通过主机头可直接访问到网站页面，也是实际应用中最常见的虚拟主机搭建方式</p>
<p><strong>具体步骤：</strong></p>
<p><strong>修改配置文件</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf.d/test.conf</span><br><span class="line"></span><br><span class="line">&lt;directory “/data/”&gt;</span><br><span class="line"></span><br><span class="line">require all granted</span><br><span class="line"></span><br><span class="line">&lt;/directory&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website1”</span><br><span class="line"></span><br><span class="line">ServerName www.a.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/a.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/a.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website2”</span><br><span class="line"></span><br><span class="line">ServerName www.b.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/b.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/b.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line"></span><br><span class="line">DocumentRoot “/data/website3”</span><br><span class="line"></span><br><span class="line">ServerName www.c.com</span><br><span class="line"></span><br><span class="line">Errorlog “logs/c.com.error_log”</span><br><span class="line"></span><br><span class="line">Transferlog “logs/c.con-access_log”</span><br><span class="line"></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p><img src="1-33.png" alt="1"></p>
<p>配置DNS解析，为了方便模拟，我们就在/etc/hosts文件中配置解析</p>
<p><img src="2-35.png" alt="2"></p>
<p>重启httpd服务</p>
<p>systemctl restart httpd</p>
<p>打开浏览器分别访问<a href="http://www.a.com,www.b.com,www.c.com，访问成功" target="_blank" rel="noopener">www.a.com,www.b.com,www.c.com，访问成功</a></p>
<p><img src="3-33.png" alt="3"></p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
		

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/19/HTTP协议介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/19/HTTP协议介绍/" itemprop="url">HTTP协议介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-19T13:35:53+08:00">
                2018-06-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络技术/" itemprop="url" rel="index">
                    <span itemprop="name">网络技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>HTTP协议</strong>(HyperText Transfer Protocol，超文本传输协议)是互联网上应用最为广泛的一种网络协议。</p>
<p>所有的WWW文件都必须遵守这个标准。</p>
<p><strong>HTTP</strong>是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。</p>
<h2 id="一、套接字概念"><a href="#一、套接字概念" class="headerlink" title="一、套接字概念"></a><strong>一、套接字概念</strong></h2><p>跨Internet的主机间通讯时，在建立通信连接的每一端，进程间的传输要有两个标志：</p>
<p>IP地址和端口号，合称为<strong>套接字地址(socket address)</strong></p>
<p>客户机套接字地址定义了一个唯一的客户进程</p>
<p>服务器套接字地址定义了一个唯一的服务器进程</p>
<p><img src="套接字.png" alt="套接字"></p>
<p><strong>Socket: </strong> 套接字，进程间通信IPC的一种实现，允许位于不同主机（或同一主机）上不同进程之间进行通信和数据交换，SocketAPI出现于1983年，4.2 BSD实现</p>
<p><strong>Socket API</strong>：封装了内核中所提供的socket通信相关的系统调用</p>
<p><strong>Socket Domain</strong>：根据其所使用的地址</p>
<p>​         <strong>AF_INET</strong>：Address Family，IPv4</p>
<p>​         <strong>AF_INET6</strong>：IPv6</p>
<p>​         <strong>AF_UNIX</strong>：同一主机上不同进程之间通信时使用</p>
<p><strong>Socket Type</strong>：根据使用的传输层协议</p>
<p>​         <strong>SOCK_STREAM</strong>：流，tcp套接字，可靠地传递、面向连接</p>
<p>​         <strong>SOCK_DGRAM</strong>：数据报，udp套接字，不可靠地传递、无连接</p>
<p>​         <strong>SOCK_RAW</strong>:  裸套接字,无须tcp或tdp,APP直接通过IP包通信</p>
<h3 id="套接字相关的系统调用："><a href="#套接字相关的系统调用：" class="headerlink" title="套接字相关的系统调用："></a><strong>套接字相关的系统调用：</strong></h3><p><strong>socket():</strong> 创建一个套接字</p>
<p><strong>bind()：</strong>绑定IP和端口</p>
<p><strong>listen()：</strong>监听</p>
<p><strong>accept()：</strong>接收请求</p>
<p><strong>connect()：</strong>请求连接建立</p>
<p><strong>write()：</strong>发送</p>
<p><strong>read()：</strong>接收</p>
<p><strong>close():</strong> 关闭连接</p>
<p>相关通信过程如下图：</p>
<p><img src="http通信服务过程1.png" alt="http通信服务过程1"></p>
<p>​<img src="http通信服务过程2.png" alt="http通信服务过程2"></p>
<h2 id="二、HTTP相关术语"><a href="#二、HTTP相关术语" class="headerlink" title="二、HTTP相关术语"></a><strong>二、HTTP相关术语</strong></h2><p><strong>http: Hyper Text Transfer Protocol</strong>, 80/tcp</p>
<p><strong>html: Hyper Text Markup Language</strong> 超文本标记语言，编程语言</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">	&lt;title&gt;html语言&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt;标题1&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;&lt;a href=http://www.lvpeixin.tech&gt;你好&lt;/a&gt;欢迎访问&lt;/p&gt;</span><br><span class="line">    &lt;h2&gt;标题2&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><strong>CSS: Cascading Style Sheet</strong> 层叠样式表</p>
<p><strong>js: javascript</strong> </p>
<p><strong>MIME: Multipurpose Internet Mail Extensions:</strong>多用途互联网邮件扩展 </p>
<p>​     是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。</p>
<p><strong>配置文件：</strong>/etc/mime.types</p>
<p>格式：<strong>major/minor</strong></p>
<p>​       text/plain</p>
<p>​       text/html</p>
<p>​       text/css</p>
<p>​       image/jpeg</p>
<p>​       image/png</p>
<p>​       video/mp4</p>
<p>​       application/javascript</p>
<p>​    参考：<a href="http://www.w3school.com.cn/media/media_mimeref.asp" target="_blank" rel="noopener">http://www.w3school.com.cn/media/media_mimeref.asp</a></p>
<p><strong>URI(Uniform Resource Identifier)</strong>统一资源标识，分为<strong>URL和URN</strong></p>
<p><strong>URN: Uniform Resource Naming</strong>，统一资源命名</p>
<p>​    <strong>示例：</strong> P2P下载使用的磁力链接是URN的一种实现</p>
<p>​         magnet:?xt=urn:btih:660557A6890EF888666</p>
<p><strong>URL: Uniform Resorce Locator</strong>，统一资源定位符，用于描述某服务器某特定资源位置</p>
<h3 id="URN与URL区别："><a href="#URN与URL区别：" class="headerlink" title="URN与URL区别："></a><strong>URN与URL区别：</strong></h3><p>URN如同一个人的名称，而URL代表一个人的住址。换言之，URN定义某事物的身份，</p>
<p>而URL提供查找该事物的方法。URN仅用于命名，而不指定地址</p>
<h3 id="URL的组成"><a href="#URL的组成" class="headerlink" title="URL的组成"></a><strong>URL的组成</strong></h3><p><strong>格式：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</span><br></pre></td></tr></table></figure>
<p><strong>schame:</strong>方案，访问服务器以获取资源时要使用哪种协议</p>
<p><strong>user:</strong>用户，某些方案访问资源时需要的用户名</p>
<p><strong>password:</strong>密码，用户对应的密码，中间用：分隔</p>
<p><strong>Host:</strong>主机，资源宿主服务器的主机名或IP地址</p>
<p><strong>port:</strong>端口,资源宿主服务器正在监听的端口号，很多方案有默认端口号</p>
<p><strong>path:</strong>路径,服务器资源的本地名，由一个/将其与前面的URL组件分隔</p>
<p><strong>params:</strong>参数，指定输入的参数，参数为名/值对，多个参数，用;分隔</p>
<p><strong>query:</strong>查询，传递参数给程序，如数据库，用？分隔,多个查询用&amp;分隔</p>
<p><strong>frag:</strong>片段,一小片或一部分资源的名字，此组件在客户端使用，用#分隔</p>
<p><strong>示例：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://www.lvpeixin.tech:8080/images/logo.jpg</span><br><span class="line">ftp://wang:password@172.16.0.1/pub/linux.ppt</span><br><span class="line">rtsp://videoserver/video_demo/</span><br><span class="line">Real Time Streaming Protocol</span><br><span class="line">http://www.lvpeixin.tech/bbs/hello;gender=f/send;type=title</span><br><span class="line">https://list.jd.com/list.html?cat=670,671,672&amp;ev=149_2992&amp;sort=sort_totalsales15_desc&amp;trans=1</span><br></pre></td></tr></table></figure>
<h3 id="HTTP的历史"><a href="#HTTP的历史" class="headerlink" title="HTTP的历史"></a>HTTP的历史</h3><p><strong>目前主流使用的http版本有1.1版本及2.0版本</strong></p>
<p><strong>http/1.1：1997年1月</strong></p>
<ol>
<li><p>引入了持久连接（persistent connection），即TCP连接默认不关闭，可以被多个请求复用，</p>
<p>不用声明Connection: keep-alive。对于同一个域名，大多数浏览器允许同时建立6个持久连接</p>
</li>
<li><p>引入了管道机制（pipelining），即在同一个TCP连接里，客户端可以同时发送多个请求，</p>
<p>进一步改进了HTTP协议的效率</p>
</li>
<li><p>新增方法：PUT、PATCH、OPTIONS、DELETE</p>
</li>
<li><p>同一个TCP连接里面，所有的数据通信是按次序进行的。服务器只能顺序处理回应，</p>
<p>前面的回应慢，会有许多请求排队，造成”队头堵塞”（Head-of-line blocking）</p>
</li>
<li><p>为避免上述问题，两种方法：一是减少请求数，二是同时多开持久连接。网页优化技巧，</p>
<p>比如合并脚本和样式表、将图片嵌入CSS代码、域名分片（domain sharding）等</p>
</li>
<li><p>HTTP 协议不带有状态，每次请求都必须附上所有信息。请求的很多字段都是重复的，浪费带宽，影响速度</p>
<p><strong>Spdy</strong>：2009年,谷歌研发,解决 HTTP/1.1 效率不高问题</p>
</li>
</ol>
<p><strong>http/2.0：2015年</strong></p>
<ol>
<li><p>头信息和数据体都是二进制，称为头信息帧和数据帧</p>
</li>
<li><p>复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，</p>
<p>且不用按顺序一一对应，避免了“队头堵塞“,此双向的实时通信称为多工（Multiplexing）</p>
</li>
<li><p>引入头信息压缩机制（header compression）,头信息使用gzip或compress压缩后再发送；</p>
<p>客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，不发送同样字段，</p>
<p>只发送索引号，提高速度</p>
</li>
<li><p>HTTP/2 允许服务器未经请求，主动向客户端发送资源，即服务器推送（server push）</p>
</li>
</ol>
<h2 id="三、HTTP工作机制"><a href="#三、HTTP工作机制" class="headerlink" title="三、HTTP工作机制"></a><strong>三、HTTP工作机制</strong></h2><h3 id="工作机制："><a href="#工作机制：" class="headerlink" title="工作机制："></a><strong>工作机制：</strong></h3><p><strong>http请求：</strong>http request</p>
<p><strong>http响应：</strong>http response</p>
<p>一次http事务：<strong>请求&lt;–&gt;响应</strong></p>
<p><img src="请求相应模型.jpg" alt="请求相应模型"></p>
<p><strong>http协议：stateless 无状态</strong></p>
<p>​    服务器无法持续追踪访问者来源</p>
<p><strong>解决http协议无状态方法:</strong></p>
<p>​    cookie  客户端存放</p>
<p>​    session 服务端存放</p>
<h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a><strong>Cookie</strong></h3><p> HTTP 是一种无状态协议。协议自身不对请求和响应之间的通信状态进行保存。也就是说在 HTTP 这个级别，</p>
<p>协议对于发送过的请求或响应都不做持久化处理。这是为了更快地处理大量事务，确保协议的可伸缩性，</p>
<p>而特意把 HTTP 协议设计成如此简单的。可是随着 Web 的不断发展，很多业务都需要对通信状态进行保存。</p>
<p>于是引入了 Cookie 技术。使用 Cookie 的状态管理Cookie 技术通过在请求和响应报文中写入 Cookie 信息来控制</p>
<p>客户端的状态。Cookie 会根据从服务器端发送的响应报文内的一个叫做 Set-Cookie 的首部字段信息，通知客户端</p>
<p>保存Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在请求报文中加入 Cookie 值后发送出去。</p>
<p>服务器端发现客户端发送过来的 Cookie 后，会去检查究竟是从哪一个客户端发来的连接请求，然后对比服务器上</p>
<p>的记录，最后得到之前的状态信息</p>
<p><img src="cookie-2.jpg" alt="cookie"></p>
<h3 id="Web资源：web-resource"><a href="#Web资源：web-resource" class="headerlink" title="Web资源：web resource"></a><strong>Web资源：</strong>web resource</h3><p>一个网页由多个资源构成，打开一个页面，会有多个资源展示出来，但是每个资源都</p>
<p>要单独请求。因此，一个“Web 页面”通常并不是单个资源，而是一组资源的集合</p>
<p><strong>静态文件：</strong>无需服务端做出额外处理</p>
<p>​    文件后缀：.jpg, .html, .txt, .js, .css, .mp3, .avi</p>
<p><strong>动态文件：</strong>服务端执行程序，返回执行的结果</p>
<p>​     文件后缀：.asp, .php, .jsp</p>
<h3 id="提高HTTP连接性能"><a href="#提高HTTP连接性能" class="headerlink" title="提高HTTP连接性能"></a><strong>提高HTTP连接性能</strong></h3><p><strong>并行连接：</strong>通过多条TCP连接发起并发的HTTP请求</p>
<p><strong>持久连接：</strong>keep-alive,长连接，重用TCP连接，以消除连接和关闭的时延,以事务个数和时间来决定是否关闭连接</p>
<p><strong>管道化连接：</strong>通过共享TCP连接发起并发的HTTP请求</p>
<p><strong>复用的连接：</strong>交替传送请求和响应报文（实验阶段）</p>
<p><strong>串行连接：</strong></p>
<p><img src="串行连接.png" alt="串行连接"></p>
<p><strong>并行连接：</strong></p>
<p><img src="并行连接.png" alt="并行连接"></p>
<p><strong>串行、持久连接和管道化连接</strong></p>
<p><img src="持久连接.png" alt="持久连接"></p>
<h2 id="四、HTTP请求过程及相应报文格式"><a href="#四、HTTP请求过程及相应报文格式" class="headerlink" title="四、HTTP请求过程及相应报文格式"></a><strong>四、HTTP请求过程及相应报文格式</strong></h2><h3 id="一次完整的http请求处理过程"><a href="#一次完整的http请求处理过程" class="headerlink" title="一次完整的http请求处理过程"></a>一次完整的http请求处理过程</h3><p><img src="Web服务请求处理步骤.png" alt="Web服务请求处理步骤"></p>
<ol>
<li><p><strong>建立连接：</strong>接收或拒绝连接请求</p>
</li>
<li><p><strong>接收请求：</strong>接收客户端请求报文中对某资源的一次请求的过程</p>
<p>Web访问响应模型（Web I/O）</p>
<ul>
<li>单进程I/O模型：启动一个进程处理用户请求，而且一次只处理一个，多个请求被串行响应</li>
<li>多进程I/O模型：并行启动多个进程,每个进程响应一个连接请求</li>
<li>复用I/O结构：启动一个进程，同时响应N个连接请求<br>实现方法：多线程模型和事件驱动<br>   多线程模型：一个进程生成N个线程，每线程响应一个连接请求<br>   事件驱动：一个进程处理N个请求</li>
<li>复用的多进程I/O模型：启动M个进程，每个进程响应N个连接请求，同时接收M*N个请求</li>
</ul>
</li>
<li><p><strong>处理请求：</strong>服务器对请求报文进行解析，并获取请求的资源及请求方法等相关信息，根据方法，资源，<br> 首部和可选的主体部分对请求进行处理<br> <strong>元数据：</strong>请求报文首部<br>   <strong><method> <url> <version></version></url></method></strong><br> <strong>HEADERS 格式</strong> name:value<br>   <strong><request body></request></strong><br> 示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Host: www.magedu.com 请求的主机名称</span><br><span class="line">Server: Apache/2.4.7</span><br></pre></td></tr></table></figure>
<p><strong>Method:</strong> HTTP常用请求方式<br>   GET、POST、HEAD、PUT、DELETE、TRACE、OPTIONS</p>
</li>
<li><p><strong>访问资源：</strong>服务器获取请求报文中请求的资源web服务器，即存放了web资源的服务器，<br> 负责向请求者提供对方请求的静态资源，或动态运行后生成的资源资源放置于本地文件<br> 系统特定的路径：DocRoot</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DocRoot   /var/www/html</span><br><span class="line">/var/www/html/images/logo.jpg</span><br><span class="line">http://www.lvpeixin.tech/images/logo.jpg</span><br></pre></td></tr></table></figure>
<p>web服务器资源路径映射方式：<br>   a. docroot<br>   b. alias<br>   c. 虚拟主机docroot<br>   d. 用户家目录docroot</p>
</li>
<li><p><strong>构建响应报文</strong>：一旦Web服务器识别除了资源，就执行请求方法中描述的动作，并返回响应报文。<br> 响应报文中 包含有响应状态码、响应首部，如果生成了响应主体的话，还包括响应主体</p>
<ol>
<li><p>响应实体：如果事务处理产生了响应主体，就将内容放在响应报文中回送过去。</p>
<p> 响应报文中通常包括：<br>   描述了响应主体MIME类型的Content-Type首部<br>   描述了响应主体长度的Content-Length<br>   实际报文的主体内容</p>
</li>
<li><p>URL重定向：web服务构建的响应并非客户端请求的资源，而是资源另外一个访问路径</p>
<p>永久重定向：<a href="http://www.360buy.com" target="_blank" rel="noopener">http://www.360buy.com</a><br>临时重定向：<a href="http://www.taobao.com" target="_blank" rel="noopener">http://www.taobao.com</a></p>
</li>
<li><p>MIME类型：Web服务器要负责确定响应主体的MIME类型。多种配置服务器的方法可将MIME类型与资源管理起来</p>
<p><strong>魔法分类：</strong>Apache web服务器可以扫描每个资源的内容，并将其与一个已知模式表(被称为魔法文件)进行匹配，    以决定每个文件的MIME类型。这样做可能比较慢，但很方便，尤其是文件没有标准扩展名时<br><strong>显式分类：</strong>可以对Web服务器进行配置，使其不考虑文件的扩展名或内容，    强制特定文件或目录内容拥有某个MIME类型<br><strong>类型协商：</strong> 有些Web服务器经过配置，可以以多种文档格式来存储资源。在这种情况下，可以配置Web服务器，使其可以通过与用户的协商来决定使用哪种格式(及相关的MIME类型)”最好”</p>
</li>
</ol>
</li>
<li><p><strong>发送响应报文:</strong> Web服务器通过连接发送数据时也会面临与接收数据一样的问题。<br> 服务器可能有很多条到各个客户端的连接，有些是空闲的，有些在向服务器发送数据，<br> 还有一些在向客户端回送响应数据。服务器要记录连接的状态，还要特别注意对持久连接的处理。<br> 对非持久连接而言，服务器应该在发送了整条报文之后，关闭自己这一端的连接。<br> 对持久连接来说，连接可能仍保持打开状态，在这种情况下，服务器要正确地计算Content-Length首部，<br> 不然客户端就无法知道响应什么时候结束了</p>
</li>
<li><p><strong>记录日志:</strong> 最后，当事务结束时，Web服务器会在日志文件中添加一个条目，来描述已执行的事务</p>
</li>
</ol>
<h3 id="request报文"><a href="#request报文" class="headerlink" title="request报文"></a><strong>request报文</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;method&gt; &lt;request-URL&gt; &lt;version&gt;</span><br><span class="line">&lt;headers&gt;</span><br><span class="line">&lt;entity-body&gt;</span><br></pre></td></tr></table></figure>
<p><img src="请求报文.png" alt="请求报文"></p>
<h3 id="response报文"><a href="#response报文" class="headerlink" title="response报文"></a><strong>response报文</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;version&gt; &lt;status&gt; &lt;reason-phrase&gt;</span><br><span class="line">&lt;headers&gt;</span><br><span class="line">&lt;entity-body&gt;</span><br></pre></td></tr></table></figure>
<p><img src="响应报文.png" alt="响应报文"></p>
<p><strong>Mehod属性：</strong></p>
<p>请求方法：标明客户端希望服务器对资源执行的动作</p>
<p><strong>GET：</strong>从服务器获取一个资源</p>
<p><strong>HEAD：</strong>只从服务器获取文档的响应首部</p>
<p><strong>POST：</strong>向服务器输入数据，通常会再由网关程序继续处理</p>
<p><strong>PUT：</strong>将请求的主体部分存储在服务器中，如上传文件</p>
<p><strong>DELETE：</strong>请求删除服务器上指定的文档</p>
<p><strong>TRACE：</strong>追踪请求到达服务器中间经过的代理服务器</p>
<p><strong>OPTIONS：</strong>请求服务器返回对指定资源支持使用的请求方法</p>
<p><strong>version:</strong></p>
<p>​    HTTP/<major>.<minor></minor></major></p>
<p><strong>status:</strong></p>
<p>​    三位数字，如200，301, 302, 404, 502; 标记请求处理过程中发生的情况</p>
<p><strong>reason-phrase：</strong></p>
<p>​    状态码所标记的状态的简要描述</p>
<p><strong>headers：</strong></p>
<p>每个请求或响应报文可包含任意个首部；每个首部都有首部名称，后面跟一个冒号，而后跟一个可选空格，接着是一个值</p>
<p><strong>entity-body：</strong></p>
<p>请求时附加的数据或响应时附加的数据</p>
<h2 id="五、网站访问量统计"><a href="#五、网站访问量统计" class="headerlink" title="五、网站访问量统计"></a><strong>五、网站访问量统计</strong></h2><p><strong>IP(独立IP)</strong>：即Internet Protocol,指独立IP数。一天内来自相同客户机IP地址只计算一次，记录远程客户机IP地址的计算机访问网站的次数，是衡量网站流量的重要指标</p>
<p><strong>PV(访问量)</strong>： 即Page View, 页面浏览量或点击量，用户每次刷新即被计算一次，PV反映的是浏览某网站的页面数，PV与来访者的数量成正比，PV并不是页面的来访者数量，而是网站被访问的页面数量</p>
<p><strong>UV(独立访客)</strong>：即Unique Visitor,访问网站的一台电脑为一个访客。一天内相同的客户端只被计算一次。可以理解成访问某网站的电脑的数量。网站判断来访电脑的身份是通过来访电脑的cookies实现的。如果更换了IP后但不清除cookies，再访问相同网站，该网站的统计中UV数是不变的</p>
<p>网站统计：<a href="http://www.alexa.cn/rank/" target="_blank" rel="noopener">http://www.alexa.cn/rank/</a></p>
<h3 id="网站访问统计示例："><a href="#网站访问统计示例：" class="headerlink" title="网站访问统计示例："></a><strong>网站访问统计示例：</strong></h3><p>甲乙丙三人在同一台通过ADSL上网的电脑上（中间没有断网），分别访问<a href="http://www.lvpeixin.tech" target="_blank" rel="noopener">www.lvpeixin.tech</a> 网站，</p>
<p>并且每人各浏览了2个页面，那么网站的流量统计是：</p>
<p><strong>IP: 1   PV:6   UV:1</strong></p>
<p>若三人都是ADSL重新拨号后,各浏览了2个页面，则</p>
<p><strong>IP: 3   PV:6   UV:1</strong></p>
<p><strong>QPS</strong>：request per second，每秒请求数</p>
<p><strong>QPS= PV* 页⾯衍生连接次数/ 统计时间（86400）</strong></p>
<p><strong>并发连接数 =QPS * http平均响应时间</strong></p>
<p><strong>峰值时间：</strong>每天80%的访问集中在20%的时间里，这20%时间为峰值时间</p>
<p><strong>峰值时间每秒请求数(QPS)=( 总PV数 *页⾯衍⽣连接次数）<em>80% ) / ( 每天秒数</em> 20% )</strong></p>
<h2 id="六、HTTP状态码"><a href="#六、HTTP状态码" class="headerlink" title="六、HTTP状态码"></a><strong>六、HTTP状态码</strong></h2><p><strong>HTTP状态码</strong>由三个十进制数字组成，第一个十进制数字定义了状态码的类型，后两个数字没有分类的作用。</p>
<h3 id="HTTP状态码共分为5种类型："><a href="#HTTP状态码共分为5种类型：" class="headerlink" title="HTTP状态码共分为5种类型："></a>HTTP状态码共分为5种类型：</h3><p><img src="状态码分类.png" alt="状态码分类"></p>
<h3 id="HTTP状态码列表："><a href="#HTTP状态码列表：" class="headerlink" title="HTTP状态码列表："></a>HTTP状态码列表：</h3><p>​    1：信息</p>
<p><img src="1-27.png" alt="1"></p>
<p>​    2：成功</p>
<p><img src="2-29.png" alt="2"></p>
<p>​    3：重定向</p>
<p><img src="3-29.png" alt="3"></p>
<p>​    4：客户端错误</p>
<p><img src="4-1-1.png" alt="4-1"></p>
<p><img src="4-2-2.png" alt="4-2"></p>
<p>​    5：服务器错误</p>
<p><img src="5-23.png" alt="5"></p>

          
        
      
    </div>
    
    
    

	<div>

	</div>
	
    
	<div>

    

    

	
	
	
	
    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </div></article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">吕培新</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">94</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吕培新</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
