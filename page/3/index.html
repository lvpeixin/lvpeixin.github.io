<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="吕培新的博客">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="吕培新的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="吕培新的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/">





  <title>吕培新的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">吕培新的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活中没有弱者，只有不愿努力的人。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-computer">
          <a href="/categories/计算机基础" rel="section">
            
            计算机基础
          </a>
        </li>
      
        
        <li class="menu-item menu-item-network">
          <a href="/categories/网络技术" rel="section">
            
            网络技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-linux">
          <a href="/categories/linux" rel="section">
            
            Linux运维
          </a>
        </li>
      
        
        <li class="menu-item menu-item-shell">
          <a href="/categories/shell脚本" rel="section">
            
            Shell脚本
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sql">
          <a href="/categories/数据库" rel="section">
            
            数据库
          </a>
        </li>
      
        
        <li class="menu-item menu-item-webserver">
          <a href="/categories/Web服务器" rel="section">
            
            Web服务器
          </a>
        </li>
      
        
        <li class="menu-item menu-item-automated">
          <a href="/categories/自动化运维" rel="section">
            
            自动化运维工具
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cluster">
          <a href="/categories/集群" rel="section">
            
            集群
          </a>
        </li>
      
        
        <li class="menu-item menu-item-test">
          <a href="/categories/文本三剑客" rel="section">
            
            文本三剑客
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/12/MySQL之日志管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/12/MySQL之日志管理/" itemprop="url">MySQL之日志管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-12T15:55:50+08:00">
                2018-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>MySQL数据库中支持多种日志类型，通过分析日志，我们可以优化数据库性能，排除故障，甚至能够还原</p>
<p>数据，本节内容将带你了解MySQL数据库中的日志管理</p>
<h2 id="一、事务日志"><a href="#一、事务日志" class="headerlink" title="一、事务日志"></a><strong>一、事务日志</strong></h2><h3 id="作用："><a href="#作用：" class="headerlink" title="作用："></a><strong>作用：</strong></h3><p>用来记录数据库更新情况的文件，它可以记录针对数据库的任何操作，并将记录的结果保存到独立的文件</p>
<p>中。对于每一次数据库更新的过程，事务日志文件都有非常全面的记录。根据这些记录可以恢复数据库更</p>
<p>新前的状态。</p>
<h3 id="日志文件："><a href="#日志文件：" class="headerlink" title="日志文件："></a><strong>日志文件：</strong></h3><p>事务型存储引擎自行管理和使用，建议和数据文件分开存放</p>
<p>事务日志包括</p>
<p><strong>Redo log</strong>      重做日志</p>
<p><strong>Undo log</strong>      回滚日志</p>
<p>Redo记录的是已经全部完成的事务，就是执行了commit的事务，记录文件是：</p>
<p><strong>ib_logfile0，ib_logfile1……</strong></p>
<h3 id="默认路径："><a href="#默认路径：" class="headerlink" title="默认路径："></a><strong>默认路径：</strong></h3><p><strong>/var/lib/mysql/</strong></p>
<h3 id="相关变量："><a href="#相关变量：" class="headerlink" title="相关变量："></a><strong>相关变量：</strong></h3><p><img src="事务日志.png" alt="事务日志"></p>
<h3 id="日志管理："><a href="#日志管理：" class="headerlink" title="日志管理："></a><strong>日志管理：</strong></h3><p>调整事务日志文件大小及数量</p>
<p>服务器选项中指定</p>
<p><strong>vim /etc/my.cnf</strong></p>
<p>[mysqld]</p>
<p>innodb_log_file_size=10240000</p>
<p>innodb_log_files_in_group=5</p>
<p>注：调整事务日志数量后，必须将原有事务日志文件删除，否则服务无法重启成功</p>
<h3 id="生产环境建议："><a href="#生产环境建议：" class="headerlink" title="生产环境建议："></a><strong>生产环境建议：</strong></h3><p>(1) 生产环境中一般根据具体情况将文件大小调大并增加日志文件数量</p>
<p>(2) 由于事务日志会重复交替覆盖，所以利用事务日志仅仅可以避免数据库突然崩溃，如掉电的情况，而不</p>
<p>可用做恢复数据用</p>
<h2 id="二、错误日志"><a href="#二、错误日志" class="headerlink" title="二、错误日志"></a><strong>二、错误日志</strong></h2><h3 id="功能："><a href="#功能：" class="headerlink" title="功能："></a><strong>功能：</strong></h3><p>在MySQL数据库中，错误日志时<strong>默认开启</strong>的。用于记录MySQL 运行过程中较为严重的警告和错误信息，</p>
<p>以及MySQL每次启动和关闭的详细信息。</p>
<h3 id="日志文件：-1"><a href="#日志文件：-1" class="headerlink" title="日志文件："></a><strong>日志文件：</strong></h3><p>logerror=/PATH/TO/LOGERRORFILE</p>
<p>默认存放路径：/var/log/mariadb/mariadb.log</p>
<p><img src="错误日志.png" alt="错误日志"></p>
<h3 id="日志管理：-1"><a href="#日志管理：-1" class="headerlink" title="日志管理："></a><strong>日志管理：</strong></h3><p>是否记录警告信息至错误日志文件</p>
<p><strong>logwarnings=1|0</strong>    1表示开启，0表示关闭，默认值为1</p>
<h3 id="生产环境建议：-1"><a href="#生产环境建议：-1" class="headerlink" title="生产环境建议："></a><strong>生产环境建议：</strong></h3><p>数据库管理员可以删除很长时间之前的错误日志，以保证mysql服务器上的硬盘空间。</p>
<p>可使用重命名原来的错误日志文件，手动冲洗日志创建一个新的错误日志，方法如下：</p>
<p>[root@CentOS7 mysql]#mv  mariadb.log  mariadb.log.data</p>
<p>[root@CentOS7 mysql]#mysqladmin -pcentos flush-logs</p>
<h2 id="三、通用日志"><a href="#三、通用日志" class="headerlink" title="三、通用日志"></a><strong>三、通用日志</strong></h2><h3 id="功能：-1"><a href="#功能：-1" class="headerlink" title="功能："></a><strong>功能：</strong></h3><p>记录对数据库的通用操作，包括错误的SQL语句，MySQL数据库默认不启用通用日志</p>
<p>文件：<strong>file</strong>，默认值</p>
<p>表：<strong>table</strong></p>
<h3 id="日志相关设置："><a href="#日志相关设置：" class="headerlink" title="日志相关设置："></a><strong>日志相关设置：</strong></h3><p><img src="通用日志.png" alt="通用日志"></p>
<h3 id="日志管理：-2"><a href="#日志管理：-2" class="headerlink" title="日志管理："></a><strong>日志管理：</strong></h3><p><strong>general_log=ON|OFF</strong></p>
<p><strong>general_log_file=HOSTNAME.log</strong></p>
<p><strong>log_output=TABLE|FILE|NONE</strong></p>
<p><strong>optimize table testlog；</strong>        整理数据库，释放磁盘数据库碎片</p>
<h3 id="生产环境建议：-2"><a href="#生产环境建议：-2" class="headerlink" title="生产环境建议："></a><strong>生产环境建议：</strong></h3><p>由于通用日志在并发操作大的环境下会产生大量的信息从而导致不必要的磁盘IO，会影响mysql的性能。</p>
<p>如若不是为了调试数据库的目的建议不要开启查询日志。</p>
<h2 id="四、慢查询日志"><a href="#四、慢查询日志" class="headerlink" title="四、慢查询日志"></a><strong>四、慢查询日志</strong></h2><h3 id="功能：-2"><a href="#功能：-2" class="headerlink" title="功能："></a><strong>功能：</strong></h3><p>记录执行查询时长超出指定时长的操作，可以帮助我们定位性能问题。</p>
<h3 id="日志文件：-2"><a href="#日志文件：-2" class="headerlink" title="日志文件："></a><strong>日志文件：</strong></h3><p>/var/lib/mysql/Hostname-slow.log</p>
<p><img src="慢日志.png" alt="慢日志"></p>
<h3 id="日志管理：-3"><a href="#日志管理：-3" class="headerlink" title="日志管理："></a><strong>日志管理：</strong></h3><p>log_slow_filter = admin,filesort,filesort_on_disk,full_join,</p>
<p>full_scan,query_cache,query_cache_miss,tmp_table,tmp_table_on_disk</p>
<p>上述查询类型且查询时长超过long_query_time，则记录日志</p>
<p>log_queries_not_using_indexes=ON 不使用索引或使用全索引扫描，不论是否达到慢查询阀值的语句是否</p>
<p>记录日志，默认OFF，即不记录,生产环境中可监控此项优化数据库环境</p>
<p>log_slow_rate_limit = 1 多少次查询才记录，mariadb特有</p>
<p>log_slow_verbosity= Query_plan,explain 记录内容</p>
<p>log_slow_queries = OFF 同slow_query_log 新版已废弃</p>
<h3 id="生产环境建议：-3"><a href="#生产环境建议：-3" class="headerlink" title="生产环境建议："></a><strong>生产环境建议：</strong></h3><p>通过慢查询日志，可以查找出哪些查询语句的执行效率很低，以便进行优化。一般建议开启，它对服务器</p>
<p>性能的影响微乎其微，但是可以记录mysql服务器上执行了很长时间的查询语句。</p>
<h3 id="示例：模拟慢查询"><a href="#示例：模拟慢查询" class="headerlink" title="示例：模拟慢查询"></a><strong>示例：模拟慢查询</strong></h3><p><img src="慢查询日志示例1.png" alt="慢查询日志示例1"></p>
<p><strong>打开慢查询日志：</strong></p>
<p><img src="慢查询日志示例2.png" alt="慢查询日志示例2"></p>
<h2 id="五、二进制日志"><a href="#五、二进制日志" class="headerlink" title="五、二进制日志"></a><strong>五、二进制日志</strong></h2><h3 id="作用：-1"><a href="#作用：-1" class="headerlink" title="作用："></a><strong>作用：</strong></h3><p>主要用于记录修改数据或有可能引起数据改变的mysql语句，并且记录了语句发生时间、执行时长、操作</p>
<p>的数据等等。所以说通过二进制日志可以查询mysql数据库中进行了哪些变化，通过“重放”日志文件中的事</p>
<p>件来恢复数据副本。</p>
<h3 id="日志文件的构成："><a href="#日志文件的构成：" class="headerlink" title="日志文件的构成："></a><strong>日志文件的构成：</strong></h3><p>有两类文件</p>
<p>(1) <strong>日志文件</strong>：mysql|mariadb-bin.文件名后缀，二进制格式</p>
<p>如： mysql-bin.000001</p>
<p>(2) <strong>索引文件</strong>：mysql|mariadb-bin.index，文本格式</p>
<h3 id="二进制日志记录有三种格式："><a href="#二进制日志记录有三种格式：" class="headerlink" title="二进制日志记录有三种格式："></a><strong>二进制日志记录有三种格式：</strong></h3><p>(1) 基于“语句”记录：<strong>statement</strong>，记录语句，默认模式</p>
<p>(2) 基于“行”记录：<strong>row</strong>，记录数据，日志量较大</p>
<p>(3) 混合模式：<strong>mixed</strong>, 让系统自行判定该基于哪种方式进行</p>
<p><img src="二进制格式变量.png" alt="二进制格式变量"></p>
<h3 id="相关变量：-1"><a href="#相关变量：-1" class="headerlink" title="相关变量："></a><strong>相关变量：</strong></h3><p><img src="二进制变量.png" alt="二进制变量"></p>
<p><strong>sql_log_bin=ON|OFF：</strong>是否记录二进制日志，默认ON，需配合log_bin，支持动态修改</p>
<p><strong>log_bin=/PATH/BIN_LOG_FILE：</strong>指定文件位置；默认OFF，表示不启用二进制日志功能，上述两</p>
<p>项都开启才可，不写路径默认在/var/lib/mysql目录下，生产中建议分开存放</p>
<p><img src="二进制开启变量.png" alt="二进制开启变量"></p>
<p><strong>两项都是ON**</strong>状态才开启二进制日志功能，缺一不可！**</p>
<p><strong>binlog_format=STATEMENT|ROW|MIXED：</strong>二进制日志记录的格式，默认STATEMENT</p>
<p><strong>max_binlog_size=1073741824：</strong>单个二进制日志文件的最大体积，到达最大值会自动滚动，默认为</p>
<p>1G       <strong>说明：</strong>文件达到上限时的大小未必为指定的精确值</p>
<p><strong>sync_binlog=1|0：</strong>设定是否启动二进制日志即时同步磁盘功能，默认0，由操作系统负责同步日志到</p>
<p>磁盘</p>
<p><strong>expire_logs_days=N：</strong>二进制日志可以自动删除的天数。 默认为0，即不自动删除</p>
<h3 id="日志管理：-4"><a href="#日志管理：-4" class="headerlink" title="日志管理："></a><strong>日志管理：</strong></h3><p>二进制日志相关配置</p>
<p>查看mariadb自行管理使用中的二进制日志文件列表，及大小</p>
<p><strong>SHOW {BINARY | MASTER} LOGS</strong></p>
<p><img src="二进制master1.png" alt="二进制master1"></p>
<p>查看使用中的二进制日志文件</p>
<p><strong>SHOW MASTER STATUS</strong></p>
<p><img src="二进制master2.png" alt="二进制master2"></p>
<p>查看二进制文件中的指定内容</p>
<p><strong>SHOW BINLOG EVENTS [IN ‘log_name’] [FROM pos] [LIMIT [offset,] row_count]</strong></p>
<p>show binlog events in ‘mysql-bin.000001′ from 6516 limit 2,3</p>
<p>清除指定二进制日志：</p>
<p>​         <strong>PURGE { BINARY | MASTER } LOGS</strong></p>
<p>​                  <strong>{ TO ‘log_name’ | BEFORE datetime_expr }</strong></p>
<p><strong>示例：</strong></p>
<p>  PURGE BINARY LOGS TO ‘mariadb-bin.000003’;删除3前日志</p>
<p>  PURGE BINARY LOGS BEFORE ‘2017-01-23’;</p>
<p>  PURGE BINARY LOGS BEFORE ‘2017-03-22 09:25:30’;</p>
<p>删除所有二进制日志，index文件重新记数</p>
<p>​        <strong>RESET MASTER [TO #];</strong> 日志文件从#开始记数，默认从1开始，一般是</p>
<p>master第一次启动时执行，MariaDB10.1.6开始支持TO #</p>
<p>切换日志文件：</p>
<p>​      <strong>FLUSH LOGS;</strong></p>
<h3 id="二进制日志事件格式："><a href="#二进制日志事件格式：" class="headerlink" title="二进制日志事件格式："></a><strong>二进制日志事件格式：</strong></h3><p># at 328</p>
<p>#151105 16:31:40 server id 1 end_log_pos 431 Query thread_id=1 exec_time=0</p>
<p>error_code=0</p>
<p>use <code>mydb</code>/<em>!</em>/;</p>
<p>SET TIMESTAMP=1446712300/<em>!</em>/;</p>
<p>CREATE TABLE tb1 (id int, name char(30))</p>
<p>/<em>!</em>/;</p>
<p>事件发生的日期和时间：151105 16:31:40</p>
<p>事件发生的服务器标识：server id 1</p>
<p>事件的结束位置：end_log_pos 431</p>
<p>事件的类型：Query</p>
<p>事件发生时所在服务器执行此事件的线程的ID：thread_id=1</p>
<p>语句的时间戳与将其写入二进制文件中的时间差：exec_time=0</p>
<p>错误代码：error_code=0</p>
<p>事件内容：</p>
<p>GTID：Global Transaction ID，mysql5.6以mariadb10以上版本专属属性：GTID</p>
<h3 id="生产环境建议：-4"><a href="#生产环境建议：-4" class="headerlink" title="生产环境建议："></a><strong>生产环境建议：</strong></h3><p>(1) <strong>强烈建议</strong>开启二进制日志功能！</p>
<p>(2) <strong>强烈建议</strong>以基于“行”的格式记录二进制日志，条件不允许可采用混合模式</p>
<h3 id="mysqlbinlog命令"><a href="#mysqlbinlog命令" class="headerlink" title="mysqlbinlog命令"></a><strong>mysqlbinlog命令</strong></h3><p><strong>功能：</strong>二进制日志的客户端命令工具</p>
<p><strong>格式：mysqlbinlog [OPTIONS] log_file…</strong></p>
<p>–start-position=# 指定开始位置</p>
<p>–stop-position=#</p>
<p>–start-datetime=</p>
<p>–stop-datetime=</p>
<p>时间格式：YYYY-MM-DD hh:mm:ss</p>
<p>–base64-output[=name]</p>
<p><strong>示例：</strong></p>
<p>mysqlbinlog –start-position=6787 –stop-position=7527 /var/lib/mysql/mariadb-bin.000003</p>
<p>mysqlbinlog –start-datetime=”2018-01-30 20:30:10″ –stopdatetime=”2018-01-30 20:35:22″ mariadb-bin.000003</p>
<p>mysqlbinlog  –start-position=647 –stop-position=797  -v /data/mysqllogs/mysql-bin.000003</p>
<h2 id="六、性能分析工具profile"><a href="#六、性能分析工具profile" class="headerlink" title="六、性能分析工具profile"></a><strong>六、性能分析工具profile</strong></h2><h3 id="功能：-3"><a href="#功能：-3" class="headerlink" title="功能："></a><strong>功能：</strong></h3><p>用于跟踪执行过的sql语句的资源消耗信息，可以帮助查看sql语句的执行情况，可以在做性能分析或者问题</p>
<p>诊断的时候作为参考。</p>
<h3 id="相关变量：-2"><a href="#相关变量：-2" class="headerlink" title="相关变量："></a><strong>相关变量：</strong></h3><p><img src="profile1.png" alt="profile1"></p>
<p>Profiling功能默认关闭，开启profiling：</p>
<p><strong>MariaDB [hellodb]&gt; set profiling=ON;</strong></p>
<p>显示每条SQL语句所消耗的时间：</p>
<p><strong>MariaDB [hellodb]&gt; show profiles;</strong></p>
<p><img src="profile2.png" alt="profile2"></p>
<p>显示指定Query_id的SQL语句执行过程各阶段消耗的时间：</p>
<p><strong>MariaDB [hellodb]&gt; show profile for query 3;</strong></p>
<p><img src="profile3.png" alt="profile3"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/12/MySQL之事务及并发控制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/12/MySQL之事务及并发控制/" itemprop="url">MySQL之事务及并发控制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-12T15:54:52+08:00">
                2018-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、事务"><a href="#一、事务" class="headerlink" title="一、事务"></a><strong>一、事务</strong></h2><h3 id="什么是事务？"><a href="#什么是事务？" class="headerlink" title="什么是事务？"></a><strong>什么是事务？</strong></h3><p><strong>事务Transactions</strong>：一组原子性的SQL语句，或一个独立工作单元。</p>
<p>事务主要用于处理操作量大，复杂度高的数据。比如说，在人员管理系统中，你删除一个</p>
<p>人员，你既需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，</p>
<p>这样，这些数据库操作语句就构成一个事务</p>
<p><strong>事务日志</strong>：记录事务信息，实现undo,redo等故障恢复功能</p>
<h3 id="ACID特性："><a href="#ACID特性：" class="headerlink" title="ACID特性："></a><strong>ACID特性：</strong></h3><p><strong>A：atomicity原子性；</strong></p>
<p>整个事务中的所有操作要么全部成功执行，要么全部失败后回滚，不可能停滞在中间某个环节。</p>
<p><strong>C：consistency一致性；</strong></p>
<p>数据库总是从一个一致性状态转换为另一个一致性状态</p>
<p>也就是说：如果事务是并发多个，系统也必须如同串行事务一样操作。其主要特征是保护性和不</p>
<p>变性(Preserving an Invariant)，以转账案例为例，假设有五个账户，每个账户余额是100元，那</p>
<p>么五个账户总额是500元，如果在这个5个账户之间同时发生多个转账，无论并发多少个，比如在</p>
<p>A与B账户之间转账5元，在C与D账户之间转账10元，在B与E之间转账15元，五个账户总额也应该</p>
<p>还是500元，这就是保护性和不变性</p>
<p><strong>I：Isolation隔离性；</strong></p>
<p>一个事务所做出的操作在提交之前，是不能为其它事务所见；隔离有多种隔离级别，实现并发。</p>
<p>如果有两个事务，运行在相同的时间内，执行相同的功能，事务的隔离性将确保每一事务在系统中</p>
<p>认为只有该事务在使用系统。这种属性有时称为串行化，为了防止事务操作间的混淆，必须串行化</p>
<p>或序列化请求，使得在同一时间仅有一个请求用于同一数据。</p>
<p><strong>D：durability持久性；</strong></p>
<p>一旦事务提交，其所做的修改会永久保存于数据库中</p>
<p><img src="事务生命周期.png" alt="事务生命周期"></p>
<p><strong>如图所示一个事务的生命周期：</strong></p>
<p>(1) 开启一个事务</p>
<p>(2) 进行事务操作，注：只有对数据库的增、删、改操作才记入事务，SELECT查</p>
<p>询语句不计入事务。</p>
<p>(3) ROLLBACK将会使未提交的数据回滚，数据还原至更改前的数据</p>
<p>(4) 一旦进行了COMMIT提交，新的数据将会持久的保存在数据库之中，并不会被回</p>
<p>滚，即事务的持久性。</p>
<h3 id="事务控制语句："><a href="#事务控制语句：" class="headerlink" title="事务控制语句："></a><strong>事务控制语句：</strong></h3><p><strong>BEGIN或START TRANSACTION：</strong>显式地开启一个事务；</p>
<p><strong>ROLLBACK：</strong>回滚会结束用户的事务，并撤销正在进行的所有未提交的修改；</p>
<p><strong>COMMIT：</strong>提交事务，并使已对数据库进行的所有修改称为永久性的；</p>
<p><strong>SAVEPOINT identifier：</strong>SAVEPOINT允许在事务中创建一个保存点，一个事务中可以有多个SAVEPOINT；</p>
<p><strong>ROLLBACK TO identifier：</strong>把事务回滚到标记点；</p>
<p><strong>RELEASE SAVEPOINT identifier：</strong>删除一个事务的保存点，当没有指定的保存点时，执行该语句会抛出一个异常；</p>
<h3 id="实现MySQL事务处理："><a href="#实现MySQL事务处理：" class="headerlink" title="实现MySQL事务处理："></a><strong>实现MySQL事务处理：</strong></h3><p><strong>方法一：</strong>用 BEGIN, ROLLBACK, COMMIT来实现</p>
<p><strong>BEGIN</strong> 开始一个事务</p>
<p><strong>ROLLBACK</strong> 事务回滚</p>
<p><strong>COMMIT</strong> 事务确认</p>
<p><strong>方法二：</strong>直接用 SET 来改变 MySQL 的自动提交模式:</p>
<p><strong>SET AUTOCOMMIT=OFF</strong> 禁止自动提交</p>
<p><strong>SET AUTOCOMMIT=ON</strong>  开启自动提交（系统默认项）</p>
<p><strong>示例：事务测试</strong></p>
<p>![M40SD}~}HE((AK_QBQ<a href="http://www.178linux.com/wp-content/uploads/2018/06/M40SDHEAK_QBQ0W.png" target="_blank" rel="noopener">0}%W</a></p>
<h2 id="二、事务隔离级别"><a href="#二、事务隔离级别" class="headerlink" title="二、事务隔离级别"></a><strong>二、事务隔离级别</strong></h2><p>在数据库操作中，为了有效保证并发读取数据的正确性，提出的<strong>事务隔离级别</strong>。</p>
<p>数据库是要被广大客户所共享访问的，那么在数据库操作过程中很可能出现以下几种不确定情况。</p>
<h4 id="更新丢失"><a href="#更新丢失" class="headerlink" title="更新丢失"></a><strong>更新丢失</strong></h4><p>两个事务都同时更新一行数据，一个事务对数据的更新把另一个事务对数据的更新覆盖了。这是因为系统</p>
<p>没有执行任何的锁操作，因此并发事务并没有被隔离开来。</p>
<h4 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a><strong>脏读</strong></h4><p>一个事务读取到了另一个事务未提交的数据操作结果。这是相当危险的，因为很可能所有的操作都被回</p>
<p>滚。</p>
<h4 id="虚读"><a href="#虚读" class="headerlink" title="虚读"></a><strong>虚读</strong></h4><p>事务T1读取某一数据后，事务T2对其做了修改，当事务T1再次读该数据时得到与前一次不同的值。</p>
<h4 id="幻读"><a href="#幻读" class="headerlink" title="幻读"></a><strong>幻读</strong></h4><p>事务在操作过程中进行两次查询，第二次查询的结果包含了第一次查询中未出现的数据或者缺少了第一次</p>
<p>查询中出现的数据（这里并不要求两次查询的SQL语句相同）。这是因为在两次查询过程中有另外一个事</p>
<p>务插入数据造成的。</p>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a><strong>事务隔离级别</strong></h3><p>为了避免上面出现的几种情况，在标准SQL规范中，定义了<strong>4个事务隔离级别</strong>，不同的隔离级别对事务的</p>
<p>处理不同。</p>
<p><strong>从上至下更加严格：</strong></p>
<p><strong>READ UNCOMMITTED</strong>：可读取到未提交数据，产生脏读</p>
<p><strong>READ COMMITTED</strong>：可读取到提交数据，但未提交数据不可读，产</p>
<p>生不可重复读，即可读取到多个提交数据，导致每次读取数据不一致</p>
<p><strong>REPEATABLE READ</strong> 可重复读，多次读取数据都一致，产生幻读，即</p>
<p>读取过程中，即使有其它提交的事务修改数据，仍只能读取到未修改</p>
<p>前的旧数据。此为MySQL默认设置</p>
<p><strong>SERIALIZABILE</strong> 可串行化，未提交的读事务阻塞修改事务，或者未</p>
<p>提交的修改事务阻塞读事务。导致并发性能差</p>
<p><img src="隔离级别对比.png" alt="隔离级别对比"></p>
<h3 id="管理事务隔离级别："><a href="#管理事务隔离级别：" class="headerlink" title="管理事务隔离级别："></a><strong>管理事务隔离级别：</strong></h3><p><strong>服务器变量**</strong>tx_isolation<strong>**指定</strong>，</p>
<p>默认为REPEATABLE-READ，可在GLOBAL和SESSION级进行设置</p>
<p>SET tx_isolation=”</p>
<p>​              READ-UNCOMMITTED</p>
<p>​              READ-COMMITTED</p>
<p>​              REPEATABLE-READ</p>
<p>​              SERIALIZABLE</p>
<p><strong>服务器选项中指定</strong></p>
<p><strong>vim /etc/my.cnf</strong></p>
<p>[mysqld]</p>
<p>transaction-isolation=SERIALIZABLE</p>
<h2 id="三、并发控制"><a href="#三、并发控制" class="headerlink" title="三、并发控制"></a><strong>三、并发控制</strong></h2><p><strong>锁粒度：</strong></p>
<p>表级锁</p>
<p>行级锁</p>
<p><strong>锁：</strong></p>
<p>读锁：共享锁，只读不可写，多个读互不阻塞，</p>
<p>写锁：独占锁,排它锁，一个写锁会阻塞其它读和它锁</p>
<p><strong>实现：</strong></p>
<p>存储引擎：自行实现其锁策略和锁粒度</p>
<p>服务器级：实现了锁，表级锁；用户可显式请求</p>
<p><strong>分类：</strong></p>
<p>隐式锁：由存储引擎自动施加锁</p>
<p>显式锁：用户手动请求</p>
<p><strong>锁策略：</strong>在锁粒度及数据安全性寻求的平衡机制</p>
<p>显示使用锁</p>
<p>  <strong>LOCK TABLES</strong></p>
<p>tbl_name [[AS] alias] lock_type</p>
<p>​         [, tbl_name [[AS] alias] lock_type] …</p>
<p>​         lock_type: READ ， WRITE</p>
<p>解锁</p>
<p><strong>UNLOCK TABLES</strong></p>
<p>FLUSH TABLES tb_name[,…] [WITH READ LOCK] </p>
<p>关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁</p>
<p>SELECT clause [FOR UPDATE | LOCK IN SHARE MODE]</p>
<p>查询时加写或读锁</p>
<h3 id="读锁："><a href="#读锁：" class="headerlink" title="读锁："></a><strong>读锁：</strong></h3><p>读锁也称为共享锁，读锁允许多个连接可以同一时刻并发的读取同一资源,互不干扰；</p>
<p>添加读锁：</p>
<p>MariaDB [hellodb]&gt; lock tables teachers read;</p>
<h3 id="写锁："><a href="#写锁：" class="headerlink" title="写锁："></a><strong>写锁：</strong></h3><p>写锁也称为排他锁，一个写锁会阻塞其他的写锁或读锁，保证同一时刻只有一个连接可以写入数据，同时</p>
<p>防止其他用户对这个数据的读写。</p>
<p>添加写锁：</p>
<p>MariaDB [hellodb]&gt; lock tables students write;</p>
<h3 id="死锁："><a href="#死锁：" class="headerlink" title="死锁："></a><strong>死锁：</strong></h3><p>两个或多个事务在同一资源相互占用并请求锁定对方占用的资源的状态</p>
<p>如下所示：</p>
<p>事务1                    事务2</p>
<p>update table1    update table2</p>
<p>update table2    update table1</p>
<p>产生死锁</p>
<h2 id="四、MVCC-多版本的并发控制协议"><a href="#四、MVCC-多版本的并发控制协议" class="headerlink" title="四、MVCC-多版本的并发控制协议"></a><strong>四、MVCC-多版本的并发控制协议</strong></h2><p>MySQL InnoDB存储引擎，实现的是基于多版本的并发控制协议——<strong>MVCC (Multi-Version</strong></p>
<p> <strong>Concurrency Control)</strong> (注：与MVCC相对的，是基于锁的并发控制，Lock-Based</p>
<p>Concurrency Control)。MVCC最大的好处，相信也是耳熟能详：<strong>读不加锁，读写不冲突。</strong></p>
<p>在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能。</p>
<p>InnoDB在每行数据都增加两个隐藏字段，<strong>一个记录创建的版本号，一个记录删除的版本号。</strong></p>
<p><strong>* SELECT**</strong>：**</p>
<p>当隔离级别是REPEATABLE READ时select操作，InnoDB必须每行数据来保证它符合两个条件：</p>
<p>1、InnoDB必须找到一个行的版本，它至少要和事务的版本一样老(也即它的版本号不大于</p>
<p>事务的版本号)。这保证了不管是事务开始之前，或者事务创建时，或者修改了这行数据的</p>
<p>时候，这行数据是存在的。</p>
<p>2、这行数据的删除版本必须是未定义的或者比事务版本要大。这可以保证在事务开始之前</p>
<p>这行数据没有被删除。</p>
<p>符合这两个条件的行可能会被当作查询结果而返回。</p>
<p><strong>* INSERT**</strong>：**<br>InnoDB为这个新行记录当前的系统版本号。</p>
<p><strong>* DELETE**</strong>：**<br>InnoDB将当前的系统版本号设置为这一行的删除ID。</p>
<p><strong>* UPDATE**</strong>：**<br>InnoDB会写一个这行数据的新拷贝，这个拷贝的版本为当前的系统版本号。</p>
<p>它同时也会将这个版本号写到旧行的删除版本里。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/11/MySQL之存储引擎及索引/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/11/MySQL之存储引擎及索引/" itemprop="url">MySQL之存储引擎及索引</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-11T15:53:55+08:00">
                2018-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、MySQL存储引擎介绍"><a href="#一、MySQL存储引擎介绍" class="headerlink" title="一、MySQL存储引擎介绍"></a><strong>一、MySQL存储引擎介绍</strong></h2><p><strong>存储引擎**</strong>是什么？**</p>
<p>例如，如果你在研究大量的临时数据，你也许需要使用内存存储引擎。内存存储引擎</p>
<p>能够在内存中存储所有的表格数据。又或者，你也许需要一个支持事务处理的数据库</p>
<p>(以确保事务处理不成功时数据的回退能力)。</p>
<p>这些不同的技术以及配套的相关功能在MySQL中被称作<strong>存储引擎</strong>。</p>
<p>下图是MySQL体系结构：</p>
<p><img src="体系架构.png" alt="体系架构"></p>
<p><strong>MySQL的存储引擎</strong>是MySQL体系架构中的重要组成部分，也是MySQL体系结构的核</p>
<p>心，它处于MySQL体系架构中Server端底层，是底层物理结构的实现，用于将数据以</p>
<p>各种不同的技术方式存储到文件或者内存中，不同的存储引擎具备不同的存储机制、索</p>
<p>引技巧和锁定水平。常见的MySQL存储引擎有<strong>InnoDB、MyISAM、Memory、Archive</strong></p>
<p>等等，它们具备各自的特征，我们可以根据不同的具体应用来建立对应的存储引擎表。</p>
<h3 id="MySQL常见的存储引擎有："><a href="#MySQL常见的存储引擎有：" class="headerlink" title="MySQL常见的存储引擎有："></a><strong>MySQL常见的存储引擎有：</strong></h3><p><strong>InnodDB：</strong>5.5版本之后的默认存储引擎，事务型数据库的首选引擎，支持ACID事务，支持</p>
<p>行级锁定</p>
<p><strong>MyISAM：</strong>拥有较高的插入，查询速度，但不支持事务5.5版本之前的默认存储引擎</p>
<p><strong>Performance_Schema：</strong>Performance_Schema数据库</p>
<p><strong>Memory ：</strong>将所有数据存储在RAM中，以便在需要快速查找参考和其他类似数据的环境中进</p>
<p>行快速访问。适用存放临时数据。引擎以前被称为HEAP引擎MRG_MyISAM：使MySQL DBA</p>
<p>或开发人员能够对一系列相同的MyISAM表进行逻辑分组，并将它们作为一个对象引用。适用</p>
<p>于VLDB(Very Large DataBase)环境，如数据仓库</p>
<p><strong>Archive ：</strong>为存储和检索大量很少参考的存档或安全审核信息，只支持SELECT和INSERT操</p>
<p>作；支持行级锁和专用缓存区</p>
<p><strong>Federated联合：</strong>用于访问其它远程MySQL服务器一个代理，它通过创建一个到远程MySQL</p>
<p>服务器的客户端连接，并将查询传输到远程服务器执行，而后完成数据存取，提供链接单独</p>
<p>MySQL服务器的能力，以便从多个物理服务器创建一个逻辑数据库。非常适合分布式或数据集</p>
<p>市环境</p>
<p><strong>BlackHole ：</strong>黑洞引擎，写入的任何数据都会消失，一般用于记录binlog做复制的中继</p>
<h3 id="MariaDB支持的其它存储引擎："><a href="#MariaDB支持的其它存储引擎：" class="headerlink" title="MariaDB支持的其它存储引擎："></a><strong>MariaDB支持的其它存储引擎：</strong></h3><p><strong>OQGraph</strong></p>
<p><strong>SphinxSE</strong></p>
<p><strong>TokuDB</strong></p>
<p><strong>Cassandra</strong></p>
<p><strong>CONNECT</strong></p>
<p><strong>SQUENCE</strong></p>
<p><strong>下图是MySQL常见存储引擎比较：</strong></p>
<p><img src="引擎对比.png" alt="引擎对比"></p>
<p>InnoDB support for FULLTEXT indexes(全文索引) is available in MySQL 5.6.4 and later.</p>
<p><strong>存储引擎比较</strong>：<a href="https://docs.oracle.com/cd/E17952_01/mysql-5.5-en/storage-engines.html" target="_blank" rel="noopener">https://docs.oracle.com/cd/E17952_01/mysql-5.5-en/storage-engines.html</a></p>
<p>作为MySQL数据库发展过程中的默认引擎，接下来我们重点介绍下InnodDB及MyISAM存储引擎</p>
<h2 id="二、InnoDB与MyISAM对比"><a href="#二、InnoDB与MyISAM对比" class="headerlink" title="二、InnoDB与MyISAM对比"></a><strong>二、InnoDB与MyISAM对比</strong></h2><h3 id="MyISAM存储引擎"><a href="#MyISAM存储引擎" class="headerlink" title="MyISAM存储引擎"></a><strong>MyISAM存储引擎</strong></h3><h4 id="MyISAM特性："><a href="#MyISAM特性：" class="headerlink" title="MyISAM特性："></a><strong>MyISAM特性：</strong></h4><p>不支持事务</p>
<p>表级锁定</p>
<p>读写相互阻塞，写入不能读，读时不能写</p>
<p>只缓存索引</p>
<p>不支持外键约束</p>
<p>不支持聚簇索引</p>
<p>读取数据较快，占用资源较少</p>
<p>不支持MVCC（多版本并发控制机制）高并发</p>
<p>崩溃恢复性较差</p>
<p><strong>MySQL5.5.5前默认的数据库引擎</strong></p>
<p><strong>适用场景：</strong>只读（或者写较少）、表较小（可以接受长时间进行修复操作）</p>
<p>### </p>
<h3 id="MyISAM引擎文件："><a href="#MyISAM引擎文件：" class="headerlink" title="MyISAM引擎文件："></a><strong>MyISAM引擎文件：</strong></h3><p><strong>tbl_name.frm</strong>: 表格式定义</p>
<p><strong>tbl_name.MYD</strong>: 数据文件</p>
<p><strong>tbl_name.MYI</strong>: 索引文件</p>
<h3 id="InnoDB存储引擎"><a href="#InnoDB存储引擎" class="headerlink" title="InnoDB存储引擎"></a><strong>InnoDB存储引擎</strong></h3><h4 id="InnoDB特性："><a href="#InnoDB特性：" class="headerlink" title="InnoDB特性："></a><strong>InnoDB特性：</strong></h4><p>行级锁</p>
<p>支持事务，适合处理大量短期事务</p>
<p>读写阻塞与事务隔离级别相关</p>
<p>可缓存数据和索引</p>
<p>支持聚簇索引</p>
<p>崩溃恢复性更好</p>
<p>支持MVCC高并发</p>
<p>从MySQL5.5后支持全文索引</p>
<p>从MySQL5.5.5开始为默认的数据库引擎</p>
<h3 id="InnoDB数据库文件："><a href="#InnoDB数据库文件：" class="headerlink" title="InnoDB数据库文件："></a><strong>InnoDB数据库文件：</strong></h3><p>所有InnoDB表的数据和索引放置于同一个表空间中</p>
<p><strong>表空间文件：</strong>datadir定义的目录下</p>
<p><strong>数据文件：</strong>ibddata1, ibddata2, …</p>
<p>每个表单独使用一个表空间存储表的数据和索引</p>
<p><strong>启用：</strong>innodb_file_per_table=ON</p>
<p>两类文件放在数据库独立目录中</p>
<p>数据文件(存储数据和索引)：tb_name.ibd</p>
<p>表格式定义：tb_name.frm</p>
<h3 id="管理存储引擎"><a href="#管理存储引擎" class="headerlink" title="管理存储引擎"></a><strong>管理存储引擎</strong></h3><p><strong>查看mysql支持的存储引擎:</strong></p>
<p>show engines;</p>
<p><strong>查看当前默认的存储引擎:</strong></p>
<p>show variables like ‘%storage_engine%’;</p>
<p><strong>查看库中所有表使用的存储引擎</strong></p>
<p>show table status from db_name;</p>
<p><strong>查看库中指定表的存储引擎</strong></p>
<p>show table status like ‘ tb_name ‘;</p>
<p>show create table tb_name;</p>
<p><strong>设置表的存储引擎：</strong></p>
<p>CREATE TABLE tb_name(… ) ENGINE=InnoDB;</p>
<p>ALTER TABLE tb_name ENGINE=InnoDB;</p>
<p><strong>操作：修改MySQL默认的存储引擎</strong></p>
<p><strong>vim /etc/my.conf</strong></p>
<p>[mysqld]</p>
<p>default_storage_engine= InnoDB;</p>
<p>重启mysql服务生效</p>
<p><strong>操作：修改MySQL中Innodb引擎每个表有独立的数据文件</strong></p>
<p><strong>vim /etc/my.cnf</strong></p>
<p>[mysqld]</p>
<p>innodb_file_per_table</p>
<p>重启mysql服务生效</p>
<h3 id="三、MVCC-多版本的并发控制协议"><a href="#三、MVCC-多版本的并发控制协议" class="headerlink" title="三、MVCC-多版本的并发控制协议"></a><strong>三、MVCC-多版本的并发控制协议</strong></h3><p>MySQL InnoDB存储引擎，实现的是基于多版本的并发控制协议——<strong>MVCC (Multi-Version</strong></p>
<p> <strong>Concurrency Control)</strong> (注：与MVCC相对的，是基于锁的并发控制，Lock-Based</p>
<p>Concurrency Control)。MVCC最大的好处，相信也是耳熟能详：<strong>读不加锁，读写不冲突。</strong></p>
<p>在读多写少的OLTP应用中，读写不冲突是非常重要的，极大的增加了系统的并发性能。</p>
<p>InnoDB在每行数据都增加两个隐藏字段，<strong>一个记录创建的版本号，一个记录删除的版本号。</strong></p>
<p><strong>* SELECT：</strong></p>
<p>当隔离级别是REPEATABLE READ时select操作，InnoDB必须每行数据来保证它符合两个条件：</p>
<p>1、InnoDB必须找到一个行的版本，它至少要和事务的版本一样老(也即它的版本号不大于</p>
<p>事务的版本号)。这保证了不管是事务开始之前，或者事务创建时，或者修改了这行数据的</p>
<p>时候，这行数据是存在的。</p>
<p>2、这行数据的删除版本必须是未定义的或者比事务版本要大。这可以保证在事务开始之前</p>
<p>这行数据没有被删除。</p>
<p>符合这两个条件的行可能会被当作查询结果而返回。</p>
<p><strong>* INSERT：</strong><br>InnoDB为这个新行记录当前的系统版本号。</p>
<p><strong>* DELETE：</strong><br>InnoDB将当前的系统版本号设置为这一行的删除ID。</p>
<p><strong>* UPDATE：</strong><br>InnoDB会写一个这行数据的新拷贝，这个拷贝的版本为当前的系统版本号。</p>
<p>它同时也会将这个版本号写到旧行的删除版本里。</p>
<p>在进行InnoDB与MyISAM引擎的对比时，我们还提到了索引的概念，什么是MySQL</p>
<p>数据库的索引呢？</p>
<h2 id="四、索引INDEX"><a href="#四、索引INDEX" class="headerlink" title="四、索引INDEX"></a><strong>四、索引INDEX</strong></h2><p>如同图书的目录，可以根据目录中的页码快速找到所需的内容。在关系数据库中，<strong>索引</strong>是一种单</p>
<p>独的、物理的对数据库表中一列或多列的值进行排序的一种存储结构，它是某个表中一列或若干</p>
<p>列值的集合和相应的指向表中物理标识这些值的数据页的逻辑指针清单。</p>
<p><strong>索引</strong>提供指向存储在表的指定列中的数据值的指针，然后根据您指定的排序顺序对这些指针排序。</p>
<p>数据库使用索引以找到特定值，然后顺指针找到包含该值的行。这样可以使对应于表的SQL语句</p>
<p>执行得更快，可快速访问数据库表中的特定信息。</p>
<h3 id="作用："><a href="#作用：" class="headerlink" title="作用："></a><strong>作用：</strong></h3><p>1.快速取数据；</p>
<p>2.保证数据记录的唯一性；</p>
<p>3.实现表与表之间的参照完整性；</p>
<p>4.在使用ORDER by、group by子句进行数据检索时，利用索引可以减少排序和</p>
<p>分组的时间。</p>
<h3 id="优点："><a href="#优点：" class="headerlink" title="优点："></a><strong>优点：</strong></h3><p>1.大大加快数据的检索速度;</p>
<p>2.创建唯一性索引，保证数据库表中每一行数据的唯一性;</p>
<p>3.加速表和表之间的连接;</p>
<p>4.在使用分组和排序子句进行数据检索时，可以显著减少查询中分组和排序的时间。</p>
<h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a><strong>缺点：</strong></h3><p>1.索引需要占物理空间。</p>
<p>2.当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护，降低了数</p>
<p>据的维护速度。</p>
<h3 id="索引类型："><a href="#索引类型：" class="headerlink" title="索引类型："></a><strong>索引类型：</strong></h3><p>聚簇（集）索引、非聚簇索引：数据和索引存储顺序是否一致</p>
<p>注：MyISAM不支持聚簇索引</p>
<p>主键索引、辅助索引（二级索引）</p>
<p>稠密索引、稀疏索引：是否索引了每一个数据项</p>
<p><strong>B+ TREE、HASH、R TREE</strong></p>
<p>简单索引、组合索引</p>
<p>左前缀索引：取前面的字符做索引</p>
<p>覆盖索引：从索引中即可取出要查询的数据，性能高</p>
<h3 id="B-Tree索引"><a href="#B-Tree索引" class="headerlink" title="B+ Tree索引"></a><strong>B+ Tree索引</strong></h3><p><img src="BTREE.jpg" alt="B+TREE"></p>
<p>顺序存储，每一个叶子节点到根结点的距离是相同的；左前缀索引，适合查询范围类的数据</p>
<p>可以使用B-Tree索引的查询类型：</p>
<p>全值匹配：精确所有索引列，如：姓wang，名xiaochun，年龄30</p>
<p>匹配最左前缀：即只使用索引的第一列，如：姓wang</p>
<p>匹配列前缀：只匹配一列值开头部分，如：姓以w开头的</p>
<p>匹配范围值：如：姓ma和姓wang之间</p>
<p>精确匹配某一列并范围匹配另一列：如：姓wang,名以x开头的</p>
<p>只访问索引的查询</p>
<p><img src="BTREE索引.png" alt="B+TREE索引"></p>
<h4 id="B-Tree索引的限制："><a href="#B-Tree索引的限制：" class="headerlink" title="B-Tree索引的限制："></a><strong>B-Tree索引的限制：</strong></h4><p>如果不从最左列开始，则无法使用索引：如：查找名为xiaochun，或姓为g结尾</p>
<p>不能跳过索引中的列：如：查找姓wang,年龄30的，只能使用索引第一列</p>
<p>如果查询中某个列是为范围查询，那么其右侧的列都无法再使用索引：如：</p>
<p>姓wang,名x%,年龄30，只能利用姓和名上面的索引</p>
<h4 id="特别提示："><a href="#特别提示：" class="headerlink" title="特别提示："></a><strong>特别提示：</strong></h4><p>索引列的顺序和查询语句的写法应相匹配，才能更好的利用索引</p>
<p>为优化性能，可能需要针对相同的列但顺序不同创建不同的索引来满足不同</p>
<p>类型的查询需求</p>
<h3 id="Hash索引"><a href="#Hash索引" class="headerlink" title="Hash索引"></a><strong>Hash索引</strong></h3><p>基于哈希表实现，只有精确匹配索引中的所有列的查询才有效，索引自身只存储索引列对应</p>
<p>的哈希值和数据指针，索引结构紧凑，查询性能好只有Memory存储引擎支持显式hash索引</p>
<h4 id="适用场景："><a href="#适用场景：" class="headerlink" title="适用场景："></a><strong>适用场景：</strong></h4><p>只支持等值比较查询，包括=, &lt;=&gt;, IN(),</p>
<p>不适合使用hash索引的场景：</p>
<p>不适用于顺序查询：索引存储顺序的不是值的顺序</p>
<p>不支持模糊匹配</p>
<p>不支持范围查询</p>
<p>不支持部分索引列匹配查找：如A，B列索引，只查询A列索引无效</p>
<h3 id="空间索引（R-Tree）："><a href="#空间索引（R-Tree）：" class="headerlink" title="空间索引（R-Tree）："></a><strong>空间索引（R-Tree）：</strong></h3><p>MyISAM支持空间索引，可以使用任意维度组合查询，使用特有的函数访问，</p>
<p>常用于做地理数据存储，使用不多</p>
<h3 id="全文索引-FULLTEXT-："><a href="#全文索引-FULLTEXT-：" class="headerlink" title="全文索引(FULLTEXT)："></a><strong>全文索引(FULLTEXT)：</strong></h3><p>在文本中查找关键词，而不是直接比较索引中的值，类似搜索引擎</p>
<p>InnoDB support for FULLTEXT indexes(全文索引) is available in MySQL 5.6.4 and later.</p>
<h3 id="聚簇索引与非聚簇索引"><a href="#聚簇索引与非聚簇索引" class="headerlink" title="聚簇索引与非聚簇索引"></a><strong>聚簇索引与非聚簇索引</strong></h3><p><strong>聚簇索引</strong>是顺序结构与数据存储物理结构一致的一种索引，并且一个表的聚簇</p>
<p>索引只能有唯一的一条。MyISAM不支持聚簇索引。</p>
<p><strong>非聚簇索引</strong>记录的物理顺序与逻辑顺序没有必然的联系，与数据的存储物理结构</p>
<p>没有关系；一个表对应的非聚簇索引可以有多条，根据不同列的约束可以建立不</p>
<p>同要求的非聚簇索引；</p>
<p><img src="聚簇和非聚簇索引.png" alt="聚簇和非聚簇索引"></p>
<h3 id="索引优化建议："><a href="#索引优化建议：" class="headerlink" title="索引优化建议："></a><strong>索引优化建议：</strong></h3><p>独立地使用列：尽量避免其参与运算，独立的列指索引列不能是表达式的一</p>
<p>部分，也不能是函数的参数，在where条件中，始终将索引列单独放在比较</p>
<p>符号的一侧</p>
<p>左前缀索引：构建指定索引字段的左侧的字符数，要通过索引选择性来评估</p>
<p>索引选择性：不重复的索引值和数据表的记录总数的比值</p>
<p>多列索引：AND操作时更适合使用多列索引，而非为每个列创建单独的索引</p>
<p>选择合适的索引列顺序：无排序和分组时，将选择性最高放左侧</p>
<p>只要列中含有NULL值，就最好不要在此例设置索引，复合索引如果有NULL值，</p>
<p>此列在使用时也不会使用索引</p>
<p>尽量使用短索引，如果可以，应该制定一个前缀长度</p>
<p>对于经常在where子句使用的列，最好设置索引</p>
<p>对于有多个列where或者order by子句，应该建立复合索引</p>
<p>对于like语句，以%或者‘-’开头的不会使用索引，以%结尾会使用索引</p>
<p>尽量不要在列上进行运算（函数操作和表达式操作）</p>
<p>尽量不要使用not in和&lt;&gt;操作</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/09/MySQL之用户与权限管理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/09/MySQL之用户与权限管理/" itemprop="url">MySQL之用户与权限管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-09T15:53:02+08:00">
                2018-06-09
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、MySQL用户管理"><a href="#一、MySQL用户管理" class="headerlink" title="一、MySQL用户管理"></a><strong>一、MySQL用户管理</strong></h2><h3 id="用户账号："><a href="#用户账号：" class="headerlink" title="用户账号："></a>用户账号：</h3><p>MySQL的用户账号由两部分组成：<strong>用户名+主机名</strong></p>
<p><strong>‘USERNAME’@’HOST’</strong></p>
<p>其中：</p>
<p>主机名HOST可以是IP地址或Network；</p>
<p>如：<a href="mailto:wxlinux@192.168.30.10" target="_blank" rel="noopener">wxlinux@192.168.30.10</a></p>
<p>主机名HOST也支持通配符的写法：</p>
<p>如：<a href="mailto:wxlinux@172.20" target="_blank" rel="noopener">wxlinux@172.20</a>.%.%</p>
<p>MySQL中自带有一张名称为mysql的数据库，称为元数据数据库。</p>
<p>它是mysql的核心数据库，类似于sql server中的master库，主要负责存储数据库的</p>
<p>用户、权限设置、关键字等mysql自己需要使用的控制和管理信息。</p>
<p>系统授权表：</p>
<p><img src="1-16.png" alt="1"></p>
<p><strong>user表：</strong>该表决定是否允许用户连接到服务器。如果允许连接，权限字段则</p>
<p>为该用户的全局权限。</p>
<p><strong>db表：</strong>用于决定哪些用户可以从哪些主机访问哪些数据库。包含在db表中的</p>
<p>权限适用于这个表标识的数据库。</p>
<p><strong>host表：</strong>当您想在db表的范围之内扩展一个条目时，就会用到这个表。举例</p>
<p>来说，如果某个db允许通过多个主机访问的话，那么超级用户就可</p>
<p>以让db表内将host列为空，然后用必要的主机名填充host表。</p>
<p><strong>tables_priv表：</strong>该表与db表相似，不同之处是它用于表而不是数据库。这个</p>
<p>表还包含一个其他字段类型，包括timestamp和grantor两个字段，用</p>
<p>于存储时间戳和授权方。在本文后面我们会对这个表做进一步的讲解。</p>
<p><strong>columns_priv：</strong>该表作用几乎与db和tables_priv表一样，不同之处是它提供</p>
<p>的是针对某些表的特定列的权限。这个表也多 出了一个字段类型，即</p>
<p>其他字段，包括了一个timestamp列，用于存放时间戳。</p>
<h3 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a><strong>用户管理</strong></h3><h4 id="创建用户："><a href="#创建用户：" class="headerlink" title="创建用户："></a><strong>创建用户：</strong></h4><p><strong>方法一：</strong></p>
<p><strong>CREATE USER ‘USERNAME’@’HOST’ [IDENTIFIED BY ‘password’]；</strong></p>
<p>默认权限：USAGE，只能连接数据库，无法查看、更改、删除</p>
<p><strong>示例：</strong></p>
<p>Mysql&gt; create user wxlinux@’192.168.30.%’ identified by ‘wxlinux’;</p>
<p>Mysql&gt; select user,host,password from mysql.user where user=’wxlinux’;</p>
<p><img src="2-16.png" alt="2"></p>
<p><strong>方法二：</strong></p>
<p>也可使用GRANT 授权同时创建用户</p>
<p><strong>示例：</strong></p>
<p>授权wang用户select、insert权限同时创建用户</p>
<p>Mysql&gt; grant select,insert on hellodb.* to wang@’%’ identified by ‘centos’;</p>
<p>Mysql&gt; select user,host,password from mysql.user where user=’wang’;       </p>
<p><img src="3-13.png" alt="3"></p>
<h4 id="用户重命名："><a href="#用户重命名：" class="headerlink" title="用户重命名："></a><strong>用户重命名：</strong></h4><p><strong>RENAME USER old_user_name TO new_user_name</strong></p>
<p><strong>示例：</strong></p>
<p>Mysql&gt; rename user wxlinux@’192.168.30.%’ to wangx@’192.168.30.%’;</p>
<p>Mysql&gt; select user,host,password from user where user=’wangx’;</p>
<p><img src="4-12.png" alt="4"></p>
<h4 id="删除用户："><a href="#删除用户：" class="headerlink" title="删除用户："></a><strong>删除用户：</strong></h4><p><strong>DROP USER ‘USERNAME’@’HOST’</strong></p>
<p><strong>示例：</strong></p>
<p><strong>删除匿名用户：</strong></p>
<p>MariaDB [mysql]&gt; select user,host,password from user;</p>
<p><img src="5-12.png" alt="5"></p>
<p><strong>删除指定用户：</strong></p>
<p>Mysql&gt; drop user wangx@’192.168.30.%’;</p>
<p>Mysql&gt; select user,host,password from user where user=’wangx’;</p>
<p>Empty set (0.00 sec)</p>
<h4 id="修改密码："><a href="#修改密码：" class="headerlink" title="修改密码："></a><strong>修改密码：</strong></h4><p><strong>方法一：</strong></p>
<p>Mysql&gt; SET PASSWORD FOR ‘user’@’host’ = PASSWORD(‘password’);</p>
<p><strong>方法二：</strong>   </p>
<p>Mysql&gt; UPDATE mysql.user SET password=PASSWORD(‘password’) WHERE clause;</p>
<p>此方法需要执行下面指令才能生效：</p>
<p>Mysql&gt; FLUSH PRIVILEGES;</p>
<p><strong>方法三：</strong></p>
<p><strong>bash命令行修改</strong>  </p>
<p>无密码新设密码：</p>
<p># mysqladmin -u root  password  ‘newpasswd’</p>
<p>修改旧密码：</p>
<p>#mysqladmin -u root –poldpasswd password  ‘newpasswd’</p>
<h2 id="二、MySQL权限管理"><a href="#二、MySQL权限管理" class="headerlink" title="二、MySQL权限管理"></a><strong>二、MySQL权限管理</strong></h2><h3 id="权限类别："><a href="#权限类别：" class="headerlink" title="权限类别："></a><strong>权限类别：</strong></h3><p>数据库级别</p>
<p>表级别</p>
<p>字段级别</p>
<p>管理类</p>
<p>程序类</p>
<h3 id="管理类："><a href="#管理类：" class="headerlink" title="管理类："></a><strong>管理类：</strong></h3><p>CREATE TEMPORARY TABLES</p>
<p>CREATE USER</p>
<p>FILE</p>
<p>SUPER</p>
<p>SHOW DATABASES</p>
<p>RELOAD</p>
<p>SHUTDOWN</p>
<p>REPLICATION SLAVE</p>
<p>REPLICATION CLIENT</p>
<p>LOCK TABLES</p>
<p>PROCESS</p>
<h3 id="程序类：-FUNCTION、PROCEDURE、TRIGGER"><a href="#程序类：-FUNCTION、PROCEDURE、TRIGGER" class="headerlink" title="程序类： FUNCTION、PROCEDURE、TRIGGER"></a><strong>程序类： FUNCTION、PROCEDURE、TRIGGER</strong></h3><p>CREATE</p>
<p>ALTER</p>
<p>DROP</p>
<p>EXCUTE</p>
<h3 id="库和表级别：DATABASE、TABLE"><a href="#库和表级别：DATABASE、TABLE" class="headerlink" title="库和表级别：DATABASE、TABLE"></a><strong>库和表级别：DATABASE、TABLE</strong></h3><p>ALTER</p>
<p>CREATE</p>
<p>CREATE VIEW</p>
<p>DROP</p>
<p>INDEX</p>
<p>SHOW VIEW</p>
<p>GRANT OPTION：能将自己获得的权限转赠给其他用户</p>
<h3 id="数据操作："><a href="#数据操作：" class="headerlink" title="数据操作："></a><strong>数据操作：</strong></h3><p>SELECT</p>
<p>INSERT</p>
<p>DELETE</p>
<p>UPDATE</p>
<h3 id="字段级别："><a href="#字段级别：" class="headerlink" title="字段级别："></a><strong>字段级别：</strong></h3><p>SELECT(col1,col2,…)</p>
<p>UPDATE(col1,col2,…)</p>
<p>INSERT(col1,col2,…)</p>
<p>所有权限：ALL PRIVILEGES 或 ALL</p>
<h3 id="授权："><a href="#授权：" class="headerlink" title="授权："></a><strong>授权：</strong></h3><p>参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/grant.html</a></p>
<p><strong>GRANT priv_type [(column_list)],… ON [object_type] priv_level TO ‘user’@’host’</strong></p>
<p><strong>[IDENTIFIED BY ‘password’] [WITH GRANT OPTION];</strong></p>
<p><strong>priv_type：</strong>ALL [PRIVILEGES]</p>
<p>   <strong>object_type：</strong>TABLE | FUNCTION | PROCEDURE</p>
<p>   <strong>priv_level：*</strong>(所有库) | <em>.</em> | db_name.* | db_name.tbl_name | tbl_name(当前库</p>
<p>的表) | db_name.routine_name(指定库的函数,存储过程,触发器)</p>
<p><strong>with_option：</strong>GRANT OPTION</p>
<p>| MAX_QUERIES_PER_HOUR count</p>
<p>| MAX_UPDATES_PER_HOUR count</p>
<p>| MAX_CONNECTIONS_PER_HOUR count</p>
<p>| MAX_USER_CONNECTIONS count</p>
<h3 id="回收授权："><a href="#回收授权：" class="headerlink" title="回收授权："></a><strong>回收授权：</strong></h3><p><strong>REVOKE priv_type [(column_list)] [, priv_type[(column_list)]] …</strong></p>
<p><strong>ON [object_type] priv_level FROM user [, user] …</strong></p>
<p>查看指定用户获得的授权：</p>
<p>​         Help SHOW GRANTS</p>
<p>​         SHOW GRANTS FOR ‘user’@’host’;</p>
<p>​         SHOW GRANTS FOR CURRENT_USER[()];</p>
<p>注意：MariaDB服务进程启动时会读取mysql库中所有授权表至内存</p>
<p>(1) GRANT或REVOKE等执行权限操作会保存于系统表中，MariaDB的服务进</p>
<p>程通常会自动重读授权表，使之生效</p>
<p>(2) 对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程</p>
<p>重读授权表：mysql&gt; FLUSH PRIVILEGES;</p>
<p><strong>示例：</strong></p>
<p>授权同时创建用户</p>
<p>MariaDB [hellodb]&gt; grant select,insert on hellodb.* to mage@’%’ identified by ‘centos’;</p>
<p>MariaDB [hellodb]&gt; select user,host,password from mysql.user;          </p>
<p><img src="3-14.png" alt="3"></p>
<p>只授权某个字段的操作权限</p>
<p>MariaDB [hellodb]&gt; grant select(stuid,name) on hellodb.students to zhang@’%’identified by ‘centos’;</p>
<p><strong>查看指定用户的权限</strong></p>
<p>MariaDB [hellodb]&gt; show grants for wang@’192.168.30.%’;</p>
<p><img src="6-12.png" alt="6"></p>
<p><strong>查看本机登录用户权限</strong></p>
<p><strong>current_user()</strong>是一个变量，特指本机</p>
<p>MariaDB [(none)]&gt; show grants for current_user();</p>
<p><img src="7-8.png" alt="7"></p>
<p><strong>收回指定用户的select权限</strong></p>
<p>MariaDB [hellodb]&gt; revoke select on hellodb.* from mage@’%’;</p>
<h2 id="三、并发控制"><a href="#三、并发控制" class="headerlink" title="三、并发控制"></a><strong>三、并发控制</strong></h2><p><strong>锁粒度：</strong></p>
<p>表级锁</p>
<p>行级锁</p>
<p><strong>锁：</strong></p>
<p>读锁：共享锁，只读不可写，多个读互不阻塞，</p>
<p>写锁：独占锁,排它锁，一个写锁会阻塞其它读和它锁</p>
<p><strong>实现</strong></p>
<p>存储引擎：自行实现其锁策略和锁粒度</p>
<p>服务器级：实现了锁，表级锁；用户可显式请求</p>
<p><strong>分类：</strong></p>
<p>隐式锁：由存储引擎自动施加锁</p>
<p>显式锁：用户手动请求</p>
<p><strong>锁策略：</strong>在锁粒度及数据安全性寻求的平衡机制</p>
<p>显示使用锁</p>
<p>  <strong>LOCK TABLES</strong></p>
<p>tbl_name [[AS] alias] lock_type</p>
<p>​         [, tbl_name [[AS] alias] lock_type] …</p>
<p>​         lock_type: READ ， WRITE</p>
<p>解锁</p>
<p><strong>UNLOCK TABLES</strong></p>
<p>FLUSH TABLES tb_name[,…] [WITH READ LOCK] </p>
<p>关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁</p>
<p>SELECT clause [FOR UPDATE | LOCK IN SHARE MODE]</p>
<p>查询时加写或读锁</p>
<p><strong>添加读锁：</strong></p>
<p>效果：可查看但不可修改，本端会提示，其他客户端会卡住并且无提示</p>
<p>MariaDB [hellodb]&gt; lock tables teachers read;</p>
<p><strong>添加写锁：</strong></p>
<p>效果：自己可读，但别人无法读</p>
<p>MariaDB [hellodb]&gt; lock tables students write;</p>
<h2 id="四、操作：破解Mysql数据库口令"><a href="#四、操作：破解Mysql数据库口令" class="headerlink" title="四、操作：破解Mysql数据库口令"></a><strong>四、操作：破解Mysql数据库口令</strong></h2><p><strong>方法一：</strong></p>
<p>适合干净环境，没有其他数据库：</p>
<p>systemctl stop mariadb</p>
<p>cd <strong>/var/lib/mysql/</strong></p>
<p>rm -rf mysql/*</p>
<p>systemctl start mariadb</p>
<p><strong>方法二：</strong></p>
<p><strong>vim /etc/my.cnf.d</strong></p>
<p>[mysqld]</p>
<p>skip-grant-tables             #忽略授权表</p>
<p>重启mysql服务</p>
<p>systemctl restart mariadb</p>
<p>#mysql</p>
<p>MariaDB [mysql] &gt; use mysql</p>
<p>MariaDB [mysql] &gt; update user set password=(‘centos’)where user=’root’ and host=’localhost’</p>
<p>最后再将忽略授权表那行删掉</p>
<p>重启mysql服务</p>
<p>systemctl restart mariadb</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/07/MySQL之SQL语法介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/07/MySQL之SQL语法介绍/" itemprop="url">MySQL之SQL语法介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-07T15:34:11+08:00">
                2018-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、SQL语言简介："><a href="#一、SQL语言简介：" class="headerlink" title="一、SQL语言简介："></a><strong>一、SQL语言简介：</strong></h2><p><strong>结构化查询语言</strong>(Structured Query Language)简称<strong>SQL</strong>，是一种特殊目的的编程语言，是一种数据库</p>
<p>查询和程序设计语言，用于存取数据以及查询、更新和管理关系数据库系统；同时也是数据库脚本文件</p>
<p>的扩展名</p>
<h3 id="关系型数据库的常见组件"><a href="#关系型数据库的常见组件" class="headerlink" title="关系型数据库的常见组件"></a><strong>关系型数据库的常见组件</strong></h3><p>数据库：database</p>
<p>表：table</p>
<p>行：row</p>
<p>列：column</p>
<p>索引：index</p>
<p>视图：view</p>
<p>用户：user</p>
<p>权限：privilege</p>
<p>存储过程：procedure，无返回值</p>
<p>存储函数：function，有返回值</p>
<p>触发器：trigger</p>
<p>事件调度器：event scheduler，任务计划</p>
<p><strong>命名规则：</strong></p>
<p>必须以字母开头</p>
<p>可包括数字和三个特殊字符（# _ $）</p>
<p>不要使用MySQL的保留字</p>
<p>同一database(Schema)下的对象不能同名</p>
<h3 id="数据类型："><a href="#数据类型：" class="headerlink" title="数据类型："></a><strong>数据类型：</strong></h3><p><strong>(一)整型</strong></p>
<p>tinyint(m) 1个字节 范围(-128~127)</p>
<p>smallint(m) 2个字节 范围(-32768~32767)</p>
<p>mediumint(m) 3个字节 范围(-8388608~8388607)</p>
<p>int(m) 4个字节 范围(-2147483648~2147483647)</p>
<p>bigint(m) 8个字节 范围(+-9.22*10的18次方)</p>
<p>取值范围如果加了<strong>unsigned</strong>，则最大值翻倍，如tinyint unsigned的取值范围为(0~255)</p>
<p><strong>(二)浮点型(float和double)，近似值</strong></p>
<p>float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位</p>
<p>double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位</p>
<p>设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存</p>
<p>的是123.457，但总个数还以实际为准，即6位</p>
<p><strong>(三)字符串(char,varchar,_text)</strong></p>
<p>char(n) 固定长度，最多255个字符</p>
<p>varchar(n)可变长度，最多65535个字符</p>
<p>inytext 可变长度，最多255个字符</p>
<p>ext 可变长度，最多65535个字符</p>
<p>mediumtext 可变长度，最多2的24次方-1个字符</p>
<p>ongtext 可变长度，最多2的32次方-1个字符</p>
<p>BINARY(M) 固定长度，可存二进制或字符，长度为0-M字节</p>
<p>VARBINARY(M) 可变长度，可存二进制或字符，允许长度为0-M字节</p>
<p>内建类型：ENUM枚举, SET集合</p>
<p><strong>char和varchar：</strong></p>
<p>1.char(n) 若存入字符数小于n，则以空格补于其后，查询之时再将空格去掉。</p>
<p>所以char类型存储的字符串末尾不能有空格，varchar不限于此。</p>
<p>2.char(n) 固定长度，char(4)不管是存入几个字符，都将占用4个字节，varchar</p>
<p>是存入的实际字符数+1个字节（n&lt; n&gt;255)，所以varchar(4),存入3个字符将</p>
<p>占用4个字节。</p>
<p>3.char类型的字符串检索速度要比varchar类型的快</p>
<p><strong>varchar和text：</strong></p>
<p>1.varchar可指定n，text不能指定，内部存储varchar是存入的实际字符数+1个</p>
<p>字节（n&lt; n&gt;255)，text是实际字符数+2个字节。</p>
<p>2.text类型不能有默认值</p>
<p>3.varchar可直接创建索引，text创建索引要指定前多少个字符。varchar查询速</p>
<p>度快于text</p>
<p><strong>(四)二进制数据：BLOB</strong></p>
<p>BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，</p>
<p>而Blob是以二进制方式存储，不分大小写</p>
<p>BLOB存储的数据只能整体读出</p>
<p>TEXT可以指定字符集，BLOB不用指定字符集</p>
<p><strong>(五)日期时间类型</strong></p>
<p>date 日期 ‘2008-12-2’</p>
<p>time 时间 ’12:25:36′</p>
<p>datetime 日期时间 ‘2008-12-2 22:06:44’</p>
<p>timestamp 自动存储记录修改时间</p>
<p>YEAR(2), YEAR(4)：年份</p>
<p><strong>timestamp</strong>字段里的时间数据会随其他字段修改的时候自动刷新，这个数据类</p>
<p>型的字段可以存放这条记录最后被修改的时间</p>
<h3 id="修饰符："><a href="#修饰符：" class="headerlink" title="修饰符："></a><strong>修饰符：</strong></h3><p>NULL                              数据列可包含NULL值</p>
<p>NOT NULL                    数据列不允许包含NULL值</p>
<p>DEFAULT                      默认值</p>
<p>PRIMARY KEY             主键</p>
<p>UNIQUE KEY                唯一键</p>
<p>CHARACTER SET name            指定一个字符集</p>
<p>AUTO_INCREMENT                自动递增，适用于整数类型</p>
<p>UNSIGNED              无符号</p>
<h2 id="SQL语句分类："><a href="#SQL语句分类：" class="headerlink" title="SQL语句分类："></a><strong>SQL语句分类：</strong></h2><p><strong>DDL：Data Defination Language</strong>         </p>
<p><strong>代表操作：</strong></p>
<p>CREATE    可用来创建数据库，表</p>
<p>DROP       可用来删除数据库，表</p>
<p>ALTER      可用来修改表的属性，字段的结构</p>
<p><strong>DML：Data Manipulation Language</strong>       </p>
<p><strong>代表操作：</strong></p>
<p>INSERT    可用来添加表中的行</p>
<p>DELETE    可用来删除表中的行</p>
<p>UPDATE   可用来修改标准行的信息</p>
<p><strong>DCL：Data Control Language</strong>        </p>
<p><strong>代表操作：</strong></p>
<p>GRANT</p>
<p>REVOKE</p>
<p><strong>DQL：Data Query Language</strong>  </p>
<p><strong>代表操作：</strong></p>
<p>SELECT</p>
<h2 id="二、数据定义语言-DDL-：CREATE-DROP-ALTER"><a href="#二、数据定义语言-DDL-：CREATE-DROP-ALTER" class="headerlink" title="二、数据定义语言(DDL)：CREATE, DROP, ALTER"></a><strong>二、数据定义语言(DDL)：CREATE, DROP, ALTER</strong></h2><p><strong>数据定义语言(DDL)：</strong>其语句包括动词CREATE和DROP。在数据库中创建新表或删除表（CREAT</p>
<p>TABLE 或 DROP TABLE）；为表加入索引等。DDL包括许多与人数据库目录中获得数据</p>
<p>有关的保留字。它也是动作查询的一部分。</p>
<h3 id="新建数据库："><a href="#新建数据库：" class="headerlink" title="新建数据库："></a><strong>新建数据库：</strong></h3><p>CREATE DATABASE|SCHEMA [IF NOT EXISTS] DB_NAME;</p>
<p>CHARACTER SET ‘character set name’</p>
<p>COLLATE ‘collate name’</p>
<h3 id="删除数据库："><a href="#删除数据库：" class="headerlink" title="删除数据库："></a><strong>删除数据库：</strong></h3><p>DROP DATABASE|SCHEMA [IF EXISTS]’DB_NAME’</p>
<h3 id="新建表："><a href="#新建表：" class="headerlink" title="新建表："></a><strong>新建表：</strong></h3><p>CREATE TABLE</p>
<p>(1) 直接创建</p>
<p>(2) 通过查询现存表创建；新表会被直接插入查询而来的数据</p>
<p>CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name</p>
<p>[(create_definition,…)] [table_options]</p>
<p>[partition_options] select_statement</p>
<p>(3) 通过复制现存的表的表结构创建，但不复制数据</p>
<p>CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name { LIKE</p>
<p>oldtblname | (LIKE oldtblname) }</p>
<p><strong>示例：直接创建表</strong></p>
<p>MariaDB [(db1)]&gt; create table emp</p>
<p>​    -&gt; ( id int unsigned primary key  auto_increment,</p>
<p>​    -&gt; name varchar(30) not null ,</p>
<p>​    -&gt; sex char(1) default ‘m’ ,</p>
<p>​    -&gt; address varchar(100) ) engine=innodb charset=utf8;</p>
<p><strong>示例：通过查询现存表创建</strong></p>
<p>MariaDB [db1]&gt; create table user select user,host,password from mysql.user;</p>
<p>MariaDB [db1]&gt; desc user;</p>
<p>+———-+———-+——+—–+———+——-+</p>
<p>| Field    | Type     | Null | Key | Default | Extra |</p>
<p>+———-+———-+——+—–+———+——-+</p>
<p>| user     | char(16) | NO   |     |         |       |</p>
<p>| host     | char(60) | NO   |     |         |       |</p>
<p>| password | char(41) | NO   |     |         |       |</p>
<p>+———-+———-+——+—–+———+——-+</p>
<p>MariaDB [db1]&gt; select * from user;</p>
<p>+——+—————+———-+</p>
<p>| user | host          | password |</p>
<p>+——+—————+———-+</p>
<p>| root | localhost     |          |</p>
<p>| root | centos7.wangx |          |</p>
<p>| root | 127.0.0.1     |          |</p>
<p>| root | ::1           |          |</p>
<p>|      | localhost     |          |</p>
<p>|      | centos7.wangx |          |</p>
<p>+——+—————+———-+</p>
<p><strong>示例：通过复制现存的表的表结构创建，但不复制数据</strong></p>
<p>MariaDB [db1]&gt; create table user3 like mysql.user;</p>
<p><strong>示例：创建表包含复合主键</strong></p>
<p>MariaDB [db1]&gt; create table t1 ( name char(30),city char(30),sex char(1) primary key(name,city) );</p>
<h3 id="表操作："><a href="#表操作：" class="headerlink" title="表操作："></a><strong>表操作：</strong></h3><p>查看所有的引擎：SHOW ENGINES</p>
<p>查看表：SHOW TABLES [FROM db_name]</p>
<p>查看表结构：DESC [db_name.]tb_name</p>
<p>删除表：DROP TABLE [IF EXISTS] tb_name</p>
<p>查看表创建命令：SHOW CREATE TABLE tbl_name</p>
<p>查看表状态：SHOW TABLE STATUS LIKE ‘tbl_name’</p>
<p>查看库中所有表状态：SHOW TABLE STATUS FROM db_name</p>
<p><strong>示例：直接创建TABLE</strong></p>
<p>MariaDB [db1]&gt; CREATE TABLE students ( id tinyint unsigned not null primary key,</p>
<p>name char(10) not null,phone char(11) not null ,sex char(1) );</p>
<p>MariaDB [db1]&gt; show tables; </p>
<p>+—————+</p>
<p>| Tables_in_db1 |</p>
<p>+—————+</p>
<p>| students      |</p>
<p>+—————+</p>
<p><strong>示例：查看表状态信息</strong></p>
<p>MariaDB [db1]&gt; show table status like ‘students’\G</p>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong></p>
<p>Name: students</p>
<p>Engine: InnoDB</p>
<p>Version: 10</p>
<p>Row_format: Compact</p>
<p>Rows: 0</p>
<p>Avg_row_length: 0</p>
<p>Data_length: 16384</p>
<p>Max_data_length: 0</p>
<p>Index_length: 0</p>
<p>Data_free: 10485760</p>
<p>Auto_increment: NULL</p>
<p>Create_time: 2018-06-06 18:19:05</p>
<p>Update_time: NULL</p>
<p>Check_time: NULL</p>
<p>Collation: latin1_swedish_ci</p>
<p>Checksum: NULL</p>
<p>Create_options:</p>
<p>Comment:</p>
<p>1 row in set (0.00 sec)</p>
<p><strong>示例：查看数据库状态信息</strong></p>
<p>MariaDB [db1]&gt; show table status from db1\G</p>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong></p>
<p>Name: students</p>
<p>Engine: InnoDB</p>
<p>Version: 10</p>
<p>Row_format: Compact</p>
<p>Rows: 0</p>
<p>Avg_row_length: 0</p>
<p>Data_length: 16384</p>
<p>Max_data_length: 0</p>
<p>Index_length: 0</p>
<p>Data_free: 10485760</p>
<p>Auto_increment: NULL</p>
<p>Create_time: 2018-06-06 18:19:05</p>
<p>Update_time: NULL</p>
<p>Check_time: NULL</p>
<p>Collation: latin1_swedish_ci</p>
<p>Checksum: NULL</p>
<p>Create_options:</p>
<p>Comment:</p>
<p>1 row in set (0.00 sec)</p>
<h3 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a><strong>表操作</strong></h3><p><strong>DROP TABLE [IF EXISTS] ‘tbl_name’;</strong></p>
<p><strong>ALTER TABLE ‘tbl_name’</strong></p>
<p>字段：</p>
<p>添加字段：<strong>add</strong></p>
<p>   ADD col1 data_type [FIRST|AFTER col_name]</p>
<p>删除字段：<strong>drop</strong></p>
<p>修改字段：</p>
<p><strong>alter</strong>（默认值）, <strong>change</strong>（字段名）, <strong>modify</strong>（字段属性）</p>
<p>索引:</p>
<p>添加索引：add index</p>
<p>删除索引: drop index</p>
<p>表选项</p>
<p>修改:</p>
<p>查看表上的索引：SHOW INDEXES FROM [db_name.]tbl_name;</p>
<p>查看帮助：Help ALTER TABLE</p>
<p><strong>示例：</strong></p>
<p>修改表名</p>
<p>ALTER TABLE students RENAME s1;</p>
<p>添加表s1中phone列到name列后</p>
<p>ALTER TABLE s1 ADD phone varchar(11) AFTER name;</p>
<p>修改表s1中的phone字段属性为int</p>
<p>ALTER TABLE s1 MODIFY phone int;</p>
<p>修改表s1中的phone字段名称为mobile</p>
<p>ALTER TABLE s1 CHANGE COLUMN phone mobile char(11);</p>
<p>删掉表s1中的一个字段mobile</p>
<p>ALTER TABLE s1 DROP COLUMN mobile;</p>
<p>在students表中新增加一列gender，只允许填入m，f</p>
<p>ALTER TABLE students ADD gender ENUM(‘m’,’f’)</p>
<p>修改students表中的id字符变为sid字段</p>
<p>ALETR TABLE students CHANGE id sid int UNSIGNED NOT NULL PRIMARY KEY;</p>
<p>将students表中name字段设为唯一键</p>
<p>ALTER TABLE students ADD UNIQUE KEY(name);</p>
<p>将students表中age字段设为索引</p>
<p>ALTER TABLE students ADD INDEX(age);</p>
<p>DESC students;</p>
<p>SHOW INDEXES FROM students;</p>
<p>删掉students表中的age字段</p>
<p>ALTER TABLE students DROP age;</p>
<h2 id="三、数据操作语言-DML-：INSERT-UPDATE-DELETE"><a href="#三、数据操作语言-DML-：INSERT-UPDATE-DELETE" class="headerlink" title="三、数据操作语言(DML)：INSERT,UPDATE,DELETE"></a><strong>三、数据操作语言(DML)：INSERT,UPDATE,DELETE</strong></h2><p><strong>数据操作语言(DML)</strong>：其语句包括动词INSERT，UPDATE和DELETE。它们分别用于添加，修</p>
<p>改和删除表中的行。也称为动作查询语言。</p>
<h3 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a><strong>INSERT</strong></h3><p><strong>功能：</strong>可用来添加表中的行</p>
<p><strong>示例：添加表中的行第一种语法</strong></p>
<p>MariaDB [db1]&gt; insert students values(1,’bai’,’10086′,’m’);</p>
<p>MariaDB [db1]&gt; select * from students;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  1 | bai  | 10086 | m    |</p>
<p>+—-+——+——-+——+</p>
<p><strong>示例：添加表中的行第二种语法</strong></p>
<p>MariaDB [db1]&gt; insert students(name,id) value (‘wangx’,70);</p>
<p>MariaDB [db1]&gt; select * from students;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  1 | bai  | 10086 | m    |</p>
<p>| 70 | wangx|       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>多行添加</strong></p>
<p>MariaDB [db1]&gt; insert students(id,name,sex) values (2,’liu’,’m’),(3,’lin’,’f’);</p>
<p>MariaDB [db1]&gt; select * from students;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  1 | bai  | 10086 | m    |</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>示例：添加表中的行第三种语法</strong></p>
<p>MariaDB [db1]&gt; insert students set id=4,name=’zhao’ ;</p>
<p>MariaDB [db1]&gt; select * from students;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  1 | bai  | 10086 | m    |</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<h3 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a><strong>UPDATE</strong></h3><p><strong>功能：</strong>可用来修改标准行的信息</p>
<p>UPDATE [LOW_PRIORITY] [IGNORE] table_reference</p>
<p>SET col_name1={expr1|DEFAULT} [, col_name2={expr2|DEFAULT}] …</p>
<p>[WHERE where_condition]</p>
<p>[ORDER BY …]</p>
<p>[LIMIT row_count]</p>
<p><strong>注意：一定要有限制条件，否则将修改所有行的指定字段</strong></p>
<p>限制条件：</p>
<p><strong>WHERE</strong></p>
<p><strong>LIMIT</strong></p>
<p>Mysql 选项：–safe-updates| –i-am-a-dummy|-U</p>
<p>MariaDB [db1]&gt; select * from students;   </p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  1 | bai  | 10086 | m    |</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>示例：修改表中行内容</strong></p>
<p>MariaDB [db1]&gt; update students set name=’admin’,sex=’f’ where id=1;  </p>
<p>MariaDB [db1]&gt; select * from students;</p>
<p>+—-+——-+——-+——+</p>
<p>| id | name  | phone | sex  |</p>
<p>+—-+——-+——-+——+</p>
<p>|  1 | admin | 10086 | f    |</p>
<p>|  2 | liu   |       | m    |</p>
<p>|  3 | lin   |       | f    |</p>
<p>|  4 | zhao  |       | NULL |</p>
<p>| 70 | wang  |       | NULL |</p>
<p>+—-+——-+——-+——+</p>
<h3 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a><strong>DELETE</strong></h3><p><strong>功能：</strong>可用来删除表中的行</p>
<p>生产环境一般用伪删除代替DELETE：</p>
<p>DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name</p>
<p>[WHERE where_condition]</p>
<p>[ORDER BY …]</p>
<p>[LIMIT row_count]</p>
<p>可先排序再指定删除的行数</p>
<p><strong>注意：一定要有限制条件，否则将清空表中的所有数据</strong></p>
<p>限制条件：</p>
<p><strong>WHERE</strong></p>
<p><strong>LIMIT</strong></p>
<p>TRUNCATE TABLE tbl_name; 清空表，慎用！</p>
<p>MariaDB [db1]&gt; delete from students where id=1;</p>
<p>MariaDB [db1]&gt; select * from students;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p>为避免操作时忘加where可使用安全更新模式</p>
<p><strong>mysql –safe-updates|-U</strong></p>
<p>当执行修该操作未指定WHERE时就会进行报错提醒</p>
<p>MariaDB [db1]&gt; update user set user=’admin’</p>
<p>-&gt; ;</p>
<p>ERROR 1175 (HY000): You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column</p>
<p><strong>方法一：添加别名</strong></p>
<p>alias mysql=mysql -U    </p>
<p><strong>方法二：修改配置文件</strong></p>
<p><strong>vim /etc/my.cnf.d/mysql-clients.cnf</strong></p>
<p>[mysql]</p>
<p>safe-updates</p>
<h2 id="四、数据查询语言-DQL-：SELECT-LIKE-GROUP-ODER-BY"><a href="#四、数据查询语言-DQL-：SELECT-LIKE-GROUP-ODER-BY" class="headerlink" title="四、数据查询语言(DQL)：SELECT,LIKE,GROUP,ODER BY"></a><strong>四、数据查询语言(DQL)：SELECT,LIKE,GROUP,ODER BY</strong></h2><p><strong>数据查询语言(DQL)：</strong>也称为“数据检索语句”，用以从表中获得数据，确定数据怎样在</p>
<p>应用程序给出。保留字SELECT是DQL（也是所有SQL）用得最多的动词，其他DQL常用的保</p>
<p>留字有WHERE，ORDER BY，GROUP BY和HAVING。这些DQL保留字常与其他类型的SQL语句一</p>
<p>起使用。</p>
<p><strong>select语句执行顺序：</strong></p>
<p><img src="语句逻辑.png" alt="语句逻辑"></p>
<h3 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a><strong>SELECT</strong></h3><p>[ALL | DISTINCT | DISTINCTROW ]</p>
<p>[SQL_CACHE | SQL_NO_CACHE]</p>
<p>select_expr [, select_expr …]</p>
<p>[FROM table_references</p>
<p>[WHERE where_condition]</p>
<p>[GROUP BY {col_name | expr | position}</p>
<p>[ASC | DESC], … [WITH ROLLUP]]</p>
<p>[HAVING where_condition]</p>
<p>[ORDER BY {col_name | expr | position}</p>
<p>[ASC | DESC], …]</p>
<p>[LIMIT {[offset,] row_count | row_count OFFSET offset}]</p>
<p>[FOR UPDATE | LOCK IN SHARE MODE]</p>
<p>注意：select语句用法不同会造成性能消耗不同，性能差的写法甚至可能造成宕机</p>
<h3 id="LIKE"><a href="#LIKE" class="headerlink" title="LIKE:"></a><strong>LIKE:</strong></h3><p>%: 任意长度的任意字符</p>
<p>_：任意单个字符</p>
<p>RLIKE：正则表达式，索引失效，不建议使用</p>
<p>REGEXP：匹配字符串可用正则表达式书写模式，同上</p>
<p>逻辑操作符：</p>
<p>​         <strong>NOT</strong></p>
<p>​         <strong>AND</strong></p>
<p>​         <strong>OR</strong></p>
<p>​         <strong>XOR</strong></p>
<h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a><strong>示例：</strong></h3><p><strong>单表操作</strong></p>
<p>MariaDB [db1]&gt; select * from user;</p>
<p>+——+—————+———-+</p>
<p>| user | host          | password |</p>
<p>+——+—————+———-+</p>
<p>| root | localhost     |          |</p>
<p>| root | centos7.wangx |          |</p>
<p>| root | 127.0.0.1     |          |</p>
<p>| root | ::1           |          |</p>
<p>|      | localhost     |          |</p>
<p>|      | centos7.wangx |          |</p>
<p>+——+—————+———-+</p>
<p><strong>select也是一种语句：</strong></p>
<p>MariaDB [db1]&gt; select ‘hello world’;</p>
<p>+————-+</p>
<p>| hello world |</p>
<p>+————-+</p>
<p>| hello world |</p>
<p>+————-+</p>
<p><strong>也可以进行运算</strong></p>
<p>MariaDB [db1]&gt; select ‘1+2=’,1+2;</p>
<p>+——+—–+</p>
<p>| 1+2= | 1+2 |</p>
<p>+——+—–+</p>
<p>| 1+2= |   3 |</p>
<p>+——+—–+</p>
<p><strong>有类似与sed的特性：</strong></p>
<p>MariaDB [db1]&gt; select ‘1+2=’,1+2 from user;</p>
<p>+——+—–+</p>
<p>| 1+2= | 1+2 |</p>
<p>+——+—–+</p>
<p>| 1+2= |   3 |</p>
<p>| 1+2= |   3 |</p>
<p>| 1+2= |   3 |</p>
<p>| 1+2= |   3 |</p>
<p>| 1+2= |   3 |</p>
<p>| 1+2= |   3 |</p>
<p>+——+—–+</p>
<p>MariaDB [db1]&gt; select user,password from user;    </p>
<p>+——+———-+</p>
<p>| user | password |</p>
<p>+——+———-+</p>
<p>| root |          |</p>
<p>| root |          |</p>
<p>| root |          |</p>
<p>| root |          |</p>
<p>|      |          |</p>
<p>|      |          |</p>
<p>+——+———-+</p>
<p><strong>可添加自定义字符：</strong></p>
<p>MariaDB [db1]&gt; select ‘number’,user,password from user;</p>
<p>+——–+——+———-+</p>
<p>| number | user | password |</p>
<p>+——–+——+———-+</p>
<p>| number | root |          |</p>
<p>| number | root |          |</p>
<p>| number | root |          |</p>
<p>| number | root |          |</p>
<p>| number |      |          |</p>
<p>| number |      |          |</p>
<p>+——–+——+———-+</p>
<p><strong>限定条件select</strong></p>
<p>MariaDB [db1]&gt; select ‘number’,user,password from user where user=’root’;</p>
<p>+——–+——+———-+</p>
<p>| number | user | password |</p>
<p>+——–+——+———-+</p>
<p>| number | root |          |</p>
<p>| number | root |          |</p>
<p>| number | root |          |</p>
<p>| number | root |          |</p>
<p>+——–+——+———-+</p>
<p>MariaDB [db1]&gt; select * from students;                 </p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>判断条件，是否为空</strong></p>
<p><strong>搜索性别为空的学生信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where sex is null;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  4 | zhao |       | NULL |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>搜索性别不为空的学生信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where sex is not null;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>+—-+——+——-+——+</p>
<p><strong>搜索id大于2小于5的学生信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where id &gt;=2 and id&lt;=5;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>也可用between写法表示范围</strong></p>
<p>MariaDB [db1]&gt; select * from students where id between 2 and 5;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>字符范围搜索</strong></p>
<p>MariaDB [db1]&gt; select * from students where sex in (‘f’,’m’); </p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>+—-+——+——-+——+</p>
<p><strong>逻辑或关系搜索</strong></p>
<p>MariaDB [db1]&gt; select * from students where sex in (‘f’,’m’) or sex is null;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  0 | 70   |       | NULL |</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>|  4 | zhao |       | NULL |</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>可对字段定义别名（as可省略）</strong></p>
<p>MariaDB [db1]&gt; select id as 编号,name 姓名 from students where sex in (‘f’,’m’) or sex is null;   </p>
<p>+——–+——–+</p>
<p>| 编号   | 姓名   |</p>
<p>+——–+——–+</p>
<p>|      0 | 70     |</p>
<p>|      2 | liu    |</p>
<p>|      3 | lin    |</p>
<p>|      4 | zhao   |</p>
<p>|     70 | wang   |</p>
<p>+——–+——–+</p>
<h3 id="LIKE-1"><a href="#LIKE-1" class="headerlink" title="LIKE"></a><strong>LIKE</strong></h3><p><strong>功能：</strong>支持模糊搜索</p>
<p><strong>搜索名字以w开头学生信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where name like ‘w%’;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>| 70 | wang |       | NULL |</p>
<p>+—-+——+——-+——+</p>
<p><strong>搜索名字包含i的学生信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where name like ‘%i%’;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>+—-+——+——-+——+</p>
<p><strong>“_”可用来表示单个字符，搜索名字为三个字符的学生信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where name like ‘___’;</p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>+—-+——+——-+——+</p>
<h3 id="RLIKE"><a href="#RLIKE" class="headerlink" title="RLIKE"></a><strong>RLIKE</strong></h3><p><strong>功能：</strong>支持正则表达式，不建议使用，将导致索引生效！！！！！</p>
<p><strong>搜索名字以l开头的学员信息</strong></p>
<p>MariaDB [db1]&gt; select * from students where name rlike ‘^l’;  </p>
<p>+—-+——+——-+——+</p>
<p>| id | name | phone | sex  |</p>
<p>+—-+——+——-+——+</p>
<p>|  2 | liu  |       | m    |</p>
<p>|  3 | lin  |       | f    |</p>
<p>+—-+——+——-+——+</p>
<h3 id="GROUP"><a href="#GROUP" class="headerlink" title="GROUP"></a><strong>GROUP</strong></h3><p><strong>功能：</strong>根据指定的条件把查询结果进行“分组”以用于做“聚合”运算</p>
<p><strong>avg(), max(), min(), count(), sum()</strong></p>
<p><strong>HAVING:</strong> 对分组聚合运算后的结果指定过滤条件</p>
<p><strong>ORDER BY:</strong> 根据指定的字段对查询结果进行排序</p>
<p>升序：ASC</p>
<p>降序：DESC</p>
<p><strong>LIMIT [[offset,]row_count]：</strong>对查询的结果进行输出行数数量限制</p>
<p>对查询结果中的数据请求施加“锁”</p>
<p>FOR UPDATE: 写锁，独占或排它锁，只有一个读和写</p>
<p>LOCK IN SHARE MODE: 读锁，共享锁，同时多个读</p>
<p><strong>以下表为示例</strong></p>
<p>MariaDB [db1]&gt; select * from students;           </p>
<p>+—-+——-+——-+——-+——+</p>
<p>| id | name  | phone | score | sex  |</p>
<p>+—-+——-+——-+——-+——+</p>
<p>|  2 | liu   |       |    88 | m    |</p>
<p>|  3 | lin   |       |    84 | f    |</p>
<p>|  6 | zhang | 10010 |    76 | m    |</p>
<p>| 70 | wang  |       |    93 | f    |</p>
<p>+—-+——-+——-+——-+——+</p>
<p><strong>按性别分组统计最好成绩</strong></p>
<p>MariaDB [db1]&gt; select sex,max(score) as 最好成绩 from students group by sex; </p>
<p>+——+————–+</p>
<p>| sex  | 最好成绩     |</p>
<p>+——+————–+</p>
<p>| f    |           93 |</p>
<p>| m    |           88 |</p>
<p>+——+————–+</p>
<p><strong>按性别分组统计平均成绩</strong></p>
<p>MariaDB [db1]&gt; select sex,avg(score) from students group by sex;             </p>
<p>+——+————+</p>
<p>| sex  | avg(score) |</p>
<p>+——+————+</p>
<p>| f    |    88.5000 |</p>
<p>| m    |    82.0000 |</p>
<p>+——+————+</p>
<p><strong>多行分组：</strong></p>
<p>MariaDB [db1]&gt; select * from students;                       </p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| id | name  | phone | score | sex  | class |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>|  2 | liu   |       |    88 | m    |     1 |</p>
<p>|  3 | lin   |       |    84 | f    |     1 |</p>
<p>|  4 | abc   | 11000 |    86 | f    |     1 |</p>
<p>|  6 | zhang | 10010 |    76 | m    |     2 |</p>
<p>| 70 | wang  |       |    93 | f    |     2 |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p><strong>统计按班级，性别分组后的各组平均成绩</strong></p>
<p>MariaDB [db1]&gt; select class,sex,avg(score) from students group by class,sex;</p>
<p>+——-+——+————+</p>
<p>| class | sex  | avg(score) |</p>
<p>+——-+——+————+</p>
<p>|     1 | f    |    85.0000 |</p>
<p>|     1 | m    |    88.0000 |</p>
<p>|     2 | f    |    93.0000 |</p>
<p>|     2 | m    |    76.0000 |</p>
<p>+——-+——+————+</p>
<p><strong>count()统计数量：</strong></p>
<p>MariaDB [db1]&gt; select class,sex,count(*) from students group by class,sex;</p>
<p>+——-+——+———-+</p>
<p>| class | sex  | count(*) |</p>
<p>+——-+——+———-+</p>
<p>|     1 | f    |        2 |</p>
<p>|     1 | m    |        1 |</p>
<p>|     2 | f    |        1 |</p>
<p>|     2 | m    |        1 |</p>
<p>+——-+——+———-+</p>
<p><strong>统计数量时建议统计主键，可提高数率</strong></p>
<p>MariaDB [db1]&gt; select class,sex,count(id) from students group by class,sex;</p>
<p>+——-+——+———–+</p>
<p>| class | sex  | count(id) |</p>
<p>+——-+——+———–+</p>
<p>|     1 | f    |         2 |</p>
<p>|     1 | m    |         1 |</p>
<p>|     2 | f    |         1 |</p>
<p>|     2 | m    |         1 |</p>
<p>+——-+——+———–+</p>
<p><strong>统计学生人数</strong></p>
<p>MariaDB [db1]&gt; select count(id) from students;</p>
<p>+———–+</p>
<p>| count(id) |</p>
<p>+———–+</p>
<p>|         5 |</p>
<p>+———–+</p>
<p><strong>分组后过滤：</strong></p>
<p><strong>统计按班级，性别分组后的各组平均成绩，只显示平均成绩打印80的组统计信息</strong></p>
<p>MariaDB [db1]&gt; select class,sex,avg(score) from students group by class,sex having avg(score) &gt;80;</p>
<p>+——-+——+————+</p>
<p>| class | sex  | avg(score) |</p>
<p>+——-+——+————+</p>
<p>|     1 | f    |    85.0000 |</p>
<p>|     1 | m    |    88.0000 |</p>
<p>|     2 | f    |    93.0000 |</p>
<p>+——-+——+————+</p>
<p><strong>分组前过滤</strong></p>
<p><strong>只显示1班分组后的统计信息</strong></p>
<p>MariaDB [db1]&gt; select class,sex,avg(score) from students where class=1 group by class,sex having avg(score) &gt;80;</p>
<p>+——-+——+————+</p>
<p>| class | sex  | avg(score) |</p>
<p>+——-+——+————+</p>
<p>|     1 | f    |    85.0000 |</p>
<p>|     1 | m    |    88.0000 |</p>
<p>+——-+——+————+</p>
<h3 id="ORDER-BY"><a href="#ORDER-BY" class="headerlink" title="ORDER BY"></a><strong>ORDER BY</strong></h3><p><strong>正序排列：</strong></p>
<p>MariaDB [db1]&gt; select * from students order by score;</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| id | name  | phone | score | sex  | class |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>|  6 | zhang | 10010 |    76 | m    |     2 |</p>
<p>|  3 | lin   |       |    84 | f    |     1 |</p>
<p>|  4 | abc   | 11000 |    86 | f    |     1 |</p>
<p>|  2 | liu   |       |    88 | m    |     1 |</p>
<p>| 70 | wang  |       |    93 | f    |     2 |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p><strong>倒序排列：</strong></p>
<p>MariaDB [db1]&gt; select * from students order by score desc;</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| id | name  | phone | score | sex  | class |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| 70 | wang  |       |    93 | f    |     2 |</p>
<p>|  2 | liu   |       |    88 | m    |     1 |</p>
<p>|  4 | abc   | 11000 |    86 | f    |     1 |</p>
<p>|  3 | lin   |       |    84 | f    |     1 |</p>
<p>|  6 | zhang | 10010 |    76 | m    |     2 |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p><strong>小技巧：利用-调整空字符NULL的位置</strong></p>
<p>MariaDB [db1]&gt; select * from students order by score desc;</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| id | name  | phone | score | sex  | class |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| 70 | wang  |       |    93 | f    |     2 |</p>
<p>|  2 | liu   |       |    88 | m    |     1 |</p>
<p>|  4 | abc   | 11000 |    86 | f    |     1 |</p>
<p>|  3 | lin   |       |    84 | f    |     1 |</p>
<p>|  6 | zhang | 10010 |    76 | m    |     2 |</p>
<p>|  7 | zz    | 10086 |    69 | m    |     2 |</p>
<p>|  8 | zhao  | 10000 |  NULL | m    |     1 |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>MariaDB [db1]&gt; select * from students order by -score desc;</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| id | name  | phone | score | sex  | class |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>|  7 | zz    | 10086 |    69 | m    |     2 |</p>
<p>|  6 | zhang | 10010 |    76 | m    |     2 |</p>
<p>|  3 | lin   |       |    84 | f    |     1 |</p>
<p>|  4 | abc   | 11000 |    86 | f    |     1 |</p>
<p>|  2 | liu   |       |    88 | m    |     1 |</p>
<p>| 70 | wang  |       |    93 | f    |     2 |</p>
<p>|  8 | zhao  | 10000 |  NULL | m    |     1 |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<h3 id="LIMIT"><a href="#LIMIT" class="headerlink" title="LIMIT"></a><strong>LIMIT</strong></h3><p>MariaDB [db1]&gt; select * from students order by score limit 3;</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>| id | name  | phone | score | sex  | class |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<p>|  8 | zhao  | 10000 |  NULL | m    |     1 |</p>
<p>|  7 | zz    | 10086 |    69 | m    |     2 |</p>
<p>|  6 | zhang | 10010 |    76 | m    |     2 |</p>
<p>+—-+——-+——-+——-+——+——-+</p>
<h2 id="五、多表查询SQJ-JOIN"><a href="#五、多表查询SQJ-JOIN" class="headerlink" title="五、多表查询SQJ JOIN"></a><strong>五、多表查询SQJ JOIN</strong></h2><h3 id="多表查询中主要的-SQL-JOIN-类型："><a href="#多表查询中主要的-SQL-JOIN-类型：" class="headerlink" title="多表查询中主要的 SQL JOIN 类型："></a><strong>多表查询中主要的 SQL JOIN 类型：</strong></h3><p><strong>INNER JOIN：</strong>如果表中有至少一个匹配，则返回行</p>
<p><strong>LEFT JOIN：</strong>即使右表中没有匹配，也从左表返回所有的行</p>
<p><strong>RIGHT JOIN：</strong>即使左表中没有匹配，也从右表返回所有的行</p>
<p><strong>FULL JOIN：</strong>只要其中一个表中存在匹配，则返回行</p>
<p><strong>CROSS JOIN：</strong>用于生成两张表的笛卡尔集</p>
<p><strong>本次示例，我们将使用 HELLODB 样本数据库。</strong></p>
<p><strong>下面是选自 “teachers” 表的数据：</strong></p>
<p>MariaDB [hellodb]&gt; select * from teachers;</p>
<p>+—–+—————+—–+——–+</p>
<p>| TID | Name          | Age | Gender |</p>
<p>+—–+—————+—–+——–+</p>
<p>|   1 | Song Jiang    |  45 | M      |</p>
<p>|   2 | Zhang Sanfeng |  94 | M      |</p>
<p>|   3 | Miejue Shitai |  77 | F      |</p>
<p>|   4 | Lin Chaoying  |  93 | F      |</p>
<p>+—–+—————+—–+——–+</p>
<p><strong>以下是 “students” 表的数据</strong></p>
<p>MariaDB [hellodb]&gt; select * from students;</p>
<p>+——-+—————+—–+——–+———+———–+</p>
<p>| StuID | Name          | Age | Gender | ClassID | TeacherID |</p>
<p>+——-+—————+—–+——–+———+———–+</p>
<p>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</p>
<p>|     2 | Shi Potian    |  22 | M      |       1 |         7 |</p>
<p>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</p>
<p>|     4 | Ding Dian     |  32 | M      |       4 |         4 |</p>
<p>|     5 | Yu Yutong     |  26 | M      |       3 |         1 |</p>
<p>|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</p>
<p>|     7 | Xi Ren        |  19 | F      |       3 |      NULL |</p>
<p>|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</p>
<p>|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</p>
<p>|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |</p>
<p>|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</p>
<p>|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</p>
<p>|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</p>
<p>|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</p>
<p>|    15 | Duan Yu       |  19 | M      |       4 |      NULL |</p>
<p>|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</p>
<p>|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</p>
<p>|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</p>
<p>|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</p>
<p>|    20 | Diao Chan     |  19 | F      |       7 |      NULL |</p>
<p>|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</p>
<p>|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</p>
<p>|    23 | Ma Chao       |  23 | M      |       4 |      NULL |</p>
<p>|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</p>
<p>|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</p>
<p>+——-+—————+—–+——–+———+———–+</p>
<h3 id="内连接：INNER-JOIN"><a href="#内连接：INNER-JOIN" class="headerlink" title="内连接：INNER JOIN"></a><strong>内连接：INNER JOIN</strong></h3><p><strong>效果：</strong>如果表中有至少一个匹配，则返回行</p>
<p><img src="内连接.png" alt="内连接"></p>
<p><strong>写法一：</strong>旧写法</p>
<p>MariaDB [hellodb]&gt; select s.name,t.name from students as s,teachers as t where s.teacherid=t.tid;</p>
<p>+————-+—————+</p>
<p>| name        | name          |</p>
<p>+————-+—————+</p>
<p>| Yu Yutong   | Song Jiang    |</p>
<p>| Shi Zhongyu | Miejue Shitai |</p>
<p>| Ding Dian   | Lin Chaoying  |</p>
<p>+————-+—————+</p>
<p>MariaDB [hellodb]&gt; select s.name as 学生姓名,t.name as 讲师姓名 from students as s,teachers as t where s.teacherid=t.tid;   </p>
<p>+————–+—————+</p>
<p>| 学生姓名     | 讲师姓名      |</p>
<p>+————–+—————+</p>
<p>| Yu Yutong    | Song Jiang    |</p>
<p>| Shi Zhongyu  | Miejue Shitai |</p>
<p>| Ding Dian    | Lin Chaoying  |</p>
<p>+————–+—————+</p>
<p><strong>写法二：</strong>SQL标准写法，适合其他类型数据库</p>
<p>MariaDB [hellodb]&gt; select s.name as 学生姓名,t.name as 讲师姓名 from students as s inner join teachers as t on s.teacherid=t.tid;</p>
<p>+————–+—————+</p>
<p>| 学生姓名     | 讲师姓名      |</p>
<p>+————–+—————+</p>
<p>| Yu Yutong    | Song Jiang    |</p>
<p>| Shi Zhongyu  | Miejue Shitai |</p>
<p>| Ding Dian    | Lin Chaoying  |</p>
<p>+————–+—————+</p>
<h3 id="交叉连接：CROSS-JOIN"><a href="#交叉连接：CROSS-JOIN" class="headerlink" title="交叉连接：CROSS JOIN"></a><strong>交叉连接：CROSS JOIN</strong></h3><p><strong>效果：</strong>用于生成两张表的笛卡尔集，笛卡尔集的列数为每个表的列数之</p>
<p>和，笛卡尔集的行数为每个表的行数相乘。我们经常做的多表查询就是在笛卡</p>
<p>尔集中通过筛选条件得出的数据，所以笛卡尔集是多表查询的基础。</p>
<p>MariaDB [hellodb]&gt; select * from students cross join teachers;</p>
<p>+——-+—————+—–+——–+———+———–+—–+—————+—–+——–+</p>
<p>| StuID | Name          | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</p>
<p>+——-+—————+—–+——–+———+———–+—–+—————+—–+——–+</p>
<p>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   1 | Song Jiang    |  45 | M      |</p>
<p>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   2 | Zhang Sanfeng |  94 | M      |</p>
<p>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</p>
<p>|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   4 | Lin Chaoying  |  93 | F      |</p>
<p>|     2 | Shi Potian    |  22 | M      |       1 |         7 |   1 | Song Jiang    |  45 | M      |</p>
<p>|     2 | Shi Potian    |  22 | M      |       1 |         7 |   2 | Zhang Sanfeng |  94 | M      |</p>
<p>|     2 | Shi Potian    |  22 | M      |       1 |         7 |   3 | Miejue Shitai |  77 | F      |</p>
<p>|     2 | Shi Potian    |  22 | M      |       1 |         7 |   4 | Lin Chaoying  |  93 | F      |</p>
<p>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   1 | Song Jiang    |  45 | M      |</p>
<p>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   2 | Zhang Sanfeng |  94 | M      |</p>
<p>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   3 | Miejue Shitai |  77 | F      |</p>
<p>|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   4 | Lin Chaoying  |  93 | F      |</p>
<p>|     4 | Ding Dian     |  32 | M      |       4 |         4 |   1 | Song Jiang    |  45 | M      |</p>
<p>|     4 | Ding Dian     |  32 | M      |       4 |         4 |   2 | Zhang Sanfeng |  94 | M      |</p>
<p>|     4 | Ding Dian     |  32 | M      |       4 |         4 |   3 | Miejue Shitai |  77 | F      |</p>
<p>|     4 | Ding Dian     |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</p>
<p>|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</p>
<p>…….</p>
<h3 id="左外连接：LEFT-JOIN"><a href="#左外连接：LEFT-JOIN" class="headerlink" title="左外连接：LEFT JOIN"></a><strong>左外连接：LEFT JOIN</strong></h3><p><strong>功能：</strong>即使右表中没有匹配，也从左表返回所有的行</p>
<p><strong>注释：</strong>在某些数据库中，LEFT JOIN 称为 LEFT OUTER JOIN</p>
<p><img src="左连接.png" alt="左连接"></p>
<p>MariaDB [hellodb]&gt; select s.name as studentname,t.name as teachername from students as s left outer join teachers as t on s.teacherid=t.tid;</p>
<p>+—————+—————+</p>
<p>| studentname   | teachername   |</p>
<p>+—————+—————+</p>
<p>| Shi Zhongyu   | Miejue Shitai |</p>
<p>| Shi Potian    | NULL          |</p>
<p>| Xie Yanke     | NULL          |</p>
<p>| Ding Dian     | Lin Chaoying  |</p>
<p>| Yu Yutong     | Song Jiang    |</p>
<p>| Shi Qing      | NULL          |</p>
<p>| Xi Ren        | NULL          |</p>
<p>| Lin Daiyu     | NULL          |</p>
<p>| Ren Yingying  | NULL          |</p>
<p>| Yue Lingshan  | NULL          |</p>
<p>| Yuan Chengzhi | NULL          |</p>
<p>| Wen Qingqing  | NULL          |</p>
<p>| Tian Boguang  | NULL          |</p>
<p>| Lu Wushuang   | NULL          |</p>
<p>| Duan Yu       | NULL          |</p>
<p>| Xu Zhu        | NULL          |</p>
<p>| Lin Chong     | NULL          |</p>
<p>| Hua Rong      | NULL          |</p>
<p>| Xue Baochai   | NULL          |</p>
<p>| Diao Chan     | NULL          |</p>
<p>| Huang Yueying | NULL          |</p>
<p>| Xiao Qiao     | NULL          |</p>
<p>| Ma Chao       | NULL          |</p>
<p>| Xu Xian       | NULL          |</p>
<p>| Sun Dasheng   | NULL          |</p>
<p>+—————+—————+</p>
<h3 id="右外连接：RIGHT-JOIN"><a href="#右外连接：RIGHT-JOIN" class="headerlink" title="右外连接：RIGHT JOIN"></a><strong>右外连接：RIGHT JOIN</strong></h3><p><strong>效果：</strong>即使左表中没有匹配，也从右表返回所有的行</p>
<p><strong>注释：</strong>在某些数据库中，LEFT JOIN 称为 RIGHT OUTER JOIN</p>
<p><img src="右连接.png" alt="右连接"></p>
<p>MariaDB [hellodb]&gt; select s.name as studentname,t.name as teachername from students as s right outer join teachers as t on s.teacherid=t.tid;   </p>
<p>+————-+—————+</p>
<p>| studentname | teachername   |</p>
<p>+————-+—————+</p>
<p>| Shi Zhongyu | Miejue Shitai |</p>
<p>| Ding Dian   | Lin Chaoying  |</p>
<p>| Yu Yutong   | Song Jiang    |</p>
<p>| NULL        | Zhang Sanfeng |</p>
<p>+————-+—————+</p>
<h3 id="联合查询：union"><a href="#联合查询：union" class="headerlink" title="联合查询：union"></a><strong>联合查询：union</strong></h3><p><strong>效果：</strong>两张表上下连起来，类似cat a b的效果</p>
<p>MariaDB [hellodb]&gt; select name from students union select name from teachers;</p>
<p>+—————+</p>
<p>| name          |</p>
<p>+—————+</p>
<p>| Shi Zhongyu   |</p>
<p>| Shi Potian    |</p>
<p>| Xie Yanke     |</p>
<p>| Ding Dian     |</p>
<p>| Yu Yutong     |</p>
<p>| Shi Qing      |</p>
<p>| Xi Ren        |</p>
<p>| Lin Daiyu     |</p>
<p>| Ren Yingying  |</p>
<p>| Yue Lingshan  |</p>
<p>| Yuan Chengzhi |</p>
<p>| Wen Qingqing  |</p>
<p>| Tian Boguang  |</p>
<p>| Lu Wushuang   |</p>
<p>| Duan Yu       |</p>
<p>| Xu Zhu        |</p>
<p>| Lin Chong     |</p>
<p>| Hua Rong      |</p>
<p>| Xue Baochai   |</p>
<p>| Diao Chan     |</p>
<p>| Huang Yueying |</p>
<p>| Xiao Qiao     |</p>
<p>| Ma Chao       |</p>
<p>| Xu Xian       |</p>
<p>| Sun Dasheng   |</p>
<p>| Song Jiang    |</p>
<p>| Zhang Sanfeng |</p>
<p>| Miejue Shitai |</p>
<p>| Lin Chaoying  |</p>
<p>+—————+</p>
<p>29 rows in set (0.00 sec)</p>
<h3 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a><strong>自连接</strong></h3><p><strong>功能：</strong>将一张表想象成两张表，自己连接自己</p>
<p>MariaDB [hellodb]&gt; select s1.name as emp,s2.name as leader from students as s1 inner join students as s2 on s1.teacherid=s2.stuid;  </p>
<p>+————-+————-+</p>
<p>| emp         | leader      |</p>
<p>+————-+————-+</p>
<p>| Shi Zhongyu | Xie Yanke   |</p>
<p>| Shi Potian  | Xi Ren      |</p>
<p>| Xie Yanke   | Xu Zhu      |</p>
<p>| Ding Dian   | Ding Dian   |</p>
<p>| Yu Yutong   | Shi Zhongyu |</p>
<p>+————-+————-+</p>
<h3 id="左自连接"><a href="#左自连接" class="headerlink" title="左自连接"></a>左自连接</h3><p>MariaDB [hellodb]&gt; select s1.name as emp,s2.name as leader from students as s1 left outer join students as s2 on s1.teacherid=s2.stuid;        </p>
<p>+—————+————-+</p>
<p>| emp           | leader      |</p>
<p>+—————+————-+</p>
<p>| Shi Zhongyu   | Xie Yanke   |</p>
<p>| Shi Potian    | Xi Ren      |</p>
<p>| Xie Yanke     | Xu Zhu      |</p>
<p>| Ding Dian     | Ding Dian   |</p>
<p>| Yu Yutong     | Shi Zhongyu |</p>
<p>| Shi Qing      | NULL        |</p>
<p>| Xi Ren        | NULL        |</p>
<p>| Lin Daiyu     | NULL        |</p>
<p>| Ren Yingying  | NULL        |</p>
<p>| Yue Lingshan  | NULL        |</p>
<p>| Yuan Chengzhi | NULL        |</p>
<p>| Wen Qingqing  | NULL        |</p>
<p>| Tian Boguang  | NULL        |</p>
<p>| Lu Wushuang   | NULL        |</p>
<p>| Duan Yu       | NULL        |</p>
<p>| Xu Zhu        | NULL        |</p>
<p>| Lin Chong     | NULL        |</p>
<p>| Hua Rong      | NULL        |</p>
<p>| Xue Baochai   | NULL        |</p>
<p>| Diao Chan     | NULL        |</p>
<p>| Huang Yueying | NULL        |</p>
<p>| Xiao Qiao     | NULL        |</p>
<p>| Ma Chao       | NULL        |</p>
<p>| Xu Xian       | NULL        |</p>
<p>| Sun Dasheng   | NULL        |</p>
<p>+—————+————-+</p>
<p><strong>右自连接</strong></p>
<p>MariaDB [hellodb]&gt; select s1.name as emp,s2.name as leader from students as s1 right join students as s2 on s1.stuid=s2.teacherid;   </p>
<p>+————-+—————+</p>
<p>| emp         | leader        |</p>
<p>+————-+—————+</p>
<p>| Xie Yanke   | Shi Zhongyu   |</p>
<p>| Xi Ren      | Shi Potian    |</p>
<p>| Xu Zhu      | Xie Yanke     |</p>
<p>| Ding Dian   | Ding Dian     |</p>
<p>| Shi Zhongyu | Yu Yutong     |</p>
<p>| NULL        | Shi Qing      |</p>
<p>| NULL        | Xi Ren        |</p>
<p>| NULL        | Lin Daiyu     |</p>
<p>| NULL        | Ren Yingying  |</p>
<p>| NULL        | Yue Lingshan  |</p>
<p>| NULL        | Yuan Chengzhi |</p>
<p>| NULL        | Wen Qingqing  |</p>
<p>| NULL        | Tian Boguang  |</p>
<p>| NULL        | Lu Wushuang   |</p>
<p>| NULL        | Duan Yu       |</p>
<p>| NULL        | Xu Zhu        |</p>
<p>| NULL        | Lin Chong     |</p>
<p>| NULL        | Hua Rong      |</p>
<p>| NULL        | Xue Baochai   |</p>
<p>| NULL        | Diao Chan     |</p>
<p>| NULL        | Huang Yueying |</p>
<p>| NULL        | Xiao Qiao     |</p>
<p>| NULL        | Ma Chao       |</p>
<p>| NULL        | Xu Xian       |</p>
<p>| NULL        | Sun Dasheng   |</p>
<p>+————-+—————+</p>
<h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a><strong>子查询</strong></h3><p>下表是内连接查询姓名和分数信息</p>
<p>MariaDB [hellodb]&gt; select students.name,scores.score from students inner join scores on students.stuid=scores.id;</p>
<p>+—————+——-+</p>
<p>| name          | score |</p>
<p>+—————+——-+</p>
<p>| Shi Zhongyu   |    77 |</p>
<p>| Shi Potian    |    93 |</p>
<p>| Xie Yanke     |    47 |</p>
<p>| Ding Dian     |    97 |</p>
<p>| Yu Yutong     |    88 |</p>
<p>| Shi Qing      |    75 |</p>
<p>| Xi Ren        |    71 |</p>
<p>| Lin Daiyu     |    89 |</p>
<p>| Ren Yingying  |    39 |</p>
<p>| Yue Lingshan  |    63 |</p>
<p>| Yuan Chengzhi |    96 |</p>
<p>| Wen Qingqing  |    86 |</p>
<p>| Tian Boguang  |    83 |</p>
<p>| Lu Wushuang   |    57 |</p>
<p>| Duan Yu       |    93 |</p>
<p>+—————+——-+</p>
<p><strong>取大于平均成绩的同学和成绩</strong></p>
<p>MariaDB [hellodb]&gt; select students.name,scores.score from students inner join scores on students.stuid=scores.id and score &gt; (select avg(score) from scores);</p>
<p>+—————+——-+</p>
<p>| name          | score |</p>
<p>+—————+——-+</p>
<p>| Shi Zhongyu   |    77 |</p>
<p>| Shi Potian    |    93 |</p>
<p>| Ding Dian     |    97 |</p>
<p>| Yu Yutong     |    88 |</p>
<p>| Lin Daiyu     |    89 |</p>
<p>| Yuan Chengzhi |    96 |</p>
<p>| Wen Qingqing  |    86 |</p>
<p>| Tian Boguang  |    83 |</p>
<p>| Duan Yu       |    93 |</p>
<p>+—————+——-+</p>
<h2 id="六、视图VIEW"><a href="#六、视图VIEW" class="headerlink" title="六、视图VIEW"></a><strong>六、视图VIEW</strong></h2><p><strong>视图：</strong>VIEW,虚表，保存有实表的查询结果</p>
<p>类似于shell中起个别名</p>
<p>视图不存数据，修改视图实际是修改了背后的表</p>
<p>物化视图：视图在磁盘上也占空间</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例:"></a><strong>示例:</strong></h3><p>MariaDB [hellodb]&gt; create view view_students as select stuid,name from students;</p>
<p>MariaDB [hellodb]&gt; select * from view_students;</p>
<p>+——-+—————+</p>
<p>| stuid | name          |</p>
<p>+——-+—————+</p>
<p>|     1 | Shi Zhongyu   |</p>
<p>|     2 | Shi Potian    |</p>
<p>|     3 | Xie Yanke     |</p>
<p>|     4 | Ding Dian     |</p>
<p>|     5 | Yu Yutong     |</p>
<p>|     6 | Shi Qing      |</p>
<p>|     7 | Xi Ren        |</p>
<p>|     8 | Lin Daiyu     |</p>
<p>|     9 | Ren Yingying  |</p>
<p>|    10 | Yue Lingshan  |</p>
<p>|    11 | Yuan Chengzhi |</p>
<p>|    12 | Wen Qingqing  |</p>
<p>|    13 | Tian Boguang  |</p>
<p>|    14 | Lu Wushuang   |</p>
<p>|    15 | Duan Yu       |</p>
<p>|    16 | Xu Zhu        |</p>
<p>|    17 | Lin Chong     |</p>
<p>|    18 | Hua Rong      |</p>
<p>|    19 | Xue Baochai   |</p>
<p>|    20 | Diao Chan     |</p>
<p>|    21 | Huang Yueying |</p>
<p>|    22 | Xiao Qiao     |</p>
<p>|    23 | Ma Chao       |</p>
<p>|    24 | Xu Xian       |</p>
<p>|    25 | Sun Dasheng   |</p>
<p>+——-+—————+</p>
<p>25 rows in set (0.00 sec)</p>
<p>判断一个表是否为视图：Comment状态</p>
<p>MariaDB [hellodb]&gt; show tables;</p>
<p>+——————-+</p>
<p>| Tables_in_hellodb |</p>
<p>+——————-+</p>
<p>| classes           |</p>
<p>| coc               |</p>
<p>| courses           |</p>
<p>| scores            |</p>
<p>| students          |</p>
<p>| teachers          |</p>
<p>| toc               |</p>
<p>| view_students     |</p>
<p>+——————-+</p>
<p>MariaDB [hellodb]&gt; show table status like ‘view_students’\G; </p>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong></p>
<p>Name: view_students</p>
<p>Engine: NULL</p>
<p>Version: NULL</p>
<p>Row_format: NULL</p>
<p>Rows: NULL</p>
<p>Avg_row_length: NULL</p>
<p>Data_length: NULL</p>
<p>Max_data_length: NULL</p>
<p>Index_length: NULL</p>
<p>Data_free: NULL</p>
<p>Auto_increment: NULL</p>
<p>Create_time: NULL</p>
<p>Update_time: NULL</p>
<p>Check_time: NULL</p>
<p>Collation: NULL</p>
<p>Checksum: NULL</p>
<p>Create_options: NULL</p>
<p>​        <strong>Comment: VIEW</strong></p>
<p>MariaDB [hellodb]&gt; show table status like ‘students’\G;    </p>
<p><strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong>***</strong></strong></strong></strong></strong></strong></p>
<p>Name: students</p>
<p>Engine: InnoDB</p>
<p>Version: 10</p>
<p>Row_format: Compact</p>
<p>Rows: 25</p>
<p>Avg_row_length: 655</p>
<p>Data_length: 16384</p>
<p>Max_data_length: 0</p>
<p>Index_length: 0</p>
<p>Data_free: 9437184</p>
<p>Auto_increment: 26</p>
<p>Create_time: 2018-06-06 21:25:56</p>
<p>Update_time: NULL</p>
<p>Check_time: NULL</p>
<p>Collation: utf8_general_ci</p>
<p>Checksum: NULL</p>
<p>Create_options:</p>
<p>Comment:</p>
<p><strong>删除视图</strong></p>
<p>MariaDB [hellodb]&gt; show tables;</p>
<p>+——————-+</p>
<p>| Tables_in_hellodb |</p>
<p>+——————-+</p>
<p>| classes           |</p>
<p>| coc               |</p>
<p>| courses           |</p>
<p>| scores            |</p>
<p>| students          |</p>
<p>| teachers          |</p>
<p>| toc               |</p>
<p>| view_goodstudent  |</p>
<p>| view_students     |</p>
<p>+——————-+</p>
<p>MariaDB [hellodb]&gt; drop view view_goodstudent;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/07/实验：实现互联网的DNS架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/07/实验：实现互联网的DNS架构/" itemprop="url">实验：实现互联网的DNS架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-07T15:31:36+08:00">
                2018-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络技术/" itemprop="url" rel="index">
                    <span itemprop="name">网络技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>实现互联网DNS分布式架构，当客户端访问时，经各级自建DNS解析，最终指向Web1或者Web2服务器httpd服务</p>
<h3 id="实验拓扑图："><a href="#实验拓扑图：" class="headerlink" title="实验拓扑图："></a><strong>实验拓扑图：</strong></h3><p><img src="DNS互联网架构实验拓扑图.jpg" alt="DNS互联网架构实验拓扑图"></p>
<h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>准备8台虚拟机，操作系统及IP地址分别为</p>
<p><strong>Root DNS Server：</strong>             CentOS6.9    IP：<strong>192.168.30.15</strong></p>
<p><strong>Com DNS Server：</strong>              CentOS6.9    IP：<strong>192.168.30.16</strong></p>
<p><strong>Master DNS Server：</strong>         CentOS6.9    IP：<strong>192.168.30.12</strong></p>
<p><strong>Slave DNS Server：</strong>            CentOS6.9    IP：<strong>192.168.30.17</strong></p>
<p><strong>Web1 Server：</strong>                     CentOS7.4    IP：<strong>192.168.30.10</strong></p>
<p><strong>Web2 Server：</strong>                     CentOS6.9    IP：<strong>192.168.30.11</strong></p>
<p><strong>ISP DNS Server：</strong>                CentOS6.9    IP：<strong>192.168.30.18</strong></p>
<p><strong>Client：</strong>                                  CentOS6.9    IP：<strong>192.168.30.19</strong></p>
<p>关闭所有主机的<strong>SELinux</strong>安全策略，关闭<strong>iptables</strong>防火墙</p>
<h3 id="实验预期："><a href="#实验预期：" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>实现互联网DNS分布式架构，当客户端访问时，经各级DNS解析，最终指向Web1或者Web2服务器httpd服</p>
<p>务。</p>
<h3 id="一、搭建-web-服务器："><a href="#一、搭建-web-服务器：" class="headerlink" title="一、搭建**web**服务器："></a><strong>一、搭建**</strong>web<strong>**服务器：</strong></h3><p><strong>Web1 Server：</strong></p>
<p>echo welcome to magedu.com websrv1 &gt; /var/www/html/index.html</p>
<p>systemctl start httpd</p>
<p><strong>Web2 Server:</strong></p>
<p>echo welcome to magedu.com websrv1 &gt; /var/www/html/index.html</p>
<p>service httpd start</p>
<p>切换至Client确认web1，web2能够正常访问</p>
<p>Curl 192.168.30.10</p>
<p>Curl 192.168.30.11</p>
<p><img src="1-10.png" alt="1"></p>
<p><strong>二、搭建主**</strong>DNS<strong>**服务器：</strong></p>
<p>yum install bind</p>
<p><strong>vim /etc/named.conf</strong></p>
<p><img src="3-6.png" alt="3"></p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p><img src="4-6.png" alt="4"></p>
<p><strong>vim /var/named/wxlinux.com.zone</strong></p>
<p><img src="5-4.png" alt="5"></p>
<p>切换到Client测试主DNS服务器：</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a>  @192.168.30.12</p>
<p><img src="6-4.png" alt="6"></p>
<h3 id="三、搭建从-DNS-服务器"><a href="#三、搭建从-DNS-服务器" class="headerlink" title="三、搭建从**DNS**服务器"></a><strong>三、搭建从**</strong>DNS<strong>**服务器</strong></h3><p><strong>vim /etc/named.conf</strong></p>
<p><img src="7-3.png" alt="7"></p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p><img src="8-1.png" alt="8"></p>
<p>启动named服务，确认slave文件生成：</p>
<p>service named start</p>
<p><img src="9.png" alt="9"></p>
<p>切换到Client测试从DNS服务器：</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a>  @192.168.30.17</p>
<p><img src="10.png" alt="10"></p>
<h3 id="四、搭建-com-服务器"><a href="#四、搭建-com-服务器" class="headerlink" title="四、搭建**com**服务器"></a><strong>四、搭建**</strong>com<strong>**服务器</strong></h3><p><strong>vim /etc/named.conf</strong></p>
<p><img src="11.png" alt="11"></p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p><img src="12.png" alt="12"></p>
<p><strong>vim com.zone</strong></p>
<p><img src="13.png" alt="13"></p>
<p>切换到Client测试从Com服务器：</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a>  @192.168.30.16</p>
<p><img src="14.png" alt="14"></p>
<h3 id="五、搭建根-DNS-服务器"><a href="#五、搭建根-DNS-服务器" class="headerlink" title="五、搭建根**DNS**服务器"></a><strong>五、搭建根**</strong>DNS<strong>**服务器</strong></h3><p><strong>vim /etc/named.conf</strong></p>
<p><img src="15.png" alt="15"></p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p><img src="16.png" alt="16"></p>
<p><strong>vim root.zone</strong></p>
<p><img src="17.png" alt="17"></p>
<p>切换到Client测试根DNS服务器：</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a>  @192.168.30.15</p>
<p><img src="18.png" alt="18"></p>
<h3 id="六、搭建-ISP-服务器"><a href="#六、搭建-ISP-服务器" class="headerlink" title="六、搭建**ISP**服务器"></a><strong>六、搭建**</strong>ISP<strong>**服务器</strong></h3><p><strong>vim /etc/named.conf</strong></p>
<p><img src="19.png" alt="19"></p>
<p><strong>vim /var/named/named.ca</strong></p>
<p><img src="20.png" alt="20"></p>
<h3 id="七、客户端进行最后测试"><a href="#七、客户端进行最后测试" class="headerlink" title="七、客户端进行最后测试"></a><strong>七、客户端进行最后测试</strong></h3><p>修改DNS</p>
<p><strong>vim /etc/resolv.conf</strong></p>
<p><img src="21.png" alt="21"></p>
<p>dig  <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a></p>
<p><img src="22.png" alt="22"></p>
<p>当访问<a href="http://www.wxlinux.com时，将随机指向两台web服务器之一" target="_blank" rel="noopener">www.wxlinux.com时，将随机指向两台web服务器之一</a></p>
<p>curl <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a></p>
<p><img src="23.png" alt="23"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/05/MySQL数据库简介及安装实验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/05/MySQL数据库简介及安装实验/" itemprop="url">MySQL数据库简介及安装实验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-05T15:32:56+08:00">
                2018-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、MySQL数据库简介"><a href="#一、MySQL数据库简介" class="headerlink" title="一、MySQL数据库简介"></a><strong>一、MySQL数据库简介</strong></h2><p><strong>MySQL</strong>是一个关系型数据库管理系统，由瑞典MySQL AB 公司开发，目前</p>
<p>属于 Oracle 旗下产品。MySQL 是最流行的关系型数据库管理系统之一，</p>
<p>在 WEB 应用方面，MySQL是最好的 <strong>RDBMS (Relational Database Management</strong></p>
<p> <strong>System，关系数据库管理系统)</strong> 应用软件。</p>
<h3 id="MySQL历史"><a href="#MySQL历史" class="headerlink" title="MySQL历史"></a><strong>MySQL历史</strong></h3><p>1979年：TcX公司 Monty Widenius，Unireg</p>
<p>1996年：发布MySQL1.0，Solaris版本，Linux版本</p>
<p>1999年：MySQL AB公司，瑞典</p>
<p>2003年：MySQL 5.0版本，提供视图、存储过程等功能</p>
<p>2008年：Sun 收购</p>
<p>2009年：Oracle收购sun</p>
<p>2009年：Monty成立MariaDB</p>
<h3 id="MySQL和MariaDB"><a href="#MySQL和MariaDB" class="headerlink" title="MySQL和MariaDB"></a>MySQL和MariaDB</h3><p>官方网址：</p>
<p><a href="https://www.mysql.com/" target="_blank" rel="noopener">https://www.mysql.com/</a></p>
<p><a href="http://mariadb.org/" target="_blank" rel="noopener">http://mariadb.org/</a></p>
<p>官方文档</p>
<p><a href="https://dev.mysql.com/doc/" target="_blank" rel="noopener">https://dev.mysql.com/doc/</a></p>
<p><a href="https://mariadb.com/kb/en/" target="_blank" rel="noopener">https://mariadb.com/kb/en/</a></p>
<p>版本演变：</p>
<p>MySQL：5.1 –&gt; 5.5 –&gt; 5.6 –&gt; 5.7</p>
<p>MariaDB：5.5 –&gt;10.0–&gt; 10.1 –&gt; 10.2 –&gt; 10.3</p>
<h3 id="MariaDB的特性"><a href="#MariaDB的特性" class="headerlink" title="MariaDB的特性"></a><strong>MariaDB的特性</strong></h3><p>插件式存储引擎：也称为“表类型”，存储管理器有多种实现版本，功能和特</p>
<p>性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始innoDB引擎是</p>
<p>MYSQL默认引擎</p>
<p>MyISAM ==&gt; Aria</p>
<p>InnoDB ==&gt; XtraDB</p>
<p>单进程，多线程</p>
<p>诸多扩展和新特性</p>
<p>提供了较多测试组件</p>
<p>开源</p>
<p><strong>下面我们以MariaDB为例，来介绍数据库在Linux系统上的安装</strong></p>
<h2 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h2><p>操作系统：CentOS 7.4</p>
<p>环境准备：关闭SELinux安全策略，Iptables防火墙，确认当前主机未安装MySQL或MariaDB其他版本</p>
<p>准备对应的安装包：</p>
<p>MariaDB 10.2.15官方下载页面：<a href="https://downloads.mariadb.org/mariadb/10.2.15/" target="_blank" rel="noopener">https://downloads.mariadb.org/mariadb/10.2.15/</a></p>
<p><strong>mariadb-10.2.15.tar</strong>                                 MariaDB源代码安装包</p>
<p><strong>mariadb-10.2.15-linux-x86_64.tar</strong>                 MariaDB二进制格式安装包</p>
<p>![LG<a href="http://www.178linux.com/wp-content/uploads/2018/06/LGPR5YOL5HQZYA8@2.png" target="_blank" rel="noopener">PR<code>5{Y</code>OL{5%HQZYA8@2</a></p>
<h2 id="一、实验：使用yum源安装MariaDB-10-2-15"><a href="#一、实验：使用yum源安装MariaDB-10-2-15" class="headerlink" title="一、实验：使用yum源安装MariaDB 10.2.15"></a><strong>一、实验：使用yum源安装MariaDB 10.2.15</strong></h2><p>去官网查询，复制yum源，yum install</p>
<p>1登录MariaDB官方网站：<a href="http://mariadb.org/" target="_blank" rel="noopener">http://mariadb.org/</a></p>
<p>MariaDB 10.2.15下载界面：<a href="https://downloads.mariadb.org/mariadb/10.2.15/" target="_blank" rel="noopener">https://downloads.mariadb.org/mariadb/10.2.15/</a></p>
<p>2 找到下图所示，点击<a href="https://downloads.mariadb.org/mariadb/repositories/" target="_blank" rel="noopener">Repository Configuration Tool</a>.</p>
<p><img src="网页.png" alt="网页"></p>
<p>3 根据自己的系统版本选择相应的选项，就会出现对应的yum源数据库配置</p>
<p><img src="yum源.png" alt="yum源"></p>
<p>4.yum将数据库配置复制入库文件，并进行安装</p>
<p><img src="安装.png" alt="安装"></p>
<p>安装MariaDB：</p>
<p>yum install mariadb</p>
<p>5.添加安全加固</p>
<p>mysql_secure_installation                       运行此脚本,交互式</p>
<p>是否设置root口令                       y</p>
<p>是否删除匿名用户                      y</p>
<p>是否允许root远程登录              n</p>
<p>是否删除test数据库                  y</p>
<p>privilege tables                          y</p>
<p><img src="加密.png" alt="加密"></p>
<h2 id="二、实验：通用二进制格式安装MariaDB-10-2-15"><a href="#二、实验：通用二进制格式安装MariaDB-10-2-15" class="headerlink" title="二、实验：通用二进制格式安装MariaDB 10.2.15"></a><strong>二、实验：通用二进制格式安装MariaDB 10.2.15</strong></h2><p>1.去官网下载：</p>
<p><strong>mariadb-10.2.15-linux-86_64.tar.gz</strong></p>
<p>2.准备用户账号</p>
<p>useradd -r -d  /data/mysqldb -s /sbin/nologin  mysql</p>
<p>3.解压包到默认安装路径</p>
<p>安装包默认路径：<strong>configure –prefix=/usr/local</strong></p>
<p>tar -xvf mariadb-version.tar.gz  -C  /usr/local/</p>
<p><img src="1-11.png" alt="1"></p>
<p>4.修改文件权限</p>
<p><strong>cd /usr/local</strong></p>
<p>ln -s mariabd-10.2.15-linux-x86_64/  mysql</p>
<p><strong>ll mysql/</strong></p>
<p>chown -R root:root mysql/</p>
<p><img src="2-10.png" alt="2"></p>
<p>5.修改PATH变量，方便mysql目录下的二进制程序执行</p>
<p><strong>ls /usr/local/mysql/bin</strong></p>
<p><img src="3-7.png" alt="3"></p>
<p>echo PATH=/usr/local/mysql/bin:$PATH &gt; /etc/profile.d/mysql.sh</p>
<p>. /etc/profile.d/mysql.sh</p>
<p><img src="4-7.png" alt="4"></p>
<p>6.创建数据库路径</p>
<p>mkdir /data/mysqldb</p>
<p>chown mysql.mysql /data/mysqldb</p>
<p>chmod 770  /data/mysqldb</p>
<p><img src="5-6.png" alt="5"></p>
<p>7.生成系统自带数据库相关文件</p>
<p><strong>cd /usr/local/mysql</strong>                          必须在此目录下执行</p>
<p>scripts/mysql_install_db –datadir=/data/mysqldb –user=mysql</p>
<p><strong>ll /data/mysqldb/</strong>                     确认相关文件是否生成</p>
<p><img src="6-7.png" alt="6"></p>
<p>8.生成mysql配置文件</p>
<p><strong>ll /usr/local/mysql/support-files</strong>    可查看数据库自带的各种配置模板</p>
<p>cp /etc/my.cnf /etc/my.cnf.bak             建议备份配置文件</p>
<p>cp my-hug.cnf  /etc/my.cnf</p>
<p><strong>vim /etc/my.cnf</strong></p>
<p>[mysqld]</p>
<p>datadir             = /data/mysqldb              ##添加此行，指定数据库存放路径</p>
<p><img src="lazy.png" alt="8"></p>
<p>9.添加mysql到服务</p>
<p>cp support-files/mysql.server  /etc/init.d/mysqld</p>
<p>chkcibfug –add mysqld</p>
<p>service mysqld start</p>
<p><img src="9-1.png" alt="9"></p>
<p>10.添加安全加固</p>
<p>mysql_secure_installation</p>
<h2 id="三、实验：编译安装MariaDB-10-2-15"><a href="#三、实验：编译安装MariaDB-10-2-15" class="headerlink" title="三、实验：编译安装MariaDB 10.2.15"></a><strong>三、实验：编译安装MariaDB 10.2.15</strong></h2><p>1.准备好源码安装包</p>
<p><strong>mariadb-10.2.15.tar.gz</strong></p>
<p>2.安装相关依赖包</p>
<p>yum install bison bison-devel zlib-devel libcurl-devel libarchive-devel boost-devel gcc gcc-c++ cmake ncurses-devel gnutls-devel libxml2-devel openssl-devel libevent-devel libaio-devel</p>
<p>3.创建用户</p>
<p>useradd -r -s /sbin/nologin mysql</p>
<p>4.解压缩源码包</p>
<p>tar -xvf mariadb-10.2.15.tar.gz</p>
<p><img src="3-8.png" alt="3"></p>
<p>5.创建数据库路径</p>
<p>mkdir /data/mysqldb</p>
<p>chown mysql.mysql /data/mysqldb</p>
<p>chmod 770  /data/mysqldb</p>
<p><img src="2-11.png" alt="2"></p>
<p>6.cmake编译</p>
<p><strong>cd /mariadb-10.2.15/</strong></p>
<p>cmake . \</p>
<p>-DCMAKE_INSTALL_PREFIX=/app/mysql \</p>
<p>-DMYSQL_DATADIR=/data/mysqldb/ \</p>
<p>-DSYSCONFDIR=/etc \</p>
<p>-DMYSQL_USER=mysql \</p>
<p>-DWITH_INNOBASE_STORAGE_ENGINE=1 \</p>
<p>-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</p>
<p>-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</p>
<p>-DWITH_PARTITION_STORAGE_ENGINE=1 \</p>
<p>-DWITHOUT_MROONGA_STORAGE_ENGINE=1 \</p>
<p>-DWITH_DEBUG=0 \</p>
<p>-DWITH_READLINE=1 \</p>
<p>-DWITH_SSL=system \</p>
<p>-DWITH_ZLIB=system \</p>
<p>-DWITH_LIBWRAP=0 \</p>
<p>-DENABLED_LOCAL_INFILE=1 \</p>
<p>-DMYSQL_UNIX_ADDR=/app/mysql/mysql.sock \</p>
<p>-DDEFAULT_CHARSET=utf8 \</p>
<p>-DDEFAULT_COLLATION=utf8_general_ci</p>
<p>7．编译安装</p>
<p>make -j 4 &amp;&amp; make install</p>
<p>8.准备环境变量</p>
<p>echo ‘PATH=/app/mysql/bin:$PATH’ &gt; /etc/profile.d/mysql.sh</p>
<p>. /etc/profile.d/mysql.sh</p>
<p><img src="4-8.png" alt="4"></p>
<p>9.生成数据库文件</p>
<p><strong>cd /app/mysql/</strong></p>
<p>scripts/mysql_install_db –datadir=/data/mysqldb/ –user=mysql –basedir=/app/mysql</p>
<p>setfacl -R -m u:mysql:rwx  /app/mysql/</p>
<p><img src="5-7.png" alt="5"></p>
<p>10.准备配置文件</p>
<p>cp /app/mysql/support-files/my-huge.cnf  /etc/my.cnf</p>
<p>11.准备启动脚本</p>
<p>cp /app/mysql/support-files/mysql.server /etc/init.d/mysqld</p>
<p>12.启动服务</p>
<p>chkconfig –add mysqld</p>
<p>service mysqld start</p>
<p><img src="6-8.png" alt="6"></p>
<h2 id="四、实验：实现多实例安装"><a href="#四、实验：实现多实例安装" class="headerlink" title="四、实验：实现多实例安装"></a><strong>四、实验：实现多实例安装</strong></h2><p><strong>实验预期：</strong>在一台虚拟机上安装三套MariaDB数据库，数据库版本5.5</p>
<p><strong>思路：</strong>三套配置文件（日志文件，配置文件，数据库文件），三个不同的端口</p>
<p>1.安装第一个实例</p>
<p>yum install mariadb-server</p>
<p>2.规划目录</p>
<p>mkdir /mysqldb/{3306,3307,3308}/{etc,socket,pid,log,data} –pv</p>
<p>目录结构如下：</p>
<p>[root@CentOS7 ~]#tree /mysqldb/</p>
<p>/mysqldb/</p>
<p>├── 3306</p>
<p>│   ├── data</p>
<p>│   ├── etc</p>
<p>│   ├── log</p>
<p>│   ├── pid</p>
<p>│   └── socket</p>
<p>├── 3307</p>
<p>│   ├── data</p>
<p>│   ├── etc</p>
<p>│   ├── log</p>
<p>│   ├── pid</p>
<p>│   └── socket</p>
<p>└── 3308</p>
<p>├── data</p>
<p>├── etc</p>
<p>├── log</p>
<p>├── pid</p>
<p>└── socket</p>
<p><img src="1-13.png" alt="1"></p>
<p>3.修改目录及文件权限</p>
<p>chown -R mysql.mysql  /mysql</p>
<p><img src="2-12.png" alt="2"></p>
<p>4.创建各自数据库文件</p>
<p>mysql_install_db –datadir=/mysqldb/3306/data  –user=mysql [–basedir=/usr/ 二进制安装]</p>
<p>mysql_install_db –datadir=/mysqldb/3307/data  –user=mysql</p>
<p>mysql_install_db –datadir=/mysqldb/3308/data  –user=mysql</p>
<p><img src="3-9.png" alt="3"></p>
<p>5.创建各自配置文件</p>
<p>cp /etc/my.cnf /mysqldb/3306/etc/</p>
<p>6.修改各自配置文件</p>
<p><strong>vim my.cnf</strong></p>
<p>[mysqld]</p>
<p>port=3306</p>
<p>datadir=/mysqldb/3306/data</p>
<p>socket=/mysqldb/3306/socket/mysql.sock</p>
<p>[mysqld_safe]</p>
<p>log-error=/mysqldb/3306/log/mariadb.log</p>
<p>pid-file=/mysqldb/3306/pid/mariadb.pid</p>
<p>#!includefir /etc/my.cnf.d               添加此行注释</p>
<p><img src="4-9.png" alt="4"></p>
<p>参照3306配置文件，将3307,3308配置文件也生成</p>
<p>cp /mysqldb/3306/etc/my.cnf /mysqldb/3307/etc/my.cnf</p>
<p>cp /mysqldb/3306/etc/my.cnf /mysqldb/3308/etc/my.cnf</p>
<p>7.准备启动服务脚本</p>
<p>chmod  700  mysqld            添加执行权限</p>
<p>cp mysqld  /mysqldb/3306 /</p>
<p>cp mysqld  /mysqldb/3307/</p>
<p>cp mysqld  /mysqldb/3308 /</p>
<p>注意修改启动服务脚本中的不同的参数</p>
<p>#!/bin/bash</p>
<p>port=3306</p>
<p>mysql_pwd=””</p>
<p>cmd_path=”/usr/bin”</p>
<p><img src="5-8.png" alt="5"></p>
<p>8.确认系统自带示例停止服务</p>
<p>systemctl stop mariadb</p>
<p>9.启动多实例服务</p>
<p>/mysqldb/{3306,3307,3308}/mysqld start</p>
<p>ss -ntl</p>
<p><img src="6-9.png" alt="6"></p>
<p>10.测试多实例</p>
<p>mysql  -S /mysqldb/3308/socket/mysql.sock</p>
<p>MariaBD [(none)]&gt; show variables like ‘%port%’;</p>
<p><img src="7-5.png" alt="7"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/02/DNS服务及相关实验/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/02/DNS服务及相关实验/" itemprop="url">DNS服务及相关实验</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-02T15:30:03+08:00">
                2018-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网络技术/" itemprop="url" rel="index">
                    <span itemprop="name">网络技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、DNS服务相关介绍"><a href="#一、DNS服务相关介绍" class="headerlink" title="一、DNS服务相关介绍"></a>一、DNS服务相关介绍</h2><p><strong>DNS：Domain Name Service</strong> 应用层协议</p>
<p>C/S,53/udp, 53/tcp</p>
<p><strong>BIND：Bekerley Internat Name Domain</strong></p>
<p>ISC （<a href="http://www.isc.org）" target="_blank" rel="noopener">www.isc.org）</a></p>
<p>名字解析服务：将全称域名解析为IP地址</p>
<p><strong>FQDN：Fully Qualified Domain Name</strong>,完整主机名</p>
<p><a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a>         完整主机名(FQDN)</p>
<p>www             主机名，或者别名</p>
<p>magedu.com          domain域名</p>
<p><strong>分散式解决方案：</strong>小环境，特定应用内部集群</p>
<p>/etc/hosts</p>
<p><strong>集中式解决方案：</strong>NIS，适合中小型环境</p>
<p><strong>分布式（既分散又集中）解决方案：</strong>DNS</p>
<p>本地名称解析配置文件：hosts</p>
<p><strong>Linux：</strong>    /etc/hosts</p>
<p><strong>Windows：</strong>%WINDIR%/system32/drivers/etc/hosts</p>
<p>​         122.10.117.2  <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a></p>
<p>​         93.46.8.89    <a href="http://www.google.com" target="_blank" rel="noopener">www.google.com</a></p>
<p>权威DNS服务器：查询FQDN所在的DNS服务器</p>
<p>13组服务器，13个IP地址存放根域</p>
<p>IPv6,25组跟服务器</p>
<p><strong>DNS查询类型：</strong></p>
<p>   <strong>递归查询：</strong>负责到底</p>
<p>  <strong>迭代查询：</strong>不负责到底</p>
<p><strong>解析类型：</strong></p>
<p><strong>正向解析：</strong>FQDN –&gt; IP</p>
<p><strong>反向解析：</strong>IP –&gt; FQDN</p>
<p>注意：正反向解析是两个不同的名称空间是两棵不同的解析树</p>
<p><strong>DNS服务器的类型：</strong></p>
<p>主DNS服务器</p>
<p>从DNS服务器</p>
<p>缓存DNS服务器（转发器）</p>
<p>主DNS服务器：管理和维护所负责解析的域内解析库的服务器</p>
<p>从DNS服务器：从主服务器或从服务器“复制”（区域传输）解析库副本</p>
<p>序列号：解析库版本号，主服务器解析库变化时，其序列递增 刷新时间间隔：</p>
<p>服务器从主服务器请求同步解析的时间间隔</p>
<p>重试时间间隔：从服务器请求同步失败时，再次尝试时间间隔</p>
<p>过期时长：从服务器联系不到主服务器时，多久后停止服务</p>
<p>“通知”机制：主服务器解析库发生变化时，会主动通知从服务器</p>
<h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a><strong>bind</strong></h3><p><strong>相关文件：</strong></p>
<p>/etc/named.conf                              主配置文件</p>
<p>/usr/sbin/named                               主程序</p>
<p>/usr/lib/systemd/system/named.service      服务</p>
<p>/var/named                               存放数据库</p>
<p>/var/named/named.localhost                区域解析库参考文件</p>
<p><strong>cat /var/named/named.localhost</strong>  </p>
<p>$TTL 1D                                                                              一天作为缓存期</p>
<p>@       IN SOA  @ rname.invalid. (                                   第一个@表示当前域名，第二个@表示主DNS服务器,rname.invalid表示管理员邮箱</p>
<p>0       ; serial            版本序列号，序列号越大表示数据越新，需手动更改</p>
<p>1D      ; refresh        刷新时间</p>
<p>1H      ; retry            重试时间</p>
<p>1W      ; expire        过期时间</p>
<p>3H )    ; minimum      否定答案的TTL值</p>
<p>NS      @</p>
<p>A       127.0.0.1</p>
<p>AAAA    ::1</p>
<h3 id="资源记录："><a href="#资源记录：" class="headerlink" title="资源记录："></a><strong>资源记录：</strong></h3><p>区域解析库：由众多RR组成：</p>
<p>资源记录：Resource Record, RR</p>
<p><strong>记录类型：</strong>A, AAAA, PTR, SOA, NS, CNAME, MX</p>
<p><strong>SOA：</strong>Start Of Authority，起始授权记录；一个区域解析库有且仅能有一个SOA记录，</p>
<p>必须位于解析库的第一条记录，定义了谁是主DNS服务器，管理员邮箱及刷新时间(从属DNS服务器拉取</p>
<p>主DNS服务器数据的时间)、重试时间、过期时间及否定答案的TTL值</p>
<p><strong>A：</strong>internet Address，作用，FQDN –&gt; IP</p>
<p><strong>AAAA：</strong>FQDN –&gt; IPv6</p>
<p><strong>PTR：</strong>PoinTeR，IP –&gt; FQDN</p>
<p><strong>NS：</strong>Name Server，专用于标明当前区域的DNS服务器</p>
<p><strong>CNAME：</strong>Canonical Name，别名记录，如www</p>
<p><strong>MX：</strong>Mail eXchanger，邮件交换器</p>
<h3 id="资源记录定义的格式："><a href="#资源记录定义的格式：" class="headerlink" title="资源记录定义的格式："></a><strong>资源记录定义的格式：</strong></h3><p><strong>语法：name [TTL] IN rr_type value</strong></p>
<p><strong>注意：</strong></p>
<p>(1) TTL可从全局继承</p>
<p>(2) @可用于引用当前区域的名字</p>
<p>(3) 同一个名字可以通过多条记录定义多个不同的值；此时DNS服务器会以轮询</p>
<p>方式响应</p>
<p>(4) 同一个值也可能有多个不同的定义名字；通过多个不同的名字指向同一个值</p>
<p>进行定义；此仅表示通过多个不同的名字可以找到同一个主机</p>
<h2 id="二、实验：搭建正向主DNS服务器"><a href="#二、实验：搭建正向主DNS服务器" class="headerlink" title="二、实验：搭建正向主DNS服务器"></a>二、实验：搭建正向主DNS服务器</h2><h3 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>主DNS服务器：192.168.30.10</p>
<p>web服务器：192.168.30.16</p>
<p>客户端：192.168.30.11</p>
<h3 id="实验预期："><a href="#实验预期：" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>客户端访问通过主DNS解析访问http服务器搭建的网页</p>
<h3 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p>1主DNS服务器安装bind包：</p>
<p>yum install bind</p>
<p>2 备份主配置文件，注意保留属性</p>
<p>cp /etc/named.conf  /etc/named.conf.bak  -a</p>
<p>3.开启named服务</p>
<p>Systemctl  start  named</p>
<p>Systemctl  enable  named</p>
<p>4.修改主配置文件：</p>
<p>vim /etc/named.conf</p>
<p>options {</p>
<p>​         listen-on port 53 { localhost; };</p>
<p>​         allow-query     { localhost;any; };</p>
<p>};</p>
<p><img src="named.conf_.png" alt="img"> </p>
<p>5.修改区域配置文件：</p>
<p><img src="区域配置文件.png" alt="区域配置文件"></p>
<p>6创建区域解析数据库文件</p>
<p>可参照named.localhost文件进行创建</p>
<p>cp named.localhost  magedu.com.zone -a</p>
<p><strong>vim magedu.com.zone</strong></p>
<p>$TTL 1D</p>
<p>@       IN SOA  dns1.magedu.com. admin.magedu.com. (</p>
<p>​                                        0       ; serial</p>
<p>​                                        1D      ; refresh</p>
<p>​                                        1H      ; retry</p>
<p>​                                        1W      ; expire</p>
<p>​                                        3H )    ; minimum</p>
<p>magedu.com.        NS      dns1</p>
<p>dns1                         A        192.168.30.10</p>
<p>www                        A        192.168.30.16</p>
<p><img src="区域数据库解析文件.png" alt="img"> </p>
<p>7重新加载named服务：</p>
<p>Systemctl reload named   或   rndc  reload</p>
<p>8如启动失败，可使用语法检查</p>
<p>named-checkconf          主配置文件语法检查</p>
<p>named-checkzone “magedu.com” /var/named/magedu.com.zone       解析库文件语法检查</p>
<p>9切换至客户端进行测试：</p>
<p>dig <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a>  @192.168.30.10            指定从192.168.30.10解析<a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a></p>
<p><img src="4dig测试.png" alt="4dig测试"></p>
<p>10切换到web服务器：</p>
<p>echo welcome to Magedu &gt; /var/www/html/html.index</p>
<p>service httpd start</p>
<p>11.切换至客户端：</p>
<p>添加DNS到网卡配置文件</p>
<p><img src="5修改网卡dns.png" alt="5修改网卡dns"></p>
<p>重启网络服务</p>
<p>Service httpd restart</p>
<p>12.测试访问<a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a></p>
<p>我们看到，客户端已经由主DNS服务器解析成功访问到我们自己搭建的http网页！</p>
<p><img src="6访问成功.png" alt="6访问成功"></p>
<h2 id="三、实验：泛域名解析，提高访问感受"><a href="#三、实验：泛域名解析，提高访问感受" class="headerlink" title="三、实验：泛域名解析，提高访问感受"></a><strong>三、实验：泛域名解析，提高访问感受</strong></h2><h3 id="前期准备：-1"><a href="#前期准备：-1" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>实验环境承接上</p>
<h3 id="实验预期：-1"><a href="#实验预期：-1" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>客户端访问网页时，即使将主机名输出，也可正常访问</p>
<h3 id="具体步骤：-1"><a href="#具体步骤：-1" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p>1修改主DNS服务器端区域数据库解析文件：</p>
<p>增加此行：泛域名解析，如ww<a href="http://www.magedu.com也可正常访问" target="_blank" rel="noopener">www.magedu.com也可正常访问</a></p>
<ul>
<li>A  192.168.30.7</li>
</ul>
<p><img src="修改区域解析库文件.png" alt="修改区域解析库文件"></p>
<p>2客户端测试：</p>
<p>我们看到即时主机名输出，也可正常访问到<a href="http://www.magedu.com的http页面" target="_blank" rel="noopener">www.magedu.com的http页面</a></p>
<p><img src="访问成功.png" alt="访问成功"></p>
<h2 id="四、实验：利用DNS实现web服务器负载均衡"><a href="#四、实验：利用DNS实现web服务器负载均衡" class="headerlink" title="四、实验：利用DNS实现web服务器负载均衡"></a><strong>四、实验：</strong>利用DNS实现web服务器负载均衡</h2><h3 id="前期准备：-2"><a href="#前期准备：-2" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>主DNS服务器：192.168.30.10</p>
<p>web服务器1：192.168.30.16</p>
<p>web服务器2：192.168.30.12</p>
<p>客户端：192.168.30.11</p>
<h3 id="实验预期：-2"><a href="#实验预期：-2" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>当客户端访问网页时，由主DNS服务器随机指向一台web服务器</p>
<h3 id="具体步骤：-2"><a href="#具体步骤：-2" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p>1修改区域解析库数据文件：</p>
<p>添加下列行：</p>
<p>websrv A 192.168.30.17</p>
<p>websrv A 192.168.30.27</p>
<p>www  CNAME  websrv</p>
<p><img src="修改区域解析库文件-1.png" alt="修改区域解析库文件"></p>
<p>重新加载named服务:</p>
<p>rndc reload</p>
<p>2切换至客户端测试：</p>
<p>我们看到当ping测<a href="http://www.magedu.com时，将随机指向一台web服务器" target="_blank" rel="noopener">www.magedu.com时，将随机指向一台web服务器</a></p>
<p><img src="测试成功.png" alt="测试成功"></p>
<h2 id="五、实验：实现反向解析"><a href="#五、实验：实现反向解析" class="headerlink" title="五、实验：实现反向解析"></a><strong>五、实验：实现反向解析</strong></h2><h3 id="前期准备：-3"><a href="#前期准备：-3" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>DNS服务器：192.168.30.10</p>
<p>测试客户端：192.168.30.11</p>
<h3 id="具体步骤：-3"><a href="#具体步骤：-3" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p>1修改DNS服务器区域配置文件，添加反向解析区域</p>
<p><img src="反向解析1.png" alt="反向解析1"></p>
<p>2添加方向区域解析数据库文件</p>
<p><img src="反向解析2.png" alt="反向解析2"></p>
<p>重启named服务</p>
<p>rcdn reload</p>
<p>3切换客户端建测试</p>
<p><strong>dig -x  IPaddr</strong> 是一个专门测试反向解析的命令</p>
<p>dig -x 192.168.30.16</p>
<p>我们看到192.168.30.16反向解析到了websrv.magedu.com</p>
<p><img src="反向解析3.png" alt="反向解析3"></p>
<p>dig -x 192.168.30.17</p>
<p>192.168.30.16反向解析到了appsrv.wxlinux.com</p>
<p><img src="反向解析4.png" alt="反向解析4"></p>
<p>dig -x 192.168.30.100</p>
<p>192.168.30.16反向解析到了mail.magedu.com</p>
<p>与DNS服务器区域解析文件对应关系相一致</p>
<p><img src="反向解析5.png" alt="反向解析5"></p>
<h2 id="六、实验：搭建正向从DNS服务器"><a href="#六、实验：搭建正向从DNS服务器" class="headerlink" title="六、实验：搭建正向从DNS服务器"></a>六、实验：搭建正向从DNS服务器</h2><h3 id="前期准备：-4"><a href="#前期准备：-4" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>主DNS服务器：192.168.30.10</p>
<p>从DNS服务器：192.168.30.12</p>
<p>web服务器：192.168.30.16</p>
<p>客户端：192.168.30.11</p>
<h3 id="实验预期：-3"><a href="#实验预期：-3" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>搭建从DNS服务器，当主DNS服务器宕机时，由从DNS实现地址解析</p>
<h3 id="具体步骤：-4"><a href="#具体步骤：-4" class="headerlink" title="具体步骤："></a><strong>具体步骤：</strong></h3><p>1.修改主DNS服务器主配置文件，</p>
<p><strong>vim /etc/named.conf</strong></p>
<p>options {</p>
<p>​         listen-on port 53 { localhost; };</p>
<p>​         allow-query     { local;any; };</p>
<p>​         allow-transfer  { 从DNS的IP };                          加此行</p>
<p>};</p>
<p><img src="1修改主dns主配置-1.png" alt="1修改主dns主配置"></p>
<p>2修改主DNS服务器区域数据库解析文件</p>
<p>将从DNS服务器同步进去</p>
<p><img src="5主dns区域解析库.png" alt="5主dns区域解析库"></p>
<p>3修改从DNS服务器主配置文件</p>
<p><strong>vim /etc/named.conf</strong></p>
<p>allow-transfer { none; };         加此行</p>
<p><img src="2修改从dns主配置.png" alt="2修改从dns主配置"></p>
<p>4修改从DNS服务器区域配置文件</p>
<p><img src="sda.png" alt="sda"></p>
<p>重启named服务</p>
<p>rndc reload</p>
<p>5确认从DNS服务器slave区域文件同步成功</p>
<p><img src="4生成slave文件-1.png" alt="4生成slave文件"></p>
<p>6模拟主DNS服务器宕机，将虚拟机网卡断开连接</p>
<p><img src="6模拟宕机.png" alt="6模拟宕机"></p>
<p>7添加从服务器地址到客户端的DNS列表中：</p>
<p><img src="7客户端添加dns.png" alt="7客户端添加dns"></p>
<p>8.客户端测试</p>
<p>ping <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a></p>
<p>经过短暂的等待（dns切换时间），从DNS服务器解析地址成功！</p>
<p> <img src="8测试成功.png" alt="8测试成功"></p>
<h2 id="七、实验：实现子域"><a href="#七、实验：实现子域" class="headerlink" title="七、实验：实现子域"></a><strong>七、实验：实现子域</strong></h2><h3 id="实验预期：-4"><a href="#实验预期：-4" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p><a href="http://www.bj.magedu.com" target="_blank" rel="noopener">www.bj.magedu.com</a></p>
<p><a href="http://www.zz.magedu.com" target="_blank" rel="noopener">www.zz.magedu.com</a>             使能正常访问</p>
<h3 id="方法一：修改主DNS区域解析文件"><a href="#方法一：修改主DNS区域解析文件" class="headerlink" title="方法一：修改主DNS区域解析文件"></a><strong>方法一：修改主DNS区域解析文件</strong></h3><p>直接将子域指向子域web服务器：</p>
<p><a href="http://www.bj" target="_blank" rel="noopener">www.bj</a>  A       192.168.30.17</p>
<p><a href="http://www.zz" target="_blank" rel="noopener">www.zz</a>  A       192.168.30.27</p>
<p><img src="方法1.png" alt="方法1"></p>
<h3 id="方法二：本机独立子域"><a href="#方法二：本机独立子域" class="headerlink" title="方法二：本机独立子域"></a><strong>方法二：本机独立子域</strong></h3><p><strong>适用场景：</strong>访问量不大，较小规模，由同一个主DNS服务器管理</p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p>zone “bj.magedu.com” IN {</p>
<p>​         type master</p>
<p>​         file “bj.magedu.com.zone”;</p>
<p>zone “zz.magedu.com” IN {</p>
<p>​         type master</p>
<p>​         file “zz.magedu.com.zone”;</p>
<p><img src="方法2.1.png" alt="方法2.1"></p>
<p>cp magedu.com.zone bj.magedu.com.zone  -a</p>
<p><strong>vim bj.magedu.com.zone</strong></p>
<p><img src="方法2.2.png" alt="方法2.2"></p>
<p>cp magedu.com.zone zz.magedu.com.zone  -a</p>
<p><strong>vim zz.magedu.com.zone</strong></p>
<p><img src="方法2.3.png" alt="方法2.3"></p>
<h3 id="方法三：委派给另一台主机维护子域，实现分布式DNS管理"><a href="#方法三：委派给另一台主机维护子域，实现分布式DNS管理" class="headerlink" title="方法三：委派给另一台主机维护子域，实现分布式DNS管理"></a>方法三：委派给另一台主机维护子域，实现分布式DNS管理</h3><p><strong>前期准备：</strong></p>
<p>主域magedu.com: 192.168.30.10</p>
<p>子域bj.magedu.com: 192.168.30.16</p>
<p>web服务器1：<a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a>: 192.168.30.17</p>
<p>web服务器2：<a href="http://www.bj.magedu.com" target="_blank" rel="noopener">www.bj.magedu.com</a>: 192.168.30.27</p>
<p>测试客户端：192.168.30.11</p>
<p>1关闭dnssec功能</p>
<p><strong>vim /etc/named.conf</strong></p>
<p>dnssec-enable no;</p>
<p>dnssec-validation no;</p>
<p><img src="方法3.1.png" alt="方法3.1"></p>
<p>2修改主域DNS区域解析文件，主域web服务器指向192.168.30.17</p>
<p><strong>vim /var/named/magedu.com.zone</strong></p>
<p>$TTL 1D</p>
<p>@       IN SOA  dns1.magedu.com. admin.magedu.com. (</p>
<p>​                                        0       ; serial</p>
<p>​                                        1D      ; refresh</p>
<p>​                                        1H      ; retry</p>
<p>​                                        1W      ; expire</p>
<p>​                                        3H )    ; minimum</p>
<p>​     NS      dns1.magedu.com.</p>
<p>bj                 NS      dns2.magedu.com.     ##新增</p>
<p>dns1       A        192.168.30.10</p>
<p>dns2                     A    192.168.30.17                         ##新增</p>
<p><img src="方法3.2.png" alt="方法3.2"></p>
<p>3切换至子域DNS服务器，添加bj.magedu.com的区域配置</p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p><img src="3.3.png" alt="3.3"></p>
<p>4添加子域DNS区域解析文件，将web服务器指向192.168.30.27</p>
<p><img src="3.4.png" alt="3.4"></p>
<p>重启named服务</p>
<p>rndc reload</p>
<p>5切换客户端进行测试</p>
<p>dig  <a href="http://www.bj.magedu.com" target="_blank" rel="noopener">www.bj.magedu.com</a> @192.168.30.10</p>
<p>ping <a href="http://www.bj.magedu.com" target="_blank" rel="noopener">www.bj.magedu.com</a></p>
<p>我们看到<a href="http://www.bj.magedu.com将通过主域DNS转发至子域DNS，再经子域DNS解析指向web服务器" target="_blank" rel="noopener">www.bj.magedu.com将通过主域DNS转发至子域DNS，再经子域DNS解析指向web服务器</a></p>
<p><img src="3.5.png" alt="3.5"></p>
<p>dig  <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a> @192.168.30.10</p>
<p>ping <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a></p>
<p>而<a href="http://www.magedu.com还是由主域DNS负责解析，这样就实现了主域和子域DNS简单的分布式管理" target="_blank" rel="noopener">www.magedu.com还是由主域DNS负责解析，这样就实现了主域和子域DNS简单的分布式管理</a></p>
<p><img src="3.6.png" alt="3.6"></p>
<h2 id="八、实验：forward转发"><a href="#八、实验：forward转发" class="headerlink" title="八、实验：forward转发"></a>八、实验：forward转发</h2><h3 id="（一）全局性转发："><a href="#（一）全局性转发：" class="headerlink" title="（一）全局性转发："></a><strong>（一）全局性转发：</strong></h3><p>对非本机所负责解析区域的请求，全转发给指定的服务器</p>
<p><strong>注意：</strong>被转发的服务器需要能够为请求者做递归否则转发请求不予进行</p>
<h3 id="前期准备：-5"><a href="#前期准备：-5" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>DNS服务器1: 192.168.30.10</p>
<p>DNS服务器2: 192.168.30.16</p>
<p>Web服务器：192.168.30.100</p>
<p>测试访问端: 192.168.30.11</p>
<h3 id="实验预期：-5"><a href="#实验预期：-5" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>当FQDN在DNS1服务器无法解析时，直接指向到DNS2服务器进行转发</p>
<p>1在DNS2服务器上建立<a href="http://www.wxlinux.com的区域文件及解析数据库文件，并将www.wxlinux.com指向web服务器：192.168.30.100" target="_blank" rel="noopener">www.wxlinux.com的区域文件及解析数据库文件，并将www.wxlinux.com指向web服务器：192.168.30.100</a></p>
<p><img src="全局转发1.png" alt="全局转发1"></p>
<p><img src="全局转发2.png" alt="全局转发2"></p>
<p>2切换到访问端用DNS2服务器解析<a href="http://www.wxlinux.com，可以解析成功" target="_blank" rel="noopener">www.wxlinux.com，可以解析成功</a></p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a> @192.168.30.16</p>
<p><img src="全局转发3.png" alt="全局转发3"></p>
<p>3切换至DNS1服务器修改主配置文件</p>
<p><strong>vim /etc/named.conf</strong></p>
<p>options {</p>
<p>​       forward first|only;                                    ##first优先在指向DNS服务器解析，only表示只在</p>
<p>​         forwarders { 192.168.30.17; }                         ##指向的DNS服务器解析</p>
<p>};</p>
<p><img src="全局4.png" alt="全局4"></p>
<p>注意确定主配置文件recursion yes;并且关闭dnssec功能否则也将导致实验失败</p>
<p>重启named服务</p>
<p>rndc reload</p>
<p>4切换至客户端进行测试：</p>
<p>首先清除dns缓存记录</p>
<p>rndc flush</p>
<p>进行ping测，解析成功（由于未搭建web服务器，所以显示主机不可达）</p>
<p>ping <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a></p>
<p><img src="全局5.0.png" alt="全局5.0"></p>
<p>指定DNS1服务器解析地址，发现DNS1直接指向了DNS2服务器进行解析</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a> @192.168.30.10</p>
<p><img src="全局5.png" alt="全局5"></p>
<h3 id="（二）特定区域转发："><a href="#（二）特定区域转发：" class="headerlink" title="（二）特定区域转发："></a><strong>（二）特定区域转发：</strong></h3><p>仅转发对特定的区域的请求，比全局转发优先级高</p>
<h3 id="前期准备：-6"><a href="#前期准备：-6" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>同全局转发实验</p>
<h3 id="实验预期：-6"><a href="#实验预期：-6" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>只有在访问wxlinux.com域时，才优先指向DNS2服务器进行解析</p>
<p>1在DNS1删除刚才的全局配置，新增加区域配置文件内容如下：</p>
<p>只有当访问wxlinux.com域时，才优先转发DNS2服务器解析</p>
<p><strong>vim /etc/named.rfc1912.zones</strong></p>
<p>zone “wxlinux.com” IN {</p>
<p>​         type forward;</p>
<p>​         forward first|only;</p>
<p>​         forwarders {192.168.30.16;};</p>
<p><img src="特定域1.png" alt="特定域1"></p>
<p>清理DNS1服务器的DNS缓存</p>
<p>rndc flush</p>
<p>2切换至客户端测试：</p>
<p>解析成功，只在访问wxlinu.com优先指向DNS2服务器进行解析</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a> @192.168.30.10</p>
<p><img src="特定域转发2.png" alt="特定域转发2"></p>
<h2 id="九、实验：实现智能DNS"><a href="#九、实验：实现智能DNS" class="headerlink" title="九、实验：实现智能DNS"></a>九、实验：实现智能DNS</h2><h3 id="前期准备：-7"><a href="#前期准备：-7" class="headerlink" title="前期准备："></a><strong>前期准备：</strong></h3><p>DNS服务器：两块网卡地址分别为172.20.113.242和192.168.30.10</p>
<p>模拟192.168.30.0/24网段为北京地区地址段</p>
<p>模拟172.20.0.0/16   网段为上海地区地址段</p>
<h3 id="实验预期：-7"><a href="#实验预期：-7" class="headerlink" title="实验预期："></a><strong>实验预期：</strong></h3><p>北京用户访问时返回192.168.30.1</p>
<p>上海用户访问时返回192.168.30.2</p>
<p>其他地区用户访问时防护192.168.30.3</p>
<p>1在主配置文件中添加ACL</p>
<p><img src="智能1.png" alt="智能1"></p>
<p>2建立与ACL映射的数据库</p>
<p><img src="区域解析配置.png" alt="区域解析配置"></p>
<p><img src="view4.png" alt="view4"></p>
<p>3建立view，一但采用viwe，必须把所有区域信息放到view语句块中，否则将失效，为了便于管理，我们将主配置文件中此段内容剪切至/etc/named.rfc19212.zones中</p>
<p><img src="view1.png" alt="view1"></p>
<p><img src="view2.png" alt="view2"></p>
<p><strong>vim /etc/named.conf</strong></p>
<p>添加view：如图</p>
<p><img src="view3.png" alt="view3"></p>
<p>4创建view对应的区域数据信息</p>
<p>cp  /etc/named.rfc1912.zone    /etc/named.rfc1912.zone.beijing –a</p>
<p>cp  /etc/named.rfc1912.zone    /etc/named.rfc1912.zone.shanghai –a</p>
<p><strong>vim /etc/named.rfc1912.zone.beijing</strong></p>
<p>zone “wxlinux.com” IN {</p>
<p>​         type master</p>
<p>​         file “wxlinux.com.zone.beijing”;</p>
<p><img src="viww6.png" alt="viww6"></p>
<p><strong>vim /etc/named.rfc1912.zone.shanghai</strong></p>
<p>zone “wxlinux.com” IN {</p>
<p>​         type master</p>
<p>​         file “wxlinux.com.zone.beijing”;</p>
<p><img src="view5.png" alt="view5"></p>
<p>最终生成三个独立的区域数据信息</p>
<p><img src="view7.png" alt="view7"></p>
<p>重启named服务</p>
<p>rndc reload</p>
<p>5切换到客户端进行测试：</p>
<p>（1）192.168.30.0/24测试</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a> @192.168.30.10</p>
<p>当地址为192.168.30.0/24段时，web服务器指向192.168.30.1</p>
<p><img src="测试2-1.png" alt="测试2"></p>
<p>（2）172.20.0.0/16测试</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a> @172.20.113.242</p>
<p>当地址为172.20.0.0/16段时，web服务器指向192.168.30.2</p>
<p><img src="测试3.png" alt="测试3"></p>
<p>（3）其他网段测试</p>
<p>切换回DNS服务器端：</p>
<p>dig <a href="http://www.wxlinux.com" target="_blank" rel="noopener">www.wxlinux.com</a> @127.0.0.1</p>
<p>由于127.0.0.1不属于上述两个网段之一，所以DNS服务器将web服务器地址指向192.168.0.3</p>
<p><img src="测试4.png" alt="测试4"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/31/Ansible使用介绍（三）templates及Roles角色/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/31/Ansible使用介绍（三）templates及Roles角色/" itemprop="url">Ansible使用介绍（三）templates及Roles角色</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-31T15:27:49+08:00">
                2018-05-31
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、环境搭建："><a href="#一、环境搭建：" class="headerlink" title="一、环境搭建："></a><strong>一、环境搭建：</strong></h2><p><strong>前期准备：</strong>一台虚拟机作为<strong>ansible</strong>，三台虚拟机作为被控端<strong>node</strong></p>
<p><strong>主控端：</strong></p>
<p>主机名：ansible</p>
<p>系统版本：CentOS6.9</p>
<p><strong>被控端：</strong></p>
<p>主机名：node1</p>
<p>CPU内核数：4</p>
<p>系统版本：CentSO7.4</p>
<p>主机名：node2</p>
<p>CPU内核数：2</p>
<p>系统版本：CentSO6.9</p>
<p>主机名：node3</p>
<p>CPU内核数：1</p>
<p>系统版本：CentSO6.9</p>
<p><img src="前期准备.png" alt="前期准备"></p>
<p><strong>/etc/ansible/hosts</strong>文件主机列表配置如下：</p>
<p><img src="前期准备host.png" alt="前期准备host"></p>
<h2 id="二、Playbook中模板templates的用法"><a href="#二、Playbook中模板templates的用法" class="headerlink" title="二、Playbook中模板templates的用法"></a><strong>二、Playbook中模板templates的用法</strong></h2><h3 id="templates模板："><a href="#templates模板：" class="headerlink" title="templates模板："></a><strong>templates模板：</strong></h3><p><strong>功能：</strong>根据模块文件动态生成对应的配置文件</p>
<p><strong>使用方法：</strong></p>
<p>（1）templates文件必须存放在templates目录下，且以.j2为后缀</p>
<p>（2）templates模块只能被playbook调用</p>
<p>（3）yam文件需和templates目录平级，目录结构如下：</p>
<p>./</p>
<p>├── temnginx.yml</p>
<p>└── templates</p>
<p>└── nginx.conf.j2</p>
<h3 id="templates使用形式："><a href="#templates使用形式：" class="headerlink" title="templates使用形式："></a><strong>templates使用形式：</strong></h3><p><strong>字符串</strong>：使用单引号或双引号</p>
<p><strong>数字</strong>：整数，浮点数</p>
<p><strong>列表</strong>：[item1, item2, …]</p>
<p><strong>元组</strong>：(item1, item2, …)</p>
<p><strong>字典</strong>：{key1:value1, key2:value2, …}</p>
<p><strong>布尔型</strong>：true/false</p>
<p><strong>算术运算</strong>：+, -, *, /, //, %, **</p>
<p><strong>比较操作</strong>：==, !=, &gt;, &gt;=, &lt;, &lt;=</p>
<p><strong>逻辑运算</strong>：and, or, not</p>
<p><strong>流表达式</strong>：For If When</p>
<h3 id="示例1：使用template传输配置文件"><a href="#示例1：使用template传输配置文件" class="headerlink" title="示例1：使用template传输配置文件"></a><strong>示例1：</strong>使用template传输配置文件</h3><p>cp /etc/nginx/nginx.conf  templates/nginx.conf.j2</p>
<p><strong>vim testtemplate.yml</strong></p>
<p>—</p>
<p>– hosts: os6</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install package</p>
<p>​      yum: name=nginx</p>
<p>​    – name: copy template</p>
<p>​      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</p>
<p>​    – name: start service</p>
<p>​      service: name=nginx state=started enabled=yes</p>
<p><strong>执行结果：</strong>运行playbook后，我们发现work process进程数量与虚拟机cpu内核数量是一致的，接下来我</p>
<p>们将把配置模板中的work process进程数量与系统自带变量结合起来引用。</p>
<p><img src="temp1.png" alt="temp1"></p>
<h3 id="示例2：template引用系统变量"><a href="#示例2：template引用系统变量" class="headerlink" title="示例2：template引用系统变量"></a><strong>示例2：</strong>template引用系统变量</h3><p>ansible websrvs -m setup |grep ‘cpu’</p>
<p><strong>vim templates/nginx.conf.j2</strong></p>
<p>worker_processes NaN;</p>
<p><img src="tmpl2.png" alt="tmpl2"></p>
<p><strong>vim testtemplate.yml</strong></p>
<p>—</p>
<p>– hosts:os6</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install package</p>
<p>​      yum: name=nginx</p>
<p>​    – name: copy template</p>
<p>​      template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</p>
<p>​      notify: restart service</p>
<p>​    – name: start service</p>
<p>​      service: name=nginx state=started enabled=yes</p>
<p>  handlers:</p>
<p>​    – name: restart service</p>
<p>​      service:name=nginx state=restarted</p>
<p><strong>执行结果：</strong>再次运行playbook后，我们发现worker process进程数量等于cpu核心数量加2，这样template</p>
<p>就能帮我们实现根据不同主机性能定制相应的配置。</p>
<p><img src="lazy.png" alt="temp3"></p>
<h3 id="示例3：hosts文件普通变量修改nginx服务端口"><a href="#示例3：hosts文件普通变量修改nginx服务端口" class="headerlink" title="示例3：hosts文件普通变量修改nginx服务端口"></a><strong>示例3：</strong>hosts文件普通变量修改nginx服务端口</h3><p><strong>vim /etc/ansible/hosts</strong></p>
<p>192.168.30.101 httpd_port=81</p>
<p>192.168.30.102 httpd_port=82</p>
<p><strong>vim templates/nginx.conf.j2</strong></p>
<p> server {</p>
<p>​       listen        default server</p>
<p>​       listen       [::]: default server</p>
<p>  }</p>
<h2 id="三、Playbook中逻辑语句的使用"><a href="#三、Playbook中逻辑语句的使用" class="headerlink" title="三、Playbook中逻辑语句的使用"></a><strong>三、Playbook中逻辑语句的使用</strong></h2><h3 id="When："><a href="#When：" class="headerlink" title="When："></a><strong>When：</strong></h3><p><strong>条件测试:</strong>如果需要根据变量、facts或此前任务的执行结果来做为某task执行与</p>
<p>否的前提时要用到条件测试,通过when语句实现，在task中使用，jinja2的语法</p>
<p>查看发行版本系统变量：</p>
<p>ansible srv -m setup filter=”*distribution”</p>
<p><img src="when1.png" alt="when1"></p>
<h3 id="示例1："><a href="#示例1：" class="headerlink" title="示例1："></a><strong>示例1：</strong></h3><p><strong>vim testtemplate.yml</strong></p>
<p>—</p>
<p>– hosts: all</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install package</p>
<p>​      yum: name=nginx</p>
<p>​    – name: copy template for centos7</p>
<p>​      template: src=nginx.conf7.j2 dest=/etc/nginx/nginx.conf</p>
<p>​      when: ansible_distribution_major_version == “7”</p>
<p>​      notify: restart service</p>
<p>​    – name: copy template for centos6</p>
<p>​      template: src=nginx.conf6.j2 dest=/etc/nginx/nginx.conf</p>
<p>​      when: ansible_distribution_major_version == “6”</p>
<p>​      notify: restart service</p>
<p>​    – name: start service</p>
<p>​      service: name=nginx state=started enabled=yes</p>
<p>  handlers:</p>
<p>​    – name: restart service</p>
<p>​      service:name=nginx state=restarted</p>
<p><strong>执行结果:</strong>当when语句不匹配时，将skipping直接跳过，仅执行与when语句匹配的语句内容，最终</p>
<p>CentOS6,7根据不同的版本号生成对应的配置并启动服务。</p>
<p><img src="when2.png" alt="when2"></p>
<h3 id="with-items：迭代"><a href="#with-items：迭代" class="headerlink" title="with_items：迭代"></a><strong>with_items：迭代</strong></h3><p><strong>迭代：</strong>当有需要重复性执行的任务时，可以使用迭代机制</p>
<p>对迭代项的引用，固定变量名为“item”</p>
<p>要在task中使用with_items给定要迭代的元素列表</p>
<p><strong>列表格式：</strong></p>
<p>字符串</p>
<p>字典</p>
<h3 id="示例1：利用迭代一次创建多个文件，安装多个命令包"><a href="#示例1：利用迭代一次创建多个文件，安装多个命令包" class="headerlink" title="示例1：利用迭代一次创建多个文件，安装多个命令包"></a><strong>示例1：</strong>利用迭代一次创建多个文件，安装多个命令包</h3><p><strong>vim testitem.yml</strong></p>
<p>—</p>
<p>– hosts: all</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: create some file</p>
<p>​      file: name=/data/  state=touch</p>
<p>​      when: ansible_distribution_major_version == “7”</p>
<p>​      with_items:</p>
<p>​        – file1</p>
<p>​        – file2</p>
<p>​        – file3</p>
<p>​    – name: install some packages</p>
<p>​      yum: name=</p>
<p>​      with_items:</p>
<p>​        – htop</p>
<p>​        – sl</p>
<p>​        – hping3</p>
<p><strong>执行结果：</strong>当系统为CentOS7版本时，在/data目录下创建file1-3文件，安装htop，sl，hping3命令</p>
<p><img src="迭代1.png" alt="迭代1"></p>
<h3 id="示例2：使用迭代创建组"><a href="#示例2：使用迭代创建组" class="headerlink" title="示例2：使用迭代创建组"></a><strong>示例2：</strong>使用迭代创建组</h3><p><strong>vim testitem2.yml</strong></p>
<p>—</p>
<p>– hosts: all</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: create some groups</p>
<p>​      group: name=</p>
<p>​      when: ansible_distribution_major_version == “7”</p>
<p>​      with_items:</p>
<p>​        – g1</p>
<p>​        – g2</p>
<p>​        – g3</p>
<p><strong>执行结果：</strong>当系统版本为CentOS7时，创建g1,g2,g3组</p>
<p><img src="迭代2.png" alt="迭代2"></p>
<h3 id="示例3：使用迭代配合字典创建用户与组"><a href="#示例3：使用迭代配合字典创建用户与组" class="headerlink" title="示例3：使用迭代配合字典创建用户与组"></a><strong>示例3：</strong>使用迭代配合字典创建用户与组</h3><p><strong>vim testitem2.yml</strong></p>
<p>—</p>
<p>– hosts: all</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: create some groups</p>
<p>​      group: name=</p>
<p>​      with_items:</p>
<p>​        – g1</p>
<p>​        – g2</p>
<p>​        – g3</p>
<p>​    – name: create some users</p>
<p>​      user: name= group=</p>
<p>​      with_items:</p>
<p>​        – { name: ‘user1’,group: ‘g1’ }</p>
<p>​        – { name: ‘user2’,group: ‘g2’ }</p>
<p>​        – { name: ‘user3’,group: ‘g3’ }</p>
<p><strong>执行结果：</strong>所有主机上创建user1，user2，user3用户，且主组为g1，g2，g3</p>
<p><img src="迭代3.png" alt="迭代3"></p>
<p><strong>for 与  if</strong></p>
<h3 id="示例1：template，for"><a href="#示例1：template，for" class="headerlink" title="示例1：template，for"></a><strong>示例1：</strong>template，for</h3><p><strong>vim for1.conf.j2</strong></p>

<p><strong>vim testfor.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  vars:</p>
<p>​    ports:</p>
<p>​      – 81</p>
<p>​      – 82</p>
<p>​      – 83</p>
<p>  tasks:</p>
<p>​    – name: copy conf</p>
<p>​       template: src=for1.conf.j2  dest=/data/for1.conf</p>
<p><strong>执行结果：</strong>每台主机生成for1.conf文件，内容如下</p>
<p><img src="for1.png" alt="for1"></p>
<h3 id="示例2：template，for，引用字典"><a href="#示例2：template，for，引用字典" class="headerlink" title="示例2：template，for，引用字典"></a><strong>示例2：</strong>template，for，引用字典</h3><p><strong>vim for2.conf.j2</strong></p>

<p>cp testfor.yml testfor2.yml</p>
<p><strong>vim testfor2.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  vars:</p>
<p>​    ports:</p>
<p>​      – listen_port: 81</p>
<p>​      – listen_port: 82</p>
<p>​      – listen_port: 83</p>
<p>  tasks:</p>
<p>​    – name: copy conf</p>
<p>​      template:src=for2.conf.j2  dest/data/for2.conf</p>
<p><strong>执行结果：</strong>每台主机生成for2.conf文件，内容如下</p>
<p><img src="for2.png" alt="for2"></p>
<p>### </p>
<h3 id="示例3：for循环中调用字典"><a href="#示例3：for循环中调用字典" class="headerlink" title="示例3：for循环中调用字典"></a><strong>示例3：</strong>for循环中调用字典</h3><p><strong>vim for3.conf.j2</strong></p>

<p>cp testfor2.yml testfor3.yml</p>
<p><strong>vim testfor3.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  vars:</p>
<p>​    ports:</p>
<p>​      – web1:</p>
<p>​        port: 81</p>
<p>​        name: web1.magedu.com</p>
<p>​        rootdir: /data/website1</p>
<p>​      – web2:</p>
<p>​        port: 82</p>
<p>​        name: web2.magedu.com</p>
<p>​        rootdir: /data/website2</p>
<p>​      – web3:</p>
<p>​        port: 83</p>
<p>​        name: web3.magedu.com</p>
<p>​        rootdir: /data/website3</p>
<p>  tasks:</p>
<p>​    – name: copy conf</p>
<p>​      template:src=for3.conf.j2  dest/data/for3.conf</p>
<p><strong>执行结果：</strong>每台主机生成for3.conf文件，内容如下</p>
<p><img src="for3.png" alt="for3"></p>
<h3 id="示例4：for循环中调用if"><a href="#示例4：for循环中调用if" class="headerlink" title="示例4：for循环中调用if"></a><strong>示例4：</strong>for循环中调用if</h3><p><strong>vim for4.conf.j2</strong></p>

<p>cp testfor3.yml testfor4.yml</p>
<p><strong>vim testfor4.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  vars:</p>
<p>​    ports:</p>
<p>​      – web1:</p>
<p>​        port: 81</p>
<p>​        #name: web1.magedu.com</p>
<p>​         rootdir: /data/website1</p>
<p>​      – web2:</p>
<p>​        port: 82</p>
<p>​        name: web2.magedu.com</p>
<p>​         rootdir: /data/website1</p>
<p>​      – web3:</p>
<p>​        port: 83</p>
<p>​        #name: web3.magedu.com</p>
<p>​         rootdir: /data/website1</p>
<p>  tasks:</p>
<p>​    – name: copy conf</p>
<p>​      template:src=for4.conf.j2  dest/data/for4.conf</p>
<p><strong>执行结果：</strong>每台主机生成for3.conf文件，内容如下，web1与web3的name没赋值，所有跳过，web2的</p>
<p>name被赋值，文件中输出结果</p>
<p><img src="for4-1.png" alt="for4"></p>
<h2 id="四、Roles角色"><a href="#四、Roles角色" class="headerlink" title="四、Roles角色"></a><strong>四、Roles角色</strong></h2><p><strong>角色（roles）</strong>：角色集合</p>
<p><strong>roles/</strong></p>
<p>  mysql/</p>
<p>   httpd/</p>
<p>   nginx/</p>
<p>   memcached/</p>
<p><strong>/roles/project/ :</strong>项目名称,有以下子目录</p>
<p><strong>files/ ：</strong>存放由copy或script模块等调用的文件</p>
<p><strong>templates/：</strong>template模块查找所需要模板文件的目录</p>
<p><strong>tasks/：</strong>定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文</p>
<p>件需要在此文件中通过include进行包含</p>
<p><strong>handlers/：</strong>至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过</p>
<p>include进行包含</p>
<p><strong>vars/：</strong>定义变量，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件</p>
<p>中通过include进行包含</p>
<p><strong>meta/：</strong>定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文</p>
<p>件，其它文件需在此文件中通过include进行包含</p>
<p><strong>default/：</strong>设定默认变量时使用此目录中的main.yml文件</p>
<p><strong>建议：roles创建在ansible目录</strong></p>
<p>mkdir roles</p>
<p>mkdir roles/{httpd,mysql,memcache,nginx} -pv</p>
<h3 id="示例1：定义nginx角色"><a href="#示例1：定义nginx角色" class="headerlink" title="示例1：定义nginx角色"></a><strong>示例1：</strong>定义nginx角色</h3><p><strong>思路：</strong></p>
<p>niginx</p>
<p>1.group:nginx</p>
<p>2.user:nginx</p>
<p>3.yum:nginx</p>
<p>4.template:nigin.conf.j2</p>
<p>5.service:nginx</p>
<p><strong>目录结构如下：</strong></p>
<p><img src="nginx目录结构.png" alt="nginx目录结构"></p>
<p>cd nginx</p>
<p>mkdir tasks templates</p>
<p>cd tasks</p>
<p><strong>vim group.yml</strong></p>
<p>– name: create group</p>
<p>  group: name=nginx gid=80</p>
<p><strong>vim user.yml</strong></p>
<p>– name: create user</p>
<p>  user: name=nginx group=nginx uid=80 shell=/sbin/noligin</p>
<p><strong>vim yum.yml</strong></p>
<p>– name: install package</p>
<p>  yum: name=nginx</p>
<p><strong>vim start.yml</strong></p>
<p>– name: start service</p>
<p>  service: name=nginx state=started enabled=yes</p>
<p><strong>vim restart.yml</strong></p>
<p>– name: restart service</p>
<p>  service: name=nginx state=restarted</p>
<p>cp /etc/nginx/nginx.conf  template/nginx.conf.j2</p>
<p><strong>vim template/nginx.conf.j2</strong></p>
<p>worker_processes NaN;</p>
<p><strong>vim templ.yml</strong></p>
<p>– name: copy conf</p>
<p>template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf</p>
<p><strong>vim main.yml</strong></p>
<p>– include: group.yml</p>
<p>– include: user.yml</p>
<p>– include: yum.yml</p>
<p>– include: templ.yml</p>
<p>– include: start.yml</p>
<p><strong>调用角色的剧本要和roles目录在同一文件夹</strong></p>
<p><strong>vim nginx_roles.yml</strong></p>
<p>– hosts: websrvs</p>
<p>  romete_user: root</p>
<p>  roles:</p>
<p>​    – role: nginx</p>
<p>ansible-playbook -C nginx_role.yml</p>
<p><strong>执行结果如下：</strong></p>
<p><img src="nginx.png" alt="nginx"></p>
<h3 id="示例2：增加httpd角色"><a href="#示例2：增加httpd角色" class="headerlink" title="示例2：增加httpd角色"></a><strong>示例2：</strong>增加httpd角色</h3><p><strong>结构目录如下：</strong></p>
<p><img src="httpd目录机构-1.png" alt="httpd目录机构"></p>
<p>cd httpd/</p>
<p>mkdir tasks</p>
<p>cd tasks/</p>
<p><strong>vim user.yml</strong></p>
<p>– name: create user</p>
<p>  user: name=apache system=yes shell=/sbin/nologin</p>
<p>cd httpd/</p>
<p>mkdir files</p>
<p>cp httpd.conf   files/</p>
<p>cd /tasks/</p>
<p><strong>模拟编译安装yum</strong></p>
<p><strong>vim copyfile.yml</strong></p>
<p>– name: copy files</p>
<p>  copy: src=httpd.conf dest=/data/ own=apache</p>
<p><strong>vim main.yml</strong></p>
<p>– incluse: user.yml</p>
<p>– incluse: copyfile.yml</p>
<p><strong>vim httpd_role.yml</strong></p>
<p>– hosts: websrvs</p>
<p>  romete_user: root</p>
<p>  roles:</p>
<p>​    – role: httpd</p>
<p><strong>执行结果如下：</strong></p>
<p><img src="httpd执行结果.png" alt="httpd执行结果"></p>
<h3 id="示例3：同时调用两个roles角色"><a href="#示例3：同时调用两个roles角色" class="headerlink" title="示例3：同时调用两个roles角色"></a><strong>示例3：</strong>同时调用两个roles角色</h3><p><strong>目录结构：</strong></p>
<p><img src="somerole目录结构.png" alt="somerole目录结构"></p>
<p>cp niginx_role.yml some_role.yml</p>
<p><strong>vim some_role.yml</strong></p>
<p>– hosts: websrvs</p>
<p>  romete_user: root</p>
<p>  roles:</p>
<p>​    – role: httpd</p>
<p>​    – role: nginx</p>
<p><strong>执行结果如下：</strong></p>
<p><img src="somerole执行结果.png" alt="somerole执行结果"></p>
<p>### </p>
<h3 id="示例4：一个roles角色调用另一个roles角色的task任务"><a href="#示例4：一个roles角色调用另一个roles角色的task任务" class="headerlink" title="示例4：一个roles角色调用另一个roles角色的task任务"></a><strong>示例4：</strong>一个roles角色调用另一个roles角色的task任务</h3><p><strong>目标：</strong>nginx调用httpd的copyfile</p>
<p><strong>vim main.yml</strong></p>
<p>– include: group.yml</p>
<p>– include: user.yml</p>
<p>– include: yum.yml</p>
<p>– include: templ.yml</p>
<p>– include: start.yml</p>
<p>– inclide: roles/httpd/tasks/copyfile.yml</p>
<h3 id="示例5：roles-playbook-tags"><a href="#示例5：roles-playbook-tags" class="headerlink" title="示例5：roles playbook tags"></a><strong>示例5：</strong>roles playbook tags</h3><p><strong>目录结构如下：</strong></p>
<p><img src="tags目录结构.png" alt="tags目录结构"></p>
<p>cp -r nginx/ app/     首先虚构一个app的role</p>
<p><strong>vim some_role2.yml</strong></p>
<p>– hosts: websrvs</p>
<p>  romete_user: root</p>
<p>  roles:</p>
<p>​    – { role: httpd,tags:[‘web’,’httpd’]}</p>
<p>​    – { role: nginx,tags:[‘web’,’nginx’]}</p>
<p>​    – { role: app,tags:’app’}</p>
<p>ansible-playbook -t web some_role.yml</p>
<p><strong>执行结果：</strong>只执行标签为web的role</p>
<p><img src="tags执行结果.png" alt="tags执行结果"></p>
<p>### </p>
<h3 id="示例6：roles-playbook-tags-when"><a href="#示例6：roles-playbook-tags-when" class="headerlink" title="示例6：roles playbook tags when"></a><strong>示例6：</strong>roles playbook tags when</h3><p>cp -r nginx/ app/     虚构一个role</p>
<p><strong>vim some_role3.yml</strong></p>
<p>– hosts: all</p>
<p>  romete_user: root</p>
<p>  roles:</p>
<p>   – { role: httpd,tags:[‘web’,’httpd’]}</p>
<p>   – { role: nginx,tags:[‘web’,’nginx’],when: ansible_distribution_major_version==”7″}</p>
<p>   – { role: app,tags:’app’}</p>
<p>ansible-playbook -t web some_role.yml</p>
<p><strong>执行结果：</strong>至执行tags标签为web的roles，当主版本号为7时，才执行nginx的role</p>
<p><img src="tags-when.png" alt="tags when"></p>
<p>### </p>
<h3 id="示例7：综合演示"><a href="#示例7：综合演示" class="headerlink" title="示例7：综合演示"></a><strong>示例7：</strong>综合演示</h3><p><strong>结构目录：</strong></p>
<p><img src="综合演示结构目录.png" alt="综合演示结构目录"></p>
<p>rm -rf /app</p>
<p>mkdir app</p>
<p>cd app</p>
<p>mkdir tasks templates vars handlers files</p>
<p>cd tasks/</p>
<p><strong>vim group.yml</strong></p>
<p>– name: create group</p>
<p>  group: name=app system=yes gid=123</p>
<p><strong>vim user.yml</strong></p>
<p>– name: create user</p>
<p>  user: name=app group=app system=yes shell=/sbin/nologin uid=123</p>
<p><strong>vim yum.yml</strong></p>
<p>– name: install package</p>
<p>   yum: name=httpd</p>
<p>cp /etc/httpd/conf/httpd.conf /templates/httpd.conf.j2</p>
<p><strong>vim temlates/httpd.conf.j2</strong></p>
<p>Listen NaN</p>
<p>User </p>
<p>Group </p>
<p><strong>vim /vars/main.yml</strong></p>
<p>username: app</p>
<p>groupname: app</p>
<p><strong>vim templ.yml</strong></p>
<p>– name: copy conf</p>
<p>  temlplate: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</p>
<p>  notify: restart service</p>
<p><strong>vim start.yml</strong></p>
<p>– name: start service</p>
<p>   service: name=httpd state=started enabled=yes</p>
<p><strong>vim handlers/main.yml</strong></p>
<p>– name: restart service</p>
<p>   service: name=httpd state=restarted</p>
<p>touch files/vhosts.conf</p>
<p><strong>vim copyfile.yml</strong></p>
<p>– name: copy config</p>
<p>   copy: src=vhosts.conf  dest=/ect/httpd/conf.d/</p>
<p><strong>vim main.yml</strong></p>
<p>– include: group.yml</p>
<p>– include: user.yml</p>
<p>– include: yum.yml</p>
<p>– include: templ.yml</p>
<p>– include: copyfile.yml</p>
<p>– include: start.yml</p>
<p>cd ansible/</p>
<p><strong>vim app_role.yml</strong></p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  roles:</p>
<p>​    – role: app</p>
<p><strong>执行结果如下：</strong></p>
<p><img src="综合演示执行结果.png" alt="综合演示执行结果"></p>
<h3 id="示例8：部署memcached，占用内存为物理内存1-4"><a href="#示例8：部署memcached，占用内存为物理内存1-4" class="headerlink" title="示例8：部署memcached，占用内存为物理内存1/4"></a><strong>示例8：</strong>部署memcached，占用内存为物理内存1/4</h3><p><img src="memcached.png" alt="memcached"></p>
<p>yum install memcached</p>
<p><strong>目录结构：</strong></p>
<p><img src="memcached目录结构.png" alt="memcached目录结构"></p>
<p>cp /etc/sysconfig/memcached templates/memcached.j2</p>
<p><strong>vim memcached.j2</strong></p>
<p>CACHESIZE=”NaN”</p>
<p><strong>vim tasks/yum.yml</strong></p>
<p>– name: install package</p>
<p>   yum: name=memcached</p>
<p><strong>vim templ.yum</strong></p>
<p>– name: copy conf</p>
<p>   template: src=memcached.j2 dest=/etc/sysconfig/memcached</p>
<p><strong>vim start.yml</strong></p>
<p>– name: start service</p>
<p>  service: name=memcached state=started enabled=yes</p>
<p><strong>vim main.yml</strong></p>
<p>– include: yum.yml</p>
<p>– include: templ.yml</p>
<p>– inculde: start.yml</p>
<p><strong>vim memcached_role.yml</strong></p>
<p>– hosts: os6</p>
<p>   remote_user: root</p>
<p>   roles:</p>
<p>​    – role: memcached</p>
<p>ansible-playbook memcached_role.yml</p>
<p><strong>执行结果如下：</strong></p>
<p><img src="memcached执行结果.png" alt="memcached执行结果"></p>
<p><strong>远程查看配置文件，确认生效：</strong></p>
<p><img src="memcached确认生效.png" alt="memcached确认生效"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/30/Ansible使用介绍（二）YAML语法及Playbook/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="吕培新">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="吕培新的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/30/Ansible使用介绍（二）YAML语法及Playbook/" itemprop="url">Ansible使用介绍（二）YAML语法及Playbook</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-30T15:25:45+08:00">
                2018-05-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/自动化运维/" itemprop="url" rel="index">
                    <span itemprop="name">自动化运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>playbook</strong>是由一个或多个”play”组成的列表</p>
<p>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansibe中的task定义好的角色。从根本上来</p>
<p>讲，所谓task无非是调用ansible的module。将多个play组织在一个playbook中，即可让它们联同起来按事</p>
<p>先编排的机制运行。</p>
<p><strong>Playbook</strong>采用<strong>YAML</strong>语言编写每一个Ansible的Playbook都是一个YAML格式的文件，因此要学习编写剧</p>
<p>本(playbook)，我们先来了解<strong>YAML</strong>语法的基本用法</p>
<h2 id="一、YAML介绍："><a href="#一、YAML介绍：" class="headerlink" title="一、YAML介绍："></a><strong>一、YAML介绍：</strong></h2><p><strong>YAML</strong>是一个可读性高的用来表达资料序列的格式。YAML参考了其他多种语言，包括：XML、</p>
<p>C语言、Python、Perl以及电子邮件格式RFC2822等。Clark Evans在2001年在首次发表了这种</p>
<p>语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者</p>
<p><strong>YAML Ain’t Markup Language</strong>，即YAML不是XML。不过，在开发的这种语言时，YAML的意</p>
<p>思其实是：”Yet Another Markup Language”（仍是一种标记语言）</p>
<h3 id="特性："><a href="#特性：" class="headerlink" title="特性："></a><strong>特性：</strong></h3><p>YAML的可读性好</p>
<p>YAML和脚本语言的交互性好</p>
<p>YAML使用实现语言的数据类型</p>
<p>YAML有一个一致的信息模型</p>
<p>YAML易于实现</p>
<p>YAML可以基于流来处理</p>
<p>YAML表达能力强，扩展性好</p>
<p>更多的内容及规范参见<a href="http://www.yaml.org/" target="_blank" rel="noopener">http://www.yaml.org</a></p>
<h3 id="YAML语法格式："><a href="#YAML语法格式：" class="headerlink" title="YAML语法格式："></a><strong>YAML语法格式：</strong></h3><p>1.在单一档案中，可用连续三个连字号(——)区分多个档案。另外，还有选择性的连续三个点号</p>
<p>( … )用来表示档案结尾</p>
<p>2.次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</p>
<p>3.使用#号注释代码</p>
<p>4.缩进必须是统一的，不能空格和tab混用</p>
<p>5.缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结</p>
<p>合换行来实现的</p>
<p>6.YAML文件内容和Linux系统大小写判断方式保持一致，是区别大小写的，k/v的值均需大小写敏</p>
<p>感</p>
<p>7.k/v的值可同行写也可换行写。同行使用:分隔</p>
<p>8.v可是个字符串，也可是另一个列表</p>
<p>9.一个完整的代码块功能需最少元素需包括 name: task</p>
<p>10.一个name只能包括一个task</p>
<p>11.YAML文件扩展名通常为yml或yaml</p>
<h3 id="YAML语法简介："><a href="#YAML语法简介：" class="headerlink" title="YAML语法简介："></a>YAML语法简介：</h3><p><strong>[列表]</strong></p>
<p>List：列表，其所有元素均使用“-”打头</p>
<p>示例：</p>
<p># A list of tasty fruits</p>
<p>– Apple</p>
<p>– Orange</p>
<p>– Strawberry</p>
<p>– Mango</p>
<p><strong>[字典]</strong></p>
<p>Dictionary：字典，通常由多个key与value构成</p>
<p>示例：</p>
<p>—</p>
<p># An employee record</p>
<p>name: Example Developer</p>
<p>job: Developer</p>
<p>skill: Elite</p>
<p>也可以将key:value放置于{}中进行表示，用,分隔多个key:value</p>
<p>示例：</p>
<p>—</p>
<p># An employee record</p>
<p>{name: Example Developer, job: Developer, skill: Elite}</p>
<h2 id="二、剧本Playbook"><a href="#二、剧本Playbook" class="headerlink" title="二、剧本Playbook"></a><strong>二、剧本Playbook</strong></h2><h3 id="Playbook核心元素："><a href="#Playbook核心元素：" class="headerlink" title="Playbook核心元素："></a>Playbook核心元素：</h3><p><strong>Hosts</strong>：执行的远程主机列表</p>
<p><strong>Tasks</strong>：任务列表</p>
<p><strong>Varniables</strong>：内置变量或自定义变量在playbook中调用</p>
<p><strong>Templates</strong>：模板，可替换模板文件中的变量并实现一些简单逻辑的文件</p>
<p><strong>Handlers</strong>：和notify结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</p>
<p><strong>tags</strong>：标签，指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性。因此</p>
<p>会自动跳过没有变化的部分。此时，如果确信其没有变化，就可以通过tags跳过此些代码片段</p>
<p>下图展示的是Playbook的工作机制：</p>
<p><img src="playbook.png" alt="playbook"></p>
<h3 id="Hosts："><a href="#Hosts：" class="headerlink" title="Hosts："></a><strong>Hosts：</strong></h3><p><strong>作用：</strong>playbook中的每一个play的目的都是为了让某个或某些主机以某个指定的用户</p>
<p>身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p>
<p>可以是如下形式：</p>
<p>one.example.com</p>
<p>one.example.com:two.example.com</p>
<p>192.168.1.50</p>
<p>192.168.1.*</p>
<p>websrvs:dbsrvs               两个组的并集</p>
<p>websrvs:&amp;dbsrvs             两个组的交集</p>
<p>webservers:!dbsrvs 在websrvs组，但不在dbsrvs组</p>
<p><strong>示例:</strong></p>
<p>– hosts: websrvs：dbsrvs</p>
<h3 id="remote-user："><a href="#remote-user：" class="headerlink" title="remote_user："></a><strong>remote_user：</strong></h3><p><strong>作用：</strong>可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，</p>
<p>其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的</p>
<p>用户</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: test connection</p>
<p>​      ping:</p>
<p>​      remote_user: magedu</p>
<p>​      sudo: yes 默认sudo为root</p>
<p>​      sudo_user:wang sudo为wang</p>
<h3 id="tasks："><a href="#tasks：" class="headerlink" title="tasks："></a><strong>tasks：</strong></h3><p><strong>作用：</strong>任务列表</p>
<p><strong>格式：module: arguments</strong></p>
<p><strong>注意：</strong>shell和command模块后面跟命令，而非key=value</p>
<p><strong>检查playbook：</strong></p>
<p>ansible-playbook -C file.yml</p>
<p><strong>运行playbook的方式：</strong></p>
<p>​    <strong>ansible-playbook &lt;filrname.yml&gt; …[options]</strong></p>
<p>​    <strong>options：</strong></p>
<p>–check                      只检测可能会发生的改变，但不真正的操作</p>
<p>–list-hosts                列出运行任务的主机</p>
<p>–limit       主机列表       只针对主机列表中的主机执行</p>
<p>-v,-vv,-vvv                 显示详细过程</p>
<p>一个最简单的Playbook需包含的基础组件有host、remote_user、tasks</p>
<p><strong>示例1：</strong></p>
<p><strong>vim http.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: create new file</p>
<p>​      file: name=/data/newfile state=touch</p>
<p>​    – name: create new file</p>
<p>​      user: name=test2 system=yes shell=/sbin/nologin</p>
<p>​    – name: install package</p>
<p>​      yum: name=httpd</p>
<p>​    – name: copy index</p>
<p>​      copy: src=/var/www/html/index.html dest=/var/www/html/</p>
<p>​    – name: start service</p>
<p>​      service: name=httpd state=started enabled=yes</p>
<p><img src="http.yml_.png" alt="http.yml"></p>
<h3 id="tags标签"><a href="#tags标签" class="headerlink" title="tags标签"></a><strong>tags标签</strong></h3><p><strong>task**</strong>任务也可以通过”tags”打标签，而后可在ansible-playbook命令上使用-t指定进行调用**</p>
<p><strong>示例2：使用tags</strong></p>
<p><strong>vim http.yml</strong></p>
<p>—</p>
<p>– host: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install httpd package</p>
<p>​      yum: name=httpd</p>
<p>​      tags: inshttpd</p>
<p>​    – name: copy conf file</p>
<p>​      copy: src=files/httpd.conf dest=/etc/httpd/conf/  backup=yes</p>
<p>​      tags: cphttpd</p>
<p>​    – name: start service</p>
<p>​      service: name=httpd state=startd enable=yes</p>
<p>​      tags: rshttpd</p>
<p>ansible-playbook -t rshttpd httpd.yml            单独执行rshttp</p>
<p>注：多个动作可共用一个tags标签</p>
<p><img src="tags2.png" alt="tags2"></p>
<h2 id="三、Playbook中handler的使用"><a href="#三、Playbook中handler的使用" class="headerlink" title="三、Playbook中handler的使用"></a><strong>三、Playbook中handler的使用</strong></h2><p>由于Ansible<strong>幂等性</strong>的特性，有时前一个task发生了变化，后续的task无变化并不会重新执行，</p>
<p>但后续的task却可能受前一个task变化而影响。使用<strong>hanlder</strong>和<strong>notify</strong>即可解决此问题，handler</p>
<p>用于当关注的资源发生变化时，才会采取一定的操作。在notify中列出的操作称为handler，</p>
<p>也即notify中调用handler中定义的操作</p>
<p><strong>示例：</strong></p>
<p><strong>vim http.yml</strong></p>
<p>—</p>
<p>– host: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install httpd package</p>
<p>​      yum: name=httpd</p>
<p>​    – name: copy conf file</p>
<p>​      copy: src=files/httpd.conf dest=/etc/httpd/conf/  backup=yes</p>
<p>​    – name: start service</p>
<p>​      service: name=httpd state=startd enable=yes</p>
<p><strong>vim /files/httpd.conf</strong></p>
<p>Listen 8080</p>
<p><img src="8080.png" alt="8080"></p>
<p>ansible-playbook http.yml</p>
<p>此时无法重启服务，端口仍为80</p>
<p><strong>vim http.yml</strong></p>
<p>—</p>
<p>– host: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install httpd package</p>
<p>​      yum: name=httpd</p>
<p>​    – name: copy conf file</p>
<p>​      copy: src=files/httpd.conf dest=/etc/httpd/conf/  backup=yes</p>
<p>​      notify: restart service</p>
<p>​    – name: start service</p>
<p>​      service: name=httpd state=startd enable=yes</p>
<p>  handlers:</p>
<p>​    – name: restart service</p>
<p>​      service: name=httpd state=restarted</p>
<p>由于httpd.conf发生了变化，触发了notify，执行相应的handler操作，httpd服务重启后</p>
<p>监听端口变为8080</p>
<p><img src="80802.png" alt="80802"></p>
<h2 id="四、Playbook中变量的使用"><a href="#四、Playbook中变量的使用" class="headerlink" title="四、Playbook中变量的使用"></a><strong>四、Playbook中变量的使用</strong></h2><p><strong>变量名：</strong>仅能由字母、数字和下划线组成，且只能以字母开头</p>
<p><strong>变量来源：</strong></p>
<p><strong>1.ansible all -m setup</strong>  远程主机的所有变量都可直接调用</p>
<p><strong>2.在/etc/ansible/hosts中定义</strong></p>
<p>普通变量：主机组中主机单独定义，优先级高于公共变量</p>
<p>host分组变量：针对主机组中所有主机定义统一变量</p>
<p><strong>3.通过命令行指定变量，优先级最高</strong></p>
<p>例如：ansible-playbook –e varname=value</p>
<p><strong>4.在playbook中定义</strong></p>
<p>vars:</p>
<p>  – var1: value1</p>
<p>  – var2: value2</p>
<p><strong>5.在role中定义</strong></p>
<p><strong>变量定义：</strong>key=value</p>
<p><strong>示例：</strong>http_port=80</p>
<p><strong>变量调用方式：</strong></p>
<p>通过 调用变量，且变量名前后必须有空格，有时用””才生效</p>
<p><strong>变量调用优先级：</strong></p>
<p><strong>命令行-e &gt; playbook定义 &gt; hosts普通变量 &gt; host分组变量</strong></p>
<p><strong>示例1：命令行变量赋值</strong></p>
<p><strong>vim app.yml</strong></p>
<p>—</p>
<p>– hosts: appsrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: install package</p>
<p>​      yum: name=</p>
<p>​    – name: start service</p>
<p>​      service: name= state=started enabled=yes</p>
<p>变量赋值并执行：</p>
<p>ansible-playbook -e ‘pkname=vsftpd’ app.yml     </p>
<p><img src="vsftpd.png" alt="vsftpd"></p>
<p><strong>示例2：playbook中赋值变量</strong></p>
<p><strong>vim app.yml</strong></p>
<p>—</p>
<p>– hosts: appsrvs</p>
<p>  remote_user: root</p>
<p>  vars:</p>
<p>​    – pkname1: httpd</p>
<p>​    – pkname2: vsftpd</p>
<p>  tasks:</p>
<p>​    – name: install package</p>
<p>​      yum: name=</p>
<p>​    – name: install package</p>
<p>​      yum: name=</p>
<p>ansible-playbook app.yml</p>
<p><img src="palybook赋值变量.png" alt="palybook赋值变量"></p>
<p><strong>示例3：hosts文件中定义普通变量</strong></p>
<p><strong>vim /etc/ansible/hosts</strong></p>
<p>192.168.30.101 httpd_port=81</p>
<p>192.168.30.102 httpd_port=82</p>
<p><strong>vim hostname.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: set hostname</p>
<p>​      hostname: name=www.magedu.com</p>
<p>ansible-playbook -C hostname.yml</p>
<p><img src="分组变量.png" alt="分组变量"></p>
<p><strong>示例4：hosts文件中定义分组变量</strong></p>
<p><strong>vim /etc/ansible/hosts</strong></p>
<p>[websrv:vars]</p>
<p>nodename=www</p>
<p>domainname=wxlinux.com</p>
<p><img src="hostname2.png" alt="hostname2"></p>
<p><strong>vim hostname2.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: set hostname</p>
<p>​      hostname: name=.</p>
<p>ansible-playbook hostname.yml</p>
<p><img src="http://www.178linux.com/wp-content/uploads/2018/05/hostname2-3.png" alt="hostname2 (hostname2-3.png)"></p>
<p><strong>示例5：引用系统自带变量</strong></p>
<p><strong>ansible all -m setup |grep  ansible_fqdn</strong>     查看系统自带变量</p>
<p><img src="系统变量.png" alt="系统变量"></p>
<p><strong>vim var.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  tasks:</p>
<p>​    – name: create log file</p>
<p>​      file: name=/data/.log state=touch</p>
<p><img src="系统变量2.png" alt="系统变量2"></p>
<p><strong>示例6：定义变量到一个文件中</strong></p>
<p><strong>vim vars.yml</strong></p>
<p>var1: httpd</p>
<p>var2: vsftpd</p>
<p><img src="变量到文件中.png" alt="变量到文件中"></p>
<p><strong>vim testvar.yml</strong></p>
<p>—</p>
<p>– hosts: websrvs</p>
<p>  remote_user: root</p>
<p>  vars_files:</p>
<p>​    – vars.yml</p>
<p>  tasks:</p>
<p>​    – name: install package</p>
<p>​      yum: name=</p>
<p>​    – name: create file</p>
<p>​      file: name=/data/.log state=touch</p>
<p><img src="变量到文件中2.png" alt="变量到文件中2"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">吕培新</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">吕培新</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
